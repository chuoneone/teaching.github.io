<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>四、相似多邊形的對應關係</title>
    <link rel="icon" href="dog.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #fefff5; /* Light yellow background */
        }
        .locked-sub-questions {
            opacity: 0.5;
            pointer-events: none;
            filter: grayscale(80%);
        }
        .interaction-locked {
            pointer-events: none;
        }
        .feedback-message {
            transition: opacity 0.3s, transform 0.3s;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            margin-top: 0.5rem;
            text-align: center;
            display: inline-block;
        }
        .feedback-correct {
            background-color: #dcfce7;
            color: #166534;
        }
        .feedback-incorrect {
            background-color: #fee2e2;
            color: #991b1b;
            animation: shake 0.5s;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .highlight {
            background: linear-gradient(to top, #fef08a 60%, transparent 60%);
            padding: 0 0.2rem;
            font-weight: 700;
        }
        .clickable-letter {
            cursor: pointer;
            user-select: none;
            transition: all 0.2s;
        }
        .clickable-letter:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .dropzone {
            border: 2px dashed #9ca3af;
            transition: all 0.2s;
        }
        .active-dropzone {
            background-color: #dbeafe;
            border-color: #3b82f6;
            transform: scale(1.1);
            border-style: solid;
        }
        .check-btn {
            background-color: #2563eb;
            color: white;
            padding: 0.5rem 1.5rem;
            border-radius: 9999px;
            font-weight: 700;
            transition: all 0.2s;
        }
        .check-btn:hover {
            background-color: #1d4ed8;
        }
        .nav-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        .nav-btn.active {
            background-color: #2563eb;
            color: white;
            border-color: #1e40af;
        }
        .nav-btn:not(.active) {
            background-color: #e5e7eb;
            color: #4b5563;
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-4xl bg-white rounded-2xl shadow-lg p-6 md:p-8 space-y-6">
        
        <!-- 標題 -->
        <div class="text-center border-b pb-4">
            <h2 class="text-2xl sm:text-3xl md:text-4xl font-bold text-slate-800">四、 相似多邊形的對應關係</h2>
        </div>
        
        <!-- 題庫導覽 -->
        <div id="question-nav" class="flex justify-center items-center flex-wrap gap-3 mb-6">
            <!-- Navigation buttons will be inserted by JavaScript -->
        </div>

        <!-- 題目區 -->
        <div class="bg-slate-50 p-4 rounded-lg text-center">
            <p id="prompt-text" class="text-slate-700 text-base sm:text-lg leading-relaxed"></p>
        </div>

        <!-- 互動區 -->
        <div id="interaction-area" class="space-y-6">
            <!-- 字母選擇區 -->
            <div id="letter-bank" class="flex justify-center items-center flex-wrap gap-6 p-4 bg-gray-100 rounded-lg min-h-[80px]">
                <!-- Clickable letters will be inserted by JavaScript -->
            </div>

            <!-- 圖形放置區 (並排) -->
            <div id="shape-area" class="grid grid-cols-1 sm:grid-cols-2 gap-6 items-center">
                <!-- Shapes will be inserted by JavaScript -->
            </div>
            
            <div class="text-center">
                <button id="check-placement-btn" class="check-btn">確認位置</button>
                <div id="placement-feedback" class="mt-2"></div>
            </div>
        </div>
        
        <!-- 下方小題 -->
        <div id="sub-questions-section" class="space-y-4 pt-4 border-t">
            <!-- Sub-questions will be inserted by JavaScript -->
        </div>
    </div>
        <footer class="mt-6 sm:mt-8 flex items-center justify-center gap-3 text-slate-500 text-sm">
        <span>@spedmix2025</span>
        <a href="https://www.instagram.com/spedmix2025/" target="_blank" rel="noopener noreferrer" class="hover:text-slate-700 transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-instagram"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line></svg>
        </a>
    </footer>

    <script>
        const questions = [
            { // Question 1
                prompt: `已知 <span class="highlight font-mono">△ABC ~ △DEF</span>，其中 A、B、C 的對應頂點分別為 D、E、F。<br><strong class="text-blue-600">任務：請依序點擊字母，填入右方圖形的對應頂點。</strong>`,
                shapes: [{ shape: 'triangle', vertices: ['A', 'B', 'C'] }],
                clickableLetters: ['D', 'E', 'F'],
                correctMapping: { D: 'A', E: 'B', F: 'C' },
                subQuestions: [
                    { question: "(1) ∠A 的對應角為何？", inputType: 'angle', answer: 'D' },
                    { question: "(2) 線段 BC 的對應邊為何？", inputType: 'side', answer: ['EF', 'FE'] }
                ]
            },
            { // Question 2
                prompt: `已知四邊形 <span class="highlight font-mono">ABCD ~ 四邊形 PQRS</span>，其中 A、B、C、D 的對應頂點分別為 P、Q、R、S。<br><strong class="text-blue-600">任務：請依序點擊字母，填入右方圖形的對應頂點。</strong>`,
                shapes: [{ shape: 'quadrilateral', vertices: ['A', 'B', 'C', 'D'] }],
                clickableLetters: ['P', 'Q', 'R', 'S'],
                correctMapping: { P: 'A', Q: 'B', R: 'C', S: 'D' },
                subQuestions: [
                    { question: "(1) ∠B 的對應角為何？", inputType: 'angle', answer: 'Q' },
                    { question: "(2) 線段 QR 的對應邊為何？", inputType: 'side', answer: ['BC', 'CB'] }
                ]
            },
            { // Question 3
                prompt: `已知五邊形 <span class="highlight font-mono">ABCDE ~ 五邊形 PQRST</span>，其中 A、B、C、D、E 的對應頂點分別為 P、Q、R、S、T。<br><strong class="text-blue-600">任務：請依序點擊字母，填入右方圖形的對應頂點。</strong>`,
                shapes: [{ shape: 'pentagon', vertices: ['A', 'B', 'C', 'D', 'E'] }],
                clickableLetters: ['P', 'Q', 'R', 'S', 'T'],
                correctMapping: { P: 'A', Q: 'B', R: 'C', S: 'D', T: 'E' },
                subQuestions: [
                    { question: "(1) ∠C 的對應角為何？", inputType: 'angle', answer: 'R' },
                    { question: "(2) 線段 EA 的對應邊為何？", inputType: 'side', answer: ['TP', 'PT'] }
                ]
            }
        ];
        let currentQuestionIndex = 0;
        
        const shapeData = {
            triangle: {
                svg: `<polygon points="50,10 10,90 90,90" fill="#f3f4f6" stroke-width="2"/>`,
                positions: { A: { top: '-5px', left: '50%', transform: 'translateX(-50%)' }, B: { top: '85%', left: '0' }, C: { top: '85%', right: '0' } },
                dropzonePositions: { A: { top: '2px', left: '50%', transform: 'translateX(-50%)' }, B: { top: '78%', left: '2px' }, C: { top: '78%', right: '2px' } }
            },
            quadrilateral: {
                svg: `<polygon points="15,15 85,15 85,85 15,85" fill="#f3f4f6" stroke-width="2"/>`,
                positions: { A: { top: '5%', left: '5%' }, B: { top: '5%', right: '5%' }, C: { top: '80%', right: '5%' }, D: { top: '80%', left: '5%' } },
                dropzonePositions: { A: { top: '7%', left: '7%' }, B: { top: '7%', right: '7%' }, C: { top: '78%', right: '7%' }, D: { top: '78%', left: '7%' } }
            },
            pentagon: {
                svg: `<polygon points="50,10 95,45 78,95 22,95 5,45" fill="#f3f4f6" stroke-width="2"/>`,
                positions: { A: { top: '-2%', left: '50%', transform: 'translateX(-50%)' }, B: { top: '35%', right: '-5%' }, C: { top: '85%', right: '15%' }, D: { top: '85%', left: '15%' }, E: { top: '35%', left: '-5%' } },
                dropzonePositions: { A: { top: '2%', left: '50%', transform: 'translateX(-50%)' }, B: { top: '38%', right: '0' }, C: { top: '82%', right: '18%' }, D: { top: '82%', left: '18%' }, E: { top: '38%', left: '0' } }
            }
        };

        const letterColors = ['#ef4444', '#34d399', '#60a5fa', '#f59e0b', '#a78bfa'];
        
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function loadQuestion(index) {
            currentQuestionIndex = index;
            const q = questions[index];

            document.querySelectorAll('#question-nav .nav-btn').forEach((btn, i) => btn.classList.toggle('active', i === index));
            document.getElementById('prompt-text').innerHTML = q.prompt;

            const letterBank = document.getElementById('letter-bank');
            letterBank.innerHTML = '';
            q.clickableLetters.forEach((letter, i) => {
                const color = letterColors[i % letterColors.length];
                letterBank.innerHTML += `<div class="clickable-letter flex items-center justify-center w-12 h-12 text-white text-2xl font-bold rounded-full shadow-md" style="background-color: ${color};" data-letter="${letter}">${letter}</div>`;
            });

            const shapeArea = document.getElementById('shape-area');
            const refShapeType = q.shapes[0].shape;
            const refShapeVertices = q.shapes[0].vertices;
            const refShapeInfo = shapeData[refShapeType];
            
            let refShapeHTML = `<div class="relative w-full max-w-xs mx-auto"><svg viewBox="0 0 100 100">${refShapeInfo.svg.replace('/>', ' stroke="#6b7280"/>')}</svg>`;
            refShapeVertices.forEach(v => {
                const pos = refShapeInfo.positions[v];
                refShapeHTML += `<div class="absolute text-xl font-bold" style="top: ${pos.top}; left: ${pos.left || 'auto'}; right: ${pos.right || 'auto'}; transform: ${pos.transform || 'none'};">${v}</div>`;
            });
            refShapeHTML += `</div>`;
            
            let dropShapeHTML = `<div class="relative w-full max-w-xs mx-auto"><svg viewBox="0 0 100 100">${refShapeInfo.svg.replace('/>', ' stroke="#9ca3af"/>')}</svg>`;
            Object.keys(q.correctMapping).forEach(dragLetter => {
                const correctVertex = q.correctMapping[dragLetter];
                const pos = refShapeInfo.dropzonePositions[correctVertex];
                dropShapeHTML += `<div class="dropzone absolute w-14 h-14 rounded-full" style="top: ${pos.top}; left: ${pos.left || 'auto'}; right: ${pos.right || 'auto'}; transform: ${pos.transform || 'none'};" data-vertex="${correctVertex}" data-correct="${dragLetter}"></div>`;
            });
            dropShapeHTML += `</div>`;
            shapeArea.innerHTML = refShapeHTML + dropShapeHTML;

            const subQuestionsSection = document.getElementById('sub-questions-section');
            let subHTML = `<h3 class="text-center font-bold text-xl text-slate-700">做得好！現在請回答下面的問題：</h3>`;
            q.subQuestions.forEach((sq, i) => {
                const prefix = sq.inputType === 'angle' ? '∠' : '線段';
                let optionsHTML = '<option value="">請選擇</option>';
                const letters = q.clickableLetters;
                
                if (sq.inputType === 'angle') {
                    letters.forEach(letter => {
                        optionsHTML += `<option value="${letter}">${letter}</option>`;
                    });
                } else { // 'side'
                    const allSides = [];
                    for (let j = 0; j < letters.length; j++) {
                        for (let k = 0; k < letters.length; k++) {
                            if (j !== k) allSides.push(letters[j] + letters[k]);
                        }
                    }
                    const correctAnswer = sq.answer[0];
                    const distractors = allSides.filter(side => !sq.answer.includes(side));
                    shuffleArray(distractors);
                    
                    const finalOptions = [correctAnswer];
                    finalOptions.push(...distractors.slice(0, 4));
                    shuffleArray(finalOptions);

                    finalOptions.forEach(option => {
                        optionsHTML += `<option value="${option}">${option}</option>`;
                    });
                }
                const answerFieldHTML = `<select id="q${i}-answer" class="w-24 p-2 border rounded text-center text-lg bg-white">${optionsHTML}</select>`;

                subHTML += `<div class="flex flex-col sm:flex-row items-center justify-center gap-2 p-3 bg-slate-50 rounded-lg">
                                <label for="q${i}-answer" class="font-medium">${sq.question}</label>
                                <div class="flex items-center gap-2">
                                    <span class="text-lg ${sq.inputType === 'angle' ? 'font-mono' : ''}">${prefix}</span>
                                    ${answerFieldHTML}
                                    <button id="check-q${i}-btn" class="check-btn !px-4 !py-2 text-sm">檢查</button>
                                </div>
                                <div id="q${i}-feedback"></div>
                            </div>`;
            });
            subHTML += `<div id="completion-message" class="text-center font-bold text-2xl text-green-600" style="display: none;">恭喜你，全部答對了！</div>`;
            subQuestionsSection.innerHTML = subHTML;

            q.subQuestions.forEach((sq, i) => {
                document.getElementById(`check-q${i}-btn`).addEventListener('click', () => checkAnswer(i));
            });

            resetState();
            setupClickInteraction();
        }

        function setupClickInteraction() {
            const interactionArea = document.getElementById('interaction-area');
            interactionArea.addEventListener('click', handleInteractionClick);
            activateNextDropzone();
        }

        function handleInteractionClick(e) {
            const clickedEl = e.target.closest('.clickable-letter');
            if (!clickedEl) return;
            
            const parent = clickedEl.parentElement;
            if (parent.id === 'letter-bank') {
                const targetZone = document.querySelector('.active-dropzone');
                if (targetZone) {
                    targetZone.appendChild(clickedEl);
                    targetZone.classList.remove('active-dropzone');
                    activateNextDropzone();
                }
            } else if (parent.classList.contains('dropzone')) {
                document.getElementById('letter-bank').appendChild(clickedEl);
                activateNextDropzone();
            }
        }

        function activateNextDropzone() {
            document.querySelectorAll('.dropzone.active-dropzone').forEach(z => z.classList.remove('active-dropzone'));
            const allZones = document.querySelectorAll('.dropzone');
            const firstEmpty = Array.from(allZones).find(zone => !zone.hasChildNodes());
            if (firstEmpty) {
                firstEmpty.classList.add('active-dropzone');
            }
        }

        function resetState() {
            document.getElementById('interaction-area').classList.remove('interaction-locked');
            document.getElementById('sub-questions-section').classList.add('locked-sub-questions');
            document.getElementById('placement-feedback').innerHTML = '';
            
            const completionMessage = document.getElementById('completion-message');
            if (completionMessage) completionMessage.style.display = 'none';

            questions[currentQuestionIndex].subQuestions.forEach(sq => sq.isCorrect = false);
        }

        function checkPlacement() {
            let isCorrect = true;
            document.querySelectorAll('.dropzone').forEach(zone => {
                const child = zone.firstElementChild;
                if (!child || child.dataset.letter !== zone.dataset.correct) {
                    isCorrect = false;
                }
            });

            const placementFeedback = document.getElementById('placement-feedback');
            placementFeedback.innerHTML = `<span class="feedback-message ${isCorrect ? 'feedback-correct' : 'feedback-incorrect'}">${isCorrect ? '位置正確！請繼續回答下方問題。' : '位置不對喔，請再試一次！'}</span>`;
            
            if (isCorrect) {
                document.getElementById('interaction-area').classList.add('interaction-locked');
                document.getElementById('sub-questions-section').classList.remove('locked-sub-questions');
            }
        }

        function checkAnswer(questionIndex) {
            const qData = questions[currentQuestionIndex].subQuestions[questionIndex];
            const answer = document.getElementById(`q${questionIndex}-answer`).value.trim().toUpperCase();
            const feedbackEl = document.getElementById(`q${questionIndex}-feedback`);
            const isCorrect = Array.isArray(qData.answer) ? qData.answer.includes(answer) : answer === qData.answer;

            feedbackEl.innerHTML = `<span class="feedback-message ${isCorrect ? 'feedback-correct' : 'feedback-incorrect'}">${isCorrect ? '答對了！' : '不對喔！'}</span>`;

            if (isCorrect) {
                document.getElementById(`q${questionIndex}-answer`).disabled = true;
                document.getElementById(`check-q${questionIndex}-btn`).disabled = true;
                qData.isCorrect = true;
                
                const allCorrect = questions[currentQuestionIndex].subQuestions.every(sq => sq.isCorrect);
                if (allCorrect) {
                    document.getElementById('completion-message').style.display = 'block';
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const navContainer = document.getElementById('question-nav');
            questions.forEach((q, i) => {
                const btn = document.createElement('button');
                btn.className = 'nav-btn';
                btn.innerText = `第 ${i + 1} 題`;
                btn.onclick = () => loadQuestion(i);
                navContainer.appendChild(btn);
            });
            
            document.getElementById('check-placement-btn').addEventListener('click', checkPlacement);
            
            loadQuestion(0);
        });
    </script>
</body>
</html>


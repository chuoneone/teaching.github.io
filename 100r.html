<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>100R 特殊需求學生轉介表數位系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @media print {
            .no-print { display: none; }
            .print-only { display: block !important; }
            body { background: white; }
            .section-card { border: none; box-shadow: none; margin-bottom: 2rem; }
        }
        .print-only { display: none; }
        .highlight-item { background-color: #fef3c7; border-left: 4px solid #f59e0b; }
        .step-active { color: #2563eb; font-weight: bold; border-left: 3px solid #2563eb; }
    </style>
</head>
<body class="bg-gray-50 font-sans text-gray-900 leading-normal">

<div id="app" class="max-w-6xl mx-auto px-4 py-8">
    <header class="mb-8 text-center no-print">
        <h1 class="text-3xl font-bold text-blue-800">特殊需求學生轉介資料表 - 100R</h1>
    </header>

    <div class="flex flex-col md:flex-row gap-8">
        <aside class="md:w-64 no-print sticky top-8 h-fit">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
                <h2 class="text-sm font-semibold text-gray-400 uppercase tracking-wider mb-4">填寫進度</h2>
                <nav class="space-y-2">
                    <button @click="currentSection = 0" :class="{'step-active': currentSection === 0}" class="w-full text-left px-3 py-2 text-sm rounded transition hover:bg-gray-100">基本資料</button>
                    <template v-for="(section, index) in sections" :key="index">
                        <button @click="currentSection = index + 1" :class="{'step-active': currentSection === index + 1}" class="w-full text-left px-3 py-2 text-sm rounded transition hover:bg-gray-100">
                            {{ index + 1 }}. {{ section.name }}
                            <span v-if="getSectionProgress(index) > 0" class="ml-1 text-xs text-blue-500">({{ getSectionProgress(index) }})</span>
                        </button>
                    </template>
                    <button @click="calculateResult" class="w-full mt-4 bg-blue-600 text-white font-bold py-2 rounded-lg hover:bg-blue-700 transition">完成並傳送資料</button>
                </nav>
            </div>
        </aside>

        <main class="flex-1">
            <div v-show="currentSection === 0" class="bg-white rounded-xl shadow-md p-8 border border-gray-200">
                <h2 class="text-2xl font-bold mb-6 border-b pb-2 text-blue-700">基本資料</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">學生姓名</label>
                        <input type="text" v-model="studentInfo.name" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">出生年月日</label>
                        <input type="date" v-model="studentInfo.birthday" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">就讀學校</label>
                        <input type="text" v-model="studentInfo.school" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">年級班級</label>
                        <input type="text" v-model="studentInfo.grade" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">轉介人</label>
                        <input type="text" v-model="studentInfo.referrer" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">填表日期</label>
                        <input type="date" v-model="studentInfo.date" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                    </div>
                </div>
                <div class="mt-8 flex justify-end">
                    <button @click="currentSection++" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold">下一步：填寫向度一</button>
                </div>
            </div>

            <div v-for="(section, sIndex) in sections" :key="sIndex" v-show="currentSection === sIndex + 1" class="bg-white rounded-xl shadow-md p-8 border border-gray-200 mb-6">
                <h2 class="text-2xl font-bold mb-4 border-b pb-2 text-blue-700">{{ sIndex + 1 }}. {{ section.name }}</h2>
                <p class="text-sm text-gray-500 mb-6">請勾選適合該生的項目（可複選）。</p>
                <div class="space-y-3">
                    <div v-for="item in section.items" :key="item.id" 
                         :class="{'highlight-item': item.isImportant}"
                         class="p-4 border border-gray-100 rounded-lg hover:bg-gray-50 transition flex items-start gap-4 cursor-pointer"
                         @click="toggleItem(item.id)">
                        <input type="checkbox" :checked="answers.includes(item.id)" class="mt-1 h-5 w-5 text-blue-600 rounded border-gray-300 focus:ring-blue-500">
                        <div class="flex-1">
                            <span class="font-bold text-gray-600 mr-2">{{ item.id }}.</span>
                            <span class="text-gray-800">{{ item.text }}</span>
                            <div v-if="item.hasInput && answers.includes(item.id)" class="mt-2" @click.stop>
                                <input type="text" v-model="inputValues[item.id]" :placeholder="item.placeholder" class="border-b border-gray-400 w-full focus:outline-none focus:border-blue-500 text-sm py-1">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-8 flex justify-between">
                    <button @click="currentSection--" class="text-blue-600 font-bold px-6 py-2 border border-blue-600 rounded-lg">回上一頁</button>
                    <button @click="nextSection(sIndex)" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold">
                        {{ sIndex === sections.length - 1 ? '上傳資料並查看結果' : '下一步' }}
                    </button>
                </div>
            </div>

            <div v-if="showResult" id="result-page" class="bg-white rounded-xl shadow-md p-8 border border-gray-200">
                <div class="flex justify-between items-center mb-6 border-b pb-4">
                    <h2 class="text-2xl font-bold text-blue-700">轉介篩選評估報告</h2>
                    <div class="no-print space-x-2">
                        <span v-if="syncStatus === 'loading'" class="text-blue-500 text-sm">正在同步至試算表...</span>
                        <span v-if="syncStatus === 'success'" class="text-green-600 text-sm">✓ 已成功儲存至雲端</span>
                        <button @click="printReport" class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm">列印報告</button>
                    </div>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8 bg-blue-50 p-4 rounded-lg">
                    <div><span class="text-gray-500 text-xs">學生：</span><br><strong>{{ studentInfo.name }}</strong></div>
                    <div><span class="text-gray-500 text-xs">年級：</span><br><strong>{{ studentInfo.grade }}</strong></div>
                    <div><span class="text-gray-500 text-xs">轉介者：</span><br><strong>{{ studentInfo.referrer }}</strong></div>
                    <div><span class="text-gray-500 text-xs">日期：</span><br><strong>{{ studentInfo.date }}</strong></div>
                </div>

                <h3 class="font-bold mb-4 text-lg">一、懷疑障礙篩選計分</h3>
                <div class="overflow-x-auto mb-8">
                    <table class="w-full border-collapse border border-gray-300">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="border border-gray-300 p-2 text-left">懷疑障礙類別</th>
                                <th class="border border-gray-300 p-2 text-center">總分</th>
                                <th class="border border-gray-300 p-2 text-center">實得分數</th>
                                <th class="border border-gray-300 p-2 text-center">切截分數</th>
                                <th class="border border-gray-300 p-2 text-center">篩選結果</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="cat in scoringCategories" :key="cat.name">
                                <td class="border border-gray-300 p-2">{{ cat.name }}</td>
                                <td class="border border-gray-300 p-2 text-center">{{ cat.maxScore }}</td>
                                <td class="border border-gray-300 p-2 text-center font-bold" :class="{'text-red-600': resultScores[cat.key] >= cat.cutoff}">
                                    {{ resultScores[cat.key] }}
                                </td>
                                <td class="border border-gray-300 p-2 text-center">{{ cat.cutoff }}</td>
                                <td class="border border-gray-300 p-2 text-center">
                                    <span v-if="resultScores[cat.key] >= cat.cutoff" class="bg-red-100 text-red-700 px-2 py-1 rounded text-xs font-bold">高危險/懷疑</span>
                                    <span v-else class="text-gray-400 text-xs">低於門檻</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>

    </div>
            <footer class="mt-12 py-6 border-t border-gray-200 text-center text-gray-500 text-sm">
                <p>參考來源：洪儷瑜（台灣師大特教系）95,01,10</p>
            </footer>
</div>

<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script>
const { createApp, ref, reactive, computed } = Vue;

createApp({
    setup() {
        const currentSection = ref(0);
        const showResult = ref(false);
        const syncStatus = ref('idle'); // idle, loading, success, error
        const studentInfo = reactive({
            name: '', birthday: '', school: '', grade: '', referrer: '', date: new Date().toISOString().split('T')[0]
        });
        
        const answers = ref([]);
        const inputValues = reactive({});

        // --- 設定你的 Google Apps Script 網址 ---
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbzhyHgMtvWCrjrE_kavF6KoshyFe5tWfyrv8MzKQ4B2cvknHFGZbNSFWx_BDhuN2Cp6PA/exec'; 

        const sections = [
            { name: "生理方面", items: [
                { id: 1, text: "身體狀況長期不佳,常因病請假或缺課", isImportant: false },
                { id: 2, text: "由醫院診斷現罹患有慢性疾病", isImportant: false, hasInput: true, placeholder: "疾病名稱" },
                { id: 3, text: "曾罹患過重大疾病", isImportant: false, hasInput: true, placeholder: "疾病名稱及年齡" },
                { id: 4, text: "生理動作發展較一般孩子明顯的遲緩", isImportant: false },
                { id: 5, text: "體質特別差,無法在一般教室", isImportant: false, hasInput: true, placeholder: "需要哪些調整" },
                { id: 6, text: "生理狀況與一般同年齡孩子差異不大", isImportant: false }
            ]},
            { name: "感官動作方面", items: [
                { id: 7, text: "已領有身心障礙手冊", isImportant: true, hasInput: true, placeholder: "程度及類別" },
                { id: 8, text: "有嚴重視力問題", isImportant: false, hasInput: true, placeholder: "近視/遠視/其他" },
                { id: 9, text: "經常揉眼睛,看東西會瞇眼睛或貼課本太近", isImportant: false },
                { id: 10, text: "發音不清楚,或聲調不對", isImportant: true },
                { id: 11, text: "經常要別人大聲說話或重說一遍", isImportant: false },
                { id: 12, text: "經常會跌倒或碰撞東西", isImportant: false },
                { id: 13, text: "動作明顯的比一般同學慢很多", isImportant: false },
                { id: 14, text: "不大會(或很少)拿剪刀、筷子等精細動作工具", isImportant: true },
                { id: 15, text: "不大會跳繩、走平衡木、打球等體能活動", isImportant: true },
                { id: 16, text: "不太會獨立行走,需要輪椅、柺杖等輔助", isImportant: false },
                { id: 17, text: "感官動作方面的發展與一般孩子差異不大", isImportant: true }
            ]},
            { name: "學業表現方面", items: [
                { id: 18, text: "整體學業成績長期(一學年以上)為全班最後五名", isImportant: false },
                { id: 19, text: "部份科目長期(一學年以上)為全班最後五名", isImportant: true },
                { id: 20, text: "學業表現經常起伏很大", isImportant: true },
                { id: 21, text: "整體學業成績遽落", isImportant: false },
                { id: 22, text: "部份學科遽落", isImportant: false, hasInput: true, placeholder: "哪些學科" },
                { id: 23, text: "不會注音符號", isImportant: true },
                { id: 24, text: "不會認字,或認讀的字很少", isImportant: false },
                { id: 25, text: "無法讀課本或考卷說明", isImportant: false },
                { id: 26, text: "閱讀不流暢", isImportant: false },
                { id: 27, text: "無法理解課文大意或複述重點", isImportant: false },
                { id: 28, text: "會抄寫但不知字彙意義", isImportant: false },
                { id: 29, text: "寫字困難,連仿寫或抄聯絡簿有困難", isImportant: false },
                { id: 30, text: "不會寫出完整通順的句子", isImportant: true },
                { id: 31, text: "不會分類(顏色/大小/形狀)", isImportant: false },
                { id: 32, text: "不會一對一的數數", isImportant: false },
                { id: 33, text: "只能背出 20 以下的數字", isImportant: false },
                { id: 34, text: "需要手指協助運算加減", isImportant: false },
                { id: 35, text: "會加減運算,但不會解應用問題", isImportant: false },
                { id: 36, text: "會加減,但不會乘除", isImportant: false },
                { id: 37, text: "會運算但不會解應用題", isImportant: false },
                { id: 38, text: "小數、分數概念差,不會運用", isImportant: false }
            ]},
            { name: "學習能力方面", items: [
                { id: 40, text: "學習速度緩慢,明顯比一般同學差", isImportant: false },
                { id: 41, text: "記憶力差,記不住當天老师交代", isImportant: true },
                { id: 42, text: "注意力差,不易持續專心任何活動", isImportant: false },
                { id: 43, text: "組織力差,說話做事顯得凌亂", isImportant: false },
                { id: 44, text: "理解能力差,弄不清楚抽象或複雜詞彙", isImportant: false },
                { id: 45, text: "不同事物表現差異大,對某些表現特別好", isImportant: false },
                { id: 46, text: "記憶力好,尤其是對感興趣的事物", isImportant: true },
                { id: 47, text: "學習能力與一般同學差不多", isImportant: false }
            ]},
            { name: "口語能力方面", items: [
                { id: 48, text: "口語能力表達差,無法與人溝通", isImportant: false },
                { id: 49, text: "聽話理解能力差,抓不到說話重點", isImportant: true },
                { id: 50, text: "不太能和別人閒談,不太能接續話題", isImportant: false },
                { id: 51, text: "說話不清楚,一般人不易聽懂", isImportant: false },
                { id: 52, text: "不喜歡聽人講解,聽課比看書更不專心", isImportant: true },
                { id: 53, text: "經常重複簡單的詞彙或短句", isImportant: true },
                { id: 54, text: "不會主動表達自己的需求", isImportant: false },
                { id: 55, text: "口語能力與一般同學差不多", isImportant: false }
            ]},
            { name: "團體生活方面", items: [
                { id: 56, text: "上課經常會隨意離開座位或教室", isImportant: false },
                { id: 57, text: "上課經常沒有反應、呆坐或打瞌睡", isImportant: true },
                { id: 58, text: "無法參與團體活動(遊戲、比賽)", isImportant: false },
                { id: 59, text: "喜歡一個人獨處或自己玩", isImportant: false },
                { id: 60, text: "下課經常一個人,沒有人和他玩", isImportant: false },
                { id: 61, text: "上課會亂出聲、走動或作弄別人", isImportant: false },
                { id: 62, text: "愛頂嘴,公開頂撞師長的指示", isImportant: false },
                { id: 63, text: "經常不交作業、或不做掃地工作", isImportant: false },
                { id: 64, text: "會蹺課、逃家、或逃學", isImportant: false },
                { id: 65, text: "霸道,不能忍受同學的不一樣", isImportant: false },
                { id: 66, text: "班上大多數同學都討厭他,拒絕同座", isImportant: true },
                { id: 67, text: "在校相處與一般孩子差不多", isImportant: false }
            ]},
            { name: "個人生活適應方面", items: [
                { id: 68, text: "髒亂、無法維持個人衛生", isImportant: false },
                { id: 69, text: "不會自行穿脫衣服", isImportant: false },
                { id: 70, text: "不會自行上廁所,會遺尿或失禁", isImportant: false },
                { id: 71, text: "應變能力差,不會隨情境調整行為", isImportant: true },
                { id: 72, text: "動作速度跟不上團體腳步", isImportant: false },
                { id: 73, text: "不會自行由教室到廁所或校內各處", isImportant: false },
                { id: 74, text: "上課鐘響經常不會自行回教室", isImportant: false },
                { id: 75, text: "經常忘記帶文具或繳交作業", isImportant: false },
                { id: 76, text: "經常遺失個人物品,不會保管", isImportant: false },
                { id: 77, text: "在校從事活動比一般同學少很多", isImportant: true },
                { id: 78, text: "對環境不預期變化有明顯不適應", isImportant: false },
                { id: 79, text: "可以像一般孩子一樣照顧自己", isImportant: true }
            ]},
            { name: "行為情緒適應方面", items: [
                { id: 80, text: "情緒表達不適當,和情境不合", isImportant: false },
                { id: 81, text: "退縮、膽子很小", isImportant: true },
                { id: 82, text: "脾氣很大,罵人", isImportant: false },
                { id: 83, text: "經常攻擊同學或破壞物品", isImportant: false },
                { id: 84, text: "一不滿意,就會哭鬧不停", isImportant: false },
                { id: 85, text: "比一般同學更容易緊張、焦慮", isImportant: false },
                { id: 86, text: "不會保護自己,經常受欺負或佔便宜", isImportant: false },
                { id: 87, text: "行為舉止顯得比一般同學幼稚、不成熟", isImportant: false },
                { id: 88, text: "對周遭人或活動不感興趣", isImportant: false },
                { id: 89, text: "經常重複相同的動作、或發出相同聲音", isImportant: false },
                { id: 90, text: "他人受傷或生氣時,不會表現出關心", isImportant: false },
                { id: 91, text: "對人感興趣但表現很奇怪", isImportant: false },
                { id: 92, text: "行為情緒與一般同學差不多", isImportant: true }
            ]},
            { name: "家庭與社區方面", items: [
                { id: 93, text: "曾經長期居住國外或偏遠地區", isImportant: false, hasInput: true, placeholder: "國家/地區/多久" },
                { id: 94, text: "放學後沒有人可以提供課業協助", isImportant: false },
                { id: 95, text: "放學後沒有人會監控學生行動", isImportant: false },
                { id: 96, text: "長期不和父母雙親居住", isImportant: false, hasInput: true, placeholder: "監護人關係" },
                { id: 97, text: "家庭經濟清寒", isImportant: false },
                { id: 98, text: "家庭環境有不良影響(如幫派/色情)", isImportant: false },
                { id: 99, text: "父母為外籍或原住民", isImportant: false, hasInput: true, placeholder: "國籍或族別" },
                { id: 100, text: "家庭狀況與一般同學差不多", isImportant: false }
            ]}
        ];

        const scoreGroups = {
            id: { items: [7, 10, 18, 23, 24, 25, 26, 27, 28, 30, 35, 38, 40, 41, 43, 44, 49, 55, 67, 81], double: [10, 23, 30, 41, 49, 81] },
            ld: { items: [17, 18, 19, 24, 26, 28, 35, 38, 40, 44, 55, 57, 63, 67, 79, 92], double: [17, 19, 57, 79, 92] },
            ed: { items: [20, 42, 52, 60, 61, 62, 63, 65, 66, 80, 82, 83, 87, 91], double: [20, 42, 61, 62, 63, 65] },
            adhd: { items: [20, 42, 43, 60, 61, 62, 63, 75, 76, 80, 89], double: [] },
            autism: { items: [7, 14, 15, 25, 27, 42, 43, 44, 46, 52, 53, 58, 59, 60, 61, 71, 72, 77, 80, 85, 87, 88, 89, 90, 91], double: [46, 53, 58, 59, 60, 61, 71, 72, 77, 85, 88, 89, 90] }
        };

        const scoringCategories = [
            { key: 'id', name: '智能障礙', maxScore: 26, cutoff: 6 },
            { key: 'ld', name: '學習障礙', maxScore: 21, cutoff: 6 },
            { key: 'ed', name: '情緒障礙', maxScore: 20, cutoff: 4 },
            { key: 'adhd', name: 'ADHD', maxScore: 11, cutoff: 4 },
            { key: 'autism', name: '自閉症', maxScore: 38, cutoff: 6 }
        ];

        const resultScores = computed(() => {
            const scores = {};
            scoringCategories.forEach(cat => {
                let sum = 0;
                const config = scoreGroups[cat.key];
                config.items.forEach(id => {
                    if (answers.value.includes(id)) sum += config.double.includes(id) ? 2 : 1;
                });
                scores[cat.key] = sum;
            });
            return scores;
        });

        const toggleItem = (id) => {
            const idx = answers.value.indexOf(id);
            if (idx > -1) answers.value.splice(idx, 1);
            else answers.value.push(id);
        };

        const getSectionProgress = (sIndex) => {
            const ids = sections[sIndex].items.map(i => i.id);
            return answers.value.filter(id => ids.includes(id)).length;
        };

        const nextSection = (sIndex) => {
            if (sIndex === sections.length - 1) calculateResult();
            else { currentSection.value++; window.scrollTo(0, 0); }
        };

        const calculateResult = async () => {
            showResult.value = true;
            currentSection.value = -1;
            window.scrollTo(0, 0);
            await submitToGoogleSheet();
        };

        const submitToGoogleSheet = async () => {
            if (!GAS_URL || GAS_URL === 'YOUR_WEB_APP_URL') return;
            syncStatus.value = 'loading';
            const payload = {
                ...studentInfo,
                score_id: resultScores.value.id,
                score_ld: resultScores.value.ld,
                score_ed: resultScores.value.ed,
                score_adhd: resultScores.value.adhd,
                score_autism: resultScores.value.autism,
                answers: answers.value,
                inputs: inputValues
            };
            try {
                await fetch(GAS_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
                syncStatus.value = 'success';
            } catch (e) {
                syncStatus.value = 'error';
            }
        };

        return {
            currentSection, studentInfo, sections, answers, inputValues, showResult, syncStatus,
            toggleItem, getSectionProgress, nextSection, calculateResult, resultScores, scoringCategories,
            printReport: () => window.print()
        };
    }
}).mount('#app');
</script>
</body>
</html>
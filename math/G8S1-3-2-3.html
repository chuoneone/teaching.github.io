<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>十字交乘法與乘法公式</title>
    <link rel="icon" href="dog.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Chiron+GoRound+TC:wght@200..900&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: "Chiron GoRound TC", sans-serif;
            background: #f0fdf4; /* 淺綠色背景 (完全平方) */
            background-image: radial-gradient(#bbf7d0 1px, transparent 1px);
            background-size: 20px 20px;
            min-height: 100vh;
        }

        /* 題目容器 */
        .math-expression {
            font-family: "Chiron GoRound TC", monospace;
            letter-spacing: 0.05em;
        }

        /* 填空 Slot 樣式 */
        .slot {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 3.5rem;
            height: 3.5rem;
            border-bottom: 3px solid #cbd5e1;
            background-color: white;
            border-radius: 0.5rem 0.5rem 0 0;
            margin: 0.25rem;
            font-weight: bold;
            color: #334155;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.2s;
            padding: 0 0.75rem;
            vertical-align: middle;
            white-space: nowrap;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .slot:hover { border-bottom-color: #16a34a; background-color: #f0fdf4; }
        .slot.filled { border-bottom-color: #16a34a; color: #15803d; }
        .slot.correct { border-bottom-color: #22c55e; color: #15803d; background-color: #dcfce7; pointer-events: none; border-bottom-width: 4px; }
        .slot.wrong { border-bottom-color: #ef4444; color: #b91c1c; background-color: #fee2e2; animation: shake 0.4s; }

        /* 選項按鈕 */
        .option-card {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 1rem;
            padding: 0.75rem 1.5rem;
            font-size: 1.5rem;
            font-weight: bold;
            color: #475569;
            box-shadow: 0 4px 0 #cbd5e1;
            cursor: pointer;
            transition: all 0.1s;
            user-select: none;
            margin: 0.25rem;
            min-width: 4rem;
        }
        .option-card:active { transform: translateY(4px); box-shadow: none; }
        .option-card:hover { border-color: #86efac; background-color: #f0fdf4; color: #166534; }
        .option-card.used { opacity: 0.4; cursor: not-allowed; background-color: #f1f5f9; box-shadow: none; transform: translateY(4px); }

        /* 步驟區塊 */
        .step-box {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 1.5rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border-left: 6px solid #cbd5e1;
            transition: all 0.5s ease;
            opacity: 0.6;
            transform: scale(0.98);
        }
        .step-box.active { 
            border-left-color: #16a34a; 
            opacity: 1; 
            transform: scale(1); 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); 
            border: 2px solid #16a34a; /* 加強邊框 */
            border-left-width: 8px;
        }
        .step-box.done { border-left-color: #22c55e; opacity: 0.8; border: none; border-left: 6px solid #22c55e;}
        .step-box.locked { opacity: 0.4; pointer-events: none; filter: grayscale(0.8); }

        /* 平方表樣式 */
        #square-table {
            transition: transform 0.3s ease-in-out, opacity 0.3s;
            transform-origin: top right;
        }
        #square-table.hidden-custom {
            transform: scale(0);
            opacity: 0;
            pointer-events: none;
        }
        
        /* 動畫 */
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        @keyframes popIn { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

        .highlight-term { color: #d97706; font-weight: 800; } /* 橘色強調中間項 */
    </style>
</head>
<body class="flex flex-col items-center py-8 px-4 relative overflow-x-hidden">

    <!-- 右上角平方表按鈕 -->
    <div class="fixed top-4 right-4 z-50 flex flex-col items-end">
        <button onclick="toggleSquareTable()" class="bg-yellow-400 hover:bg-yellow-500 text-yellow-900 font-bold py-2 px-4 rounded-full shadow-lg flex items-center transition transform hover:scale-105 border-2 border-white">
            <i class="fas fa-calculator mr-2"></i>平方表
        </button>
        
        <div id="square-table" class="hidden-custom mt-2 bg-white/95 backdrop-blur p-4 rounded-2xl shadow-2xl border-4 border-yellow-200 w-40 text-center">
            <h3 class="font-bold text-yellow-600 mb-2 border-b border-yellow-100 pb-1">平方數速查</h3>
            <div class="space-y-1 font-mono text-slate-600 font-bold text-lg">
                <div class="flex justify-between px-2"><span>1²</span><span>=</span><span>1</span></div>
                <div class="flex justify-between px-2"><span>2²</span><span>=</span><span>4</span></div>
                <div class="flex justify-between px-2"><span>3²</span><span>=</span><span>9</span></div>
                <div class="flex justify-between px-2"><span>4²</span><span>=</span><span>16</span></div>
                <div class="flex justify-between px-2"><span>5²</span><span>=</span><span>25</span></div>
                <div class="flex justify-between px-2"><span>6²</span><span>=</span><span>36</span></div>
                <div class="flex justify-between px-2"><span>7²</span><span>=</span><span>49</span></div>
                <div class="flex justify-between px-2"><span>8²</span><span>=</span><span>64</span></div>
                <div class="flex justify-between px-2"><span>9²</span><span>=</span><span>81</span></div>
                <div class="flex justify-between px-2"><span>10²</span><span>=</span><span>100</span></div>
            </div>
            <button onclick="toggleSquareTable()" class="mt-3 text-xs text-slate-400 hover:text-slate-600 underline">關閉</button>
        </div>
    </div>

    <header class="mb-8 text-center mt-8 md:mt-0">
        <h1 class="text-3xl md:text-4xl font-bold text-slate-800 mb-2">
            <i class="fas fa-star text-yellow-400 mr-2"></i>十字交乘法與乘法公式
        </h1>
        <p class="text-slate-600 font-medium text-lg bg-green-100 inline-block px-4 py-1 rounded-full">
            <span class="font-mono">a² ± 2ab + b² = (a ± b)²</span>
        </p>
    </header>

    <!-- 進度條 -->
    <div class="w-full max-w-2xl mb-6 flex justify-between items-center text-slate-500 font-bold">
        <button id="prev-btn" class="hover:text-green-600 disabled:opacity-30 transition"><i class="fas fa-chevron-left mr-1"></i>上一題</button>
        <span id="progress-text" class="bg-white px-4 py-1 rounded-full shadow-sm border border-green-100 text-green-700">第 1 / 16 題</span>
        <button id="next-btn" class="hover:text-green-600 disabled:opacity-30 transition">下一題<i class="fas fa-chevron-right ml-1"></i></button>
    </div>

    <!-- 主要遊戲區 -->
    <main class="w-full max-w-3xl relative">
        
        <!-- 步驟一：找主角 -->
        <div id="step1-container" class="step-box active">
            <div class="flex justify-between items-start mb-4">
                <h2 class="text-xl font-bold text-slate-700 flex items-center">
                    <span class="bg-green-100 text-green-600 w-8 h-8 rounded-full flex items-center justify-center mr-2 text-sm border border-green-200">1</span>
                    第一步：找出是誰的平方？
                </h2>
                <i id="step1-icon" class="fas fa-search text-green-400 text-xl"></i>
            </div>
            
            <div class="text-center">
                <!-- 題目顯示 -->
                <div class="text-3xl md:text-5xl mb-8 math-expression text-slate-800 font-bold" id="question-display">
                    <!-- JS 填入 -->
                </div>
                
                <p class="text-slate-500 mb-2 font-medium"><i class="fas fa-comment-dots text-blue-400 mr-1"></i>觀察「頭」和「尾」，分別是誰的平方？</p>

                <div class="text-2xl md:text-3xl math-expression flex flex-wrap justify-center items-center gap-2 py-2" id="step1-slots">
                    <!-- JS 填入 -->
                </div>
            </div>
        </div>

        <!-- 步驟二：寫答案 -->
        <div id="step2-container" class="step-box locked">
            <div class="flex justify-between items-start mb-4">
                <h2 class="text-xl font-bold text-slate-700 flex items-center">
                    <span class="bg-blue-100 text-blue-600 w-8 h-8 rounded-full flex items-center justify-center mr-2 text-sm border border-blue-200">2</span>
                    第二步：寫出完全平方
                </h2>
                <i id="step2-icon" class="fas fa-lock text-slate-300 text-xl"></i>
            </div>

            <div class="text-center">
                <p class="text-slate-500 mb-4 text-lg">
                    <span class="bg-yellow-100 px-2 py-1 rounded">注意中間項符號！</span> 決定是加還是減
                </p>
                
                <!-- 預覽第一步結果 -->
                <div class="text-xl md:text-2xl mb-6 text-slate-400 font-bold math-expression bg-slate-50 p-2 rounded-lg inline-block" id="step2-preview">
                    <!-- JS 填入 -->
                </div>

                <!-- 作答區 -->
                <div class="text-3xl md:text-4xl math-expression flex flex-wrap justify-center items-center gap-2 mb-4" id="step2-slots">
                     <span class="text-slate-400 mr-2">=</span>
                     <!-- JS 填入 -->
                </div>
            </div>
        </div>

        <!-- 選項區 (Bottom Sheet) -->
        <div class="fixed bottom-0 left-0 w-full bg-white/95 backdrop-blur-md border-t-4 border-green-200 p-4 pb-8 shadow-[0_-4px_20px_rgba(0,0,0,0.15)] transition-transform duration-300 z-40 rounded-t-3xl" id="options-panel">
            <div class="max-w-4xl mx-auto">
                <div class="flex justify-between items-center mb-3 px-2">
                    <span class="text-base text-slate-600 font-bold flex items-center">
                        <i class="fas fa-hand-pointer text-green-500 mr-2"></i>請點選卡片填入空格：
                    </span>
                    <button onclick="resetCurrentStep()" class="text-sm text-orange-500 font-bold hover:text-orange-600 hover:bg-orange-50 px-3 py-1 rounded-lg transition">
                        <i class="fas fa-undo mr-1"></i>重填本步驟
                    </button>
                </div>
                <div class="flex flex-wrap justify-center gap-2 md:gap-3" id="options-container">
                    <!-- JS 生成選項 -->
                </div>
            </div>
        </div>

        <!-- 佔位符 -->
        <div class="h-64"></div>

    </main>

    <!-- 恭喜過關 Overlay -->
    <div id="success-overlay" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm hidden">
        <div class="bg-white p-8 rounded-3xl shadow-2xl flex flex-col items-center animate-[popIn_0.4s_ease-out] max-w-sm w-full mx-4 border-4 border-green-200">
            <div class="w-24 h-24 bg-green-100 rounded-full flex items-center justify-center mb-4 shadow-inner">
                <i class="fas fa-check text-5xl text-green-500"></i>
            </div>
            <h2 class="text-3xl font-bold text-slate-800 mb-2">正確！</h2>
            <p class="text-slate-500 mb-6 text-center">你掌握得很好！繼續挑戰下一題吧。</p>
            <button onclick="nextQuestion()" class="bg-green-500 hover:bg-green-600 text-white text-xl font-bold py-3 px-10 rounded-xl shadow-lg transition transform hover:scale-105 w-full">
                下一題 <i class="fas fa-arrow-right ml-2"></i>
            </button>
        </div>
    </div>

    <script>
        // --- 題庫資料 (全 16 題) ---
        const questions = [
            // a=1 的基礎題
            { a: 1, b: 4, c: 4 },      // (x+2)^2
            { a: 1, b: 16, c: 64 },    // (x+8)^2
            { a: 1, b: 18, c: 81 },    // (x+9)^2
            { a: 1, b: 20, c: 100 },   // (x+10)^2
            { a: 1, b: -4, c: 4 },     // (x-2)^2
            { a: 1, b: -6, c: 9 },     // (x-3)^2
            { a: 1, b: -12, c: 36 },   // (x-6)^2
            { a: 1, b: -14, c: 49 },   // (x-7)^2
            // a!=1 的進階題
            { a: 4, b: 4, c: 1 },      // (2x+1)^2
            { a: 4, b: 36, c: 81 },    // (2x+9)^2
            { a: 9, b: 12, c: 4 },     // (3x+2)^2
            { a: 16, b: 24, c: 9 },    // (4x+3)^2
            { a: 25, b: -40, c: 16 },  // (5x-4)^2
            { a: 4, b: -20, c: 25 },   // (2x-5)^2
            { a: 9, b: -42, c: 49 },   // (3x-7)^2
            { a: 25, b: -30, c: 9 }    // (5x-3)^2
        ];

        // 自動生成題目內容
        function processQuestions() {
            questions.forEach(q => {
                // 1. 計算平方根作為答案
                const sqrtA = Math.sqrt(q.a);
                const sqrtC = Math.sqrt(q.c);
                const sign = q.b > 0 ? '+' : '-';
                const termA = sqrtA === 1 ? 'x' : `${sqrtA}x`;
                const termC = `${sqrtC}`;
                
                // 2. 顯示字串 (HTML)
                const displayA = q.a === 1 ? '' : q.a;
                const sign1 = q.b > 0 ? '+' : '-';
                const absB = Math.abs(q.b);
                // 題目: ax^2 +/- bx + c
                q.display = `${displayA}x<sup>2</sup> ${sign1} <span class="highlight-term">${absB}x</span> + ${q.c}`;

                // 3. Step 1 Slots (找頭尾)
                // 格式: ( termA )^2 + ... + ( termC )^2
                // 中間省略 2ab 的檢查，專注於找頭尾
                q.step1 = {
                    slots: [
                        { pre: '(', post: ')<sup>2</sup>', type: 'base', ans: termA },
                        { pre: (q.b > 0 ? ' + 2 · ' : ' - 2 · '), post: '', type: 'middle', ans: termA, isReadOnly: true }, // 顯示中間項結構，但唯讀或讓學生填？
                        // 為了簡化，我們 Step 1 只要填頭尾
                        // UI: ( [ ] )² +/- 2([ ])([ ]) + ( [ ] )²
                        // Let's simplify: Just identify squares.
                    ],
                    options: generateOptions(termA, termC)
                };
                
                // 重新定義 Step 1 結構為簡潔版： ( A )² ... ( B )²
                // 為了讓學生意識到中間項，我們可以顯示成： ( A )² +/- 2(A)(B) + ( B )²
                // 但為了好操作，我們先只讓學生填 A 和 B
                const midSign = q.b > 0 ? '+' : '-';
                q.step1.slots = [
                    { pre: '(', post: ')<sup>2</sup>', ans: termA },
                    { pre: ` ${midSign} 2 ( ... ) + (`, post: ')<sup>2</sup>', ans: termC }
                ];

                // 4. Step 2 Slots (寫答案)
                // 格式: ( termA op termC )^2
                q.step2 = {
                    slots: [
                        { pre: '(', post: '', ans: termA },
                        { pre: '', post: '', ans: sign, isOp: true },
                        { pre: '', post: ')<sup>2</sup>', ans: termC }
                    ],
                    options: [termA, termC, '+', '-', ...generateDistractors(termA, termC)]
                };
            });
        }

        function generateOptions(a, c) {
            let opts = [a, c];
            // 產生干擾項
            // 如果 a=2x, c=1 -> 干擾: 4x, 1, 2, x
            // 如果 a=x, c=4 -> 干擾: x, 2, 16, 8
            
            // 簡單邏輯：如果是 x，加個係數；如果是數字，加平方或兩倍
            let numC = parseInt(c);
            if(!isNaN(numC)) {
                opts.push((numC*numC).toString()); // 平方
                opts.push((numC*2).toString()); // 兩倍
            }
            
            // 針對 x 項
            let coeffA = parseInt(a.replace('x', '')) || 1;
            if (coeffA !== 1) {
                opts.push(`${coeffA*coeffA}x`); // 係數平方
                opts.push(`x`);
            } else {
                opts.push(`2x`);
            }
            
            // 去重
            return [...new Set(opts)];
        }

        function generateDistractors(a, c) {
            return generateOptions(a, c).filter(o => o!==a && o!==c);
        }

        processQuestions();

        // --- 遊戲邏輯 ---
        let currentQIdx = 0;
        let currentStep = 1;
        let filledSlots = {};

        // Elements
        const qDisplay = document.getElementById('question-display');
        const step1Box = document.getElementById('step1-container');
        const step1SlotsDiv = document.getElementById('step1-slots');
        const step2Box = document.getElementById('step2-container');
        const step2Preview = document.getElementById('step2-preview');
        const step2SlotsDiv = document.getElementById('step2-slots');
        const optionsContainer = document.getElementById('options-container');
        const progressText = document.getElementById('progress-text');
        const successOverlay = document.getElementById('success-overlay');
        const squareTable = document.getElementById('square-table');

        function toggleSquareTable() {
            squareTable.classList.toggle('hidden-custom');
        }

        function initGame() {
            loadQuestion(0);
            document.getElementById('prev-btn').onclick = () => {
                if(currentQIdx > 0) loadQuestion(currentQIdx - 1);
            };
            document.getElementById('next-btn').onclick = () => {
                if(currentQIdx < questions.length - 1) loadQuestion(currentQIdx + 1);
            };
        }

        function loadQuestion(idx) {
            currentQIdx = idx;
            currentStep = 1;
            filledSlots = {};
            
            progressText.innerText = `第 ${idx + 1} / ${questions.length} 題`;
            document.getElementById('prev-btn').disabled = idx === 0;
            document.getElementById('next-btn').disabled = idx === questions.length - 1;
            
            const q = questions[idx];
            qDisplay.innerHTML = q.display;

            // Reset UI
            step1Box.classList.remove('done', 'locked');
            step1Box.classList.add('active');
            document.getElementById('step1-icon').className = 'fas fa-search text-green-400 text-xl';
            
            step2Box.classList.remove('active', 'done');
            step2Box.classList.add('locked');
            document.getElementById('step2-icon').className = 'fas fa-lock text-slate-300 text-xl';
            step2Preview.innerHTML = '';

            renderStep1();
        }

        function renderStep1() {
            const q = questions[currentQIdx];
            step1SlotsDiv.innerHTML = '';
            
            q.step1.slots.forEach((slotData, i) => {
                if(slotData.pre) appendText(step1SlotsDiv, slotData.pre);
                
                const el = document.createElement('div');
                el.className = 'slot';
                el.dataset.idx = i;
                el.onclick = () => removeSlotValue(i);
                step1SlotsDiv.appendChild(el);
                
                if(slotData.post) appendText(step1SlotsDiv, slotData.post);
            });

            renderOptions(q.step1.options);
        }

        function renderStep2() {
            const q = questions[currentQIdx];
            step2SlotsDiv.innerHTML = '';
            
            // Preview Step 1: 顯示剛填好的 ( A )² ... ( B )²
            // 簡單顯示 A 和 B 即可
            const valA = filledSlots[0] || q.step1.slots[0].ans;
            const valB = filledSlots[1] || q.step1.slots[1].ans;
            const midSign = q.b > 0 ? '+' : '-';
            
            // 顯示完整分解式預覽
            step2Preview.innerHTML = `( ${valA} )² ${midSign} 2(${valA})(${valB}) + ( ${valB} )²`;

            filledSlots = {}; // 清空給 Step 2 用

            q.step2.slots.forEach((slotData, i) => {
                if(slotData.pre) appendText(step2SlotsDiv, slotData.pre);
                
                const el = document.createElement('div');
                el.className = 'slot';
                if(slotData.isOp) el.classList.add('bg-blue-50', 'border-blue-200'); // 特殊顏色給符號格
                el.dataset.idx = i;
                el.onclick = () => removeSlotValue(i);
                step2SlotsDiv.appendChild(el);
                
                if(slotData.post) appendText(step2SlotsDiv, slotData.post);
            });

            renderOptions(q.step2.options);
        }

        function appendText(container, html) {
            const sp = document.createElement('span');
            sp.className = 'text-slate-400 font-bold mx-1 text-lg md:text-xl';
            sp.innerHTML = html;
            container.appendChild(sp);
        }

        function renderOptions(opts) {
            optionsContainer.innerHTML = '';
            // 混合排序，但 + - 符號通常放前面比較好找，或者隨機
            const shuffled = [...opts].sort(() => Math.random() - 0.5);
            shuffled.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'option-card';
                btn.innerText = opt;
                // 如果是符號，給予特殊樣式
                if(opt === '+' || opt === '-') {
                     btn.classList.add('text-blue-500', 'border-blue-300', 'bg-blue-50');
                }
                btn.onclick = () => handleOptionClick(opt);
                optionsContainer.appendChild(btn);
            });
        }

        function handleOptionClick(val) {
            const container = currentStep === 1 ? step1SlotsDiv : step2SlotsDiv;
            // 找到第一個空格
            const emptySlot = Array.from(container.querySelectorAll('.slot')).find(el => !el.innerText);
            
            if (emptySlot) {
                // 播放點擊音效 (模擬)
                const idx = emptySlot.dataset.idx;
                filledSlots[idx] = val;
                emptySlot.innerText = val;
                emptySlot.classList.add('filled');
                
                // Check full
                const allSlots = container.querySelectorAll('.slot');
                const isFull = Array.from(allSlots).every(el => el.innerText);
                if (isFull) checkAnswer();
            }
        }

        function removeSlotValue(idx) {
            const container = currentStep === 1 ? step1SlotsDiv : step2SlotsDiv;
            const slot = container.querySelector(`.slot[data-idx="${idx}"]`);
            if (slot && !slot.classList.contains('correct')) {
                delete filledSlots[idx];
                slot.innerText = '';
                slot.classList.remove('filled', 'wrong');
            }
        }

        function resetCurrentStep() {
            filledSlots = {};
            if (currentStep === 1) renderStep1();
            else renderStep2();
        }

        function checkAnswer() {
            const q = questions[currentQIdx];
            const targetSlots = currentStep === 1 ? q.step1.slots : q.step2.slots;
            const container = currentStep === 1 ? step1SlotsDiv : step2SlotsDiv;
            const uiSlots = container.querySelectorAll('.slot');
            
            let allCorrect = true;
            
            uiSlots.forEach((slot, i) => {
                if(slot.innerText === targetSlots[i].ans) {
                    slot.classList.add('correct');
                    slot.classList.remove('filled');
                } else {
                    slot.classList.add('wrong');
                    allCorrect = false;
                }
            });

            if (allCorrect) {
                if (currentStep === 1) {
                    setTimeout(() => {
                        step1Box.classList.remove('active');
                        step1Box.classList.add('done');
                        document.getElementById('step1-icon').className = 'fas fa-check-circle text-green-500 text-xl';
                        
                        step2Box.classList.remove('locked');
                        step2Box.classList.add('active');
                        document.getElementById('step2-icon').className = 'fas fa-pen text-blue-400 text-xl';
                        
                        currentStep = 2;
                        renderStep2();
                        step2Box.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 600);
                } else {
                    setTimeout(() => {
                        successOverlay.classList.remove('hidden');
                    }, 400);
                }
            } else {
                setTimeout(() => {
                    uiSlots.forEach(slot => {
                        if (slot.classList.contains('wrong')) {
                            slot.classList.remove('wrong');
                            slot.innerText = '';
                            delete filledSlots[slot.dataset.idx];
                        }
                    });
                }, 800);
            }
        }

        function nextQuestion() {
            successOverlay.classList.add('hidden');
            if (currentQIdx < questions.length - 1) {
                loadQuestion(currentQIdx + 1);
            } else {
                alert("恭喜你！全部挑戰完成！");
                // 可以重置或導向
            }
        }

        initGame();

    </script>
</body>
</html>
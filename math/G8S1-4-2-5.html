<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>互動式數學-公式解填空</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* --- 數學式專用 CSS --- */
        .math-text { 
            font-family: 'Courier New', Courier, monospace; 
            font-weight: 700; 
            display: inline-flex;
            align-items: center;
        }
        .fraction { 
            display: inline-flex; 
            flex-direction: column; 
            align-items: center; 
            vertical-align: middle; 
            margin: 0 4px;
        }
        .fraction-top { 
            border-bottom: 2px solid #000; 
            padding: 2px 5px; 
            width: 100%; 
            text-align: center; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 2px;
        }
        .fraction-bottom { 
            padding-top: 2px; 
            width: 100%; 
            text-align: center; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 2px;
        }
        .sqrt-container { 
            display: inline-flex; 
            align-items: center; 
        }
        .sqrt-symbol { 
            font-size: 1.4em; 
            margin-right: -2px; 
            transform: scaleY(1.2); 
            line-height: 1;
        }
        .sqrt-content { 
            border-top: 2px solid #000; 
            padding-top: 4px; 
            display: inline-flex; 
            align-items: center; 
            gap: 2px;
        }
        .power { 
            font-size: 0.7em; 
            vertical-align: top; 
            position: relative;
            top: -0.4em; 
            margin-left: 1px; 
            color: #000;
        }

        /* --- 互動元件 CSS --- */
        .slot {
            width: 56px; 
            height: 48px;
            border: 3px dashed #cbd5e1;
            border-radius: 8px;
            display: inline-flex; 
            justify-content: center; 
            align-items: center;
            font-size: 1.4rem; 
            font-weight: bold; 
            color: #334155;
            background-color: white;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); /* 平滑過渡 */
            user-select: none;
            margin: 0 2px;
            white-space: nowrap;
            padding: 0 4px;
        }
        @media (max-width: 768px) {
            .slot { width: 48px; height: 42px; font-size: 1.1rem; border-width: 2px; }
        }
        .slot.filled { border-style: solid; background-color: #f0f9ff; }
        .slot.completed {
            border-color: #22c55e !important;
            color: #15803d !important;
            background-color: #dcfce7 !important;
            cursor: default;
        }
        .slot:hover:not(.filled):not(.completed) { 
            border-color: #94a3b8; background-color: #f8fafc; 
        }

        /* 當前填寫目標的高亮特效：改為單純微放大 */
        .active-slot {
            transform: scale(1.2); /* 放大 1.2 倍 */
            z-index: 20; /* 確保浮在最上層 */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* 增加陰影凸顯層次 */
            background-color: white;
        }
        
        .slot-red { border-color: #fca5a5; color: #ef4444; }
        .slot-blue { border-color: #93c5fd; color: #3b82f6; }
        .slot-black { border-color: #94a3b8; color: #1f2937; }
        .slot-green { border-color: #86efac; color: #16a34a; }
        
        .option-btn {
            min-width: 56px; 
            height: 56px;
            padding: 0 12px;
            border-radius: 12px;
            background-color: white;
            box-shadow: 0 4px 0px 0px #cbd5e1;
            border: 2px solid #e2e8f0;
            font-size: 1.5rem; 
            font-weight: bold;
            color: #334155;
            display: flex; 
            justify-content: center; 
            align-items: center;
            cursor: pointer;
            transition: all 0.1s;
            touch-action: manipulation;
            position: relative;
            top: 0;
        }
        .option-btn:active { top: 4px; box-shadow: 0 0px 0px 0px #cbd5e1; }
        .option-btn.used {
            opacity: 0.3; cursor: not-allowed; top: 4px; 
            box-shadow: none; background-color: #f1f5f9; pointer-events: none;
        }

        /* 按鈕顏色類別 */
        .btn-red { color: #ef4444; border-color: #fca5a5; background-color: #fef2f2; }
        .btn-blue { color: #3b82f6; border-color: #93c5fd; background-color: #eff6ff; }
        .btn-black { color: #1f2937; border-color: #cbd5e1; background-color: #f8fafc; }
        .btn-green { color: #16a34a; border-color: #86efac; background-color: #f0fdf4; }

        .step-card {
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out, filter 0.5s;
            opacity: 0.4; pointer-events: none; filter: blur(2px); transform: translateY(20px);
        }
        .step-card.active {
            opacity: 1; pointer-events: auto; filter: blur(0); transform: translateY(0);
        }
        .step-card.completed-step {
            opacity: 1; pointer-events: auto; border-color: #86efac;
        }

        @keyframes tada {
            0% { transform: scale(1); }
            10%, 20% { transform: scale(0.9) rotate(-3deg); }
            30%, 50%, 70%, 90% { transform: scale(1.1) rotate(3deg); }
            40%, 60%, 80% { transform: scale(1.1) rotate(-3deg); }
            100% { transform: scale(1) rotate(0); }
        }
        .animate-tada { animation: tada 1s; }

        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .text-c-red { color: #ef4444; }
        .text-c-blue { color: #2563eb; }
        .text-c-black { color: #1f2937; }
        .text-c-green { color: #16a34a; }
        
        .nav-btn.active {
            background-color: #e0e7ff; color: #4338ca; ring: 2px solid #6366f1; font-weight: bold;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen overflow-hidden flex flex-col font-sans select-none">

    <!-- 導覽列 -->
    <nav class="bg-white border-b border-slate-200 shadow-sm z-30 flex-none h-14 md:h-16 flex items-center px-4">
        <div class="flex items-center gap-4 w-full overflow-x-auto hide-scrollbar" id="nav-container">
            <div class="font-bold text-lg text-slate-700 whitespace-nowrap border-r border-slate-200 pr-4 flex items-center gap-2">
                <span class="bg-indigo-600 text-white text-xs px-2 py-1 rounded">單元 3-1</span>
                <span>公式解</span>
            </div>
        </div>
    </nav>

    <!-- 主畫面 -->
    <main class="flex-1 flex flex-col md:flex-row overflow-hidden relative">
        
        <!-- 左側：題目區 -->
        <section class="md:w-5/12 lg:w-1/3 bg-white border-b md:border-b-0 md:border-r border-slate-200 p-4 md:p-8 flex flex-col items-center justify-start md:justify-center shadow-[0_4px_6px_-1px_rgba(0,0,0,0.05)] z-20 shrink-0">
            <div class="sticky top-0 w-full flex flex-col items-center gap-4 md:gap-8 overflow-hidden">
                <span class="bg-amber-100 text-amber-800 px-3 py-1 rounded-full text-xs md:text-sm font-bold tracking-wider flex-none">觀察方程式</span>
                
                <div id="equation-display" class="math-text text-4xl md:text-5xl lg:text-6xl flex justify-center items-center py-4 min-h-[80px] w-full px-1 overflow-hidden">
                    <!-- JS 注入 -->
                </div>

                <div class="text-slate-500 text-sm md:text-base text-center bg-slate-50 p-3 rounded-lg border border-slate-100 w-full max-w-xs flex-none">
                    <p class="mb-1">目標：計算每一步驟的數值</p>
                </div>
            </div>
        </section>

        <!-- 右側：步驟流程區 -->
        <section class="md:w-7/12 lg:w-2/3 bg-slate-50/50 p-4 md:p-8 overflow-y-auto scroll-smooth pb-40" id="steps-container">
            
            <!-- Step 1: 係數對應 -->
            <div id="step-1" class="step-card active bg-white rounded-2xl shadow-sm border border-slate-200 p-4 md:p-6 mb-6 max-w-2xl mx-auto">
                <header class="flex justify-between items-center mb-6 pb-2 border-b border-slate-100">
                    <h3 class="text-lg md:text-xl font-bold text-slate-700 flex items-center gap-2">
                        <span class="bg-slate-700 text-white w-7 h-7 rounded-full flex items-center justify-center text-sm font-bold">1</span>
                        找出係數 a, b, c
                    </h3>
                    <div class="step-check hidden text-green-500 flex items-center gap-1 font-bold">
                        <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                        完成
                    </div>
                </header>

                <div class="step-content flex flex-col items-center gap-6">
                    <div class="flex flex-wrap justify-center gap-4 md:gap-8 text-2xl font-bold math-text">
                        <div class="flex items-center gap-2 bg-red-50 p-2 rounded-lg border border-red-100">
                            <span class="text-c-red italic">a</span> = <div id="s1-slot-a" class="slot slot-red" data-fill-order="1"></div>
                        </div>
                        <div class="flex items-center gap-2 bg-blue-50 p-2 rounded-lg border border-blue-100">
                            <span class="text-c-blue italic">b</span> = <div id="s1-slot-b" class="slot slot-blue" data-fill-order="2"></div>
                        </div>
                        <div class="flex items-center gap-2 bg-gray-50 p-2 rounded-lg border border-gray-200">
                            <span class="text-c-black italic">c</span> = <div id="s1-slot-c" class="slot slot-black" data-fill-order="3"></div>
                        </div>
                    </div>
                    
                    <div class="controls w-full flex flex-col items-center gap-4">
                        <div id="s1-options" class="options-area flex gap-4 mt-2"></div>
                        <button class="check-btn bg-indigo-600 hover:bg-indigo-700 text-white px-8 py-3 rounded-xl font-bold shadow-lg shadow-indigo-200 active:scale-95 transition-all text-lg">檢查答案</button>
                        <div class="feedback-msg h-6 text-base font-bold text-center"></div>
                    </div>
                </div>
            </div>

            <!-- Step 2: 代入公式 -->
            <div id="step-2" class="step-card bg-white rounded-2xl shadow-sm border border-slate-200 p-4 md:p-6 mb-6 max-w-2xl mx-auto">
                <header class="flex justify-between items-center mb-6 pb-2 border-b border-slate-100">
                    <h3 class="text-lg md:text-xl font-bold text-slate-700 flex items-center gap-2">
                        <span class="bg-slate-700 text-white w-7 h-7 rounded-full flex items-center justify-center text-sm font-bold">2</span>
                        將數字填入公式
                    </h3>
                    <div class="step-check hidden text-green-500 flex items-center gap-1 font-bold">
                        <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                        完成
                    </div>
                </header>

                <div class="step-content flex flex-col items-center gap-6">
                    <div class="math-text text-2xl md:text-4xl flex items-center bg-slate-50 p-4 rounded-xl border border-slate-100 w-full overflow-x-auto justify-center">
                        <span class="mr-2 italic">x = </span>
                        <div class="fraction">
                            <div class="fraction-top">
                                <span>-</span>
                                <div id="s2-slot-b1" class="slot slot-blue" data-fill-order="2"></div> 
                                <span class="mx-1">±</span>
                                <div class="sqrt-container">
                                    <span class="sqrt-symbol">√</span>
                                    <div class="sqrt-content">
                                        <div id="s2-slot-b2" class="slot slot-blue" data-fill-order="3"></div>
                                        <span class="power">2</span>
                                        <span class="mx-1">-</span>
                                        <span>4</span>
                                        <div id="s2-slot-a1" class="slot slot-red" data-fill-order="4"></div>
                                        <div id="s2-slot-c1" class="slot slot-black" data-fill-order="5"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="fraction-bottom">
                                <span>2</span>
                                <div id="s2-slot-a2" class="slot slot-red" data-fill-order="1"></div>
                            </div>
                        </div>
                    </div>

                    <div class="controls w-full flex flex-col items-center gap-4">
                        <div id="s2-options" class="options-area flex flex-wrap justify-center gap-3 mt-2"></div>
                        <button class="check-btn bg-indigo-600 hover:bg-indigo-700 text-white px-8 py-3 rounded-xl font-bold shadow-lg shadow-indigo-200 active:scale-95 transition-all text-lg">檢查答案</button>
                        <div class="feedback-msg h-6 text-base font-bold text-center"></div>
                    </div>
                </div>
            </div>

            <!-- Step 3: 計算數值 -->
            <div id="step-3" class="step-card bg-white rounded-2xl shadow-sm border border-slate-200 p-4 md:p-6 mb-6 max-w-2xl mx-auto">
                <header class="flex justify-between items-center mb-6 pb-2 border-b border-slate-100">
                    <h3 class="text-lg md:text-xl font-bold text-slate-700 flex items-center gap-2">
                        <span class="bg-slate-700 text-white w-7 h-7 rounded-full flex items-center justify-center text-sm font-bold">3</span>
                        計算數值
                    </h3>
                    <div class="step-check hidden text-green-500 flex items-center gap-1 font-bold">
                        <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                        完成
                    </div>
                </header>

                <div class="step-content flex flex-col items-center gap-6">
                    <!-- JS 動態生成算式結構 -->
                    <div id="s3-equation" class="math-text text-2xl md:text-4xl flex items-center bg-slate-50 p-4 rounded-xl border border-slate-100 w-full overflow-x-auto justify-center">
                    </div>

                    <div class="controls w-full flex flex-col items-center gap-4">
                        <div id="s3-options" class="options-area flex flex-wrap justify-center gap-3 mt-2"></div>
                        <button class="check-btn bg-indigo-600 hover:bg-indigo-700 text-white px-8 py-3 rounded-xl font-bold shadow-lg shadow-indigo-200 active:scale-95 transition-all text-lg">檢查答案</button>
                        <div class="feedback-msg h-6 text-base font-bold text-center"></div>
                    </div>
                </div>
            </div>

            <!-- Step 4: 最終化簡 -->
            <div id="step-4" class="step-card bg-white rounded-2xl shadow-sm border border-slate-200 p-4 md:p-6 mb-32 max-w-2xl mx-auto">
                <header class="flex justify-between items-center mb-6 pb-2 border-b border-slate-100">
                    <h3 class="text-lg md:text-xl font-bold text-slate-700 flex items-center gap-2">
                        <span class="bg-slate-700 text-white w-7 h-7 rounded-full flex items-center justify-center text-sm font-bold">4</span>
                        計算根號內的值
                    </h3>
                    <div class="step-check hidden text-green-500 flex items-center gap-1 font-bold">
                        <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                        完成
                    </div>
                </header>

                <div class="step-content flex flex-col items-center gap-6">
                    <div id="s4-equation" class="math-text text-2xl md:text-4xl flex items-center bg-slate-50 p-4 rounded-xl border border-slate-100 w-full overflow-x-auto justify-center">
                    </div>

                    <div class="controls w-full flex flex-col items-center gap-4">
                        <div id="s4-options" class="options-area flex flex-wrap justify-center gap-3 mt-2"></div>
                        <button class="check-btn bg-indigo-600 hover:bg-indigo-700 text-white px-8 py-3 rounded-xl font-bold shadow-lg shadow-indigo-200 active:scale-95 transition-all text-lg">檢查答案</button>
                        <div class="feedback-msg h-6 text-base font-bold text-center"></div>
                    </div>
                </div>
            </div>

        </section>
    </main>

    <!-- 完成視窗 (Modal) -->
    <div id="completion-modal" class="fixed inset-0 bg-slate-900/60 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm transition-opacity duration-300 opacity-0">
        <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-sm w-full transform scale-95 transition-all duration-300 relative overflow-hidden text-center">
            <div class="absolute top-0 left-0 w-full h-3 bg-gradient-to-r from-green-400 to-emerald-600"></div>
            <div class="mb-4 inline-flex p-4 rounded-full bg-green-100 text-green-600 animate-tada mt-4">
                <svg class="w-16 h-16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
            </div>
            <h2 class="text-3xl font-extrabold text-slate-800 mb-2">太棒了！</h2>
            <p class="text-slate-500 mb-8 font-medium">你已經成功完成所有計算步驟！</p>
            <div class="flex flex-col gap-3">
                <button onclick="resetProblem()" class="w-full py-3.5 bg-indigo-600 text-white rounded-xl font-bold text-lg hover:bg-indigo-700 hover:shadow-lg transition active:scale-95">再做一次</button>
                <button onclick="closeModalOnly()" class="w-full py-3.5 bg-white text-slate-500 border-2 border-slate-200 rounded-xl font-bold text-lg hover:bg-slate-50 transition active:scale-95">關閉視窗</button>
            </div>
        </div>
    </div>

    <script>
        const problems = [
            { id: 0, a: 3, b: 5, c: 1, text: "3x² + 5x + 1" },
            { id: 1, a: 5, b: 7, c: 2, text: "5x² + 7x + 2" },
            { id: 2, a: 3, b: -8, c: 2, text: "3x² - 8x + 2" },
            { id: 3, a: 2, b: -11, c: 8, text: "2x² - 11x + 8" },
            { id: 4, a: 3, b: -5, c: 1, text: "3x² - 5x + 1" },
            { id: 5, a: 1, b: 5, c: 5, text: "x² + 5x + 5" },
            { id: 6, a: 5, b: 7, c: 2, text: "5x² + 7x + 2" },
            { id: 7, a: 4, b: -9, c: 3, text: "4x² - 9x + 3" },
            { id: 8, a: 9, b: -10, c: 2, text: "9x² - 10x + 2" },
            { id: 9, a: 1, b: -9, c: 16, text: "x² - 9x + 16" },
            { id: 10, a: 3, b: -8, c: -2, text: "3x² - 8x - 2" },
            { id: 11, a: -5, b: -4, c: -6, text: "-5x² - 4x - 6" },
            { id: 12, a: -2, b: -11, c: -8, text: "-2x² - 11x - 8" }
        ];

        let currentProblemIndex = 0;
        let stepStatus = { 1: false, 2: false, 3: false, 4: false };

        document.addEventListener('DOMContentLoaded', () => {
            renderNav();
            loadProblem(0);
            window.addEventListener('resize', fitEquation);
        });

        function renderNav() {
            const navContainer = document.getElementById('nav-container');
            const titleEl = navContainer.firstElementChild;
            navContainer.innerHTML = '';
            navContainer.appendChild(titleEl);
            problems.forEach((p, idx) => {
                const btn = document.createElement('button');
                btn.className = `nav-btn whitespace-nowrap px-4 py-1.5 rounded-full font-bold transition text-sm md:text-base ring-offset-1 hover:bg-indigo-50`;
                btn.textContent = `題目 ${idx + 1}`;
                btn.onclick = () => switchProblem(idx);
                btn.id = `nav-btn-${idx}`;
                navContainer.appendChild(btn);
            });
        }

        function updateNavActive(idx) {
            document.querySelectorAll('.nav-btn').forEach(b => {
                b.classList.remove('active', 'ring-2', 'bg-indigo-100', 'text-indigo-700');
                b.classList.add('text-slate-500');
            });
            const activeBtn = document.getElementById(`nav-btn-${idx}`);
            if(activeBtn) {
                activeBtn.classList.add('active', 'bg-indigo-100', 'text-indigo-700');
                activeBtn.classList.remove('text-slate-500');
                activeBtn.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
            }
        }

        function fitEquation() {
            const container = document.getElementById('equation-display');
            const content = document.getElementById('math-scaler');
            if (!container || !content) return;
            content.style.transform = 'scale(1)';
            const containerWidth = container.clientWidth;
            const contentWidth = content.scrollWidth;
            let scale = 1;
            if (contentWidth > containerWidth) {
                scale = containerWidth / (contentWidth + 10);
            }
            content.style.transform = `scale(${scale})`;
        }

        function loadProblem(index) {
            currentProblemIndex = index;
            updateNavActive(index);
            const p = problems[index];
            const eqDisplay = document.getElementById('equation-display');

            // --- 計算中間值 ---
            const val_neg_b = -p.b;
            const val_b_sq = p.b * p.b;
            const val_4ac_raw = 4 * p.a * p.c; // 原始值
            const val_4ac_abs = Math.abs(val_4ac_raw); // 顯示用的正數
            const val_2a = 2 * p.a;
            const val_D = val_b_sq - val_4ac_raw;

            // --- 生成方程式 HTML ---
            let aHtml, bHtml, cHtml;
            if (p.a === 1) aHtml = `<div class="flex items-center shrink-0"><span class="text-c-red font-black hidden">1</span><span>x</span><span class="power">2</span></div>`;
            else if (p.a === -1) aHtml = `<div class="flex items-center shrink-0"><span class="text-c-red font-black mr-0.5">-</span><span class="text-c-red font-black hidden">1</span><span>x</span><span class="power">2</span></div>`;
            else aHtml = `<div class="flex items-center shrink-0"><span class="text-c-red font-black">${p.a}</span><span>x</span><span class="power">2</span></div>`;
            
            if (p.b < 0) bHtml = `<span class="text-c-blue font-black mx-1 shrink-0">-</span><div class="flex items-center shrink-0"><span class="text-c-blue font-black">${Math.abs(p.b)}</span><span>x</span></div>`;
            else bHtml = `<span class="text-c-blue font-black mx-1 shrink-0">+</span><div class="flex items-center shrink-0"><span class="text-c-blue font-black">${p.b}</span><span>x</span></div>`;

            if (p.c < 0) cHtml = `<span class="text-slate-400 mx-1 shrink-0">-</span><div class="flex items-center shrink-0"><span class="text-c-black font-black">${Math.abs(p.c)}</span></div>`;
            else cHtml = `<span class="text-slate-400 mx-1 shrink-0">+</span><div class="flex items-center shrink-0"><span class="text-c-black font-black">${p.c}</span></div>`;

            eqDisplay.innerHTML = `<div id="math-scaler" class="flex items-center justify-center whitespace-nowrap transition-transform duration-200 origin-center">${aHtml}${bHtml}${cHtml}<span class="text-slate-400 mx-2 shrink-0">=</span><span class="shrink-0">0</span></div>`;
            setTimeout(fitEquation, 0);

            // --- Step 1 & 2 Ans ---
            document.getElementById('s1-slot-a').dataset.ans = p.a;
            document.getElementById('s1-slot-b').dataset.ans = p.b;
            document.getElementById('s1-slot-c').dataset.ans = p.c;
            
            document.getElementById('s2-slot-a1').dataset.ans = p.a;
            document.getElementById('s2-slot-a2').dataset.ans = p.a;
            document.getElementById('s2-slot-b1').dataset.ans = p.b;
            document.getElementById('s2-slot-b2').dataset.ans = p.b;
            document.getElementById('s2-slot-c1').dataset.ans = p.c;

            // --- Step 3 Template (動態生成) ---
            const s3Eq = document.getElementById('s3-equation');
            let operatorHtml = '';
            let slot3Ans = '';
            
            // 判斷 4ac 正負號
            if (val_4ac_raw < 0) {
                operatorHtml = `<span class="mx-1">+</span>`;
                slot3Ans = val_4ac_abs;
            } else {
                operatorHtml = `<span class="mx-1">-</span>`;
                slot3Ans = val_4ac_abs;
            }

            // Step 3 順序：2a(分母) -> -b(分子左) -> b^2(根號左) -> 4ac(根號右)
            s3Eq.innerHTML = `
                <span class="mr-2 italic">x = </span>
                <div class="fraction">
                    <div class="fraction-top">
                        <div id="s3-slot-nb" class="slot slot-blue" data-ans="${val_neg_b}" data-fill-order="2"></div>
                        <span class="mx-1">±</span>
                        <div class="sqrt-container">
                            <span class="sqrt-symbol">√</span>
                            <div class="sqrt-content">
                                <div id="s3-slot-bsq" class="slot slot-blue" data-ans="${val_b_sq}" data-fill-order="3"></div>
                                ${operatorHtml}
                                <div id="s3-slot-4ac" class="slot slot-black" data-ans="${slot3Ans}" data-fill-order="4"></div>
                            </div>
                        </div>
                    </div>
                    <div class="fraction-bottom">
                        <div id="s3-slot-2a" class="slot slot-red" data-ans="${val_2a}" data-fill-order="1"></div>
                    </div>
                </div>
            `;

            // --- Step 4 Template ---
            const s4Eq = document.getElementById('s4-equation');
            s4Eq.innerHTML = `
                <span class="mr-2 italic">x = </span>
                <div class="fraction">
                    <div class="fraction-top">
                        <span class="text-c-blue font-bold text-xl">${val_neg_b}</span>
                        <span class="mx-1">±</span>
                        <div class="sqrt-container">
                            <span class="sqrt-symbol">√</span>
                            <div class="sqrt-content">
                                <div id="s4-slot-D" class="slot slot-green" data-ans="${val_D}" data-fill-order="1"></div>
                            </div>
                        </div>
                    </div>
                    <div class="fraction-bottom">
                        <span class="text-c-red font-bold text-xl">${val_2a}</span>
                    </div>
                </div>
            `;

            // --- 生成選項 ---
            // Step 1: 單純係數
            renderOptions('s1-options', [p.a, p.b, p.c], 'text-lg', p);
            
            // Step 2: 係數組合
            const s2Pool = [p.b, p.b, p.a, p.a, p.c]; 
            renderOptions('s2-options', s2Pool.sort((a,b)=>a-b), 'text-xl', p);
            
            // Step 3: 計算值 (帶顏色提示)
            // -b (Blue), b^2 (Blue), 4ac (Black), 2a (Red)
            const s3Pool = [
                { val: val_neg_b, type: 'btn-blue' },
                { val: val_b_sq, type: 'btn-blue' },
                { val: val_4ac_abs, type: 'btn-black' },
                { val: val_2a, type: 'btn-red' }
            ];
            // 排序讓數字小的在前，方便尋找
            s3Pool.sort((a, b) => a.val - b.val);
            renderOptionsWithColor('s3-options', s3Pool, 'text-xl');

            // Step 4: 最終值 (Green)
            const s4Pool = [
                { val: val_D, type: 'btn-green' }
            ];
            renderOptionsWithColor('s4-options', s4Pool, 'text-xl');

            resetUI();
        }

        function renderOptions(containerId, values, textSizeClass, p) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            values.forEach(val => {
                const btn = document.createElement('button');
                let colorClass = 'text-slate-700 border-slate-200';
                // Step 1 & 2 的顏色推斷邏輯
                if (val === p.a) colorClass = 'text-c-red border-red-200 bg-red-50/50';
                else if (val === p.b) colorClass = 'text-c-blue border-blue-200 bg-blue-50/50';
                else if (val === p.c) colorClass = 'text-c-black border-slate-200 bg-slate-50/50';
                
                btn.className = `option-btn ${colorClass} ${textSizeClass}`;
                btn.dataset.val = val;
                btn.textContent = val;
                container.appendChild(btn);
            });
        }

        function renderOptionsWithColor(containerId, items, textSizeClass) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            items.forEach(item => {
                const btn = document.createElement('button');
                // 使用明確指定的顏色 class
                btn.className = `option-btn ${item.type} ${textSizeClass}`;
                btn.dataset.val = item.val;
                btn.textContent = item.val;
                container.appendChild(btn);
            });
        }

        function resetUI() {
            stepStatus = { 1: false, 2: false, 3: false, 4: false };
            document.querySelectorAll('.slot').forEach(s => {
                s.textContent = '';
                s.className = s.className.replace('filled', '').replace('completed', '').replace('active-slot', '');
                if(s.id.includes('red')) s.classList.add('slot-red');
                if(s.id.includes('blue')) s.classList.add('slot-blue');
                if(s.id.includes('black')) s.classList.add('slot-black');
                if(s.id.includes('green')) s.classList.add('slot-green');
                delete s.dataset.sourceOid;
            });
            document.querySelectorAll('.step-card').forEach(card => {
                card.classList.remove('completed-step', 'active');
                card.querySelector('.step-check').classList.add('hidden');
                const controls = card.querySelector('.controls');
                controls.style.display = 'flex';
                controls.style.opacity = '1';
            });
            document.getElementById('step-1').classList.add('active'); 
            document.querySelectorAll('.feedback-msg').forEach(f => f.textContent = '');
            document.getElementById('steps-container').scrollTo({ top: 0, behavior: 'smooth' });
            initStep(1);
        }

        // 高亮下一個要填的格子
        function highlightNextSlot(stepEl) {
            // 移除所有格子的 active-slot
            stepEl.querySelectorAll('.slot').forEach(s => s.classList.remove('active-slot'));
            
            // 找出所有 slot 並排序
            let slots = Array.from(stepEl.querySelectorAll('.slot'));
            slots.sort((a, b) => (parseInt(a.dataset.fillOrder)||999) - (parseInt(b.dataset.fillOrder)||999));
            
            // 找出第一個還沒填的
            let target = slots.find(s => !s.classList.contains('filled'));
            if (target) {
                target.classList.add('active-slot');
            }
        }

        function initStep(stepNum) {
            const stepEl = document.getElementById(`step-${stepNum}`);
            let slots = Array.from(stepEl.querySelectorAll('.slot'));
            slots.sort((a, b) => (parseInt(a.dataset.fillOrder)||999) - (parseInt(b.dataset.fillOrder)||999));
            const options = stepEl.querySelectorAll('.option-btn');
            const checkBtn = stepEl.querySelector('.check-btn');
            const feedback = stepEl.querySelector('.feedback-msg');

            // 初始高亮
            highlightNextSlot(stepEl);

            options.forEach((btn, index) => {
                btn.dataset.oid = `s${stepNum}-opt-${index}`;
                btn.onclick = () => {
                    if (btn.classList.contains('used')) return;
                    // 尋找目標：第一個未填的
                    let targetSlot = slots.find(s => !s.classList.contains('filled'));
                    if (targetSlot) {
                        targetSlot.textContent = btn.dataset.val;
                        targetSlot.classList.add('filled');
                        targetSlot.dataset.sourceOid = btn.dataset.oid;
                        btn.classList.add('used');
                        feedback.textContent = '';
                        
                        // 更新高亮到下一格
                        highlightNextSlot(stepEl);
                    } else {
                        feedback.textContent = '格子已經滿囉，請檢查答案';
                        feedback.className = 'feedback-msg h-6 text-base font-bold text-center text-orange-500';
                        shake(stepEl);
                    }
                };
            });

            slots.forEach(slot => {
                slot.onclick = () => {
                    if (!slot.classList.contains('filled') || stepStatus[stepNum]) return;
                    const btn = stepEl.querySelector(`[data-oid="${slot.dataset.sourceOid}"]`);
                    if (btn) btn.classList.remove('used');
                    slot.textContent = '';
                    slot.classList.remove('filled');
                    delete slot.dataset.sourceOid;
                    feedback.textContent = '';
                    
                    // 恢復高亮
                    highlightNextSlot(stepEl);
                };
            });

            checkBtn.onclick = () => {
                let hasEmpty = slots.some(s => !s.classList.contains('filled'));
                if (hasEmpty) {
                    feedback.textContent = '請填滿所有空格';
                    feedback.className = 'feedback-msg h-6 text-base font-bold text-center text-orange-500';
                    shake(checkBtn);
                    return;
                }
                let isCorrect = slots.every(s => s.textContent === s.dataset.ans);
                if (isCorrect) {
                    feedback.textContent = '答對了！太棒了！';
                    feedback.className = 'feedback-msg h-6 text-base font-bold text-center text-green-600';
                    stepStatus[stepNum] = true;
                    stepEl.classList.add('completed-step');
                    stepEl.querySelector('.step-check').classList.remove('hidden');
                    // 完成後移除高亮
                    stepEl.querySelectorAll('.slot').forEach(s => {
                        s.classList.add('completed');
                        s.classList.remove('active-slot');
                    });
                    
                    const controls = stepEl.querySelector('.controls');
                    controls.style.opacity = '0';
                    setTimeout(() => controls.style.display = 'none', 500);

                    if (stepNum < 4) unlockStep(stepNum + 1);
                    else setTimeout(showCompletionModal, 800);
                } else {
                    feedback.textContent = '再想想看...';
                    feedback.className = 'feedback-msg h-6 text-base font-bold text-center text-red-500';
                    shake(stepEl);
                }
            };
        }

        function unlockStep(nextStepNum) {
            const nextStepEl = document.getElementById(`step-${nextStepNum}`);
            if (nextStepEl) {
                nextStepEl.classList.add('active');
                initStep(nextStepNum);
                setTimeout(() => nextStepEl.scrollIntoView({ behavior: 'smooth', block: 'center' }), 500);
            }
        }

        function shake(element) {
            element.animate([{ transform: 'translateX(0)' }, { transform: 'translateX(-5px)' }, { transform: 'translateX(5px)' }, { transform: 'translateX(0)' }], { duration: 300 });
        }

        const modal = document.getElementById('completion-modal');
        const modalContent = modal.querySelector('div');
        function showCompletionModal() {
            modal.classList.remove('hidden');
            setTimeout(() => { modal.classList.remove('opacity-0'); modalContent.classList.remove('scale-95'); modalContent.classList.add('scale-100'); }, 10);
        }
        function closeModalOnly() {
            modal.classList.add('opacity-0'); modalContent.classList.remove('scale-100'); modalContent.classList.add('scale-95');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }
        function resetProblem() {
            closeModalOnly();
            setTimeout(() => loadProblem(currentProblemIndex), 300);
        }
        function switchProblem(idx) {
            if (idx === currentProblemIndex) return;
            loadProblem(idx);
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çŸ­é™¤æ³•èˆ‡æœ€å°å…¬å€æ•¸ - SPEDMIX</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Noto+Sans+TC:wght@400;700&display=swap');

        body {
            font-family: 'Noto Sans TC', sans-serif;
            -webkit-tap-highlight-color: transparent;
            background-color: #f8fafc;
        }

        .math-font {
            font-family: 'Fredoka', sans-serif;
            font-weight: 600;
        }
        
        .math { font-family: 'Times New Roman', serif; font-style: italic; }

        /* å‹•ç•«æ•ˆæœ */
        @keyframes pop {
            0% { transform: scale(0.5); opacity: 0; }
            70% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-pop { animation: pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }

        @keyframes tada {
            0% { transform: scale(1); }
            10%, 20% { transform: scale(0.9) rotate(-3deg); }
            30%, 50%, 70%, 90% { transform: scale(1.1) rotate(3deg); }
            40%, 60%, 80% { transform: scale(1.1) rotate(-3deg); }
            100% { transform: scale(1) rotate(0); }
        }
        .animate-tada { animation: tada 0.8s ease-in-out; }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .animate-shake { animation: shake 0.4s ease-in-out; }

        @keyframes dash {
            to { stroke-dashoffset: 0; }
        }

        /* Slot (å¡«ç­”æ ¼) æ¨£å¼ */
        .slot {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 48px;
            height: 48px;
            border-bottom: 3px solid #cbd5e1;
            font-size: 1.75rem;
            color: #475569;
            cursor: pointer;
            transition: all 0.2s;
            background-color: rgba(255, 255, 255, 0.8);
            margin: 0 4px;
            border-radius: 8px 8px 0 0;
            font-family: 'Fredoka', sans-serif;
        }
        .slot:hover {
            background-color: #f1f5f9;
        }
        .slot.active {
            border-color: #6366f1;
            background-color: #e0e7ff;
            color: #4338ca;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(99, 102, 241, 0.2);
        }
        .slot.filled {
            border-bottom: 3px solid #22c55e;
            color: #15803d;
            background-color: transparent;
            font-weight: bold;
        }
        
        /* Grid Layout - åŸºç¤è¨­å®š */
        .short-division-grid {
            display: grid;
            gap: 12px 0;
            font-family: 'Fredoka', monospace;
            font-size: 2.25rem;
            line-height: 1.5;
            width: fit-content;
            min-width: 300px;
            margin: 0 auto;
            position: relative;
            padding: 20px;
        }
        /* JS æœƒå‹•æ…‹ä¿®æ”¹ grid-template-columns */

        .d-cell {
            min-width: 50px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            z-index: 2;
            padding: 0 4px;
        }

        /* L å‹è½‰è§’ */
        .short-div-bracket {
            border-bottom: 4px solid #64748b;
            border-left: 4px solid #64748b;
            border-bottom-left-radius: 12px;
            width: 100%;
            height: 100%;
            position: absolute;
            bottom: 0;
            right: 0;
            transform: translateY(2px); 
        }

        /* å»¶ä¼¸çš„åº•ç·š */
        .div-line-extend {
            border-bottom: 4px solid #64748b;
            transform: translateY(2px);
        }

        /* æ­¥é©Ÿå¡ç‰‡ */
        .step-card {
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0.5;
            transform: scale(0.98);
            pointer-events: none;
            filter: grayscale(0.8);
            border: 2px solid transparent;
        }
        .step-card.active {
            opacity: 1;
            transform: scale(1);
            pointer-events: auto;
            filter: grayscale(0);
            border-color: #6366f1;
            background-color: #ffffff;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }
        .step-card.completed {
            opacity: 0.8;
            border-left: 6px solid #22c55e;
            background-color: #f0fdf4;
            filter: grayscale(0);
        }

        .lcm-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            overflow: visible;
        }
        .lcm-path {
            fill: none;
            stroke: #ef4444;
            stroke-width: 4;
            stroke-linecap: round;
            stroke-linejoin: round;
            stroke-dasharray: 1000;
            stroke-dashoffset: 1000;
            opacity: 0.8;
            filter: drop-shadow(0 0 4px rgba(239, 68, 68, 0.5));
        }
        .lcm-path.draw {
            animation: dash 1.5s ease-out forwards;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .option-btn {
            font-family: 'Fredoka', sans-serif;
            letter-spacing: 0.5px;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 h-screen flex flex-col overflow-hidden">

    <!-- 1. å°è¦½åˆ— -->
    <nav class="bg-white shadow-sm z-50 flex-none border-b border-slate-200">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex items-center h-16 overflow-x-auto no-scrollbar gap-4">
                <span class="font-bold text-slate-700 whitespace-nowrap mr-2 flex items-center text-lg">
                    <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white mr-2 shadow-md">
                        <i class="fas fa-shapes"></i>
                    </div>
                    SPEDMIX
                </span>
                <div id="nav-buttons" class="flex gap-2">
                    <!-- Injected by JS -->
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col md:flex-row overflow-hidden max-w-7xl mx-auto w-full p-2 md:p-4 gap-4">
        
        <!-- 2. å·¦å´ï¼šé¡Œç›®èˆ‡è¦–è¦ºå‘ˆç¾ -->
        <section class="w-full md:w-5/12 lg:w-5/12 bg-white rounded-3xl shadow-xl overflow-hidden flex flex-col relative border-4 border-slate-100 flex-shrink-0">
            <!-- Header -->
            <div class="bg-slate-50 p-4 border-b border-slate-100 flex justify-between items-center flex-none">
                <div>
                    <span class="text-xs font-bold text-indigo-500 uppercase tracking-wider">Current Problem</span>
                    <h2 class="text-2xl font-black text-slate-800 math-font" id="problem-title">...</h2>
                </div>
                <div class="bg-white px-3 py-1 rounded-full border border-slate-200 text-xs font-bold text-slate-400">
                    çŸ­é™¤æ³• LCM
                </div>
            </div>

            <!-- Canvas Area -->
            <div class="flex-1 overflow-auto bg-white relative flex flex-col items-center justify-start md:justify-center p-6 bg-[url('https://www.transparenttextures.com/patterns/graphy.png')]">
                <div id="board-container" class="relative transform transition-transform origin-top-center">
                    <!-- Dynamic Grid -->
                </div>

                <div class="mt-8 bg-amber-50 text-amber-600 px-4 py-2 rounded-xl text-sm font-bold flex items-center shadow-sm border border-amber-100 flex-none max-w-full">
                    <i class="fas fa-lightbulb text-amber-400 mr-2"></i>
                    <span id="problem-hint">...</span>
                </div>
            </div>
        </section>

        <!-- 3. å³å´ï¼šæ­¥é©Ÿè§£é–æµç¨‹ -->
        <section class="flex-1 bg-white/50 backdrop-blur-sm rounded-3xl border-2 border-slate-200/50 overflow-y-auto p-4 md:p-6 relative scroll-smooth" id="stepsContainer">
            <div class="max-w-2xl mx-auto pb-20 space-y-6" id="stepsWrapper">
                <!-- Steps -->
            </div>
        </section>

    </main>

    <!-- Javascript Logic -->
    <script>
        // --- 1. Data Definitions ---
        const allProblems = [
            // --- 2 å€‹æ•¸å­—çš„é¡Œç›® (0-2) ---
            {
                id: 0,
                title: "12, 18",
                desc: "åŸºæœ¬é¡Œï¼šå…©å€‹æ•¸å­—",
                hint: "å…ˆæ‰¾å…¬å› æ•¸ï¼Œé™¤åˆ°äº’è³ªç‚ºæ­¢",
                initNumbers: [12, 18],
                steps: [
                    { id: 1, title: "æ­¥é©Ÿ 1ï¼šæ‰¾å…¬å› æ•¸", instruction: `<span class="math">12, 18</span> éƒ½æ˜¯å¶æ•¸ï¼Œç”¨èª°é™¤ï¼Ÿ`, slots: [{ target: 'div-1', value: '2' }], options: ['2', '3', '7'], hint: "æœ€å°çš„è³ªæ•¸" },
                    { id: 2, title: "æ­¥é©Ÿ 2ï¼šç®—å‡ºå•†æ•¸", instruction: `<span class="math">12Ã·2</span>, <span class="math">18Ã·2</span>`, slots: [{ target: 'q1-0', value: '6' }, { target: 'q1-1', value: '9' }], options: ['6, 9', '4, 8'], isMultiSlot: true, multiSplit: ', ', hint: "é™¤æ³•é‹ç®—" },
                    { id: 3, title: "æ­¥é©Ÿ 3ï¼šç¹¼çºŒé™¤", instruction: `<span class="math">6, 9</span> å¯ä»¥è¢«èª°æ•´é™¤ï¼Ÿ`, slots: [{ target: 'div-2', value: '3' }], options: ['2', '3', '5'], hint: "3 çš„å€æ•¸" },
                    { id: 4, title: "æ­¥é©Ÿ 4ï¼šç®—å‡ºå•†æ•¸", instruction: `<span class="math">6Ã·3</span>, <span class="math">9Ã·3</span>`, slots: [{ target: 'q2-0', value: '2' }, { target: 'q2-1', value: '3' }], options: ['2, 3', '3, 3'], isMultiSlot: true, multiSplit: ', ', hint: "é™¤æ³•é‹ç®—" },
                    { id: 5, title: "æ­¥é©Ÿ 5ï¼šæª¢æŸ¥äº’è³ª", instruction: `<span class="math">2, 3</span> äº’è³ªäº†å—ï¼Ÿ`, correctOption: 'æ˜¯', options: ['æ˜¯', 'å¦'], hint: "ä¸èƒ½å†é™¤äº†" },
                    { id: 6, title: "æ­¥é©Ÿ 6ï¼šè¨ˆç®— LCM", instruction: `å°‡ L å‹æ•¸å­—ç›¸ä¹˜`, slots: [{ target: 'lcm-ans', value: '36' }], options: ['30', '36'], hint: "2Ã—3Ã—2Ã—3" }
                ]
            },
            {
                id: 1,
                title: "20, 30",
                desc: "åŸºæœ¬é¡Œï¼šå…©å€‹æ•¸å­—",
                hint: "çµå°¾æœ‰ 0 çš„æ•¸å­—ç‰¹è‰²",
                initNumbers: [20, 30],
                steps: [
                    { id: 1, title: "æ­¥é©Ÿ 1ï¼šæ‰¾å…¬å› æ•¸", instruction: `<span class="math">20, 30</span> ç”¨èª°é™¤ï¼Ÿ`, slots: [{ target: 'div-1', value: '2' }], options: ['2', '3', '7'], hint: "å¶æ•¸" },
                    { id: 2, title: "æ­¥é©Ÿ 2ï¼šç®—å‡ºå•†æ•¸", instruction: `é™¤ä»¥ 2 çš„çµæœï¼Ÿ`, slots: [{ target: 'q1-0', value: '10' }, { target: 'q1-1', value: '15' }], options: ['10, 15', '10, 10'], isMultiSlot: true, multiSplit: ', ', hint: "æ¸›åŠ" },
                    { id: 3, title: "æ­¥é©Ÿ 3ï¼šç¹¼çºŒé™¤", instruction: `<span class="math">10, 15</span> å¯ä»¥è¢«èª°æ•´é™¤ï¼Ÿ`, slots: [{ target: 'div-2', value: '5' }], options: ['2', '3', '5'], hint: "å°¾æ•¸ 0 æˆ– 5" },
                    { id: 4, title: "æ­¥é©Ÿ 4ï¼šç®—å‡ºå•†æ•¸", instruction: `é™¤ä»¥ 5 çš„çµæœï¼Ÿ`, slots: [{ target: 'q2-0', value: '2' }, { target: 'q2-1', value: '3' }], options: ['2, 3', '3, 5'], isMultiSlot: true, multiSplit: ', ', hint: "é™¤æ³•" },
                    { id: 5, title: "æ­¥é©Ÿ 5ï¼šæª¢æŸ¥äº’è³ª", instruction: `é‚„èƒ½å†é™¤å—ï¼Ÿ`, correctOption: 'ä¸èƒ½', options: ['èƒ½', 'ä¸èƒ½'], hint: "äº’è³ªäº†" },
                    { id: 6, title: "æ­¥é©Ÿ 6ï¼šè¨ˆç®— LCM", instruction: `ä¹˜èµ·ä¾†ï¼`, slots: [{ target: 'lcm-ans', value: '60' }], options: ['50', '60'], hint: "2Ã—5Ã—2Ã—3" }
                ]
            },
            {
                id: 2,
                title: "18, 24",
                desc: "åŸºæœ¬é¡Œï¼šå…©å€‹æ•¸å­—",
                hint: "å¤šç·´ç¿’ä¸€æ¬¡",
                initNumbers: [18, 24],
                steps: [
                    { id: 1, title: "æ­¥é©Ÿ 1ï¼šæ‰¾å…¬å› æ•¸", instruction: `<span class="math">18, 24</span> å…ˆé™¤ä»¥ï¼Ÿ`, slots: [{ target: 'div-1', value: '2' }], options: ['2', '3', '5'], hint: "å¶æ•¸" },
                    { id: 2, title: "æ­¥é©Ÿ 2ï¼šç®—å‡ºå•†æ•¸", instruction: `å•†æ˜¯å¤šå°‘ï¼Ÿ`, slots: [{ target: 'q1-0', value: '9' }, { target: 'q1-1', value: '12' }], options: ['9, 12', '8, 12'], isMultiSlot: true, multiSplit: ', ', hint: "é™¤ä»¥ 2" },
                    { id: 3, title: "æ­¥é©Ÿ 3ï¼šç¹¼çºŒé™¤", instruction: `<span class="math">9, 12</span> éƒ½åœ¨èª°çš„ä¹˜æ³•è¡¨ï¼Ÿ`, slots: [{ target: 'div-2', value: '3' }], options: ['2', '3'], hint: "3x3=9" },
                    { id: 4, title: "æ­¥é©Ÿ 4ï¼šç®—å‡ºå•†æ•¸", instruction: `å•†æ˜¯å¤šå°‘ï¼Ÿ`, slots: [{ target: 'q2-0', value: '3' }, { target: 'q2-1', value: '4' }], options: ['3, 4', '3, 5'], isMultiSlot: true, multiSplit: ', ', hint: "é™¤æ³•" },
                    { id: 5, title: "æ­¥é©Ÿ 5ï¼šæª¢æŸ¥äº’è³ª", instruction: `<span class="math">3, 4</span> äº’è³ªå—ï¼Ÿ`, correctOption: 'æ˜¯', options: ['æ˜¯', 'å¦'], hint: "æ²’æœ‰å…¬å› æ•¸äº†" },
                    { id: 6, title: "æ­¥é©Ÿ 6ï¼šè¨ˆç®— LCM", instruction: `L å‹ä¹˜æ³•`, slots: [{ target: 'lcm-ans', value: '72' }], options: ['48', '72'], hint: "2Ã—3Ã—3Ã—4" }
                ]
            },
            // --- 3 å€‹æ•¸å­—çš„é¡Œç›® (3-5) ---
            {
                id: 3,
                title: "6, 12, 18",
                desc: "é€²éšé¡Œï¼šä¸‰å€‹æ•¸å­—",
                hint: "è¦ä¸‰å€‹æ•¸å­—ä¸€èµ·çœ‹å–”",
                initNumbers: [6, 12, 18],
                steps: [
                    { id: 1, title: "æ­¥é©Ÿ 1ï¼šæ‰¾å…¬å› æ•¸", instruction: `ä¸‰å€‹æ•¸å­—éƒ½æ˜¯å¶æ•¸ï¼Œå…ˆé™¤ä»¥ï¼Ÿ`, slots: [{ target: 'div-1', value: '2' }], options: ['2', '3'], hint: "æœ€å°è³ªæ•¸" },
                    { id: 2, title: "æ­¥é©Ÿ 2ï¼šç®—å‡ºå•†æ•¸", instruction: `åˆ†åˆ¥é™¤ä»¥ 2`, slots: [{ target: 'q1-0', value: '3' }, { target: 'q1-1', value: '6' }, { target: 'q1-2', value: '9' }], options: ['3, 6, 9', '2, 6, 9'], isMultiSlot: true, multiSplit: ', ', hint: "æ¸›åŠ" },
                    { id: 3, title: "æ­¥é©Ÿ 3ï¼šç¹¼çºŒé™¤", instruction: `<span class="math">3, 6, 9</span> éƒ½å¯ä»¥è¢«èª°æ•´é™¤ï¼Ÿ`, slots: [{ target: 'div-2', value: '3' }], options: ['2', '3'], hint: "3 çš„å€æ•¸" },
                    { id: 4, title: "æ­¥é©Ÿ 4ï¼šç®—å‡ºå•†æ•¸", instruction: `åˆ†åˆ¥é™¤ä»¥ 3`, slots: [{ target: 'q2-0', value: '1' }, { target: 'q2-1', value: '2' }, { target: 'q2-2', value: '3' }], options: ['1, 2, 3', '1, 3, 3'], isMultiSlot: true, multiSplit: ', ', hint: "é™¤æ³•" },
                    { id: 5, title: "æ­¥é©Ÿ 5ï¼šæª¢æŸ¥äº’è³ª", instruction: `<span class="math">1, 2, 3</span> å…©å…©äº’è³ªäº†å—ï¼Ÿ`, correctOption: 'æ˜¯', options: ['æ˜¯', 'å¦'], hint: "æ²’è¾¦æ³•å†æå…¬å› æ•¸äº†" },
                    { id: 6, title: "æ­¥é©Ÿ 6ï¼šè¨ˆç®— LCM", instruction: `L å‹ä¹˜èµ·ä¾†ï¼<br>2Ã—3Ã—1Ã—2Ã—3`, slots: [{ target: 'lcm-ans', value: '36' }], options: ['24', '36'], hint: "6Ã—6=?" }
                ]
            },
            {
                id: 4,
                title: "4, 8, 12",
                desc: "é€²éšé¡Œï¼šä¸‰å€‹æ•¸å­—",
                hint: "æ³¨æ„ï¼ä¸‰å€‹æ•¸éƒ½è¦çœ‹",
                initNumbers: [4, 8, 12],
                steps: [
                    { id: 1, title: "æ­¥é©Ÿ 1ï¼šæ‰¾å…¬å› æ•¸", instruction: `å…ˆç”¨ 2 é™¤`, slots: [{ target: 'div-1', value: '2' }], options: ['2', '4'], hint: "ç”¨è³ªæ•¸" },
                    { id: 2, title: "æ­¥é©Ÿ 2ï¼šç®—å‡ºå•†æ•¸", instruction: `4, 8, 12 é™¤ä»¥ 2`, slots: [{ target: 'q1-0', value: '2' }, { target: 'q1-1', value: '4' }, { target: 'q1-2', value: '6' }], options: ['2, 4, 6', '2, 4, 8'], isMultiSlot: true, multiSplit: ', ', hint: "ä¸€åŠ" },
                    { id: 3, title: "æ­¥é©Ÿ 3ï¼šç¹¼çºŒé™¤", instruction: `<span class="math">2, 4, 6</span> é‚„å¯ä»¥ç”¨ 2 é™¤`, slots: [{ target: 'div-2', value: '2' }], options: ['2', '3'], hint: "é‚„æ˜¯å¶æ•¸" },
                    { id: 4, title: "æ­¥é©Ÿ 4ï¼šç®—å‡ºå•†æ•¸", instruction: `åˆ†åˆ¥é™¤ä»¥ 2`, slots: [{ target: 'q2-0', value: '1' }, { target: 'q2-1', value: '2' }, { target: 'q2-2', value: '3' }], options: ['1, 2, 3', '1, 2, 2'], isMultiSlot: true, multiSplit: ', ', hint: "é™¤æ³•" },
                    { id: 5, title: "æ­¥é©Ÿ 5ï¼šè¨ˆç®— LCM", instruction: `2Ã—2Ã—1Ã—2Ã—3 = ?`, slots: [{ target: 'lcm-ans', value: '24' }], options: ['24', '48'], hint: "4Ã—6" }
                ]
            },
            {
                id: 5,
                title: "10, 15, 20",
                desc: "æŒ‘æˆ°é¡Œï¼šéƒ¨åˆ†æ•´é™¤",
                hint: "æ³¨æ„ï¼å¦‚æœä¸èƒ½æ•´é™¤ï¼Œå°±ç…§æŠ„ä¸‹ä¾†",
                initNumbers: [10, 15, 20],
                steps: [
                    { id: 1, title: "æ­¥é©Ÿ 1ï¼šæ‰¾å…¬å› æ•¸", instruction: `10, 15, 20 éƒ½å¯ä»¥è¢«èª°æ•´é™¤ï¼Ÿ`, slots: [{ target: 'div-1', value: '5' }], options: ['2', '5'], hint: "å°¾æ•¸ 0 æˆ– 5" },
                    { id: 2, title: "æ­¥é©Ÿ 2ï¼šç®—å‡ºå•†æ•¸", instruction: `åˆ†åˆ¥é™¤ä»¥ 5`, slots: [{ target: 'q1-0', value: '2' }, { target: 'q1-1', value: '3' }, { target: 'q1-2', value: '4' }], options: ['2, 3, 4', '2, 5, 4'], isMultiSlot: true, multiSplit: ', ', hint: "é™¤æ³•" },
                    { id: 3, title: "æ­¥é©Ÿ 3ï¼šè§€å¯Ÿéƒ¨åˆ†å…¬å› æ•¸", instruction: `<span class="math">2, 3, 4</span> ä¸‰å€‹æ•¸ä¸­ï¼Œ2 å’Œ 4 å¯ä»¥è¢« 2 æ•´é™¤ã€‚<br>3 ä¸èƒ½æ•´é™¤æ€éº¼è¾¦ï¼Ÿ<br><b>ç…§æŠ„ï¼</b>`, slots: [{ target: 'div-2', value: '2' }], options: ['2', '3'], hint: "æå‡º 2" },
                    { id: 4, title: "æ­¥é©Ÿ 4ï¼šéƒ¨åˆ†é™¤æ³•", instruction: `2Ã·2=1, 4Ã·2=2, 3 ç…§æŠ„`, slots: [{ target: 'q2-0', value: '1' }, { target: 'q2-1', value: '3' }, { target: 'q2-2', value: '2' }], options: ['1, 3, 2', '1, 1, 2'], isMultiSlot: true, multiSplit: ', ', hint: "3 æ²’æœ‰è®Šå–”" },
                    { id: 5, title: "æ­¥é©Ÿ 5ï¼šè¨ˆç®— LCM", instruction: `L å‹ä¹˜èµ·ä¾†ï¼š<br>5Ã—2Ã—1Ã—3Ã—2`, slots: [{ target: 'lcm-ans', value: '60' }], options: ['30', '60'], hint: "10Ã—6" }
                ]
            }
        ];

        // --- 2. State Management ---
        let currentProblemIndex = 0;
        let progressData = allProblems.map(p => ({
            currentStepIndex: 0,
            isCompleted: false,
            filledSlots: {} 
        }));
        let isProcessing = false;

        // --- 3. Initial Setup ---
        function init() {
            renderNav();
            loadProblem(currentProblemIndex);
            
            window.addEventListener('resize', () => {
                const progress = progressData[currentProblemIndex];
                if(progress.isCompleted) {
                    drawLCMPath(false);
                }
            });
        }

        function renderNav() {
            const container = document.getElementById('nav-buttons');
            container.innerHTML = allProblems.map((p, idx) => `
                <button onclick="switchProblem(${idx})" 
                    class="problem-btn px-5 py-2 rounded-xl text-sm font-bold transition-all whitespace-nowrap border-b-4 active:border-b-0 active:translate-y-1
                    ${idx === currentProblemIndex 
                        ? 'bg-indigo-500 text-white border-indigo-700 shadow-indigo-200' 
                        : 'bg-white text-slate-500 border-slate-200 hover:bg-slate-50 hover:border-slate-300'}">
                    é¡Œç›® ${idx + 1}
                </button>
            `).join('');
        }

        function switchProblem(index) {
            if(index === currentProblemIndex) return;
            currentProblemIndex = index;
            renderNav();
            loadProblem(index);
        }

        function loadProblem(index) {
            const problem = allProblems[index];
            const progress = progressData[index];

            document.getElementById('problem-title').textContent = problem.title;
            document.getElementById('problem-hint').textContent = problem.hint;

            // Render Board
            const boardContainer = document.getElementById('board-container');
            renderShortDivisionBoard(boardContainer, problem);

            // Restore State
            Object.keys(progress.filledSlots).forEach(target => {
                const val = progress.filledSlots[target];
                const el = document.querySelector(`.slot-container[data-pos="${target}"]`);
                if(el) el.innerHTML = `<span class="slot filled">${val}</span>`;
            });

            if(progress.isCompleted) {
                setTimeout(() => drawLCMPath(true), 500);
            }

            renderSteps();
            updateBoardHighlights();
            setTimeout(() => scrollToStep(progress.currentStepIndex), 100);
        }

        // --- 4. Board Rendering Logic (Flexible for 2 or 3 numbers) ---
        function renderShortDivisionBoard(container, problem) {
            const nums = problem.initNumbers;
            const count = nums.length; // 2 or 3

            // Grid Template configuration
            // 2 nums: min min 1fr min 1fr (5 cols)
            // 3 nums: min min 1fr min 1fr min 1fr (7 cols)
            let gridStyle = '';
            let headerHTML = '';
            let row2HTML = '';
            let row3HTML = '';
            let resultHTML = '';

            if (count === 3) {
                // 3 Numbers Layout
                gridStyle = `grid-template-columns: min-content min-content 1fr min-content 1fr min-content 1fr;`;
                
                // Header Row
                headerHTML = `
                    <div class="d-cell math-font text-slate-700 div-line-extend text-2xl">${nums[0]}</div>
                    <div class="d-cell div-line-extend"></div>
                    <div class="d-cell math-font text-slate-700 div-line-extend text-2xl">${nums[1]}</div>
                    <div class="d-cell div-line-extend"></div>
                    <div class="d-cell math-font text-slate-700 div-line-extend text-2xl">${nums[2]}</div>
                `;

                // Row 2 (Quotients 1)
                row2HTML = `
                    <div class="d-cell slot-container div-line-extend" data-pos="q1-0"></div>
                    <div class="d-cell div-line-extend"></div>
                    <div class="d-cell slot-container div-line-extend" data-pos="q1-1"></div>
                    <div class="d-cell div-line-extend"></div>
                    <div class="d-cell slot-container div-line-extend" data-pos="q1-2"></div>
                `;

                // Row 3 (Quotients 2 / Remainders)
                row3HTML = `
                    <div class="d-cell slot-container text-indigo-600 font-bold" data-pos="q2-0"></div>
                    <div class="d-cell"></div>
                    <div class="d-cell slot-container text-indigo-600 font-bold" data-pos="q2-1"></div>
                    <div class="d-cell"></div>
                    <div class="d-cell slot-container text-indigo-600 font-bold" data-pos="q2-2"></div>
                `;
                
                // Result Equation Preview (Logic simplified for display)
                resultHTML = `
                    <span class="math-font text-rose-500" id="disp-d1">?</span> Ã— 
                    <span class="math-font text-rose-500" id="disp-d2">?</span> Ã— 
                    <span class="math-font text-indigo-500" id="disp-q1">?</span> Ã— 
                    <span class="math-font text-indigo-500" id="disp-q2">?</span> Ã—
                    <span class="math-font text-indigo-500" id="disp-q3">?</span>
                `;

            } else {
                // 2 Numbers Layout (Default)
                gridStyle = `grid-template-columns: min-content min-content 1fr min-content 1fr;`;
                
                headerHTML = `
                    <div class="d-cell math-font text-slate-700 div-line-extend text-2xl">${nums[0]}</div>
                    <div class="d-cell div-line-extend"></div>
                    <div class="d-cell math-font text-slate-700 div-line-extend text-2xl">${nums[1]}</div>
                `;

                row2HTML = `
                    <div class="d-cell slot-container div-line-extend" data-pos="q1-0"></div>
                    <div class="d-cell div-line-extend"></div>
                    <div class="d-cell slot-container div-line-extend" data-pos="q1-1"></div>
                `;

                row3HTML = `
                    <div class="d-cell slot-container text-indigo-600 font-bold" data-pos="q2-0"></div>
                    <div class="d-cell"></div>
                    <div class="d-cell slot-container text-indigo-600 font-bold" data-pos="q2-1"></div>
                `;

                 resultHTML = `
                    <span class="math-font text-rose-500" id="disp-d1">?</span> Ã— 
                    <span class="math-font text-rose-500" id="disp-d2">?</span> Ã— 
                    <span class="math-font text-indigo-500" id="disp-q1">?</span> Ã— 
                    <span class="math-font text-indigo-500" id="disp-q2">?</span>
                `;
            }

            container.innerHTML = `
                <div class="flex flex-col items-center">
                    <div class="short-division-grid relative" id="grid-root" style="${gridStyle}">
                        <!-- SVG Overlay -->
                        <svg class="lcm-overlay" id="lcm-svg">
                            <path id="lcm-path-line" class="lcm-path" d="" />
                        </svg>

                        <!-- Row 1 -->
                        <div class="d-cell slot-container text-rose-500 font-bold" data-pos="div-1"></div>
                        <div class="d-cell"><div class="short-div-bracket"></div></div>
                        ${headerHTML}

                        <!-- Row 2 -->
                        <div class="d-cell slot-container text-rose-500 font-bold" data-pos="div-2"></div>
                        <div class="d-cell"><div class="short-div-bracket"></div></div>
                        ${row2HTML}

                        <!-- Row 3 -->
                        <div class="d-cell"></div>
                        <div class="d-cell"></div>
                        ${row3HTML}
                    </div>

                    <!-- LCM Result Area -->
                    <div class="mt-8 p-4 bg-white rounded-2xl flex flex-wrap items-center justify-center gap-3 text-xl font-bold text-slate-700 shadow-lg border-2 border-indigo-100 animate-pop max-w-full">
                        <span class="bg-indigo-100 text-indigo-600 px-2 py-1 rounded text-sm whitespace-nowrap">LCM</span>
                        <div class="flex flex-wrap items-center justify-center gap-1">
                            ${resultHTML}
                            <span> = </span>
                            <div class="slot-container inline-block align-middle" data-pos="lcm-ans"></div>
                        </div>
                    </div>
                </div>
            `;
            initSlots();
        }

        function initSlots() {
            document.querySelectorAll('.slot-container').forEach(el => {
                if (!el.innerHTML) el.innerHTML = `<span class="slot">?</span>`;
            });
        }

        // --- 5. Step Logic ---
        function renderSteps() {
            const container = document.getElementById('stepsWrapper');
            container.innerHTML = '';
            
            const problem = allProblems[currentProblemIndex];
            const progress = progressData[currentProblemIndex];

            problem.steps.forEach((step, index) => {
                const isCompleted = index < progress.currentStepIndex;
                const isActive = index === progress.currentStepIndex;
                
                let statusClass = isActive ? 'active' : (isCompleted ? 'completed' : '');
                
                let icon = isCompleted 
                    ? '<i class="fas fa-check-circle text-green-500 text-xl"></i>' 
                    : (isActive 
                        ? '<span class="flex h-3 w-3 relative"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-indigo-400 opacity-75"></span><span class="relative inline-flex rounded-full h-3 w-3 bg-indigo-500"></span></span>' 
                        : `<span class="w-2 h-2 rounded-full bg-slate-300"></span>`);

                let optionsHtml = '';
                if (!isCompleted && isActive) {
                    optionsHtml = `<div class="mt-6 flex flex-wrap gap-3 animate-pop" id="options-${index}">
                        ${step.options.map(opt => `
                            <button onclick="handleOptionClick(${index}, '${opt}', this)" 
                                class="option-btn px-6 py-3 bg-white border-b-4 border-slate-200 rounded-xl text-xl font-bold text-slate-600 shadow-sm hover:border-indigo-400 hover:text-indigo-600 hover:bg-indigo-50 hover:-translate-y-1 transition-all active:border-b-0 active:translate-y-1">
                                ${opt}
                            </button>
                        `).join('')}
                    </div>`;
                }

                const card = document.createElement('div');
                card.className = `step-card bg-white p-6 rounded-2xl shadow-sm border border-slate-100 relative overflow-hidden ${statusClass}`;
                card.id = `step-card-${index}`;
                
                const watermark = `<div class="absolute -right-4 -top-4 text-9xl font-black text-slate-50 opacity-10 pointer-events-none math-font">${index+1}</div>`;

                card.innerHTML = `
                    ${watermark}
                    <div class="flex justify-between items-center mb-3 relative z-10">
                        <h3 class="text-lg font-bold text-slate-800 flex items-center gap-3">
                            ${icon}
                            ${step.title}
                        </h3>
                    </div>
                    <div class="text-slate-600 text-lg leading-relaxed relative z-10 font-medium">
                        ${step.instruction}
                    </div>
                    ${ isActive ? `<div class="mt-4 text-sm text-amber-600 bg-amber-50 px-3 py-2 rounded-lg inline-block font-bold border border-amber-100">
                        <i class="far fa-smile text-amber-500 mr-1"></i> ${step.hint}
                    </div>` : ''}
                    ${optionsHtml}
                    <div id="feedback-${index}" class="mt-3 text-base font-bold min-h-[20px]"></div>
                `;
                container.appendChild(card);
            });
        }

        function handleOptionClick(stepIndex, selectedValue, btnElement) {
            if (isProcessing) return;
            const progress = progressData[currentProblemIndex];
            if (stepIndex !== progress.currentStepIndex) return;

            const problem = allProblems[currentProblemIndex];
            const currentStepData = problem.steps[stepIndex];
            const feedbackEl = document.getElementById(`feedback-${stepIndex}`);
            
            let isCorrect = false;
            if (currentStepData.slots && currentStepData.slots.length > 0) {
                let expectedValue = "";
                if (currentStepData.isMultiSlot) {
                    if (currentStepData.multiSplit) {
                         expectedValue = currentStepData.slots.map(s => s.value).join(currentStepData.multiSplit);
                    } else {
                         expectedValue = currentStepData.slots.map(s => s.value).join('');
                    }
                } else {
                    expectedValue = currentStepData.slots[0].value;
                }
                isCorrect = (selectedValue === expectedValue);
            } else if (currentStepData.correctOption) {
                isCorrect = (selectedValue === currentStepData.correctOption);
            }

            if (isCorrect) {
                isProcessing = true;
                btnElement.className = "option-btn px-6 py-3 bg-green-500 border-b-4 border-green-700 rounded-xl text-xl font-bold text-white shadow-lg animate-tada";
                
                playSound('correct');
                feedbackEl.innerHTML = '<span class="text-green-600 flex items-center gap-2"><i class="fas fa-check-circle"></i> ç­”å°äº†ï¼</span>';

                if(currentStepData.slots && currentStepData.slots.length > 0) {
                    fillBoardSlots(currentStepData, selectedValue);
                }

                updateEquationDisplay();

                const container = document.getElementById(`options-${stepIndex}`);
                Array.from(container.children).forEach(btn => {
                    btn.disabled = true;
                    if(btn !== btnElement) {
                        btn.style.opacity = '0;';
                        btn.style.display = 'none';
                    }
                });

                setTimeout(() => {
                    progress.currentStepIndex++;
                    isProcessing = false;
                    
                    if (progress.currentStepIndex >= problem.steps.length) {
                        progress.isCompleted = true;
                        celebrateCompletion();
                        drawLCMPath(true);
                    }

                    renderSteps();
                    updateBoardHighlights();
                    scrollToStep(progress.currentStepIndex);
                }, 1200);

            } else {
                btnElement.classList.add('animate-shake', 'bg-red-100', 'border-red-300', 'text-red-500');
                feedbackEl.innerHTML = '<span class="text-red-500 flex items-center gap-2"><i class="fas fa-times-circle"></i> å†è©¦è©¦çœ‹ï¼</span>';
                playSound('wrong');
                setTimeout(() => {
                    btnElement.classList.remove('animate-shake', 'bg-red-100', 'border-red-300', 'text-red-500');
                }, 500);
            }
        }

        function fillBoardSlots(stepData, selectedValue) {
            const progress = progressData[currentProblemIndex];
            
            let values = [];
            if(stepData.isMultiSlot && stepData.multiSplit) {
                values = selectedValue.split(stepData.multiSplit);
            } else if (stepData.isMultiSlot) {
                values = selectedValue.split('');
            } else {
                values = [selectedValue];
            }

            stepData.slots.forEach((slotInfo, i) => {
                const val = values[i];
                const el = document.querySelector(`.slot-container[data-pos="${slotInfo.target}"]`);
                if(el) {
                    el.innerHTML = `<span class="slot filled animate-pop">${val}</span>`;
                }
                progress.filledSlots[slotInfo.target] = val;
            });
        }

        function updateEquationDisplay() {
            const progress = progressData[currentProblemIndex];
            // Mapping for display slots at bottom
            const map = {
                'div-1': 'disp-d1',
                'div-2': 'disp-d2',
                'q2-0': 'disp-q1',
                'q2-1': 'disp-q2',
                'q2-2': 'disp-q3' // For 3 numbers
            };
            
            for (const [key, id] of Object.entries(map)) {
                if (progress.filledSlots[key]) {
                    const el = document.getElementById(id);
                    if(el) el.textContent = progress.filledSlots[key];
                }
            }
        }

        function updateBoardHighlights() {
            document.querySelectorAll('.slot').forEach(s => s.classList.remove('active'));

            const problem = allProblems[currentProblemIndex];
            const progress = progressData[currentProblemIndex];

            if(progress.currentStepIndex < problem.steps.length) {
                const currentStep = problem.steps[progress.currentStepIndex];
                if(currentStep.slots) {
                    currentStep.slots.forEach(s => {
                        const el = document.querySelector(`.slot-container[data-pos="${s.target}"] .slot`);
                        if(el) el.classList.add('active');
                    });
                }
            }
        }

        function scrollToStep(idx) {
            const el = document.getElementById(`step-card-${idx}`);
            if(el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // --- 6. Visual Effects (LCM Path) ---
        function drawLCMPath(animate = false) {
            const grid = document.getElementById('grid-root');
            const pathEl = document.getElementById('lcm-path-line');
            if(!grid || !pathEl) return;
            
            const problem = allProblems[currentProblemIndex];
            const count = problem.initNumbers.length;

            // Define targets based on number count
            let targets = [];
            if (count === 3) {
                targets = ['div-1', 'div-2', 'q2-0', 'q2-1', 'q2-2'];
            } else {
                targets = ['div-1', 'div-2', 'q2-0', 'q2-1'];
            }

            const coords = targets.map(id => {
                const el = document.querySelector(`[data-pos="${id}"]`);
                if(!el) return null;
                const gridRect = grid.getBoundingClientRect();
                const cellRect = el.getBoundingClientRect();
                return {
                    x: (cellRect.left - gridRect.left) + cellRect.width / 2,
                    y: (cellRect.top - gridRect.top) + cellRect.height / 2
                };
            }).filter(c => c !== null);

            if (coords.length < targets.length) return;
            
            // Draw path: Div1 -> Div2 -> Down to Row3 -> Right to last quotient
            let d = `M ${coords[0].x} ${coords[0].y} `; 
            d += `L ${coords[1].x} ${coords[1].y} `; // Down to div2
            
            const bottomY = coords[2].y; // Y level of the bottom row (quotients)
            
            // Vertical segment down from div2 to the bottom row level
            d += `L ${coords[1].x} ${bottomY} `;
            
            // Horizontal segment right across all quotients
            for (let i = 2; i < coords.length; i++) {
                d += `L ${coords[i].x} ${bottomY} `;
            }

            pathEl.setAttribute('d', d);
            
            if(animate) {
                pathEl.classList.remove('draw');
                void pathEl.offsetWidth; 
                pathEl.classList.add('draw');
            }
        }

        function celebrateCompletion() {
            const wrapper = document.getElementById('stepsWrapper');
            const victory = document.createElement('div');
            victory.className = "text-center p-8 bg-indigo-600 text-white rounded-2xl shadow-xl animate-tada mt-8 border-4 border-indigo-400/50";
            victory.innerHTML = `
                <div class="text-6xl mb-4 animate-bounce">ğŸ†</div>
                <h2 class="text-3xl font-black mb-2">å¤ªæ£’äº†ï¼</h2>
                <p class="text-indigo-100 text-lg">ä½ å·²ç¶“æŒæ¡äº†æœ€å°å…¬å€æ•¸ï¼</p>
                <button onclick="location.reload()" class="mt-6 px-8 py-3 bg-white text-indigo-600 rounded-full font-bold hover:bg-indigo-50 transition shadow-lg">
                    å†ç©ä¸€æ¬¡
                </button>
            `;
            wrapper.appendChild(victory);
            victory.scrollIntoView({ behavior: 'smooth' });
        }

        // --- 7. Audio ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            
            if (type === 'correct') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(500, audioCtx.currentTime);
                osc.frequency.linearRampToValueAtTime(800, audioCtx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.4);
                osc.start(); osc.stop(audioCtx.currentTime + 0.4);
            } else {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, audioCtx.currentTime);
                osc.frequency.linearRampToValueAtTime(100, audioCtx.currentTime + 0.2);
                gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                osc.start(); osc.stop(audioCtx.currentTime + 0.3);
            }
        }

        window.onload = init;
    </script>
</body>
</html>
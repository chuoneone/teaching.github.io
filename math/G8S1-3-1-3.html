<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>變號提公因式：分步闖關</title>
    <link rel="icon" href="dog.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Chiron+GoRound+TC:wght@200..900&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: "Chiron GoRound TC", sans-serif;
            background: #f0fdf4; /* 淺綠色背景，象徵生長與學習 */
            background-image: radial-gradient(#dcfce7 1px, transparent 1px);
            background-size: 20px 20px;
            min-height: 100vh;
        }

        /* 題目容器 */
        .math-expression {
            font-family: "Chiron GoRound TC", monospace; /* 確保數字對齊 */
            letter-spacing: 0.05em;
        }

        /* 填空 Slot 樣式 */
        .slot {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 3.5rem; /* 稍微加寬以容納多字元 */
            height: 3.5rem;
            border-bottom: 3px solid #cbd5e1;
            background-color: white;
            border-radius: 0.5rem 0.5rem 0 0;
            margin: 0.25rem;
            font-weight: bold;
            color: #334155;
            font-size: 1.4rem;
            cursor: pointer;
            transition: all 0.2s;
            padding: 0 0.75rem;
            vertical-align: middle;
            white-space: nowrap;
        }
        .slot:hover { border-bottom-color: #3b82f6; background-color: #eff6ff; }
        .slot.filled { border-bottom-color: #3b82f6; color: #2563eb; }
        .slot.correct { border-bottom-color: #22c55e; color: #15803d; background-color: #dcfce7; pointer-events: none; }
        .slot.wrong { border-bottom-color: #ef4444; color: #b91c1c; background-color: #fee2e2; animation: shake 0.4s; }

        /* 選項按鈕 */
        .option-card {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 1rem;
            padding: 0.75rem 1.25rem;
            font-size: 1.4rem;
            font-weight: bold;
            color: #475569;
            box-shadow: 0 4px 0 #cbd5e1;
            cursor: pointer;
            transition: all 0.1s;
            user-select: none;
            margin: 0.25rem;
        }
        .option-card:active { transform: translateY(4px); box-shadow: none; }
        .option-card:hover { border-color: #94a3b8; background-color: #f8fafc; }
        .option-card.used { opacity: 0.4; cursor: not-allowed; background-color: #f1f5f9; box-shadow: none; transform: translateY(4px); }

        /* 步驟區塊 */
        .step-box {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 1.5rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border-left: 6px solid #cbd5e1;
            transition: all 0.5s ease;
        }
        .step-box.active { border-left-color: #3b82f6; transform: scale(1.02); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .step-box.done { border-left-color: #22c55e; opacity: 0.8; }
        .step-box.locked { opacity: 0.5; pointer-events: none; filter: grayscale(0.8); }

        /* 關鍵字強調 */
        .highlight-red { color: #ef4444; font-weight: bold; }
        .highlight-blue { color: #2563eb; font-weight: bold; }
        
        /* 動畫 */
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        @keyframes popIn { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        
        /* 變號箭頭指示 */
        .arrow-indicator {
            font-size: 1.5rem;
            color: #f59e0b;
            margin: 0.5rem 0;
            animation: bounce 2s infinite;
        }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(5px); } }

    </style>
</head>
<body class="flex flex-col items-center py-8 px-4">

    <header class="mb-8 text-center">
        <h1 class="text-3xl md:text-4xl font-bold text-slate-800 mb-2">
            <i class="fas fa-exchange-alt text-green-500 mr-2"></i>變號提公因式
        </h1>
        <p class="text-slate-600 font-medium">步驟化解題挑戰：先變號，再提出！</p>
    </header>

    <!-- 進度條 -->
    <div class="w-full max-w-2xl mb-6 flex justify-between items-center text-slate-500 font-bold">
        <button id="prev-btn" class="hover:text-blue-600 disabled:opacity-30"><i class="fas fa-chevron-left mr-1"></i>上一題</button>
        <span id="progress-text" class="bg-white px-4 py-1 rounded-full shadow-sm">第 1 / 6 題</span>
        <button id="next-btn" class="hover:text-blue-600 disabled:opacity-30">下一題<i class="fas fa-chevron-right ml-1"></i></button>
    </div>

    <!-- 主要遊戲區 -->
    <main class="w-full max-w-3xl relative">
        
        <!-- 步驟一：變號 -->
        <div id="step1-container" class="step-box active">
            <div class="flex justify-between items-start mb-4">
                <h2 class="text-xl font-bold text-slate-700 flex items-center">
                    <span class="bg-blue-100 text-blue-600 w-8 h-8 rounded-full flex items-center justify-center mr-2 text-sm">1</span>
                    第一步：變號轉身
                </h2>
                <i id="step1-icon" class="fas fa-pen text-blue-400 text-xl"></i>
            </div>
            
            <div class="text-center">
                <!-- 題目顯示 -->
                <div class="text-2xl md:text-4xl mb-4 math-expression text-slate-800 leading-relaxed" id="question-display">
                    <!-- JS 填入 -->
                </div>
                
                <div class="arrow-indicator"><i class="fas fa-arrow-down"></i> 括號不一樣，變號轉過來！</div>

                <!-- 作答區 -->
                <div class="text-2xl md:text-3xl mt-4 math-expression flex flex-wrap justify-center items-center gap-2" id="step1-slots">
                    <!-- JS 填入 Slot -->
                </div>
            </div>
        </div>

        <!-- 步驟二：提公因式 -->
        <div id="step2-container" class="step-box locked">
            <div class="flex justify-between items-start mb-4">
                <h2 class="text-xl font-bold text-slate-700 flex items-center">
                    <span class="bg-green-100 text-green-600 w-8 h-8 rounded-full flex items-center justify-center mr-2 text-sm">2</span>
                    第二步：提公因式
                </h2>
                <i id="step2-icon" class="fas fa-lock text-slate-300 text-xl"></i>
            </div>

            <div class="text-center">
                <p class="text-slate-500 mb-4 text-lg">括號現在一樣了！把它提出來：</p>
                <!-- 顯示整理好的式子 (唯讀) -->
                <div class="text-2xl md:text-3xl mb-6 text-blue-600 font-bold opacity-50 math-expression" id="step2-preview">
                    <!-- JS 填入 -->
                </div>

                <!-- 作答區 -->
                <div class="text-2xl md:text-3xl math-expression flex flex-wrap justify-center items-center gap-2" id="step2-slots">
                     <span class="text-slate-400">=</span>
                     <!-- JS 填入 Slot -->
                </div>
            </div>
        </div>

        <!-- 選項區 (固定在下方，類似鍵盤) 
             修改：bottom-0 改為 bottom-12 (約48px) 讓出空間給 footer
        -->
        <div class="fixed bottom-12 left-0 w-full bg-white/90 backdrop-blur-md border-t border-slate-200 p-4 shadow-[0_-4px_20px_rgba(0,0,0,0.1)] transition-transform duration-300 z-50" id="options-panel">
            <div class="max-w-4xl mx-auto">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm text-slate-500 font-bold">請點選卡片填入空格：</span>
                    <button onclick="resetCurrentStep()" class="text-sm text-orange-500 font-bold hover:underline"><i class="fas fa-undo mr-1"></i>重填</button>
                </div>
                <div class="flex flex-wrap justify-center gap-2" id="options-container">
                    <!-- JS 生成選項 -->
                </div>
            </div>
        </div>

        <!-- 佔位符，避免內容被固定底欄遮住，增加高度以容納 footer -->
        <div class="h-48"></div>

    </main>

    <!-- 頁尾 Footer (新增) -->
    <footer class="fixed bottom-0 left-0 w-full text-center text-gray-500 text-sm bg-white bg-opacity-80 py-2 border-t border-gray-200 backdrop-blur-sm z-40">
        © 2025 米克師｜採用 
        <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh_TW" target="_blank" class="text-sky-600 hover:underline">
            CC BY-NC-SA 4.0 創用CC授權
        </a>｜非商業用途歡迎轉載或改編，請保留署名並附上原始連結。
    </footer>

    <!-- 恭喜過關遮罩 -->
    <div id="success-overlay" class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm hidden">
        <div class="bg-white p-8 rounded-3xl shadow-2xl flex flex-col items-center animate-[popIn_0.4s_ease-out]">
            <div class="w-24 h-24 bg-green-100 rounded-full flex items-center justify-center mb-4">
                <i class="fas fa-check text-5xl text-green-500"></i>
            </div>
            <h2 class="text-3xl font-bold text-slate-800 mb-2">解題成功！</h2>
            <p class="text-slate-500 mb-6">步驟非常清楚喔！</p>
            <button onclick="nextQuestion()" class="bg-green-500 hover:bg-green-600 text-white text-xl font-bold py-3 px-10 rounded-xl shadow-lg transition transform hover:scale-105">
                下一題
            </button>
        </div>
    </div>

    <script>
        // --- 題庫資料 (更新為 1-6 題) ---
        const questions = [
            {
                // Q1 (原題 2): 2x(2x-3) - 3(3-2x)
                display: `2x(2x-3) <span class="highlight-red">- 3(3-2x)</span>`,
                step1: {
                    prefix: `2x(2x-3)`,
                    slots: [
                        { ans: '+' },
                        { ans: '3' }, 
                        { ans: '(2x-3)' }
                    ],
                    options: ['+', '-', '3', '(2x-3)', '(3-2x)']
                },
                step2: {
                    slots: [
                        { ans: '(2x-3)' },
                        { ans: '(2x+3)' }
                    ],
                    options: ['(2x-3)', '(2x+3)', '(2x-3)']
                }
            },
            {
                // Q2 (原題 3): x(x-1) - (1-x)(2x-5)
                display: `x(x-1) <span class="highlight-red">- (1-x)(2x-5)</span>`,
                step1: {
                    prefix: `x(x-1)`,
                    slots: [
                        { ans: '+' },
                        { ans: '(x-1)' }, 
                        { ans: '(2x-5)' }
                    ],
                    options: ['+', '-', '(x-1)', '(1-x)', '(2x-5)']
                },
                step2: {
                    slots: [
                        { ans: '(x-1)' },
                        { ans: '(3x-5)' } // x + 2x - 5
                    ],
                    options: ['(x-1)', '(3x-5)', '(x+2x-5)', '(2x-5)']
                }
            },
            {
                // Q3 (原題 4): 2(4x-3) - 3x(3-4x)
                display: `2(4x-3) <span class="highlight-red">- 3x(3-4x)</span>`,
                step1: {
                    prefix: `2(4x-3)`,
                    slots: [
                        { ans: '+' },
                        { ans: '3x' }, 
                        { ans: '(4x-3)' }
                    ],
                    options: ['+', '-', '3x', '(4x-3)', '(3-4x)']
                },
                step2: {
                    slots: [
                        { ans: '(4x-3)' },
                        { ans: '(2+3x)' }
                    ],
                    options: ['(4x-3)', '(2+3x)', '(2-3x)']
                }
            },
            {
                // Q4 (原題 5): (3x+5)^2 + x(-3x-5)
                // 變號：+ x(-(3x+5)) -> - x(3x+5)
                display: `(3x+5)<sup class="text-sm">2</sup> <span class="highlight-red">+ x(-3x-5)</span>`,
                step1: {
                    prefix: `(3x+5)²`,
                    slots: [
                        { ans: '-' },
                        { ans: 'x' }, 
                        { ans: '(3x+5)' }
                    ],
                    options: ['+', '-', 'x', '(3x+5)', '(-3x-5)']
                },
                step2: {
                    slots: [
                        { ans: '(3x+5)' },
                        { ans: '(2x+5)' } // 3x+5 - x
                    ],
                    options: ['(3x+5)', '(2x+5)', '(4x+5)', '(3x+5-x)']
                }
            },
            {
                // Q5 (原題 6): 2x(2x-7) + (7-2x)(x+7)
                // 變號：+ (-(2x-7))(x+7) -> - (2x-7)(x+7)
                display: `2x(2x-7) <span class="highlight-red">+ (7-2x)(x+7)</span>`,
                step1: {
                    prefix: `2x(2x-7)`,
                    slots: [
                        { ans: '-' },
                        { ans: '(2x-7)' }, 
                        { ans: '(x+7)' }
                    ],
                    options: ['+', '-', '(2x-7)', '(7-2x)', '(x+7)']
                },
                step2: {
                    slots: [
                        { ans: '(2x-7)' },
                        { ans: '(x-7)' } // 2x - (x+7) = 2x - x - 7 = x - 7
                    ],
                    options: ['(2x-7)', '(x-7)', '(3x+7)', '(x+7)']
                }
            },
            {
                // Q6 (原題 7): (x-2)(4x-1) - 3x(2-x)
                // 變號：- 3x(-(x-2)) -> + 3x(x-2)
                display: `(x-2)(4x-1) <span class="highlight-red">- 3x(2-x)</span>`,
                step1: {
                    prefix: `(x-2)(4x-1)`,
                    slots: [
                        { ans: '+' },
                        { ans: '3x' }, 
                        { ans: '(x-2)' }
                    ],
                    options: ['+', '-', '3x', '(x-2)', '(2-x)']
                },
                step2: {
                    slots: [
                        { ans: '(x-2)' },
                        { ans: '(7x-1)' } // 4x-1 + 3x = 7x-1
                    ],
                    options: ['(x-2)', '(7x-1)', '(x-1)', '(4x-1)']
                }
            }
        ];

        let currentQIdx = 0;
        let currentStep = 1; // 1 or 2
        let filledSlots = {}; // { slotIndex: value }

        // DOM Elements
        const qDisplay = document.getElementById('question-display');
        const step1Box = document.getElementById('step1-container');
        const step1SlotsDiv = document.getElementById('step1-slots');
        const step2Box = document.getElementById('step2-container');
        const step2Preview = document.getElementById('step2-preview');
        const step2SlotsDiv = document.getElementById('step2-slots');
        const optionsContainer = document.getElementById('options-container');
        const progressText = document.getElementById('progress-text');
        const successOverlay = document.getElementById('success-overlay');

        function initGame() {
            loadQuestion(0);
            document.getElementById('prev-btn').onclick = () => {
                if(currentQIdx > 0) loadQuestion(currentQIdx - 1);
            };
            document.getElementById('next-btn').onclick = () => {
                if(currentQIdx < questions.length - 1) loadQuestion(currentQIdx + 1);
            };
        }

        function loadQuestion(idx) {
            currentQIdx = idx;
            currentStep = 1;
            filledSlots = {};
            
            // Update Progress UI
            progressText.innerText = `第 ${idx + 1} / ${questions.length} 題`;
            document.getElementById('prev-btn').disabled = idx === 0;
            document.getElementById('next-btn').disabled = idx === questions.length - 1;
            
            const q = questions[idx];
            qDisplay.innerHTML = q.display;

            // Reset Step UI
            step1Box.classList.remove('done', 'locked');
            step1Box.classList.add('active');
            document.getElementById('step1-icon').className = 'fas fa-pen text-blue-400 text-xl';
            
            step2Box.classList.remove('active', 'done');
            step2Box.classList.add('locked');
            document.getElementById('step2-icon').className = 'fas fa-lock text-slate-300 text-xl';
            step2Preview.innerHTML = '';

            // Render Step 1
            renderStep1();
        }

        function renderStep1() {
            const q = questions[currentQIdx];
            step1SlotsDiv.innerHTML = '';
            
            // Prefix
            const prefixSpan = document.createElement('span');
            prefixSpan.className = 'mr-2';
            prefixSpan.innerText = q.step1.prefix;
            step1SlotsDiv.appendChild(prefixSpan);

            // Slots
            q.step1.slots.forEach((slot, i) => {
                const el = document.createElement('div');
                el.className = 'slot';
                el.dataset.idx = i;
                el.onclick = () => removeSlotValue(i);
                step1SlotsDiv.appendChild(el);
            });

            renderOptions(q.step1.options);
        }

        function renderStep2() {
            const q = questions[currentQIdx];
            step2SlotsDiv.innerHTML = '';
            
            // Preview Step 1 result
            let resultStr = q.step1.prefix + ' ';
            q.step1.slots.forEach(s => resultStr += s.ans + ' ');
            step2Preview.innerText = resultStr;

            // Slots for Step 2
            q.step2.slots.forEach((slot, i) => {
                const el = document.createElement('div');
                el.className = 'slot';
                el.style.minWidth = '6rem';
                el.dataset.idx = i;
                el.onclick = () => removeSlotValue(i);
                step2SlotsDiv.appendChild(el);
            });

            renderOptions(q.step2.options);
        }

        function renderOptions(opts) {
            optionsContainer.innerHTML = '';
            const shuffled = [...opts].sort(() => Math.random() - 0.5);
            shuffled.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'option-card';
                btn.innerText = opt;
                btn.onclick = () => handleOptionClick(opt);
                optionsContainer.appendChild(btn);
            });
        }

        function handleOptionClick(val) {
            const container = currentStep === 1 ? step1SlotsDiv : step2SlotsDiv;
            const emptySlot = Array.from(container.querySelectorAll('.slot')).find(el => !el.innerText);
            
            if (emptySlot) {
                const idx = emptySlot.dataset.idx;
                filledSlots[idx] = val;
                emptySlot.innerText = val;
                emptySlot.classList.add('filled');
                
                // Check if full
                const allSlots = container.querySelectorAll('.slot');
                const isFull = Array.from(allSlots).every(el => el.innerText);
                if (isFull) {
                    checkAnswer();
                }
            }
        }

        function removeSlotValue(idx) {
            const container = currentStep === 1 ? step1SlotsDiv : step2SlotsDiv;
            const slot = container.querySelector(`.slot[data-idx="${idx}"]`);
            if (slot && !slot.classList.contains('correct')) {
                delete filledSlots[idx];
                slot.innerText = '';
                slot.classList.remove('filled', 'wrong');
            }
        }

        function resetCurrentStep() {
            filledSlots = {};
            if (currentStep === 1) renderStep1();
            else renderStep2();
        }

        function checkAnswer() {
            const q = questions[currentQIdx];
            const targetSlots = currentStep === 1 ? q.step1.slots : q.step2.slots;
            const container = currentStep === 1 ? step1SlotsDiv : step2SlotsDiv;
            const uiSlots = container.querySelectorAll('.slot');
            
            let allCorrect = true;

            if (currentStep === 1) {
                // Step 1: Strict order
                uiSlots.forEach((slot, i) => {
                    if (slot.innerText === targetSlots[i].ans) {
                        slot.classList.add('correct');
                        slot.classList.remove('filled');
                    } else {
                        slot.classList.add('wrong');
                        allCorrect = false;
                    }
                });
            } else {
                // Step 2: Allow commutative property (A)(B) == (B)(A)
                const userAns = Array.from(uiSlots).map(s => s.innerText);
                const correctSet = targetSlots.map(s => s.ans);
                
                const case1 = (userAns[0] === correctSet[0] && userAns[1] === correctSet[1]);
                const case2 = (userAns[0] === correctSet[1] && userAns[1] === correctSet[0]);
                
                if (case1 || case2) {
                    uiSlots.forEach(slot => slot.classList.add('correct'));
                } else {
                    uiSlots.forEach(slot => slot.classList.add('wrong'));
                    allCorrect = false;
                }
            }

            if (allCorrect) {
                if (currentStep === 1) {
                    setTimeout(() => {
                        step1Box.classList.remove('active');
                        step1Box.classList.add('done');
                        document.getElementById('step1-icon').className = 'fas fa-check-circle text-green-500 text-xl';
                        
                        step2Box.classList.remove('locked');
                        step2Box.classList.add('active');
                        document.getElementById('step2-icon').className = 'fas fa-pen text-blue-400 text-xl';
                        
                        currentStep = 2;
                        filledSlots = {};
                        renderStep2();
                        step2Box.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 800);
                } else {
                    setTimeout(() => {
                         successOverlay.classList.remove('hidden');
                    }, 500);
                }
            } else {
                setTimeout(() => {
                    uiSlots.forEach(slot => {
                        if (slot.classList.contains('wrong')) {
                            slot.classList.remove('wrong');
                            slot.innerText = '';
                            delete filledSlots[slot.dataset.idx];
                        }
                    });
                }, 1000);
            }
        }

        function nextQuestion() {
            successOverlay.classList.add('hidden');
            if (currentQIdx < questions.length - 1) {
                loadQuestion(currentQIdx + 1);
            } else {
                alert("恭喜你！全數通關！");
            }
        }

        initGame();

    </script>
</body>
</html>
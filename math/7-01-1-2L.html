<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>正負數學習單圖形版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;600;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        .bounce-in {
            animation: bounceIn 0.6s ease-out;
        }
        @keyframes bounceIn {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        .fade-out {
            animation: fadeOut 0.8s ease-out forwards;
        }
        @keyframes fadeOut {
            0% { opacity: 1; transform: scale(1); }
            100% { opacity: 0; transform: scale(0.8); }
        }
        .move-to-center {
            transition: all 0.8s ease-in-out;
        }
        @keyframes explosion {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 1; }
            50% { transform: translate(-50%, -50%) scale(1.5); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(2); opacity: 0; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-100 to-purple-100 min-h-screen p-4">
    <div class="max-w-4xl mx-auto">
        <!-- 標題 -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-purple-800 mb-2">正負數學習單</h1>
            <p class="text-xl text-gray-700">用顏色和圖示學習正負數運算</p>
        </div>

        <!-- 說明區域 -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-8">
            <h2 class="text-2xl font-bold text-center mb-4 text-gray-800">學習步驟</h2>
            <div class="grid md:grid-cols-3 gap-4">
                <div class="text-center p-4 bg-blue-50 rounded-xl">
                    <div class="text-3xl mb-2">1️⃣</div>
                    <p class="font-semibold text-blue-800">看看正數還是負數比較多</p>
                </div>
                <div class="text-center p-4 bg-green-50 rounded-xl">
                    <div class="text-3xl mb-2">2️⃣</div>
                    <p class="font-semibold text-green-800">相同符號：相加</p>
                </div>
                <div class="text-center p-4 bg-orange-50 rounded-xl">
                    <div class="text-3xl mb-2">3️⃣</div>
                    <p class="font-semibold text-orange-800">不同符號：互相抵消</p>
                </div>
            </div>
        </div>

        <!-- 圖示說明 -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-8">
            <h3 class="text-xl font-bold text-center mb-4 text-gray-800">圖示說明</h3>
            <div class="flex justify-center gap-8">
                <div class="text-center">
                    <div class="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center text-white text-2xl font-bold mx-auto mb-2">+</div>
                    <p class="font-semibold text-green-700">正數（綠色圓圈）</p>
                </div>
                <div class="text-center">
                    <div class="w-12 h-12 bg-red-500 rounded-full flex items-center justify-center text-white text-2xl font-bold mx-auto mb-2">-</div>
                    <p class="font-semibold text-red-700">負數（紅色圓圈）</p>
                </div>
            </div>
        </div>

        <!-- 練習區域 -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-8">
            <h3 class="text-2xl font-bold text-center mb-6 text-gray-800">開始練習</h3>
            
            <!-- 題型切換欄 -->
            <div class="mb-6">
                <h4 class="text-lg font-bold text-center mb-4 text-gray-700">選擇題型</h4>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-4">
                    <button onclick="selectType(0)" id="typeBtn0" class="type-btn bg-blue-100 hover:bg-blue-200 text-blue-800 font-semibold py-2 px-3 rounded-lg text-sm transition-colors">正數減正數</button>
                    <button onclick="selectType(1)" id="typeBtn1" class="type-btn bg-green-100 hover:bg-green-200 text-green-800 font-semibold py-2 px-3 rounded-lg text-sm transition-colors">負數加正數</button>
                    <button onclick="selectType(2)" id="typeBtn2" class="type-btn bg-red-100 hover:bg-red-200 text-red-800 font-semibold py-2 px-3 rounded-lg text-sm transition-colors">負數減正數</button>
                    <button onclick="selectType(3)" id="typeBtn3" class="type-btn bg-purple-100 hover:bg-purple-200 text-purple-800 font-semibold py-2 px-3 rounded-lg text-sm transition-colors">正數減負數</button>
                    <button onclick="selectType(4)" id="typeBtn4" class="type-btn bg-orange-100 hover:bg-orange-200 text-orange-800 font-semibold py-2 px-3 rounded-lg text-sm transition-colors">正數加負數</button>
                    <button onclick="selectType(5)" id="typeBtn5" class="type-btn bg-pink-100 hover:bg-pink-200 text-pink-800 font-semibold py-2 px-3 rounded-lg text-sm transition-colors">負數加負數</button>
                    <button onclick="selectType(6)" id="typeBtn6" class="type-btn bg-indigo-100 hover:bg-indigo-200 text-indigo-800 font-semibold py-2 px-3 rounded-lg text-sm transition-colors">負數減負數</button>
                    <button onclick="selectRandomType()" class="bg-yellow-400 hover:bg-yellow-500 text-yellow-900 font-bold py-2 px-3 rounded-lg text-sm transition-colors">🎲 隨機</button>
                </div>
            </div>
            
            <!-- 題目生成按鈕 -->
            <div class="text-center mb-6">
                <button onclick="generateProblem()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-8 rounded-full text-xl transition-colors">
                    🎯 產生題目
                </button>
            </div>

            <!-- 題目顯示區 -->
            <div id="problemArea" class="text-center mb-8">
                <p class="text-gray-500 text-lg">點擊上方按鈕開始練習</p>
            </div>

            <!-- 視覺化區域 -->
            <div id="visualArea" class="mb-8"></div>



            <!-- 答案區域 -->
            <div id="answerArea" class="text-center"></div>
        </div>
    </div>

    <script>
        let currentProblem = null;
        let currentQuestionIndex = 0;
        let currentTypeIndex = 0;
        
        // 定義題型模板和對應的題目
        const questionTypes = [
            { type: "正數減正數", template: "a - b", examples: [[10, 8], [9, 3], [7, 5]] },
            { type: "負數加正數", template: "-a + b", examples: [[-8, 10], [-5, 9], [-3, 7]] },
            { type: "負數減正數", template: "-a - b", examples: [[-8, 10], [-6, 4], [-9, 2]] },
            { type: "正數減負數", template: "a - (-b)", examples: [[10, -8], [7, -3], [5, -6]] },
            { type: "正數加負數", template: "a + (-b)", examples: [[10, -8], [8, -5], [6, -9]] },
            { type: "負數加負數", template: "-a + (-b)", examples: [[-8, -10], [-4, -6], [-3, -7]] },
            { type: "負數減負數", template: "-a - (-b)", examples: [[-8, -10], [-5, -3], [-9, -4]] }
        ];

        function generateProblem() {
            // 重置視覺區域
            document.getElementById('visualArea').innerHTML = '';
            
            // 獲取當前題型和題目
            const currentType = questionTypes[currentTypeIndex];
            const currentExample = currentType.examples[currentQuestionIndex];
            
            let num1, num2, operator, displayText;
            
            switch(currentTypeIndex) {
                case 0: // 正數減正數
                    num1 = currentExample[0];
                    num2 = currentExample[1];
                    operator = '-';
                    displayText = `${num1} - ${num2} = ?`;
                    break;
                case 1: // 負數加正數
                    num1 = currentExample[0];
                    num2 = currentExample[1];
                    operator = '+';
                    displayText = `${num1} + ${num2} = ?`;
                    break;
                case 2: // 負數減正數
                    num1 = currentExample[0];
                    num2 = currentExample[1];
                    operator = '-';
                    displayText = `${num1} - ${num2} = ?`;
                    break;
                case 3: // 正數減負數
                    num1 = currentExample[0];
                    num2 = currentExample[1];
                    operator = '-';
                    displayText = `${num1} - (${num2}) = ?`;
                    break;
                case 4: // 正數加負數
                    num1 = currentExample[0];
                    num2 = currentExample[1];
                    operator = '+';
                    displayText = `${num1} + (${num2}) = ?`;
                    break;
                case 5: // 負數加負數
                    num1 = currentExample[0];
                    num2 = currentExample[1];
                    operator = '+';
                    displayText = `${num1} + (${num2}) = ?`;
                    break;
                case 6: // 負數減負數
                    num1 = currentExample[0];
                    num2 = currentExample[1];
                    operator = '-';
                    displayText = `${num1} - (${num2}) = ?`;
                    break;
            }
            
            // 計算答案
            let answer;
            switch(currentTypeIndex) {
                case 0: // 正數減正數: a - b
                    answer = num1 - num2;
                    break;
                case 1: // 負數加正數: -a + b
                    answer = num1 + num2;
                    break;
                case 2: // 負數減正數: -a - b
                    answer = num1 - num2;
                    break;
                case 3: // 正數減負數: a - (-b) = a + b
                    answer = num1 + Math.abs(num2);
                    break;
                case 4: // 正數加負數: a + (-b) = a - b
                    answer = num1 + num2;
                    break;
                case 5: // 負數加負數: -a + (-b)
                    answer = num1 + num2;
                    break;
                case 6: // 負數減負數: -a - (-b) = -a + b
                    answer = num1 + Math.abs(num2);
                    break;
            }
            
            currentProblem = { 
                num1, 
                num2, 
                operator, 
                answer, 
                displayText,
                typeIndex: currentTypeIndex,
                typeName: currentType.type
            };
            
            displayProblem();
            createVisualization();
            
            // 更新題目計數器
            updateQuestionCounter();
        }

        function displayProblem() {
            const problemArea = document.getElementById('problemArea');
            const { displayText, typeName } = currentProblem;
            
            problemArea.innerHTML = `
                <div class="mb-2 text-lg font-semibold text-purple-600">${typeName}</div>
                <div class="text-4xl font-bold text-gray-800 mb-4">${displayText}</div>
            `;
        }

        function createVisualization() {
            const visualArea = document.getElementById('visualArea');
            const { num1, num2, typeIndex } = currentProblem;
            
            // 檢查是否有括號需要去除（後四種題型都有括號）
            if (typeIndex >= 3) { // 有括號的題型
                // 先顯示去括號步驟，不顯示圓圈
                showBracketRemoval();
                return;
            }
            
            let html = '<div class="text-center">';
            html += '<h4 class="text-xl font-bold mb-4 text-gray-700">視覺化表示</h4>';
            html += '<div id="circleContainer" class="flex flex-wrap justify-center gap-2 mb-6 min-h-[120px]">';
            
            let circleId = 0;
            
            // 第一組數字
            html += '<div class="flex flex-wrap justify-center gap-2" id="group1">';
            for (let i = 0; i < Math.abs(num1); i++) {
                const color = num1 > 0 ? 'bg-green-500' : 'bg-red-500';
                const sign = num1 > 0 ? '+' : '-';
                html += `<div id="circle${circleId}" class="w-10 h-10 ${color} rounded-full flex items-center justify-center text-white font-bold bounce-in circle" style="animation-delay: ${i * 0.1}s" data-value="${num1 > 0 ? 1 : -1}">${sign}</div>`;
                circleId++;
            }
            html += '</div>';
            
            // 運算符號顯示
            html += '<div class="w-full flex justify-center my-4">';
            html += `<div class="text-3xl font-bold text-gray-600">${currentProblem.operator}</div>`;
            html += '</div>';
            
            // 第二組數字
            html += '<div class="flex flex-wrap justify-center gap-2" id="group2">';
            
            // 根據題型決定第二組的顯示方式
            let secondGroupValue, secondGroupColor, secondGroupSign, secondGroupDataValue;
            
            if (typeIndex === 0) { // 正數減正數: a - b (顯示要被減掉的正數，用紅色表示會被拿走)
                secondGroupValue = num2;
                secondGroupColor = 'bg-red-500'; // 用紅色表示會被減掉
                secondGroupSign = '-';
                secondGroupDataValue = -1; // 標記為負值用於抵消
            } else if (typeIndex === 2) { // 負數減正數: -a - b
                secondGroupValue = num2;
                secondGroupColor = 'bg-red-500'; // 減法讓正數變成負數
                secondGroupSign = '-';
                secondGroupDataValue = -1;
            } else {
                secondGroupValue = Math.abs(num2);
                secondGroupColor = num2 > 0 ? 'bg-green-500' : 'bg-red-500';
                secondGroupSign = num2 > 0 ? '+' : '-';
                secondGroupDataValue = num2 > 0 ? 1 : -1;
            }
            
            for (let i = 0; i < secondGroupValue; i++) {
                html += `<div id="circle${circleId}" class="w-10 h-10 ${secondGroupColor} rounded-full flex items-center justify-center text-white font-bold bounce-in circle" style="animation-delay: ${(Math.abs(num1) + i) * 0.1}s" data-value="${secondGroupDataValue}">${secondGroupSign}</div>`;
                circleId++;
            }
            html += '</div>';
            
            html += '</div>';
            
            // 抵消按鈕
            html += '<button onclick="showCancellation()" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-8 rounded-full mb-4 text-lg">🎬 看動畫</button>';
            
            html += '</div>';
            visualArea.innerHTML = html;
        }

        function showCancellation() {
            const circles = document.querySelectorAll('.circle');
            const positiveCircles = Array.from(circles).filter(c => c.dataset.value === '1');
            const negativeCircles = Array.from(circles).filter(c => c.dataset.value === '-1');
            
            // 判斷是同號合併還是異號抵消
            if (positiveCircles.length > 0 && negativeCircles.length > 0) {
                // 異號抵消
                const minCount = Math.min(positiveCircles.length, negativeCircles.length);
                
                // 執行抵消動畫
                for (let i = 0; i < minCount; i++) {
                    setTimeout(() => {
                        animateCancellation(positiveCircles[i], negativeCircles[i]);
                    }, i * 300);
                }
                
                // 顯示下一題按鈕
                setTimeout(() => {
                    showNextQuestionButton();
                }, minCount * 300 + 1000);
            } else {
                // 同號合併
                const allCircles = positiveCircles.length > 0 ? positiveCircles : negativeCircles;
                animateMerging(allCircles);
                
                // 顯示下一題按鈕
                setTimeout(() => {
                    showNextQuestionButton();
                }, 1500);
            }
        }
        
        function showNextQuestionButton() {
            const visualArea = document.getElementById('visualArea');
            const buttonHtml = '<div class="text-center mt-6"><button onclick="nextQuestion()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-full text-lg">➡️ 下一題</button></div>';
            visualArea.insertAdjacentHTML('beforeend', buttonHtml);
        }

        function showBracketRemoval() {
            const { displayText, typeIndex } = currentProblem;
            const problemArea = document.getElementById('problemArea');
            const visualArea = document.getElementById('visualArea');
            
            // 顯示去括號步驟
            let stepHtml = '<div class="mb-4 p-4 bg-yellow-50 rounded-lg border-2 border-yellow-300">';
            stepHtml += '<h4 class="text-lg font-bold text-yellow-800 mb-2">步驟1：去括號</h4>';
            stepHtml += '<div class="text-2xl font-bold text-gray-800 mb-2">';
            
            if (typeIndex === 3) { // 正數減負數
                stepHtml += `= ${currentProblem.num1} + ${Math.abs(currentProblem.num2)}`;
            } else if (typeIndex === 4) { // 正數加負數
                stepHtml += `= ${currentProblem.num1} - ${Math.abs(currentProblem.num2)}`;
            } else if (typeIndex === 5) { // 負數加負數
                stepHtml += `= ${currentProblem.num1} - ${Math.abs(currentProblem.num2)}`;
            } else if (typeIndex === 6) { // 負數減負數
                stepHtml += `= ${currentProblem.num1} + ${Math.abs(currentProblem.num2)}`;
            }
            
            stepHtml += '</div>';
            if (typeIndex === 3 || typeIndex === 6) {
                stepHtml += '<div class="text-sm text-yellow-700">減負數 = 加正數</div>';
            } else {
                stepHtml += '<div class="text-sm text-yellow-700">加負數 = 減正數</div>';
            }
            stepHtml += '</div>';
            
            // 在題目區域下方插入去括號說明
            const existingContent = problemArea.innerHTML;
            problemArea.innerHTML = existingContent + stepHtml;
            
            // 顯示按鈕讓使用者控制下一步
            visualArea.innerHTML = '<div class="text-center"><button onclick="showCirclesAfterBracket()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-full text-lg">🎬 看動畫</button></div>';
        }
        
        function showCirclesAfterBracket() {
            // 顯示圓圈
            createCirclesAfterBracketRemoval();
            
            // 顯示動畫按鈕
            const visualArea = document.getElementById('visualArea');
            const buttonHtml = '<div class="text-center mt-6"><button onclick="startCancellationAnimation()" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-8 rounded-full text-lg">🎬 看動畫</button></div>';
            visualArea.insertAdjacentHTML('beforeend', buttonHtml);
        }
        
        function startCancellationAnimation() {
            const circles = document.querySelectorAll('.circle');
            const positiveCircles = Array.from(circles).filter(c => c.dataset.value === '1');
            const negativeCircles = Array.from(circles).filter(c => c.dataset.value === '-1');
            
            // 移除按鈕
            const button = document.querySelector('button[onclick="startCancellationAnimation()"]');
            if (button) button.parentElement.remove();
            
            // 判斷是同號合併還是異號抵消
            if (positiveCircles.length > 0 && negativeCircles.length > 0) {
                // 異號抵消
                const minCount = Math.min(positiveCircles.length, negativeCircles.length);
                
                // 執行抵消動畫
                for (let i = 0; i < minCount; i++) {
                    setTimeout(() => {
                        animateCancellation(positiveCircles[i], negativeCircles[i]);
                    }, i * 300);
                }
                
                // 顯示下一題按鈕
                setTimeout(() => {
                    showNextQuestionButton();
                }, minCount * 300 + 1000);
            } else {
                // 同號合併
                const allCircles = positiveCircles.length > 0 ? positiveCircles : negativeCircles;
                animateMerging(allCircles);
                
                // 顯示下一題按鈕
                setTimeout(() => {
                    showNextQuestionButton();
                }, 1500);
            }
        }
        
        function createCirclesAfterBracketRemoval() {
            const visualArea = document.getElementById('visualArea');
            const { num1, num2, typeIndex } = currentProblem;
            
            let html = '<div class="text-center">';
            html += '<h4 class="text-xl font-bold mb-4 text-gray-700">視覺化表示</h4>';
            html += '<div id="circleContainer" class="flex flex-wrap justify-center gap-2 mb-6 min-h-[120px]">';
            
            let circleId = 0;
            
            // 第一組數字
            html += '<div class="flex flex-wrap justify-center gap-2" id="group1">';
            for (let i = 0; i < Math.abs(num1); i++) {
                const color = num1 > 0 ? 'bg-green-500' : 'bg-red-500';
                const sign = num1 > 0 ? '+' : '-';
                html += `<div id="circle${circleId}" class="w-10 h-10 ${color} rounded-full flex items-center justify-center text-white font-bold bounce-in circle" style="animation-delay: ${i * 0.1}s" data-value="${num1 > 0 ? 1 : -1}">${sign}</div>`;
                circleId++;
            }
            html += '</div>';
            
            // 運算符號顯示（根據去括號後的結果）
            html += '<div class="w-full flex justify-center my-4">';
            let operatorSymbol = '+';
            if (typeIndex === 4 || typeIndex === 5) { // 加負數變減正數
                operatorSymbol = '-';
            }
            html += `<div class="text-3xl font-bold text-gray-600">${operatorSymbol}</div>`;
            html += '</div>';
            
            // 第二組數字（根據去括號後的結果）
            html += '<div class="flex flex-wrap justify-center gap-2" id="group2">';
            
            let secondGroupColor, secondGroupSign, secondGroupDataValue;
            if (typeIndex === 3 || typeIndex === 6) { // 減負數變加正數
                secondGroupColor = 'bg-green-500';
                secondGroupSign = '+';
                secondGroupDataValue = 1;
            } else { // 加負數變減正數
                secondGroupColor = 'bg-red-500';
                secondGroupSign = '-';
                secondGroupDataValue = -1;
            }
            
            for (let i = 0; i < Math.abs(num2); i++) {
                html += `<div id="circle${circleId}" class="w-10 h-10 ${secondGroupColor} rounded-full flex items-center justify-center text-white font-bold bounce-in circle" style="animation-delay: ${(Math.abs(num1) + i) * 0.1}s" data-value="${secondGroupDataValue}">${secondGroupSign}</div>`;
                circleId++;
            }
            html += '</div>';
            
            html += '</div>';
            html += '</div>';
            
            visualArea.innerHTML = html;
        }

        function animateCancellation(circle1, circle2) {
            // 獲取兩個圓圈的位置
            const rect1 = circle1.getBoundingClientRect();
            const rect2 = circle2.getBoundingClientRect();
            
            // 計算中點
            const midX = (rect1.left + rect2.left) / 2;
            const midY = (rect1.top + rect2.top) / 2;
            
            // 讓兩個圓圈移動到中點
            circle1.style.transition = 'all 0.8s ease-in-out';
            circle2.style.transition = 'all 0.8s ease-in-out';
            circle1.style.transform = `translate(${midX - rect1.left - rect1.width/2}px, ${midY - rect1.top - rect1.height/2}px) scale(0.5)`;
            circle2.style.transform = `translate(${midX - rect2.left - rect2.width/2}px, ${midY - rect2.top - rect2.height/2}px) scale(0.5)`;
            
            // 在中點碰撞後消失
            setTimeout(() => {
                circle1.style.opacity = '0';
                circle2.style.opacity = '0';
                
                // 添加爆炸效果
                const explosion = document.createElement('div');
                explosion.innerHTML = '💥';
                explosion.style.position = 'absolute';
                explosion.style.left = midX + 'px';
                explosion.style.top = midY + 'px';
                explosion.style.fontSize = '24px';
                explosion.style.transform = 'translate(-50%, -50%)';
                explosion.style.animation = 'explosion 0.8s ease-out';
                document.body.appendChild(explosion);
                
                setTimeout(() => {
                    explosion.remove();
                }, 500);
            }, 800);
        }

        function animateMerging(circles) {
            if (circles.length === 0) return;
            
            // 計算容器的中心位置
            const container = document.getElementById('circleContainer');
            const containerRect = container.getBoundingClientRect();
            const centerX = containerRect.left + containerRect.width / 2;
            const centerY = containerRect.top + containerRect.height / 2;
            
            // 計算排列位置（每排最多10個）
            const spacing = 45; // 圓圈間距
            const rowSpacing = 50; // 行間距
            const maxPerRow = 10; // 每排最多10個
            const totalRows = Math.ceil(circles.length / maxPerRow);
            
            // 讓所有圓圈移動到排列位置
            circles.forEach((circle, index) => {
                const rect = circle.getBoundingClientRect();
                
                // 計算當前圓圈在第幾排、第幾個
                const rowIndex = Math.floor(index / maxPerRow);
                const colIndex = index % maxPerRow;
                const circlesInThisRow = Math.min(maxPerRow, circles.length - rowIndex * maxPerRow);
                
                // 計算這一排的起始X位置（居中）
                const rowWidth = (circlesInThisRow - 1) * spacing;
                const rowStartX = centerX - rowWidth / 2;
                
                // 計算目標位置
                const targetX = rowStartX + colIndex * spacing;
                const targetY = centerY - (totalRows - 1) * rowSpacing / 2 + rowIndex * rowSpacing;
                
                circle.style.transition = 'all 1s ease-in-out';
                circle.style.transform = `translate(${targetX - rect.left - rect.width/2}px, ${targetY - rect.top - rect.height/2}px)`;
                circle.style.zIndex = '10';
            });
            
            // 合併後產生閃光效果
            setTimeout(() => {
                // 添加合併效果
                const mergeEffect = document.createElement('div');
                mergeEffect.innerHTML = '✨';
                mergeEffect.style.position = 'absolute';
                mergeEffect.style.left = centerX + 'px';
                mergeEffect.style.top = centerY + 'px';
                mergeEffect.style.fontSize = '32px';
                mergeEffect.style.transform = 'translate(-50%, -50%)';
                mergeEffect.style.animation = 'explosion 1s ease-out';
                document.body.appendChild(mergeEffect);
                
                setTimeout(() => {
                    mergeEffect.remove();
                }, 1000);
            }, 1000);
        }



        function nextQuestion() {
            currentQuestionIndex++;
            
            // 如果當前題型的3題都做完了，換下一個題型
            if (currentQuestionIndex >= 3) {
                currentQuestionIndex = 0;
                currentTypeIndex++;
                
                // 如果所有題型都做完了，重新開始
                if (currentTypeIndex >= questionTypes.length) {
                    currentTypeIndex = 0;
                }
            }
            
            generateProblem();
        }

        function updateQuestionCounter() {
            const totalQuestions = currentTypeIndex * 3 + currentQuestionIndex + 1;
            const counterHtml = `<div class="text-center mb-4 text-lg font-semibold text-gray-600">
                題型：${questionTypes[currentTypeIndex].type} | 第 ${currentQuestionIndex + 1}/3 題 | 總進度：${totalQuestions}/21
            </div>`;
            
            document.getElementById('problemArea').insertAdjacentHTML('afterbegin', counterHtml);
        }



        function selectType(typeIndex) {
            currentTypeIndex = typeIndex;
            currentQuestionIndex = 0;
            
            // 更新按鈕樣式
            document.querySelectorAll('.type-btn').forEach(btn => {
                btn.classList.remove('bg-yellow-300', 'ring-2', 'ring-yellow-400');
            });
            document.getElementById(`typeBtn${typeIndex}`).classList.add('bg-yellow-300', 'ring-2', 'ring-yellow-400');
            
            generateProblem();
        }

        function selectRandomType() {
            const randomIndex = Math.floor(Math.random() * questionTypes.length);
            selectType(randomIndex);
        }

        // 初始化
        window.onload = function() {
            selectType(0); // 預設選擇第一個題型
        };
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98173c8fb7cd0758',t:'MTc1ODI2NTU0Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>

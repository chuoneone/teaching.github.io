<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4-1不等式解題步道</title>
    <link rel="icon" href="dog.png" type="image/png">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="tab-container">
        <button class="tab-button active" onclick="openSection(event, 'section1')">一、列不等式</button>
        <button class="tab-button" onclick="openSection(event, 'section2')">二、依情境列不等式</button>
        <button class="tab-button" onclick="openSection(event, 'section3')">三、判別不等式的解</button>
    </div>

    <div id="section1" class="content-section active">
        <div class="container">
            <h1>一、列不等式練習</h1>
            <h2>請根據題目敘述，填寫不等式的各個部分。</h2>
            <p><strong>小提示：</strong></p>
            <ul>
                <li><mark>大於</mark> 選 <mark>></mark></li>
                <li><mark>小於</mark> 選 <mark><</mark></li>
                <li><mark>大於或等於</mark> (或 <mark>不小於</mark>) 選 <mark>≥</mark></li>
                <li><mark>小於或等於</mark> (或 <mark>不大於</mark>) 選 <mark>≤</mark></li>
            </ul>
            <div class="progress" id="s1-progress-indicator"></div>
            <div class="problem-card">
                <div class="question" id="s1-question-text"></div>
                <div class="structured-input-container" id="s1-input-area"></div>
                <button class="action-btn" onclick="s1_checkAnswer()">檢查答案</button>
                <div class="feedback" id="s1-feedback-message"></div>
                <div class="explanation" id="s1-explanation-text" style="display:none;"></div>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="nav-btn" id="s1-prev-btn" onclick="s1_previousProblem()" disabled>上一題</button>
                <button class="nav-btn" id="s1-next-btn" onclick="s1_nextProblem()">下一題</button>
            </div>
        </div>
    </div>

    <div id="section2" class="content-section">
        <div class="container">
            <h1>二、依情境列不等式</h1>
            <h3>請仔細閱讀題目，並填寫符合情境的不等式。</h3>
            <p><strong>小提示：</strong></p>
            <ul>
                <li><mark>高於、超過</mark> 通常選 <mark>></mark></li>
                <li><mark>不到、小於</mark> 通常選 <mark><</mark></li>
                <li><mark>不超過、至多</mark> 通常選 <mark>≤</mark></li>
                <li><mark>不低於、至少</mark> 通常選 <mark>≥</mark></li>
            </ul>
            <div class="progress" id="s2-progress-indicator"></div>
            <div id="s2-pages-container"></div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="nav-btn" id="s2-prev-btn" onclick="s2_previousPage()" disabled>上一題</button>
                <button class="nav-btn" id="s2-next-btn" onclick="s2_nextPage()">下一題</button>
            </div>
        </div>
    </div>

    <div id="section3" class="content-section">
        <div class="container">
            <h1>三、判別不等式的解</h1>
            <h3 id="s3-problem-type-subtitle"></h3> 

            <div class="progress" id="s3-progress-indicator"></div>
            
            <div class="problem-card">
                <div class="s3-question-main" id="s3-question-text"></div>
                <div class="s3-number-line-display" id="s3-number-line"></div>
                <div id="s3-options-instruction" style="text-align:center; margin-bottom:10px; font-style:italic; color:#555;"></div>
                <div class="s3-options-container" id="s3-options-area"></div>
                
                <div style="text-align: center; margin-top: 15px; margin-bottom: 10px;">
                    <button class="action-btn" id="s3-check-answer-btn" onclick="s3_checkAnswer()">檢查答案</button>
                    <!-- 提示按鈕已移除 -->
                </div>

                <div class="feedback" id="s3-feedback-message"></div>
                
                <!-- 移項提示區域，用於直接顯示 -->
                <div class="s3-transposition-hint" id="s3-transposition-hint-area" style="display:none;">
                    <h4>移項小幫手：</h4>
                    <div id="s3-hint-steps-container">
                        <!-- 步驟會動態加入這裡 -->
                    </div>
                    <p id="s3-hint-conclusion" style="font-weight:bold; margin-top:10px;"></p>
                </div>
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button class="nav-btn" id="s3-prev-btn" onclick="s3_previousProblem()" disabled>上一題</button>
                <button class="nav-btn" id="s3-next-btn" onclick="s3_nextProblem()" disabled>下一題</button>
            </div>
        </div>
    </div>

    <script>
        // --- 通用函數 ---
        function normalizeAnswer(answer) { if (typeof answer !== 'string') return ''; return answer.replace(/\s+/g, '').toLowerCase(); }
        
        function createOperatorSelect(baseId, part) { const select = document.createElement('select'); select.id = `${baseId}-${part.id_suffix || 'op'}`; const operators = [ { text: '請選擇', value: ''}, { text: '>', value: '>' }, { text: '<', value: '<' }, { text: '≥', value: '≥' }, { text: '≤', value: '≤' } ]; operators.forEach(op => { const option = document.createElement('option'); option.value = op.value; option.textContent = op.text; select.appendChild(option); }); return select; }
        
        function createTextInput(baseId, part, index) { 
            const input = document.createElement('input'); 
            input.type = 'text'; 
            input.id = `${baseId}-${part.id_suffix || index}`; 
            input.placeholder = part.placeholder || ''; // 如果 placeholder 未定義，則為空
            return input; 
        }
        
        function createStructuredInput(problem, baseId, inputAreaId, problemIndexForEnter, checkFunction) { 
            const inputArea = document.getElementById(inputAreaId); 
            inputArea.innerHTML = ''; 
            problem.parts.forEach((part, index) => { 
                let element; 
                if (part.type === 'input') { 
                    element = createTextInput(baseId, part, index); 
                } else if (part.type === 'select') { 
                    element = createOperatorSelect(baseId, part); 
                } 
                if (element) { 
                    inputArea.appendChild(element); 
                    if (part.type === 'input') { 
                        element.addEventListener('keypress', function(event) { 
                            if (event.key === 'Enter') { 
                                event.preventDefault(); 
                                if (checkFunction && typeof problemIndexForEnter === 'number') { // 確保 problemIndexForEnter 是數字 (用於 s2)
                                    checkFunction(problemIndexForEnter); 
                                } else if (checkFunction && problemIndexForEnter === null) { // 用於 s1
                                    checkFunction();
                                }
                            } 
                        }); 
                    } 
                } 
            }); 
            if (inputArea.firstChild && inputArea.firstChild.focus) { 
                setTimeout(() => inputArea.firstChild.focus(), 0); 
            } 
        }
        
        function getAnswerFromStructuredInput(problem, baseId) { 
            let userAnswer = ""; 
            problem.parts.forEach((part, index) => { 
                const elementId = `${baseId}-${part.id_suffix || (part.type === 'input' ? index : 'op')}`; 
                const element = document.getElementById(elementId); 
                if (element) { 
                    userAnswer += element.value; 
                } 
            }); 
            return userAnswer; 
        }
        
        function checkAnswerLogic(userAnswerRaw, problem) { 
            const userAnswer = normalizeAnswer(userAnswerRaw); 
            const correctAnswers = problem.answers.map(ans => normalizeAnswer(ans)); 
            if (correctAnswers.includes(userAnswer)) { 
                return true; 
            } 
            if (problem.parts.length === 3 && problem.parts[1].type === 'select') { 
                const leftElement = document.getElementById(`${problem.baseId}-${problem.parts[0].id_suffix}`);
                const opElement = document.getElementById(`${problem.baseId}-${problem.parts[1].id_suffix}`);
                const rightElement = document.getElementById(`${problem.baseId}-${problem.parts[2].id_suffix}`);

                if(leftElement && opElement && rightElement){
                    const leftVal = normalizeAnswer(leftElement.value); 
                    const opVal = opElement.value; 
                    const rightVal = normalizeAnswer(rightElement.value); 
                    let inverseOp; 
                    if (opVal === '>') inverseOp = '<'; 
                    else if (opVal === '<') inverseOp = '>'; 
                    else if (opVal === '≥') inverseOp = '≤'; 
                    else if (opVal === '≤') inverseOp = '≥'; 
                    if (inverseOp) { 
                        const reversedUserAnswer = normalizeAnswer(rightVal + inverseOp + leftVal); 
                        if (correctAnswers.includes(reversedUserAnswer)) { 
                            return true; 
                        } 
                    } 
                }
            } 
            return false; 
        }

        // --- Section 1 Script ---
        const s1_problems = [ 
            { id: 1, question: "x <mark>大於</mark> 5", parts: [{ type: 'input', id_suffix: 'left' },{ type: 'select', id_suffix: 'op' },{ type: 'input', id_suffix: 'right' }], answers: ["x>5", "5<x"], explanation: "「大於」就是開口朝向比較大的那邊。x 比 5 大，所以是 x > 5。" },
            { id: 2, question: "－4a <mark>比</mark> 7 <mark>大</mark>", parts: [{ type: 'input', id_suffix: 'left' },{ type: 'select', id_suffix: 'op' },{ type: 'input', id_suffix: 'right' }], answers: ["-4a>7", "7<-4a"], explanation: "「-4a 比 7 大」意思就是 -4a 大於 7，所以是 -4a > 7。" },
            { id: 3, question: "3y－5 <mark>比</mark> 1 <mark>小</mark>", parts: [{ type: 'input', id_suffix: 'left' },{ type: 'select', id_suffix: 'op' },{ type: 'input', id_suffix: 'right' }], answers: ["3y-5<1", "1>3y-5"], explanation: "「3y-5 比 1 小」意思就是 3y-5 小於 1，所以是 3y-5 < 1。" },
            { id: 4, question: "x <mark>不大於</mark> －2", parts: [{ type: 'input', id_suffix: 'left' },{ type: 'select', id_suffix: 'op' },{ type: 'input', id_suffix: 'right' }], answers: ["x≤-2", "-2≥x"], explanation: "「不大於」就是「小於或等於」(≤)。x 不大於 -2，代表 x 可能等於 -2，或者比 -2 小，所以是 x ≤ -2。" },
            { id: 5, question: "－2x <mark>小於或等於</mark> 5", parts: [{ type: 'input', id_suffix: 'left' },{ type: 'select', id_suffix: 'op' },{ type: 'input', id_suffix: 'right' }], answers: ["-2x≤5", "5≥-2x"], explanation: "「小於或等於」直接選 ≤ 符號。所以是 -2x ≤ 5。" },
            { id: 6, question: "y <mark>不小於</mark> 6", parts: [{ type: 'input', id_suffix: 'left' },{ type: 'select', id_suffix: 'op' },{ type: 'input', id_suffix: 'right' }], answers: ["y≥6", "6≤y"], explanation: "「不小於」就是「大於或等於」(≥)。y 不小於 6，代表 y 可能等於 6，或者比 6 大，所以是 y ≥ 6。" },
            { id: 7, question: "x <mark>大於或等於</mark> y", parts: [{ type: 'input', id_suffix: 'left' },{ type: 'select', id_suffix: 'op' },{ type: 'input', id_suffix: 'right' }], answers: ["x≥y", "y≤x"], explanation: "「大於或等於」直接選 ≥ 符號。所以是 x ≥ y。" },
            { id: 8, question: "x <mark>大於</mark> －2，<mark>且</mark> <mark>小於</mark> 5", parts: [{ type: 'input', id_suffix: 'leftmost' },{ type: 'select', id_suffix: 'op1' },{ type: 'input', id_suffix: 'middle' },{ type: 'select', id_suffix: 'op2' },{ type: 'input', id_suffix: 'rightmost' }], answers: ["-2<x<5"], explanation: "這是一個範圍。x 比 -2 大，同時 x 比 5 小。可以寫成 -2 < x < 5。" }
        ].map(p => ({ ...p, baseId: 's1-input' }));
        let s1_currentProblemIndex = 0;
        const s1_questionTextEl = document.getElementById('s1-question-text'); 
        const s1_inputAreaEl = document.getElementById('s1-input-area');
        const s1_feedbackMessageEl = document.getElementById('s1-feedback-message'); 
        const s1_explanationTextEl = document.getElementById('s1-explanation-text'); 
        const s1_progressIndicatorEl = document.getElementById('s1-progress-indicator'); 
        const s1_prevBtn = document.getElementById('s1-prev-btn'); 
        const s1_nextBtn = document.getElementById('s1-next-btn');
        
        function s1_displayProblem() { 
            const problem = s1_problems[s1_currentProblemIndex]; 
            s1_questionTextEl.innerHTML = `題目 ${problem.id}: ${problem.question}`; 
            createStructuredInput(problem, 's1-input', 's1-input-area', null, s1_checkAnswer); 
            s1_feedbackMessageEl.textContent = ''; 
            s1_feedbackMessageEl.className = 'feedback'; 
            s1_explanationTextEl.style.display = 'none'; 
            s1_explanationTextEl.innerHTML = `<strong>提示/解說：</strong> ${problem.explanation}`; 
            s1_progressIndicatorEl.textContent = `進度: ${s1_currentProblemIndex + 1} / ${s1_problems.length}`; 
            s1_prevBtn.disabled = s1_currentProblemIndex === 0; 
            s1_nextBtn.disabled = s1_currentProblemIndex === s1_problems.length - 1; 
            const firstInputS1 = s1_inputAreaEl.querySelector('input[type="text"], select');
            if (firstInputS1) {setTimeout(()=>firstInputS1.focus(),0);}
        }
        
        function s1_checkAnswer() { 
            const problem = s1_problems[s1_currentProblemIndex]; 
            const userAnswerRaw = getAnswerFromStructuredInput(problem, 's1-input'); 
            if (checkAnswerLogic(userAnswerRaw, problem)) { 
                s1_feedbackMessageEl.textContent = '太棒了，答案正確！'; 
                s1_feedbackMessageEl.className = 'feedback correct'; 
            } else { 
                s1_feedbackMessageEl.textContent = '喔喔，答案不太對，再試一次看看！'; 
                s1_feedbackMessageEl.className = 'feedback incorrect'; 
            } 
            s1_explanationTextEl.style.display = 'block'; // 第一大題的解析在檢查後顯示
        }
        
        function s1_nextProblem() { 
            if (s1_currentProblemIndex < s1_problems.length - 1) { 
                s1_currentProblemIndex++; 
                s1_displayProblem(); 
            } 
        }
        
        function s1_previousProblem() { 
            if (s1_currentProblemIndex > 0) { 
                s1_currentProblemIndex--; 
                s1_displayProblem(); 
            } 
        }
        
        // --- Section 2 Script ---
        const movieInfoTableHTML = ` <p>下表是電影分級資訊：</p> <table class="info-table"> <thead><tr><th>分級</th><th>說明</th></tr></thead> <tbody> <tr><td>限制級（18＋）</td><td><mark>未滿十八歲</mark>之人<mark>不得觀賞</mark>。</td></tr> <tr><td>輔15級（15＋）</td><td><mark>未滿十五歲</mark>之人<mark>不得觀賞</mark>。</td></tr> <tr><td>輔12級（12＋）</td><td><mark>未滿十二歲</mark>之兒童<mark>不得觀賞</mark>。</td></tr> <tr><td>保護級（6＋）</td><td><mark>未滿六歲</mark>之兒童<mark>不得觀賞</mark>，<mark>六歲以上未滿十二歲</mark>之兒童須父母、師長或成年親友陪伴輔導觀賞。</td></tr> <tr><td>普遍級（0＋）</td><td>一般觀眾皆可觀賞。</td></tr> </tbody> </table>`;
        const s2_problems_template = [ 
            { id: 1, question: "治賢的身高為x公分，他身高的<mark>4倍</mark><mark>高於</mark>720公分。依據上述的情形列出一元一次不等式。", parts: [{ type: 'input', id_suffix: 'left' },{ type: 'select', id_suffix: 'op' },{ type: 'input', id_suffix: 'right' }], answers: ["4x>720", "720<4x"], explanation: "「身高的4倍」是 4x。「高於720」就是大於720。所以是 4x > 720。" },
            { id: 2, question: "怡如的體重為y公斤，她體重的<mark>一半減3公斤</mark>，<mark>超過</mark>25公斤。依據上述的情形列出一元一次不等式。", parts: [{ type: 'input', id_suffix: 'left' },{ type: 'select', id_suffix: 'op' },{ type: 'input', id_suffix: 'right' }], answers: ["y/2-3>25", "0.5y-3>25", "(1/2)y-3>25"], explanation: "「體重的一半」是 y/2 或 0.5y。「減3公斤」就是 -3。「超過25公斤」就是大於25。所以是 y/2 - 3 > 25。" },
            { id: 3, question: "心儀買了每塊x元的蛋糕<mark>5塊</mark>，總價<mark>不到</mark>100元。依據上述的情形列出一元一次不等式。", parts: [{ type: 'input', id_suffix: 'left' },{ type: 'select', id_suffix: 'op' },{ type: 'input', id_suffix: 'right' }], answers: ["5x<100", "100>5x"], explanation: "「每塊x元的蛋糕5塊」總價是 5x。「不到100元」就是小於100。所以是 5x < 100。" },
            { id: 4, question: "蓉蓉買每枝x元的原子筆<mark>3枝</mark>，每本y元的筆記簿<mark>4本</mark>，<mark>不超過</mark>100元。依據上述的情形列出一元一次不等式。", parts: [{ type: 'input', id_suffix: 'left' },{ type: 'select', id_suffix: 'op' },{ type: 'input', id_suffix: 'right' }], answers: ["3x+4y≤100", "100≥3x+4y"], explanation: "「原子筆3枝」總價 3x。「筆記簿4本」總價 4y。總共花費 3x + 4y。「不超過100元」就是小於或等於100。所以是 3x + 4y ≤ 100。" },
            { id: 5, question: "義信與父母分別為x、y、z歲，三人的年齡<mark>總和</mark><mark>不低於</mark>100歲。依據上述的情形列出一元一次不等式。", parts: [{ type: 'input', id_suffix: 'left' },{ type: 'select', id_suffix: 'op' },{ type: 'input', id_suffix: 'right' }], answers: ["x+y+z≥100", "100≤x+y+z"], explanation: "「三人的年齡總和」是 x + y + z。「不低於100歲」就是大於或等於100。所以是 x + y + z ≥ 100。" },
            { id: 6, question: movieInfoTableHTML + "<p>(1)若阿信的年齡x歲，<mark>可以購買限制級</mark>的票，試以不等式表示x的範圍。</p>", parts: [{ type: 'input', id_suffix: 'left' },{ type: 'select', id_suffix: 'op' },{ type: 'input', id_suffix: 'right' }], answers: ["x≥18", "18≤x"], explanation: "「限制級」是未滿十八歲不得觀賞。所以「可以購買」代表阿信的年齡 x 必須大於或等於18歲。即 x ≥ 18。" },
            { id: 7, question: movieInfoTableHTML + "<p>(2)若小歐的年齡y歲，<mark>可以看保護級</mark><mark>但不能看輔12級</mark>，試以不等式表示y的範圍。</p>", parts: [{ type: 'input', id_suffix: 'leftmost' },{ type: 'select', id_suffix: 'op1' },{ type: 'input', id_suffix: 'middle' },{ type: 'select', id_suffix: 'op2' },{ type: 'input', id_suffix: 'rightmost' }], answers: ["6≤y<12"], explanation: "「可以看保護級」代表年齡 y 至少6歲 (y ≥ 6)。「不能看輔12級」代表年齡 y 未滿12歲 (y < 12)。合併起來就是 6 ≤ y < 12。" }
        ];
        const s2_problems = s2_problems_template.map((p, index) => ({ ...p, baseId: `s2-p${index}-input`}));
        let s2_currentPageIndex = 0;
        const s2_pagesContainer = document.getElementById('s2-pages-container'); 
        const s2_progressIndicatorEl = document.getElementById('s2-progress-indicator'); 
        const s2_prevBtn = document.getElementById('s2-prev-btn'); 
        const s2_nextBtn = document.getElementById('s2-next-btn');
        
        function s2_initApp() { 
            s2_pagesContainer.innerHTML = ''; 
            s2_problems.forEach((problem, index) => { 
                const pageDiv = document.createElement('div'); 
                pageDiv.className = 'problem-page'; 
                pageDiv.id = `s2-page-${index}`; 
                pageDiv.style.display = 'none'; 
                pageDiv.innerHTML = ` <h3>題目 ${problem.id}</h3> <div class="question">${problem.question}</div> <div class="structured-input-container" id="s2-input-area-${index}"></div> <button class="action-btn" onclick="s2_checkAnswerForPage(${index})">檢查答案</button> <div class="feedback" id="s2-feedback-${index}"></div> <div class="explanation" id="s2-explanation-${index}" style="display:none;"></div> `; 
                s2_pagesContainer.appendChild(pageDiv); 
            }); 
            s2_showPage(s2_currentPageIndex); 
        }
        
        function s2_showPage(index) { 
            document.querySelectorAll('#s2-pages-container .problem-page').forEach(page => page.style.display = 'none'); 
            const currentPageDiv = document.getElementById(`s2-page-${index}`); 
            if (currentPageDiv) { 
                currentPageDiv.style.display = 'block'; 
                const problem = s2_problems[index]; 
                createStructuredInput(problem, problem.baseId, `s2-input-area-${index}`, index, s2_checkAnswerForPage); 
                const firstInputS2 = currentPageDiv.querySelector('input[type="text"], select');
                if (firstInputS2) {setTimeout(()=>firstInputS2.focus(),0);}
            } 
            s2_currentPageIndex = index; 
            s2_progressIndicatorEl.textContent = `進度: ${s2_currentPageIndex + 1} / ${s2_problems.length}`; 
            s2_prevBtn.disabled = s2_currentPageIndex === 0; 
            s2_nextBtn.disabled = s2_currentPageIndex === s2_problems.length - 1; 
        }
        
        function s2_checkAnswerForPage(problemIndex) { 
            const pageDiv = document.getElementById(`s2-page-${problemIndex}`); 
            const feedbackMessageEl = pageDiv.querySelector(`#s2-feedback-${problemIndex}`); 
            const explanationTextEl = pageDiv.querySelector(`#s2-explanation-${problemIndex}`); 
            const problem = s2_problems[problemIndex]; 
            const userAnswerRaw = getAnswerFromStructuredInput(problem, problem.baseId); 
            if (checkAnswerLogic(userAnswerRaw, problem)) { 
                feedbackMessageEl.textContent = '太棒了，答案正確！'; 
                feedbackMessageEl.className = 'feedback correct'; 
            } else { 
                feedbackMessageEl.textContent = '喔喔，答案不太對，再試一次看看！'; 
                feedbackMessageEl.className = 'feedback incorrect'; 
            } 
            explanationTextEl.innerHTML = `<strong>提示/解說：</strong> ${problem.explanation}`; 
            explanationTextEl.style.display = 'block'; // 第二大題的解析在檢查後顯示
        }
        
        function s2_nextPage() { 
            if (s2_currentPageIndex < s2_problems.length - 1) { 
                s2_showPage(s2_currentPageIndex + 1); 
            } 
        }
        
        function s2_previousPage() { 
            if (s2_currentPageIndex > 0) { 
                s2_showPage(s2_currentPageIndex - 1); 
            } 
        }

        // --- Section 3 Script ---
        // --- Section 3 Script ---
        const s3_problems_data = [
            { 
                id: 1, type: "single", 
                question_html: "下列哪個數值是<mark>不等式 x＞5</mark> 的解？", 
                inequality_str: "x > 5", variable: "x", 
                options: [{text:"(A) －3", value: -3}, {text:"(B) 2", value: 2}, {text:"(C) 5", value: 5}, {text:"(D) 8", value: 8}], 
                correct_values: [8]
            },
            { 
                id: 2, type: "multiple", 
                question_html: "下列哪些數值是<mark>不等式 x ≥ －1</mark> 的解？ (本題有 <mark>3</mark> 個正確答案)", 
                inequality_str: "x >= -1", variable: "x", 
                options: [{text:"(A) －2", value: -2}, {text:"(B) －1", value: -1}, {text:"(C) 0", value: 0}, {text:"(D) 3.5", value: 3.5}], 
                correct_values: [-1, 0, 3.5]
            },
            { 
                id: 3, type: "single", 
                question_html: "下列哪個數值是<mark>不等式 x＜－2</mark> 的解？", 
                inequality_str: "x < -2", variable: "x", 
                options: [{text:"(A) －1.9", value: -1.9}, {text:"(B) －2.1", value: -2.1}, {text:"(C) －2", value: -2}, {text:"(D) 0", value: 0}], 
                correct_values: [-2.1]
            },
            { 
                id: 4, type: "multiple", 
                question_html: "下列哪些數值是<mark>不等式 2x－3 ≤ 1</mark> 的解？ (本題有 <mark>3</mark> 個正確答案)", 
                inequality_str: "2*x - 3 <= 1", variable: "x", 
                options: [{text:"(A) －1", value: -1}, {text:"(B) 0", value: 0}, {text:"(C) 2", value: 2}, {text:"(D) 3", value: 3}], 
                correct_values: [-1, 0, 2],
                transposition_hint: { 
                    steps: [
                        "<code>2x - 3 ≤ 1</code>",
                        "<code>2x   ≤ 1 + 3</code>   ",
                        "<code>2x   ≤ 4</code>       ",
                        "<code>x    ≤ 4 ÷ 2</code>   ",
                        "<code>x    ≤ 2</code>       "
                    ],
                    conclusion: "所以，我們要找的解是小於或等於 2 的數。"
                }
            },
            { 
                id: 5, type: "single", 
                question_html: "下列哪個數值是<mark>不等式 －x＋1＞2</mark> 的解？", 
                inequality_str: "-1*x + 1 > 2", variable: "x", 
                options: [{text:"(A) －2", value: -2}, {text:"(B) －1", value: -1}, {text:"(C) 0", value: 0}, {text:"(D) 1", value: 1}], 
                correct_values: [-2],
                transposition_hint: {
                    steps: [
                        "<code>-x + 1 > 2</code>",
                        "<code>-x   > 2 - 1</code>   ",
                        "<code>-x   > 1</code>       ",
                        "<code>x    < -1</code>      "
                    ],
                    conclusion: "所以，我們要找的解是小於 -1 的數。"
                }
            },
            { 
                id: 6, type: "multiple", 
                question_html: "下列哪些數值是<mark>不等式 －3x ≥ 6</mark> 的解？ (本題有 <mark>2</mark> 個正確答案)", 
                inequality_str: "-3*x >= 6", variable: "x", 
                options: [{text:"(A) －3", value: -3}, {text:"(B) －2", value: -2}, {text:"(C) －1", value: -1}, {text:"(D) 0", value: 0}], 
                correct_values: [-3, -2],
                transposition_hint: {
                    steps: [
                        "<code>-3x ≥ 6</code>",
                        "<code>x   ≤ 6 ÷ (-3)</code> (兩邊同除以 -3，<mark>不等號方向改變</mark>)",
                        "<code>x   ≤ -2</code>       (得到結果)"
                    ],
                    conclusion: "所以，我們要找的解是小於或等於 -2 的數。"
                }
            }
        ];

        let s3_currentProblemIndex = -1;
        // let s3_currentHintStep = 0; // 不再需要逐行提示的追蹤
        let s3_problemChecked = false; 

        let s3_questionTextEl, s3_problemTypeSubtitleEl, s3_optionsAreaEl, s3_optionsInstructionEl, 
            s3_checkAnswerBtn, /* s3_showHintBtn, */ s3_feedbackMessageEl, s3_numberLineEl, 
            s3_transpositionHintAreaEl, s3_hintStepsContainerEl, s3_hintConclusionEl, 
            s3_progressIndicatorEl, s3_prevBtn, s3_nextBtn;
        
        function s3_initDOMElements() {
            s3_questionTextEl = document.getElementById('s3-question-text');
            s3_problemTypeSubtitleEl = document.getElementById('s3-problem-type-subtitle');
            s3_optionsAreaEl = document.getElementById('s3-options-area');
            s3_optionsInstructionEl = document.getElementById('s3-options-instruction');
            s3_checkAnswerBtn = document.getElementById('s3-check-answer-btn');
            // s3_showHintBtn = document.getElementById('s3-show-hint-btn'); // 按鈕已移除
            s3_feedbackMessageEl = document.getElementById('s3-feedback-message');
            s3_numberLineEl = document.getElementById('s3-number-line');
            s3_transpositionHintAreaEl = document.getElementById('s3-transposition-hint-area');
            s3_hintStepsContainerEl = document.getElementById('s3-hint-steps-container');
            s3_hintConclusionEl = document.getElementById('s3-hint-conclusion');
            s3_progressIndicatorEl = document.getElementById('s3-progress-indicator');
            s3_prevBtn = document.getElementById('s3-prev-btn');
            s3_nextBtn = document.getElementById('s3-next-btn');
        }
                
        function s3_evaluateInequality(inequality_str, variable, value) {
            try {
                const expression = inequality_str.replace(new RegExp(variable, 'g'), `(${value})`);
                return new Function(`return ${expression}`)();
            } catch (e) {
                console.error("Error evaluating inequality:", e, "for expression:", expression);
                return false;
            }
        }

        function s3_generateNumberLine(problem) {
            if (!s3_numberLineEl) s3_initDOMElements();
            s3_numberLineEl.innerHTML = ''; 
            const axis = document.createElement('div');
            axis.className = 's3-number-line-axis';
            s3_numberLineEl.appendChild(axis);
            const ticksContainer = document.createElement('div');
            ticksContainer.className = 's3-number-line-ticks-container';
            s3_numberLineEl.appendChild(ticksContainer);
            const optionValues = problem.options.map(opt => opt.value);
            let allNumericPoints = [...new Set(optionValues)].sort((a,b) => a-b);
            let minVal = allNumericPoints.length > 0 ? Math.min(...allNumericPoints) : -5;
            let maxVal = allNumericPoints.length > 0 ? Math.max(...allNumericPoints) : 5;
            const rangeBuffer = Math.max(2, Math.ceil((maxVal - minVal) * 0.2));
            minVal = Math.floor(minVal - rangeBuffer);
            maxVal = Math.ceil(maxVal + rangeBuffer);
            if (minVal === maxVal) { minVal -=1; maxVal +=1; }
            const displayRange = maxVal - minVal;
            let pointsToDraw = new Set();
            for (let i = minVal; i <= maxVal; i++) { pointsToDraw.add(i); }
            allNumericPoints.forEach(p => pointsToDraw.add(p));
            let sortedPointsToDraw = Array.from(pointsToDraw).sort((a,b)=>a-b);
            sortedPointsToDraw.forEach(val => {
                const tick = document.createElement('div');
                tick.className = 's3-number-line-tick';
                if (optionValues.includes(val)) { tick.classList.add('option-value-tick'); }
                const positionPercent = displayRange === 0 ? 50 : ((val - minVal) / displayRange) * 100;
                if (positionPercent < 0 || positionPercent > 100) return; 
                tick.style.left = `${positionPercent}%`;
                const label = document.createElement('span');
                label.className = 's3-number-line-tick-label';
                label.textContent = val;
                tick.appendChild(label);
                ticksContainer.appendChild(tick);
            });
        }

        function s3_displayProblem() {
            if (!s3_questionTextEl) s3_initDOMElements();
            if (s3_currentProblemIndex < 0 || s3_currentProblemIndex >= s3_problems_data.length) return;
            
            s3_problemChecked = false; 
            // s3_currentHintStep = 0; // 不再需要

            const problem = s3_problems_data[s3_currentProblemIndex];
            s3_questionTextEl.innerHTML = `題目 ${problem.id}: ${problem.question_html}`;
            
            let subtitleText = "";
            if (problem.type === "multiple") {
                subtitleText = `這是一題<mark>複選題</mark>`;
                s3_optionsInstructionEl.textContent = "點擊選項可選取或取消選取。選好後按「檢查答案」。";
            } else {
                subtitleText = `這是一題<mark>單選題</mark>。`;
                s3_optionsInstructionEl.textContent = "點擊選項選擇答案。選好後按「檢查答案」。";
            }
            s3_problemTypeSubtitleEl.innerHTML = subtitleText;

            s3_optionsAreaEl.innerHTML = ''; 
            problem.options.forEach(option => {
                const button = document.createElement('button');
                button.className = 's3-option-button';
                button.innerHTML = option.text;
                button.dataset.value = option.value; 
                button.onclick = () => {
                    if (s3_problemChecked) return; 
                    if (problem.type === "single") {
                        s3_optionsAreaEl.querySelectorAll('.s3-option-button').forEach(btn => btn.classList.remove('selected'));
                        button.classList.add('selected');
                    } else { 
                        button.classList.toggle('selected');
                    }
                };
                s3_optionsAreaEl.appendChild(button);
            });
            
            s3_generateNumberLine(problem);

            s3_feedbackMessageEl.textContent = '';
            s3_feedbackMessageEl.className = 'feedback';
            s3_transpositionHintAreaEl.style.display = 'none'; 
            s3_hintStepsContainerEl.innerHTML = ''; 
            s3_hintConclusionEl.textContent = '';
            
            if (s3_checkAnswerBtn) s3_checkAnswerBtn.disabled = false; 
            // s3_showHintBtn.disabled = !(problem && problem.transposition_hint); // 提示按鈕已移除
            if (s3_nextBtn) s3_nextBtn.disabled = true; 
            
            s3_progressIndicatorEl.textContent = `進度: ${s3_currentProblemIndex + 1} / ${s3_problems_data.length}`;
            if (s3_prevBtn) s3_prevBtn.disabled = s3_currentProblemIndex === 0;
        }

        // 移除 s3_toggleHintDisplay 和 s3_showNextHintStep (或修改為 s3_showFullHint)
        function s3_showFullTranspositionHint(problem) {
            if (!s3_transpositionHintAreaEl || !s3_hintStepsContainerEl || !s3_hintConclusionEl) s3_initDOMElements();
            
            if (problem && problem.transposition_hint && problem.transposition_hint.steps) {
                s3_hintStepsContainerEl.innerHTML = ''; // 清空舊步驟
                problem.transposition_hint.steps.forEach(stepText => {
                    const stepPara = document.createElement('p');
                    stepPara.className = 's3-hint-step'; // CSS 會使其直接可見
                    stepPara.innerHTML = stepText;
                    s3_hintStepsContainerEl.appendChild(stepPara);
                });
                if (problem.transposition_hint.conclusion) {
                    s3_hintConclusionEl.textContent = problem.transposition_hint.conclusion;
                } else {
                    s3_hintConclusionEl.textContent = '';
                }
                s3_transpositionHintAreaEl.style.display = 'block';
            } else {
                s3_transpositionHintAreaEl.style.display = 'none';
                s3_hintStepsContainerEl.innerHTML = '';
                s3_hintConclusionEl.textContent = '';
            }
        }


        function s3_checkAnswer() {
            if (!s3_feedbackMessageEl) s3_initDOMElements();
            if (s3_problemChecked) return; 

            const problem = s3_problems_data[s3_currentProblemIndex];
            const selectedButtons = Array.from(s3_optionsAreaEl.querySelectorAll('.s3-option-button.selected'));
            
            if (selectedButtons.length === 0) {
                s3_feedbackMessageEl.textContent = (problem.type === "multiple") ? '請至少選擇一個答案。' : '請選擇一個答案。';
                s3_feedbackMessageEl.className = 'feedback';
                if (s3_transpositionHintAreaEl) s3_transpositionHintAreaEl.style.display = 'none'; // 未選答案時不顯示提示
                return; 
            }

            const selectedValues = selectedButtons.map(btn => parseFloat(btn.dataset.value));
            const correctAnswers = problem.correct_values.map(v => parseFloat(v));

            const sortedSelected = selectedValues.slice().sort((a, b) => a - b);
            const sortedCorrect = correctAnswers.slice().sort((a, b) => a - b);

            let studentCorrect = JSON.stringify(sortedSelected) === JSON.stringify(sortedCorrect);
            
            s3_problemChecked = true; 
            if (s3_checkAnswerBtn) s3_checkAnswerBtn.disabled = true; 
            if (s3_optionsAreaEl) s3_optionsAreaEl.querySelectorAll('.s3-option-button').forEach(btn => btn.disabled = true);

            if (studentCorrect) {
                s3_feedbackMessageEl.textContent = '答對了！做得好！可以按「下一題」。';
                s3_feedbackMessageEl.className = 'feedback correct';
                if (s3_nextBtn) s3_nextBtn.disabled = (s3_currentProblemIndex === s3_problems_data.length - 1); 
                if (s3_transpositionHintAreaEl) s3_transpositionHintAreaEl.style.display = 'none'; 
            } else {
                s3_feedbackMessageEl.textContent = '這個答案不太對喔。請看下方提示或按「下一題」繼續。';
                s3_feedbackMessageEl.className = 'feedback incorrect';
                if (s3_nextBtn) s3_nextBtn.disabled = (s3_currentProblemIndex === s3_problems_data.length - 1); 
                s3_showFullTranspositionHint(problem); // 回答錯誤時，直接顯示完整提示
            }
        }
                
        function s3_init() {
            s3_initDOMElements(); 
            if (s3_problems_data.length > 0) {
                 if (s3_currentProblemIndex === -1 || document.getElementById('section3').classList.contains('active')) { 
                    s3_currentProblemIndex = (s3_currentProblemIndex === -1 || s3_currentProblemIndex >= s3_problems_data.length) ? 0 : s3_currentProblemIndex; 
                    s3_displayProblem();
                    document.removeEventListener('keydown', s3_handleEnterKey); 
                    document.addEventListener('keydown', s3_handleEnterKey);
                 }
            }
        }

        function s3_removeEnterKeyListener() {
            document.removeEventListener('keydown', s3_handleEnterKey);
        }

        function s3_handleEnterKey(event) {
            if (!s3_checkAnswerBtn) s3_initDOMElements(); 
            const section3Active = document.getElementById('section3').classList.contains('active');
            if (!section3Active) return; 

            if (event.key === 'Enter') {
                if (!s3_problemChecked && s3_checkAnswerBtn && !s3_checkAnswerBtn.disabled) { 
                    event.preventDefault(); 
                    s3_checkAnswer();
                } else if (s3_problemChecked && s3_nextBtn && !s3_nextBtn.disabled) { 
                    event.preventDefault();
                    s3_nextProblem();
                }
            }
        }

        function s3_nextProblem() {
            if (!s3_optionsAreaEl) s3_initDOMElements(); 
            if (s3_currentProblemIndex < s3_problems_data.length - 1) {
                s3_currentProblemIndex++;
                s3_displayProblem();
                if(s3_optionsAreaEl) s3_optionsAreaEl.querySelectorAll('.s3-option-button').forEach(btn => btn.disabled = false);
            }
        }

        function s3_previousProblem() {
            if (!s3_optionsAreaEl) s3_initDOMElements(); 
            if (s3_currentProblemIndex > 0) {
                s3_currentProblemIndex--;
                s3_displayProblem();
                 if(s3_optionsAreaEl) s3_optionsAreaEl.querySelectorAll('.s3-option-button').forEach(btn => btn.disabled = false);
            }
        }

        // --- Tab切換邏輯 ---
        function openSection(evt, sectionName) {
            let i, contentSections, tabButtons;
            contentSections = document.getElementsByClassName("content-section");
            for (i = 0; i < contentSections.length; i++) { contentSections[i].classList.remove("active"); }
            tabButtons = document.getElementsByClassName("tab-button");
            for (i = 0; i < tabButtons.length; i++) { tabButtons[i].classList.remove("active"); }
            
            const targetSection = document.getElementById(sectionName);
            if (targetSection) targetSection.classList.add("active");
            if (evt && evt.currentTarget) evt.currentTarget.classList.add("active");

            s3_removeEnterKeyListener(); 

            if (sectionName === 'section1') {
                if (s1_problems.length > 0) {
                    if (s1_inputAreaEl) { // 檢查元素是否已獲取
                        if (!s1_inputAreaEl.hasChildNodes() || s1_currentProblemIndex < 0 ) { 
                            s1_currentProblemIndex = 0; 
                            s1_displayProblem();
                        } else {
                            s1_displayProblem(); 
                        }
                    }
                }
            } else if (sectionName === 'section2') {
                if (s2_problems && s2_problems.length > 0) {
                    if (s2_pagesContainer) { // 檢查元素是否已獲取
                        if (!s2_pagesContainer.hasChildNodes() || s2_currentPageIndex < 0) { 
                            s2_currentPageIndex = 0; 
                            s2_initApp();
                        } else {
                            s2_showPage(s2_currentPageIndex); 
                        }
                    }
                }
            } else if (sectionName === 'section3') {
                s3_init(); 
            }
        }

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            s3_initDOMElements(); // 確保 S3 DOM 元素在最早時機被獲取

            s1_currentProblemIndex = -1; 
            s2_currentPageIndex = -1;  
            s3_currentProblemIndex = -1; 

            const firstTabButton = document.querySelector('.tab-button'); 
            if (firstTabButton) {
                firstTabButton.click(); 
            }
        });

    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡å­—ç¬¦è™Ÿ - ç†Ÿç·´3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f0f9ff;
        }

        /* æ•¸å­¸å¼å°ˆç”¨ CSS */
        .math {
            font-family: 'Times New Roman', serif;
            font-size: 28px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: #1e3a8a;
            vertical-align: middle;
        }

        /* åˆ†æ•¸çµæ§‹ */
        .fraction-group {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            vertical-align: middle;
            margin: 0 4px;
        }
        
        .fraction-group .fraction-line {
            width: 100%;
            height: 3px;
            background-color: #333;
            margin: 4px 0;
            border-radius: 2px;
        }

        .fraction {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            font-size: 0.9em;
            vertical-align: middle;
        }
        .fraction span:first-child { border-bottom: 2px solid #000; padding: 0 4px; display: block; text-align: center; }
        
        /* å¡«ç­”æ§½ (Slot) */
        .slot {
            min-width: 60px;
            height: 60px;
            padding: 0 10px;
            border: 2px dashed #94a3b8;
            border-radius: 8px;
            background-color: #ffffff;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            font-weight: bold;
            color: #333;
            cursor: pointer;
            transition: all 0.2s;
            margin: 0 2px;
            vertical-align: middle;
        }

        /* åˆ†æ•¸æ¨¡å¼ä¸‹çš„ Slot ç‰¹èª¿ */
        .fraction-group .slot {
            min-width: 50px;
            height: 50px;
            font-size: 20px;
            border-width: 2px;
            margin: 1px 0;
        }

        .slot.filled {
            border: 2px solid #3b82f6;
            background-color: #eff6ff;
            border-style: solid;
        }

        .slot.correct {
            border: 2px solid #22c55e;
            background-color: #dcfce7;
            color: #15803d;
        }

        /* é¸é …æŒ‰éˆ• */
        .option-btn {
            min-width: 60px;
            height: 60px;
            padding: 0 16px;
            margin: 6px;
            background-color: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 22px;
            font-family: 'Times New Roman', serif;
            font-weight: bold;
            color: #334155;
            box-shadow: 0 4px 0 #cbd5e1;
            transition: all 0.1s;
            display: inline-flex;
            justify-content: center;
            align-items: center;
        }

        .option-btn:active { transform: translateY(4px); box-shadow: none; }
        .option-btn:disabled {
            background-color: #f1f5f9; color: #cbd5e1;
            border-color: #f1f5f9; box-shadow: none;
            cursor: not-allowed; transform: translateY(4px);
        }

        /* æ­¥é©Ÿå®¹å™¨ */
        .step-container {
            opacity: 0.6;
            pointer-events: none;
            transition: all 0.4s ease;
            filter: grayscale(0.8);
        }
        .step-container.active {
            opacity: 1; pointer-events: auto; filter: grayscale(0);
            background-color: white; border: 2px solid #3b82f6;
            transform: scale(1.01); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        .step-container.completed {
            opacity: 1; filter: grayscale(0); border: 2px solid #22c55e;
            background-color: #f0fdf4;
        }

        /* é‡é»é«˜äº® */
        mark { background-color: #fef08a; padding: 0 4px; border-radius: 4px; color: #854d0e; }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen flex flex-col items-center">

    <!-- Header -->
    <header class="w-full max-w-3xl mb-8 text-center">
        <div class="inline-block bg-slate-700 text-white px-6 py-2 rounded-full text-lg font-bold mb-4 shadow-md">
            ğŸ““ ç†±ç·´ 3ï¼šä»¥æ–‡å­—ç¬¦è™Ÿè¡¨ç¤ºç”Ÿæ´»ä¸­çš„æ•¸é‡é—œä¿‚
        </div>
        <p class="text-slate-600 text-lg">
            æ ¹æ“šé¡Œæ„ï¼Œå°‡æ­£ç¢ºçš„æ•¸å­¸å¼å¡«å…¥ç©ºæ ¼ä¸­ã€‚<br>
            <span class="text-sm text-slate-500">ï¼ˆä¸å¿…åŒ–ç°¡ï¼Œåˆ—å‡ºå¼å­å³å¯ï¼‰</span>
        </p>
    </header>

    <!-- Main Game Area -->
    <main id="game-area" class="w-full max-w-3xl space-y-6">
        <!-- Steps generated by JS -->
    </main>

    <!-- Feedback Modal -->
    <div id="feedback-modal" class="fixed bottom-8 left-1/2 transform -translate-x-1/2 bg-white px-6 py-4 rounded-xl shadow-2xl border-l-8 hidden z-50 flex items-center gap-4 transition-all duration-300">
        <span id="feedback-icon" class="text-3xl"></span>
        <span id="feedback-text" class="text-xl font-bold text-slate-700"></span>
    </div>

    <!-- JavaScript Logic -->
    <script>
        // é¡Œç›®è³‡æ–™ï¼šç†Ÿç·´ 3
        const stepsData = [
            {
                id: 1,
                title: "é¡Œç›® 1ï¼šæ­£æ–¹å½¢é‚Šé•·",
                question: "å·²çŸ¥ä¸€æ­£æ–¹å½¢çš„ <mark>å‘¨é•·ç‚º x å…¬åˆ†</mark>ï¼Œ<br>å‰‡æ­¤æ­£æ–¹å½¢çš„ <b>é‚Šé•·</b> ç‚ºå¤šå°‘å…¬åˆ†ï¼Ÿ",
                layout: "fraction", // ç‰¹æ®Šä½ˆå±€ï¼šåˆ†æ•¸
                slots: 2, // åˆ†å­ + åˆ†æ¯
                options: ["x", "4", "4x", "1"],
                correctAnswer: ["x", "4"],
                hint: "é‚Šé•· = å‘¨é•· Ã· 4ï¼Œè©¦è‘—ç”¨åˆ†æ•¸è¡¨ç¤ºçœ‹çœ‹ï¼(åˆ†å­ Ã· åˆ†æ¯)",
            },
            {
                id: 2,
                title: "é¡Œç›® 2ï¼šè·é›¢å…¬å¼",
                question: "ä»¥ <mark>æ¯å°æ™‚ 60 å…¬é‡Œ</mark> çš„é€Ÿåº¦è¡Œé§› <span class='math'>x</span> å°æ™‚ï¼Œ<br>å¯è¡Œé§›å¤šå°‘å…¬é‡Œï¼Ÿ",
                layout: "linear",
                slots: 2, // 60 x
                options: ["60", "x", "60+x", "Ã·"],
                correctAnswer: ["60", "x"],
                hint: "è·é›¢ = é€Ÿåº¦ Ã— æ™‚é–“ (ä¹˜è™Ÿå¯ä»¥çœç•¥å–”)",
            },
            {
                id: 3,
                title: "é¡Œç›® 3ï¼šä½å€¼åŸç†",
                question: "å€‹ä½æ•¸ç‚º <span class='math'>x-3</span>ï¼Œåä½æ•¸ç‚º <span class='math'>x</span> çš„äºŒä½æ•¸ï¼Œ<br>å¯è¡¨ç¤ºç‚ºï¼Ÿ",
                layout: "linear",
                slots: 3, // 10x + (x-3)
                options: ["10x", "+", "(x-3)", "x", "10"],
                correctAnswer: ["10x", "+", "(x-3)"],
                hint: "æ•¸å€¼ = 10 Ã— åä½æ•¸å­— + å€‹ä½æ•¸å­—",
            },
            {
                id: 4,
                title: "é¡Œç›® 4ï¼šé™¤æ³•åŸç†",
                question: "ç”²æ•¸é™¤ä»¥ä¹™æ•¸çš„å•†ç‚º 7ï¼Œé¤˜æ•¸ç‚º 5ã€‚<br>è¨­ <mark>ä¹™æ•¸ç‚º x</mark>ï¼Œå‰‡ <b>ç”²æ•¸</b> ç‚ºï¼Ÿ",
                layout: "linear",
                slots: 3, // 7x + 5
                options: ["7x", "+", "5", "7", "x", "-"],
                correctAnswer: ["7x", "+", "5"],
                hint: "è¢«é™¤æ•¸(ç”²) = é™¤æ•¸(ä¹™) Ã— å•† + é¤˜æ•¸ã€‚æ³¨æ„ï¼š7 ä¹˜ä»¥ x å¯ä»¥ç°¡è¨˜ç‚º 7x å–”ï¼",
            }
        ];

        let currentStep = 0;
        let userAnswers = {}; 
        let stepCompleted = {}; 

        const gameArea = document.getElementById('game-area');
        const feedbackModal = document.getElementById('feedback-modal');
        const feedbackText = document.getElementById('feedback-text');
        const feedbackIcon = document.getElementById('feedback-icon');

        function init() {
            renderSteps();
            activateStep(0);
        }

        function renderSteps() {
            gameArea.innerHTML = '';
            stepsData.forEach((step, index) => {
                const stepEl = document.createElement('div');
                stepEl.id = `step-${index}`;
                stepEl.className = `step-container bg-white p-6 rounded-2xl border border-slate-200 shadow-sm relative overflow-hidden`;
                
                userAnswers[index] = new Array(step.slots).fill(null);
                stepCompleted[index] = false;

                stepEl.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-lg font-bold text-slate-400">Step ${index + 1}ï¼š${step.title}</h3>
                        <span class="status-icon hidden text-green-500 text-xl font-bold">âœ”ï¸ å®Œæˆ</span>
                    </div>
                    
                    <div class="mb-6 text-xl text-slate-800 leading-relaxed font-medium">
                        ${step.question}
                    </div>

                    <div class="flex flex-col items-center gap-6">
                        <!-- ç­”é¡Œå€ -->
                        <div class="flex items-center flex-wrap gap-2 bg-slate-50 p-6 rounded-xl w-full justify-center min-h-[120px] math" id="slots-area-${index}">
                            ${generateSlotsByLayout(index, step)}
                            <span class="text-xl text-slate-400 font-bold ml-2">
                                ${getUnit(index)}
                            </span>
                        </div>

                        <!-- é¸é …å€ -->
                        <div class="flex flex-wrap justify-center gap-3" id="options-area-${index}">
                            ${generateOptionsHTML(index, step.options)}
                        </div>

                        <!-- æª¢æŸ¥æŒ‰éˆ• -->
                        <button onclick="checkStep(${index})" class="check-btn bg-indigo-600 hover:bg-indigo-700 text-white text-lg font-bold py-3 px-8 rounded-xl shadow-lg transform transition active:scale-95 w-full md:w-auto mt-2">
                            æª¢æŸ¥ç­”æ¡ˆ
                        </button>
                    </div>
                `;
                gameArea.appendChild(stepEl);
            });
        }

        function getUnit(index) {
            // æ ¹æ“šé¡Œç›®é¡¯ç¤ºå–®ä½ (éå¿…è¦ï¼Œä½†å¢åŠ å®Œæ•´åº¦)
            if (index === 0) return "(å…¬åˆ†)";
            if (index === 1) return "(å…¬é‡Œ)";
            return "";
        }

        // æ ¹æ“šä½ˆå±€é¡å‹ç”Ÿæˆ Slot HTML
        function generateSlotsByLayout(stepIndex, step) {
            if (step.layout === 'fraction') {
                // ç”Ÿæˆåˆ†æ•¸çµæ§‹ï¼šåˆ†å­ Slot 0, åˆ†æ¯ Slot 1
                return `
                    <div class="fraction-group">
                        <div class="slot" data-step="${stepIndex}" data-slot-index="0" onclick="handleSlotClick(${stepIndex}, 0)"></div>
                        <div class="fraction-line"></div>
                        <div class="slot" data-step="${stepIndex}" data-slot-index="1" onclick="handleSlotClick(${stepIndex}, 1)"></div>
                    </div>
                `;
            } else {
                // é è¨­ç·šæ€§çµæ§‹
                let html = '';
                for (let i = 0; i < step.slots; i++) {
                    html += `<div class="slot" data-step="${stepIndex}" data-slot-index="${i}" onclick="handleSlotClick(${stepIndex}, ${i})"></div>`;
                }
                return html;
            }
        }

        function generateOptionsHTML(stepIndex, options) {
            return options.map(opt => `
                <button class="option-btn" data-step="${stepIndex}" data-val="${opt}" onclick="handleOptionClick(${stepIndex}, '${opt}', this)">
                    ${opt}
                </button>
            `).join('');
        }

        function activateStep(index) {
            currentStep = index;
            const stepEl = document.getElementById(`step-${index}`);
            if (stepEl) {
                stepEl.classList.add('active');
                setTimeout(() => stepEl.scrollIntoView({ behavior: 'smooth', block: 'center' }), 300);
            }
        }

        window.handleOptionClick = function(stepIndex, value, btnEl) {
            if (stepCompleted[stepIndex]) return;

            // å°‹æ‰¾è©²æ­¥é©Ÿç¬¬ä¸€å€‹ç©ºçš„ slot
            const emptySlotIndex = userAnswers[stepIndex].findIndex(val => val === null);
            
            if (emptySlotIndex !== -1) {
                userAnswers[stepIndex][emptySlotIndex] = value;
                
                const slotEl = document.querySelector(`.slot[data-step="${stepIndex}"][data-slot-index="${emptySlotIndex}"]`);
                slotEl.innerHTML = value; // ä¸éœ€è¦è¤‡é›œæ¸²æŸ“ï¼Œç›´æ¥å¡«å…¥
                slotEl.classList.add('filled');
                
                btnEl.disabled = true;
                playSound('pop');
            } else {
                showFeedback('ç©ºæ ¼æ»¿äº†ï¼é»æ“Šç©ºæ ¼å¯ä»¥æ¸…é™¤é‡å¡«ã€‚', 'warning');
            }
        }

        window.handleSlotClick = function(stepIndex, slotIndex) {
            if (stepCompleted[stepIndex]) return;

            const currentVal = userAnswers[stepIndex][slotIndex];
            if (currentVal) {
                userAnswers[stepIndex][slotIndex] = null;

                const slotEl = document.querySelector(`.slot[data-step="${stepIndex}"][data-slot-index="${slotIndex}"]`);
                slotEl.innerHTML = '';
                slotEl.classList.remove('filled');

                // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                const optionBtns = document.querySelectorAll(`#options-area-${stepIndex} .option-btn`);
                for (let btn of optionBtns) {
                    if (btn.disabled && btn.dataset.val === currentVal) {
                        btn.disabled = false;
                        break;
                    }
                }
            }
        }

        window.checkStep = function(stepIndex) {
            const currentAnswers = userAnswers[stepIndex];
            const correctData = stepsData[stepIndex].correctAnswer;
            
            if (currentAnswers.includes(null)) {
                showFeedback('è«‹å¡«æ»¿æ‰€æœ‰ç©ºæ ¼å†æª¢æŸ¥ï¼', 'warning');
                return;
            }

            // æª¢æŸ¥ç­”æ¡ˆ (JSON stringify æ¯”å°é™£åˆ—)
            const isCorrect = JSON.stringify(currentAnswers) === JSON.stringify(correctData);

            if (isCorrect) {
                handleSuccess(stepIndex);
            } else {
                handleFailure(stepIndex, stepsData[stepIndex].hint);
            }
        }

        function handleSuccess(stepIndex) {
            stepCompleted[stepIndex] = true;
            const stepEl = document.getElementById(`step-${stepIndex}`);
            
            stepEl.classList.remove('active');
            stepEl.classList.add('completed');
            stepEl.querySelector('.status-icon').classList.remove('hidden');
            stepEl.querySelector('.check-btn').classList.add('hidden');
            
            const slots = stepEl.querySelectorAll('.slot');
            slots.forEach(s => s.classList.add('correct'));

            showFeedback('ç­”å°äº†ï¼å¤ªæ£’äº†ï¼ ğŸ‰', 'success');
            playSound('success');

            if (stepIndex < stepsData.length - 1) {
                setTimeout(() => activateStep(stepIndex + 1), 1500);
            } else {
                setTimeout(() => {
                    showFeedback('æ­å–œï¼æ‰€æœ‰æŒ‘æˆ°éƒ½å®Œæˆäº†ï¼ ğŸ†', 'success');
                    confettiEffect();
                }, 1000);
            }
        }

        function handleFailure(stepIndex, hint) {
            showFeedback(`å†æƒ³æƒ³çœ‹... ğŸ’¡ ${hint}`, 'error');
            playSound('error');
            const slotsArea = document.getElementById(`slots-area-${stepIndex}`);
            slotsArea.classList.add('animate-pulse');
            setTimeout(() => slotsArea.classList.remove('animate-pulse'), 500);
        }

        function showFeedback(msg, type) {
            feedbackText.innerText = msg;
            feedbackModal.classList.remove('hidden');
            
            // Reset classes
            feedbackModal.className = "fixed bottom-8 left-1/2 transform -translate-x-1/2 bg-white px-8 py-4 rounded-xl shadow-2xl border-l-8 z-50 flex items-center gap-4 transition-all duration-300 min-w-[320px]";
            
            if (type === 'success') {
                feedbackModal.classList.add('border-green-500');
                feedbackIcon.innerText = "ğŸ˜";
            } else if (type === 'error') {
                feedbackModal.classList.add('border-red-500');
                feedbackIcon.innerText = "ğŸ’ª";
            } else {
                feedbackModal.classList.add('border-yellow-500');
                feedbackIcon.innerText = "âš ï¸";
            }

            setTimeout(() => feedbackModal.classList.add('hidden'), 3500);
        }

        function playSound(type) {
            // Placeholder for sound
        }

        function confettiEffect() {
            const colors = ['#f43f5e', '#8b5cf6', '#3b82f6', '#10b981', '#f59e0b'];
            for(let i=0; i<60; i++) {
                const conf = document.createElement('div');
                Object.assign(conf.style, {
                    position: 'fixed',
                    left: Math.random() * 100 + 'vw',
                    top: '-10px',
                    width: '12px',
                    height: '12px',
                    backgroundColor: colors[Math.floor(Math.random() * colors.length)],
                    transition: 'top 2.5s ease-out, transform 2.5s linear',
                    zIndex: '9999',
                    borderRadius: '2px'
                });
                document.body.appendChild(conf);
                setTimeout(() => {
                    conf.style.top = '105vh';
                    conf.style.transform = `rotate(${Math.random() * 720}deg) translateX(${Math.random()*100 - 50}px)`;
                }, 50);
            }
        }

        // Init
        init();
    </script>
</body>
</html>
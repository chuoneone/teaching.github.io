<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹³è¡Œå››é‚Šå½¢å¹¾ä½•è­‰æ˜ - äº’å‹•å­¸ç¿’å–®</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f3f4f6; /* bg-gray-100 */
        }

        /* æ•¸å­¸å¼æ¨£å¼è¨­å®š */
        .math-text {
            font-family: 'Times New Roman', serif;
            font-style: italic;
            font-weight: 600;
        }
        
        .segment {
            text-decoration: overline;
            margin-right: 2px;
        }

        .angle {
            font-style: normal;
            margin-right: 2px;
        }

        .triangle {
            display: inline-block;
            margin-right: 2px;
        }
        .triangle::before {
            content: "â–³";
            font-family: 'Times New Roman', serif;
        }

        /* å¡«ç­”æ ¼æ¨£å¼ */
        .slot {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 80px;
            height: 42px;
            margin: 0 4px;
            padding: 0 10px;
            border: 2px dashed #9ca3af; /* gray-400 */
            border-radius: 8px;
            background-color: #ffffff;
            color: #374151;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            vertical-align: middle;
            white-space: nowrap;
        }

        .slot.filled {
            border-style: solid;
            border-color: #3b82f6; /* blue-500 */
            background-color: #eff6ff; /* blue-50 */
            color: #1d4ed8;
        }

        .slot.correct {
            border-color: #10b981; /* green-500 */
            background-color: #ecfdf5; /* green-50 */
            color: #047857;
            cursor: default;
        }

        .slot.error {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
            border-color: #ef4444; /* red-500 */
        }

        /* é¸é …æŒ‰éˆ•æ¨£å¼ */
        .option-btn {
            background-color: #ffffff;
            border: 2px solid #e5e7eb;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border-radius: 12px;
            padding: 10px 16px;
            font-size: 1.1rem;
            font-weight: 600;
            color: #374151;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .option-btn:not(:disabled):hover {
            transform: translateY(-2px);
            border-color: #60a5fa;
            background-color: #eff6ff;
        }

        .option-btn:not(:disabled):active {
            transform: translateY(0);
        }

        .option-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            background-color: #f3f4f6;
            transform: none;
            box-shadow: none;
        }

        /* æ­¥é©Ÿå¡ç‰‡ */
        .step-card {
            opacity: 0.5;
            pointer-events: none;
            filter: grayscale(0.8);
            transition: all 0.5s ease;
            transform: translateY(20px);
        }

        .step-card.active {
            opacity: 1;
            pointer-events: auto;
            filter: grayscale(0);
            transform: translateY(0);
            border-left: 5px solid #3b82f6;
        }

        .step-card.completed {
            opacity: 1;
            pointer-events: none;
            filter: grayscale(0);
            border-left: 5px solid #10b981;
            background-color: #f0fdf4;
        }
        
        .step-card.completed .check-btn-area {
            display: none;
        }

        /* å°è¦½åˆ—æŒ‰éˆ• */
        .problem-tab {
            opacity: 0.7;
        }
        .problem-tab.active {
            opacity: 1;
            background-color: #2563eb; /* blue-600 */
            color: white;
        }

        /* å‹•ç•« */
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        @keyframes tada {
            0% { transform: scale(1); }
            10%, 20% { transform: scale(0.9) rotate(-3deg); }
            30%, 50%, 70%, 90% { transform: scale(1.1) rotate(3deg); }
            40%, 60%, 80% { transform: scale(1.1) rotate(-3deg); }
            100% { transform: scale(1) rotate(0); }
        }

        .animate-tada {
            animation: tada 1s;
        }

        /* éš±è—å…ƒç´ å·¥å…· */
        .hidden { display: none !important; }

        /* SVG æ¨£å¼ */
        .svg-text {
            font-family: 'Times New Roman', serif;
            font-style: italic;
            font-size: 16px;
            font-weight: bold;
        }
        .svg-label {
            font-family: sans-serif;
            font-size: 14px;
            fill: #dc2626; /* red-600 */
            font-weight: bold;
        }
        .svg-line {
            stroke: #000;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        .svg-dash {
            stroke-dasharray: 4;
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- å°è¦½åˆ— -->
    <nav class="bg-white border-b border-gray-200 shadow-sm z-20 flex-none">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex space-x-4 overflow-x-auto py-3 items-center">
                <span class="text-gray-500 font-bold px-2 flex-shrink-0 hidden md:block">å–®å…ƒï¼šå¹³è¡Œå››é‚Šå½¢</span>
                
                <button onclick="switchProblem(1)" id="tab-1" class="problem-tab active px-4 py-2 bg-gray-200 text-gray-700 rounded-full text-sm font-bold shadow-sm whitespace-nowrap transition-colors">
                    é¡Œç›® 1ï¼šæ±‚è­‰å¹³è¡Œ
                </button>
                <button onclick="switchProblem(2)" id="tab-2" class="problem-tab px-4 py-2 bg-gray-200 text-gray-700 rounded-full text-sm font-bold shadow-sm whitespace-nowrap transition-colors">
                    é¡Œç›® 2ï¼šå°è§’ç·šå¹³åˆ†
                </button>
            </div>
        </div>
    </nav>

    <!-- ä¸»å…§å®¹å€ -->
    <main class="flex-1 flex flex-col md:flex-row overflow-hidden relative">
        
        <!-- å·¦å´ï¼šé¡Œç›®å€ -->
        <section id="left-panel" class="md:w-1/3 bg-white border-b md:border-b-0 md:border-r border-gray-200 flex flex-col overflow-y-auto md:h-full z-10 shadow-sm md:shadow-none">
            <div class="p-6 sticky top-0">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <span class="bg-indigo-100 text-indigo-700 p-2 rounded-lg mr-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                        </svg>
                    </span>
                    é¡Œç›®èªªæ˜
                </h2>
                
                <!-- é¡Œç›® 1 å…§å®¹ -->
                <div id="problem-intro-1">
                    <div class="flex justify-center mb-6 bg-gray-50 rounded-xl p-4 border border-gray-100">
                        <svg width="240" height="160" viewBox="0 0 240 160">
                            <!-- å››é‚Šå½¢ ABCD -->
                            <polygon points="60,30 30,130 180,130 210,30" fill="none" class="svg-line" />
                            <line x1="30" y1="130" x2="210" y2="30" class="svg-line" />
                            <!-- é»æ¨™è¨˜ -->
                            <text x="50" y="25" class="svg-text">A</text>
                            <text x="15" y="135" class="svg-text">B</text>
                            <text x="190" y="135" class="svg-text">C</text>
                            <text x="220" y="25" class="svg-text">D</text>
                            <!-- è§’æ¨™è¨˜ -->
                            <text x="175" y="45" class="svg-text" font-size="12">1</text>
                            <text x="55" y="125" class="svg-text" font-size="12">2</text>
                            <text x="195" y="60" class="svg-text" font-size="12">3</text>
                            <text x="40" y="115" class="svg-text" font-size="12">4</text>
                        </svg>
                    </div>
                    <div class="space-y-4 text-lg text-gray-700 leading-relaxed">
                        <p>
                            <span class="font-bold bg-yellow-100 px-1 rounded">å·²çŸ¥ï¼š</span>
                            åœ¨å››é‚Šå½¢ <span class="math-text">ABCD</span> ä¸­ï¼Œ
                            <span class="segment math-text">AD</span> // <span class="segment math-text">BC</span>ï¼Œä¸” <span class="angle">âˆ </span><span class="math-text">A</span> = <span class="angle">âˆ </span><span class="math-text">C</span>ã€‚
                        </p>
                        <p class="mt-4 border-t pt-4">
                            <span class="font-bold bg-green-100 px-1 rounded">æ±‚è­‰ï¼š</span>
                            <span class="segment math-text">AB</span> // <span class="segment math-text">DC</span>
                        </p>
                    </div>
                </div>

                <!-- é¡Œç›® 2 å…§å®¹ (é è¨­éš±è—) -->
                <div id="problem-intro-2" class="hidden">
                    <div class="flex justify-center mb-6 bg-gray-50 rounded-xl p-4 border border-gray-100">
                        <svg width="240" height="160" viewBox="0 0 240 160">
                            <!-- å››é‚Šå½¢ ABCD -->
                            <polygon points="50,30 20,130 170,130 200,30" fill="none" class="svg-line" />
                            <!-- å°è§’ç·š -->
                            <line x1="50" y1="30" x2="170" y2="130" class="svg-line" />
                            <line x1="20" y1="130" x2="200" y2="30" class="svg-line" />
                            <!-- é»æ¨™è¨˜ -->
                            <text x="40" y="25" class="svg-text">A</text>
                            <text x="5" y="135" class="svg-text">B</text>
                            <text x="180" y="135" class="svg-text">C</text>
                            <text x="210" y="25" class="svg-text">D</text>
                            <text x="110" y="90" class="svg-text">O</text>
                            <!-- ç´…è‰²æ•¸å­—æ¨™è¨˜ -->
                            <text x="65" y="50" class="svg-label">1</text>
                            <text x="80" y="45" class="svg-label">4</text>
                            <text x="35" y="120" class="svg-label">5</text>
                            <text x="155" y="115" class="svg-label">2</text>
                            <text x="140" y="120" class="svg-label">3</text>
                            <text x="185" y="50" class="svg-label">6</text>
                        </svg>
                    </div>
                    <div class="space-y-4 text-lg text-gray-700 leading-relaxed">
                        <p>
                            <span class="font-bold bg-yellow-100 px-1 rounded">å·²çŸ¥ï¼š</span>
                            å¦‚åœ–ï¼Œ<span class="math-text">â–±ABCD</span> ä¸­ï¼Œ
                            <span class="segment math-text">AB</span> // <span class="segment math-text">CD</span>ï¼Œ
                            <span class="segment math-text">AD</span> // <span class="segment math-text">BC</span>ï¼Œ
                            å°è§’ç·š <span class="segment math-text">AC</span> èˆ‡ <span class="segment math-text">BD</span> äº¤æ–¼ <span class="math-text">O</span> é»ã€‚
                        </p>
                        <p class="mt-4 border-t pt-4">
                            <span class="font-bold bg-green-100 px-1 rounded">æ±‚è­‰ï¼š</span>
                            <span class="segment math-text">OA</span> = <span class="segment math-text">OC</span>ï¼Œ
                            <span class="segment math-text">OB</span> = <span class="segment math-text">OD</span>ã€‚
                        </p>
                    </div>
                </div>

            </div>
        </section>

        <!-- å³å´ï¼šäº’å‹•æ­¥é©Ÿå€ -->
        <section id="right-panel" class="flex-1 bg-gray-100 overflow-y-auto p-4 md:p-8 relative">
            <div id="steps-container" class="max-w-2xl mx-auto space-y-6 pb-20">
                <!-- æ­¥é©Ÿå¡ç‰‡å°‡ç”± JS å‹•æ…‹ç”Ÿæˆ -->
            </div>
        </section>

    </main>

    <script>
        // é¡Œç›®è³‡æ–™çµæ§‹
        const problems = [
            // é¡Œç›® 1
            {
                id: 1,
                steps: [
                    {
                        id: 1,
                        title: "æ­¥é©Ÿ 1ï¼šåˆ©ç”¨å¹³è¡Œç·šæ€§è³ª",
                        content: `
                            <p class="mb-2">å› ç‚º <span class="segment math-text">AD</span> // <span class="segment math-text">BC</span>ï¼Œ</p>
                            <p>æ ¹æ“šå¹³è¡Œç·šæˆªè§’æ€§è³ªï¼Œæˆ‘å€‘å¯ä»¥çŸ¥é“ï¼š</p>
                            <div class="my-4 text-xl bg-white p-4 rounded-lg shadow-inner text-center">
                                <span class="angle">âˆ </span>1 = <span class="slot" data-index="0"></span>
                                <br><span class="text-base text-gray-500 mt-2 block">( æ ¹æ“š <span class="slot" data-index="1"></span> ç›¸ç­‰ )</span>
                            </div>
                        `,
                        answers: ["âˆ 2", "å…§éŒ¯è§’"],
                        options: ["âˆ 2", "âˆ 3", "å…§éŒ¯è§’", "åŒä½è§’"],
                        hint: "è§€å¯Ÿåœ–å½¢ä¸­çš„ Z å­—å½¢ï¼ŒAD å¹³è¡Œ BCï¼ŒBD æ˜¯æˆªç·šã€‚"
                    },
                    {
                        id: 2,
                        title: "æ­¥é©Ÿ 2ï¼šåˆ©ç”¨è§’åº¦é—œä¿‚ä»£æ›",
                        content: `
                            <p class="mb-2">å·²çŸ¥ <span class="angle">âˆ </span><span class="math-text">A</span> = <span class="angle">âˆ </span><span class="math-text">C</span>ï¼Œä¸”å‰›æ‰è­‰å‡º <span class="angle">âˆ </span>1 = <span class="angle">âˆ </span>2ã€‚</p>
                            <p>è§€å¯Ÿä¸‰è§’å½¢è§’åº¦å’Œï¼Œæˆ‘å€‘å¯ä»¥æ¨å°ï¼š</p>
                            <div class="my-4 text-lg bg-white p-4 rounded-lg shadow-inner">
                                <p class="mb-2 text-center text-gray-400 text-sm">ä¸‰è§’å½¢å…§è§’å’Œ 180Â°</p>
                                <p class="text-center mb-2"><span class="angle">âˆ </span><span class="math-text">A</span> + <span class="angle">âˆ </span>2 + <span class="angle">âˆ </span>4 = 180Â°</p>
                                <p class="text-center mb-2"><span class="angle">âˆ </span><span class="math-text">C</span> + <span class="angle">âˆ </span>1 + <span class="angle">âˆ </span>3 = 180Â°</p>
                                <hr class="my-2 border-dashed">
                                <p class="font-bold text-center text-blue-600">
                                    <span class="text-black font-normal">çµè«–ï¼š</span> 
                                    <span class="angle">âˆ </span>3 = <span class="slot" data-index="0"></span>
                                </p>
                            </div>
                        `,
                        answers: ["âˆ 4"],
                        options: ["âˆ 1", "âˆ 4", "âˆ B", "âˆ D"],
                        hint: "æ—¢ç„¶ A=C ä¸” 1=2ï¼Œå‰©ä¸‹çš„è§’å¿…å®šç›¸ç­‰ã€‚"
                    },
                    {
                        id: 3,
                        title: "æ­¥é©Ÿ 3ï¼šæ¨å°å‡ºçµè«–",
                        content: `
                            <p class="mb-2">æœ€å¾Œï¼Œå› ç‚º <span class="angle">âˆ </span>3 = <span class="angle">âˆ </span>4ï¼Œ</p>
                            <p>é€™å…©è§’äº’ç‚º <span class="slot" data-index="0"></span>ï¼Œ</p>
                            <div class="my-4 text-xl bg-white p-4 rounded-lg shadow-inner text-center border-2 border-blue-200">
                                <span class="text-base block mb-2">æ•…å¯å¾—è­‰ï¼š</span>
                                <span class="segment math-text">AB</span> // <span class="slot" data-index="1"></span>
                            </div>
                        `,
                        answers: ["å…§éŒ¯è§’", "DC"],
                        options: ["BC", "DC", "å…§éŒ¯è§’", "åŒå´å…§è§’"],
                        hint: "ç•¶å…§éŒ¯è§’ç›¸ç­‰æ™‚ï¼Œå…©ç›´ç·šå¹³è¡Œã€‚"
                    }
                ]
            },
            // é¡Œç›® 2
            {
                id: 2,
                steps: [
                    {
                        id: 1,
                        title: "æ­¥é©Ÿ 1ï¼šè§€å¯Ÿå¹³è¡Œé—œä¿‚",
                        content: `
                            <p class="mb-2">åœ¨ <span class="triangle">â–³</span><span class="math-text">AOB</span> èˆ‡ <span class="triangle">â–³</span><span class="math-text">COD</span> ä¸­ï¼Œ</p>
                            <p>å› ç‚ºå››é‚Šå½¢ <span class="math-text">ABCD</span> ç‚ºå¹³è¡Œå››é‚Šå½¢ï¼Œ</p>
                            <div class="my-4 text-xl bg-white p-4 rounded-lg shadow-inner text-center">
                                <span class="text-base text-gray-500 block mb-1">å°é‚Šäº’ç›¸å¹³è¡Œï¼š</span>
                                <span class="slot" data-index="0"></span> // <span class="segment math-text">CD</span>
                            </div>
                        `,
                        answers: ["AB"],
                        options: ["AB", "AD", "BC", "AC"],
                        hint: "è§€å¯Ÿåœ–å½¢å·¦å´èˆ‡å³å´çš„é‚Šã€‚"
                    },
                    {
                        id: 2,
                        title: "æ­¥é©Ÿ 2ï¼šå…¨ç­‰æ¢ä»¶ (ASA)",
                        content: `
                            <p class="mb-2">å› ç‚º <span class="segment math-text">AB</span> // <span class="segment math-text">CD</span>ï¼Œæˆ‘å€‘å¯ä»¥æ‰¾åˆ°å…§éŒ¯è§’ç›¸ç­‰ï¼š</p>
                            <div class="my-4 text-lg bg-white p-4 rounded-lg shadow-inner space-y-3">
                                <div class="flex items-center justify-center gap-2">
                                    <span>â‘ </span>
                                    <span class="angle">âˆ </span>1 = <span class="slot" data-index="0"></span>
                                    <span class="text-sm text-gray-400">(å…§éŒ¯è§’)</span>
                                </div>
                                <div class="flex items-center justify-center gap-2">
                                    <span>â‘¡</span>
                                    <span class="angle">âˆ </span>5 = <span class="slot" data-index="1"></span>
                                    <span class="text-sm text-gray-400">(å…§éŒ¯è§’)</span>
                                </div>
                                <div class="flex items-center justify-center gap-2">
                                    <span>â‘¢</span>
                                    <span class="segment math-text">AB</span> = <span class="slot" data-index="2"></span>
                                    <span class="text-sm text-gray-400">(å°é‚Šç­‰é•·)</span>
                                </div>
                            </div>
                        `,
                        answers: ["âˆ 2", "âˆ 6", "CD"],
                        options: ["âˆ 2", "âˆ 3", "âˆ 6", "âˆ 4", "CD", "BC"],
                        hint: "è§€å¯Ÿ Z å­—å½¢ï¼šâˆ 1 èˆ‡å“ªå€‹è§’æ˜¯å…§éŒ¯è§’ï¼Ÿâˆ 5 å‘¢ï¼Ÿ"
                    },
                    {
                        id: 3,
                        title: "æ­¥é©Ÿ 3ï¼šçµè«–",
                        content: `
                            <p class="mb-2">æ ¹æ“šä¸Šè¿°æ¢ä»¶ï¼Œ<span class="triangle">â–³</span><span class="math-text">AOB</span> <span class="math-text">â‰…</span> <span class="triangle">â–³</span><span class="math-text">COD</span> (ASA å…¨ç­‰)ã€‚</p>
                            <p>æ‰€ä»¥å°æ‡‰é‚Šæœƒç›¸ç­‰ï¼š</p>
                            <div class="my-4 text-xl bg-white p-4 rounded-lg shadow-inner text-center border-2 border-blue-200">
                                <p class="mb-2"><span class="segment math-text">OA</span> = <span class="slot" data-index="0"></span></p>
                                <p><span class="segment math-text">OB</span> = <span class="slot" data-index="1"></span></p>
                            </div>
                        `,
                        answers: ["OC", "OD"],
                        options: ["OC", "OD", "AB", "CD"],
                        hint: "å…¨ç­‰ä¸‰è§’å½¢çš„å°æ‡‰é‚Šç›¸ç­‰ã€‚"
                    }
                ]
            }
        ];

        let currentProblemId = 1;
        // ç‹€æ…‹ç®¡ç†ï¼šè¨˜éŒ„æ¯é¡Œçš„ currentStepIndex å’Œ userAnswers
        // çµæ§‹ï¼š { problemId: { stepIndex: 0, answers: { step0: [], step1: [] ... } } }
        let appState = {
            1: {
                currentStepIndex: 0,
                answers: {}
            },
            2: {
                currentStepIndex: 0,
                answers: {}
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            initAnswersStorage();
            switchProblem(1);
        });

        function initAnswersStorage() {
            problems.forEach(p => {
                p.steps.forEach((step, sIdx) => {
                    appState[p.id].answers[sIdx] = new Array(step.answers.length).fill(null);
                });
            });
        }

        function switchProblem(id) {
            currentProblemId = id;
            
            // 1. æ›´æ–°å°è¦½åˆ—æŒ‰éˆ•æ¨£å¼
            document.querySelectorAll('.problem-tab').forEach(btn => {
                btn.classList.remove('active', 'bg-blue-600', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-700');
            });
            const activeBtn = document.getElementById(`tab-${id}`);
            activeBtn.classList.add('active', 'bg-blue-600', 'text-white');
            activeBtn.classList.remove('bg-gray-200', 'text-gray-700');

            // 2. åˆ‡æ›å·¦å´é¡Œç›®å€å¡Š
            document.getElementById('problem-intro-1').classList.add('hidden');
            document.getElementById('problem-intro-2').classList.add('hidden');
            document.getElementById(`problem-intro-${id}`).classList.remove('hidden');

            // 3. é‡æ–°æ¸²æŸ“å³å´æ­¥é©Ÿ
            renderSteps();
            updateStepVisibility();
        }

        function renderSteps() {
            const container = document.getElementById('steps-container');
            container.innerHTML = '';
            
            const problem = problems.find(p => p.id === currentProblemId);
            const state = appState[currentProblemId];
            
            problem.steps.forEach((step, index) => {
                const stepCard = document.createElement('div');
                // æª¢æŸ¥æ˜¯å¦å·²å®Œæˆï¼Œä»¥æ±ºå®šæ¨£å¼
                // ç°¡å–®åˆ¤æ–·ï¼šå¦‚æœæ¯”ç•¶å‰æ­¥é©Ÿå°ï¼Œå°±æ˜¯å·²å®Œæˆ (å‰ææ˜¯å¾ªåºæ¼¸é€²)
                // ç‚ºäº†åš´è¬¹ï¼Œæˆ‘å€‘å¯ä»¥æª¢æŸ¥æ˜¯å¦è©²æ­¥é©Ÿå·²å…¨å°ï¼Œä½†é€™è£¡ç”¨ currentStepIndex åˆ¤æ–·å³å¯
                const isCompleted = index < state.currentStepIndex;
                const isActive = index === state.currentStepIndex;
                
                let cardClass = `step-card bg-white rounded-xl shadow-md p-6 border border-gray-100`;
                if (isCompleted) cardClass += ' completed';
                if (isActive) cardClass += ' active';

                stepCard.className = cardClass;
                stepCard.id = `step-${index}`;
                stepCard.dataset.index = index;

                // æ¨™é¡Œèˆ‡ç‹€æ…‹
                const header = `
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                            <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">Step ${index + 1}</span>
                            ${step.title}
                        </h3>
                        <span class="status-icon ${isCompleted ? '' : 'hidden'} text-green-500 font-bold flex items-center">
                            <svg class="w-6 h-6 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                            å®Œæˆ
                        </span>
                    </div>
                `;

                // å…§å®¹èˆ‡å¡«ç­”æ ¼
                const contentDiv = document.createElement('div');
                contentDiv.innerHTML = step.content;
                contentDiv.className = "text-lg leading-relaxed mb-6 text-gray-700";

                // è‹¥å·²å›ç­”éï¼Œéœ€å›å¡« Slot å…§å®¹
                const savedAnswers = state.answers[index];
                const slots = contentDiv.querySelectorAll('.slot');
                slots.forEach((slot, slotIdx) => {
                    const ans = savedAnswers[slotIdx];
                    if (ans) {
                        slot.textContent = ans;
                        slot.classList.add('filled');
                        if (isCompleted) slot.classList.add('correct');
                    }
                    // ç¶å®šé»æ“Šäº‹ä»¶
                    slot.addEventListener('click', () => handleSlotClick(index, slot));
                });

                // é¸é …æŒ‰éˆ•å€
                const optionsDiv = document.createElement('div');
                optionsDiv.className = "options-area grid grid-cols-2 md:grid-cols-4 gap-3 mb-6";
                step.options.forEach(opt => {
                    const btn = document.createElement('button');
                    btn.className = "option-btn";
                    btn.textContent = opt;
                    
                    // æª¢æŸ¥æŒ‰éˆ•æ˜¯å¦æ‡‰è©²ç¦ç”¨ (å·²è¢«å¡«å…¥ Slot)
                    const isUsed = savedAnswers.includes(opt);
                    if (isUsed && !isCompleted) { // è‹¥è©²æ­¥é©Ÿå·²å®Œæˆï¼Œé€šå¸¸æŒ‰éˆ•å€æœƒéš±è—æˆ–ç¦ç”¨ï¼Œé€™è£¡ä¿æŒç¦ç”¨
                         btn.disabled = true;
                    }

                    btn.onclick = () => handleOptionClick(index, opt, btn);
                    optionsDiv.appendChild(btn);
                });

                // æª¢æŸ¥æŒ‰éˆ•å€
                const footer = `
                    <div class="check-btn-area flex flex-col items-center gap-3 border-t pt-4 ${isCompleted ? 'hidden' : ''}">
                        <div id="feedback-${index}" class="hidden w-full text-center p-2 rounded-lg text-sm font-bold"></div>
                        <button onclick="checkAnswer(${index})" class="w-full md:w-auto px-8 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold text-lg shadow-lg transition-transform transform active:scale-95 flex items-center justify-center gap-2">
                            <span>æª¢æŸ¥ç­”æ¡ˆ</span>
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        </button>
                    </div>
                `;

                stepCard.innerHTML = header;
                stepCard.appendChild(contentDiv);
                stepCard.appendChild(optionsDiv);
                stepCard.insertAdjacentHTML('beforeend', footer);

                container.appendChild(stepCard);
            });
        }

        function handleOptionClick(stepIndex, value, btnElement) {
            const stepCard = document.getElementById(`step-${stepIndex}`);
            const slots = stepCard.querySelectorAll('.slot');
            const currentAnswers = appState[currentProblemId].answers[stepIndex];
            
            let emptySlotIndex = -1;
            for (let i = 0; i < slots.length; i++) {
                if (!slots[i].classList.contains('filled')) {
                    emptySlotIndex = i;
                    break;
                }
            }

            if (emptySlotIndex !== -1) {
                const targetSlot = slots[emptySlotIndex];
                targetSlot.textContent = value;
                targetSlot.classList.add('filled');
                
                // æ›´æ–°ç‹€æ…‹
                currentAnswers[emptySlotIndex] = value;
                
                btnElement.disabled = true;
                
                const feedback = document.getElementById(`feedback-${stepIndex}`);
                if(feedback) feedback.classList.add('hidden');
                targetSlot.classList.remove('error');
            } else {
                showFeedback(stepIndex, "ç©ºæ ¼å·²æ»¿ï¼Œè«‹å…ˆæŒ‰æª¢æŸ¥ï¼Œæˆ–é»æ“Šç©ºæ ¼æ¸…é™¤ã€‚", "info");
            }
        }

        function handleSlotClick(stepIndex, slotElement) {
            // å¦‚æœæ­¥é©Ÿå·²å®Œæˆ (correct)ï¼Œä¸å¯å†é»æ“Šæ¸…é™¤
            if (slotElement.classList.contains('correct')) return;
            if (!slotElement.classList.contains('filled')) return;

            const value = slotElement.textContent;
            const slotIndex = parseInt(slotElement.dataset.index);
            
            // æ¸…é™¤ Slot
            slotElement.textContent = '';
            slotElement.classList.remove('filled', 'error');
            
            // æ›´æ–°ç‹€æ…‹
            appState[currentProblemId].answers[stepIndex][slotIndex] = null;

            // æ¢å¾©æŒ‰éˆ•
            const stepCard = document.getElementById(`step-${stepIndex}`);
            const buttons = stepCard.querySelectorAll('.option-btn');
            for (let btn of buttons) {
                if (btn.disabled && btn.textContent === value) {
                    btn.disabled = false;
                    break; 
                }
            }
        }

        function checkAnswer(stepIndex) {
            const problem = problems.find(p => p.id === currentProblemId);
            const step = problem.steps[stepIndex];
            const currentAnswers = appState[currentProblemId].answers[stepIndex];
            const stepCard = document.getElementById(`step-${stepIndex}`);
            const slots = stepCard.querySelectorAll('.slot');

            if (currentAnswers.includes(null)) {
                showFeedback(stepIndex, "è«‹å¡«æ»¿æ‰€æœ‰ç©ºæ ¼å†æª¢æŸ¥å“¦ï¼", "warning");
                return;
            }

            let allCorrect = true;
            currentAnswers.forEach((ans, idx) => {
                if (ans !== step.answers[idx]) {
                    allCorrect = false;
                    slots[idx].classList.add('error');
                } else {
                    slots[idx].classList.remove('error');
                }
            });

            if (allCorrect) {
                handleCorrect(stepIndex, slots);
            } else {
                showFeedback(stepIndex, "ç­”æ¡ˆä¸å®Œå…¨æ­£ç¢ºï¼Œå†æƒ³æƒ³çœ‹ï¼(é»æ“Šç©ºæ ¼å¯ä»¥ä¿®æ”¹)", "error");
            }
        }

        function handleCorrect(stepIndex, slots) {
            const stepCard = document.getElementById(`step-${stepIndex}`);
            
            showFeedback(stepIndex, "å¤ªæ£’äº†ï¼ç­”å°äº†ï¼", "success");
            slots.forEach(slot => {
                slot.classList.add('correct');
            });

            stepCard.classList.add('completed');
            stepCard.querySelector('.status-icon').classList.remove('hidden');
            stepCard.querySelector('.status-icon').classList.add('animate-tada');
            
            // éš±è—æª¢æŸ¥æŒ‰éˆ•å€
            stepCard.querySelector('.check-btn-area').classList.add('hidden');

            const state = appState[currentProblemId];
            const problem = problems.find(p => p.id === currentProblemId);

            // è§£é–ä¸‹ä¸€æ­¥
            if (stepIndex < problem.steps.length - 1) {
                state.currentStepIndex++;
                setTimeout(() => {
                    renderSteps(); // é‡æ–°æ¸²æŸ“ä»¥é¡¯ç¤ºä¸‹ä¸€æ­¥
                    
                    const nextStep = document.getElementById(`step-${state.currentStepIndex}`);
                    if(nextStep) nextStep.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 1000);
            } else {
                state.currentStepIndex++; // æ¨™è¨˜ç‚ºå…¨éƒ¨å®Œæˆ
                setTimeout(() => {
                    alert("æ­å–œï¼ä½ å·²ç¶“å®Œæˆé€™é¡Œçš„è­‰æ˜äº†ï¼ğŸ‰");
                }, 800);
            }
        }

        function updateStepVisibility() {
            // é€™å€‹åŠŸèƒ½ä¸»è¦æ•´åˆåœ¨ renderSteps ä¸­äº†ï¼Œ
            // å› ç‚ºæˆ‘å€‘ç¾åœ¨æ˜¯æ ¹æ“š appState å‹•æ…‹ç”Ÿæˆ class
        }

        function showFeedback(stepIndex, msg, type) {
            const feedbackEl = document.getElementById(`feedback-${stepIndex}`);
            if(!feedbackEl) return;
            
            feedbackEl.textContent = msg;
            feedbackEl.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'bg-yellow-100', 'text-yellow-700');
            
            if (type === 'error') {
                feedbackEl.classList.add('bg-red-100', 'text-red-700');
            } else if (type === 'success') {
                feedbackEl.classList.add('bg-green-100', 'text-green-700');
            } else {
                feedbackEl.classList.add('bg-yellow-100', 'text-yellow-700');
            }
        }

    </script>
</body>
</html>
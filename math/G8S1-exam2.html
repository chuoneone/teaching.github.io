<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>國中數學互動複習網</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- KaTeX for Math -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>

    <style>
        /* Math Font Setting */
        .font-math { font-family: 'Times New Roman', serif; }
        
        /* Pulse Animation */
        @keyframes pulse-once {
            0% { transform: scale(0.9); opacity: 0; }
            60% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); }
        }
        .animate-pulse-once {
            animation: pulse-once 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 20px;
        }

        /* Hide scrollbar for clean UI but keep functionality */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Icons (Inline SVGs to remove dependencies) ---
        const Calculator = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></svg>
        );
        const BookOpen = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
        );
        const Brain = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"/></svg>
        );
        const Home = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
        );
        const ArrowRight = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
        );
        const ChevronRight = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m9 18 6-6-6-6"/></svg>
        );
        const RefreshCcw = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 21h5v-5"/></svg>
        );
        const CheckCircle = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="M22 4 12 14.01l-3-3"/></svg>
        );
        const Star = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
        );

        // --- Geometry Component ---
        const RightTriangle = ({ a, b, h_label, c_label, showAltitude }) => {
            const scale = 180 / Math.max(a, b);
            const w = a * scale;
            const h = b * scale;
            
            return (
                <svg viewBox="-20 -20 250 250" className="w-56 h-56 md:w-64 md:h-64 mx-auto drop-shadow-md">
                    <path 
                        d={`M 20 ${20+h} L ${20+w} ${20+h} L 20 20 Z`} 
                        fill="#f0f9ff" 
                        stroke="#3b82f6" 
                        strokeWidth="3"
                        strokeLinejoin="round"
                    />
                    <path d={`M 20 ${20+h-15} L 35 ${20+h-15} L 35 ${20+h}`} fill="none" stroke="#94a3b8" strokeWidth="2" />

                    <text x={20 + w/2} y={20 + h + 25} textAnchor="middle" className="text-lg font-bold fill-slate-600">{a}</text>
                    <text x={0} y={20 + h/2} textAnchor="middle" className="text-lg font-bold fill-slate-600">{b}</text>
                    
                    {!showAltitude && (
                        <text x={20 + w/2 + 10} y={20 + h/2 - 10} textAnchor="middle" className="text-lg font-bold fill-red-500">{c_label || '?'}</text>
                    )}

                    {showAltitude && (
                        <>
                        <text x={20 + w/2 + 20} y={20 + h/2 - 20} textAnchor="middle" className="text-lg font-bold fill-slate-600">{c_label}</text>
                        <line x1={20} y1={20+h} x2={20 + w*0.36} y2={20 + h*0.36} stroke="#ef4444" strokeWidth="2" strokeDasharray="5,5" />
                        <text x={20 + w*0.2} y={20 + h*0.7} className="text-lg font-bold fill-red-600">h</text>
                        </>
                    )}
                </svg>
            );
        };

        // --- Data ---
        const TOPICS = [
            {
                id: '2-2',
                title: '2-2 根式的運算',
                color: 'bg-blue-100 text-blue-800',
                icon: <Calculator className="w-6 h-6" />,
                questions: [
                {
                    id: 'q2-2-1a',
                    title: '基礎乘法',
                    question: '$-3 \\times 4\\sqrt{2} = ?$',
                    steps: [
                    { text: '先把整數的部分乘在一起', math: '-3 \\times 4 = -12' },
                    { text: '把乘出來的結果寫在根號前面', math: '-12\\sqrt{2}' }
                    ],
                    final: '-12\\sqrt{2}'
                },
                {
                    id: 'q2-2-1b',
                    title: '根式除法',
                    question: '$16\\sqrt{6} \\div 8 = ?$',
                    steps: [
                    { text: '寫成分數的樣子比較好算', math: '\\frac{16\\sqrt{6}}{8}' },
                    { text: '將整數 16 除以 8', math: '2\\sqrt{6}' }
                    ],
                    final: '2\\sqrt{6}'
                },
                {
                    id: 'q2-2-2',
                    title: '根號乘法',
                    question: '$\\sqrt{5} \\times \\sqrt{11} = ?$',
                    steps: [
                    { text: '把兩個數字放在同一個根號裡相乘', math: '\\sqrt{5 \\times 11}' },
                    { text: '算出乘法結果', math: '\\sqrt{55}' }
                    ],
                    final: '\\sqrt{55}'
                },
                {
                    id: 'q2-2-3',
                    title: '根號除法',
                    question: '$\\sqrt{72} \\div \\sqrt{12} = ?$',
                    steps: [
                    { text: '把兩個數字放在同一個根號裡相除', math: '\\sqrt{\\frac{72}{12}}' },
                    { text: '算出 72 除以 12 的結果', math: '\\sqrt{6}' }
                    ],
                    final: '\\sqrt{6}'
                },
                {
                    id: 'q2-2-5',
                    title: '有理化分母',
                    question: '有理化 $\\frac{4}{\\sqrt{5}}$',
                    steps: [
                    { text: '分子和分母都乘以根號 5', math: '\\frac{4 \\times \\sqrt{5}}{\\sqrt{5} \\times \\sqrt{5}}' },
                    { text: '分母兩個根號 5 相乘會變成整數 5', math: '\\frac{4\\sqrt{5}}{5}' }
                    ],
                    final: '\\frac{4\\sqrt{5}}{5}'
                },
                {
                    id: 'q2-2-6',
                    title: '根式加減',
                    question: '$\\sqrt{18} + \\sqrt{12} - 2\\sqrt{2}$',
                    steps: [
                    { text: '先把第一項的根號 18 化簡', math: '3\\sqrt{2} + \\sqrt{12} - 2\\sqrt{2}' },
                    { text: '再把中間的根號 12 化簡', math: '3\\sqrt{2} + 2\\sqrt{3} - 2\\sqrt{2}' },
                    { text: '把有根號 2 的項目合併計算', math: '(3-2)\\sqrt{2} + 2\\sqrt{3}' },
                    { text: '算出最後答案', math: '\\sqrt{2} + 2\\sqrt{3}' }
                    ],
                    final: '\\sqrt{2} + 2\\sqrt{3}'
                },
                {
                    id: 'q2-2-7',
                    title: '進階有理化',
                    question: '$\\frac{1}{\\sqrt{7}-\\sqrt{4}}$',
                    steps: [
                    { text: '先把根號 4 變成整數 2', math: '\\frac{1}{\\sqrt{7}-2}' },
                    { text: '上下同乘 (根號 7 加 2)', math: '\\frac{\\sqrt{7}+2}{(\\sqrt{7}-2)(\\sqrt{7}+2)}' },
                    { text: '分母變成平方減平方', math: '\\frac{\\sqrt{7}+2}{(\\sqrt{7})^2 - 2^2}' },
                    { text: '算出分母 7 減 4 等於 3', math: '\\frac{\\sqrt{7}+2}{3}' }
                    ],
                    final: '\\frac{\\sqrt{7}+2}{3}'
                }
                ]
            },
            {
                id: '2-3',
                title: '2-3 畢氏定理',
                color: 'bg-green-100 text-green-800',
                icon: <BookOpen className="w-6 h-6" />,
                questions: [
                {
                    id: 'q2-3-1',
                    title: '求斜邊長',
                    type: 'geometry',
                    geometryProps: { a: 12, b: 16, c_label: 'x' },
                    question: '如圖，直角三角形兩股 $12$, $16$，求斜邊 $x$',
                    steps: [
                    { text: '使用畢氏定理公式', math: 'c = \\sqrt{a^2 + b^2}' },
                    { text: '把題目數字放進去', math: 'x = \\sqrt{12^2 + 16^2}' },
                    { text: '算出平方', math: 'x = \\sqrt{144 + 256}' },
                    { text: '相加起來', math: 'x = \\sqrt{400}' },
                    { text: '開根號得到答案', math: '20' }
                    ],
                    final: '20'
                },
                {
                    id: 'q2-3-2',
                    title: '求斜邊上的高',
                    type: 'geometry',
                    geometryProps: { a: 8, b: 6, c_label: '10', showAltitude: true },
                    question: '斜邊 $10$，兩股 $6$, $8$，求斜邊上的高 $h$',
                    steps: [
                    { text: '利用速算法：兩股相乘除以斜邊', math: 'h = \\frac{\\text{兩股相乘}}{\\text{斜邊}}' },
                    { text: '把數字放進分數裡 (6和8在上面，10在下面)', math: 'h = \\frac{6 \\times 8}{10}' },
                    { text: '先算出分子 6 乘 8', math: 'h = \\frac{48}{10}' },
                    { text: '算出答案 (除以 10 就是小數點移一位)', math: 'h = 4.8' }
                    ],
                    final: '4.8'
                },
                {
                    id: 'q2-3-3',
                    title: '兩點距離',
                    question: '求 $A(4,1), B(-2,5)$ 的距離 $\\overline{AB}$',
                    steps: [
                    { text: '使用兩點距離公式', math: '\\sqrt{(x_1-x_2)^2 + (y_1-y_2)^2}' },
                    { text: '把數字放進去 (小心負號)', math: '\\sqrt{(4 - (-2))^2 + (1 - 5)^2}' },
                    { text: '算出括號裡的數字', math: '\\sqrt{6^2 + (-4)^2}' },
                    { text: '平方相加', math: '\\sqrt{36 + 16} = \\sqrt{52}' },
                    { text: '化簡根號 52 (4乘以13)', math: '2\\sqrt{13}' }
                    ],
                    final: '2\\sqrt{13}'
                }
                ]
            },
            {
                id: '3-1',
                title: '3-1~2 因式分解',
                color: 'bg-amber-100 text-amber-800',
                icon: <Brain className="w-6 h-6" />,
                questions: [
                {
                    id: 'q3-1-2',
                    title: '提公因式',
                    question: '$x(2x+1)-5(2x+1)$',
                    steps: [
                    { text: '找找看前後都有什麼一樣的？', math: '\\underline{(2x+1)} \\text{ 是公因式}' },
                    { text: '把一樣的提出來，剩下的放括號', math: '(2x+1)(x-5)' }
                    ],
                    final: '(2x+1)(x-5)'
                },
                {
                    id: 'q3-1-3',
                    title: '平方差公式',
                    question: '$x^2 - 36$',
                    steps: [
                    { text: '36 是 6 的平方', math: 'x^2 - 6^2' },
                    { text: '套用平方差公式：一加一減', math: '(x+6)(x-6)' }
                    ],
                    final: '(x+6)(x-6)'
                },
                {
                    id: 'q3-1-5',
                    title: '差的平方',
                    question: '$9x^2 - 6x + 1$',
                    steps: [
                    { text: '檢查前後是不是完全平方數', math: '(3x)^2 \\text{ 和 } 1^2' },
                    { text: '檢查中間項是不是 2 乘以前後', math: '2 \\times (3x) \\times 1 = 6x \\text{ (對)}' },
                    { text: '寫成差的平方公式', math: '(3x-1)^2' }
                    ],
                    final: '(3x-1)^2'
                },
                {
                    id: 'q3-2-1',
                    title: '十字交乘法 (1)',
                    question: '$x^2 - 8x + 15$',
                    steps: [
                    { text: '找兩個數相乘是 15', math: '(-3) \\times (-5) = 15' },
                    { text: '這兩個數相加剛好是 -8', math: '(-3) + (-5) = -8' },
                    { text: '把這兩個數寫進答案', math: '(x-3)(x-5)' }
                    ],
                    final: '(x-3)(x-5)'
                },
                {
                    id: 'q3-2-2',
                    title: '十字交乘法 (2)',
                    question: '$12x^2 + 7x - 12$',
                    steps: [
                    { text: '拆解前面的 12x 平方', math: '12x^2 \\to 4x, 3x' },
                    { text: '拆解後面的 -12', math: '-12 \\to -3, +4' },
                    { text: '交叉相乘檢查', math: '16x - 9x = 7x \\text{ (符合)}' },
                    { text: '橫向寫出答案', math: '(4x-3)(3x+4)' }
                    ],
                    final: '(4x-3)(3x+4)'
                }
                ]
            }
        ];

        // --- Math Components ---
        const MathDisplay = ({ latex, className = "" }) => {
            const containerRef = useRef(null);

            useEffect(() => {
                if (window.katex && containerRef.current) {
                    window.katex.render(latex, containerRef.current, {
                        throwOnError: false,
                        displayMode: true,
                    });
                }
            }, [latex]);

            return <div ref={containerRef} className={`font-math my-2 ${className}`}></div>;
        };

        const InlineMath = ({ latex }) => {
            const containerRef = useRef(null);

            useEffect(() => {
                if (window.katex && containerRef.current) {
                    window.katex.render(latex, containerRef.current, {
                        throwOnError: false,
                        displayMode: false,
                    });
                }
            }, [latex]);

            return <span ref={containerRef} className="font-math mx-1 inline-block"></span>;
        };

        const FormattedText = ({ text, className = "" }) => {
            const parts = text.split(/(\$[^$]+\$)/g);
            return (
                <div className={`${className} leading-relaxed break-words whitespace-normal`}>
                    {parts.map((part, index) => {
                        if (part.startsWith('$') && part.endsWith('$')) {
                            return <InlineMath key={index} latex={part.slice(1, -1)} />;
                        }
                        return <span key={index}>{part}</span>;
                    })}
                </div>
            );
        };

        // --- Main App Component ---
        const App = () => {
            const [currentTopicId, setCurrentTopicId] = useState(null);
            const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
            const [currentStep, setCurrentStep] = useState(0);
            const [showConfetti, setShowConfetti] = useState(false);
            const stepsEndRef = useRef(null);

            // Auto-scroll
            useEffect(() => {
                if (stepsEndRef.current) {
                    stepsEndRef.current.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            }, [currentStep]);

            const currentTopic = TOPICS.find(t => t.id === currentTopicId);
            const currentQuestion = currentTopic ? currentTopic.questions[currentQuestionIndex] : null;

            const handleNextStep = () => {
                if (currentQuestion && currentStep < currentQuestion.steps.length + 1) {
                    setCurrentStep(prev => prev + 1);
                    if (currentStep === currentQuestion.steps.length) {
                        setShowConfetti(true);
                        setTimeout(() => setShowConfetti(false), 3000);
                    }
                }
            };

            const handleReset = () => {
                setCurrentStep(0);
                setShowConfetti(false);
            };

            const handleNextQuestion = () => {
                if (currentQuestionIndex < currentTopic.questions.length - 1) {
                    setCurrentQuestionIndex(prev => prev + 1);
                    handleReset();
                }
            };

            const handlePrevQuestion = () => {
                if (currentQuestionIndex > 0) {
                    setCurrentQuestionIndex(prev => prev - 1);
                    handleReset();
                }
            };

            if (!currentTopic) {
                return (
                    <div className="min-h-screen bg-slate-50 font-sans p-6 flex flex-col items-center">
                        <header className="mb-10 text-center max-w-2xl">
                            <h1 className="text-4xl md:text-5xl font-bold text-slate-800 mb-6 tracking-tight">國中數學重點複習</h1>
                            <p className="text-xl text-slate-600 leading-relaxed">選擇一個單元，我們一起一步步慢慢解題。</p>
                        </header>
                        
                        <div className="w-full max-w-5xl grid gap-6 md:grid-cols-2 lg:grid-cols-3">
                            {TOPICS.map(topic => (
                                <button
                                    key={topic.id}
                                    onClick={() => { setCurrentTopicId(topic.id); setCurrentQuestionIndex(0); handleReset(); }}
                                    className={`${topic.color} p-8 rounded-3xl shadow-sm hover:shadow-xl transition-all transform hover:-translate-y-2 flex flex-col items-center text-center border-2 border-transparent hover:border-current group relative overflow-hidden`}
                                >
                                    <div className="absolute top-0 right-0 p-4 opacity-10">
                                        {topic.icon}
                                    </div>
                                    <div className="bg-white/90 p-5 rounded-full mb-5 group-hover:scale-110 transition-transform shadow-sm">
                                        {topic.icon}
                                    </div>
                                    <h2 className="text-2xl font-bold mb-3">{topic.title}</h2>
                                    <div className="text-base opacity-80 font-medium tracking-wide">{topic.questions.length} 題練習</div>
                                </button>
                            ))}
                        </div>
                    </div>
                );
            }

            const isFinished = currentStep > currentQuestion.steps.length;

            return (
                <div className="min-h-screen bg-slate-50 flex flex-col">
                    <div className="bg-white shadow-sm p-4 sticky top-0 z-20">
                        <div className="max-w-7xl mx-auto flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <button 
                                    onClick={() => setCurrentTopicId(null)}
                                    className="p-2 hover:bg-slate-100 rounded-full transition-colors text-slate-600 flex items-center gap-2 font-medium"
                                >
                                    <Home className="w-5 h-5" />
                                    <span className="hidden sm:inline">回首頁</span>
                                </button>
                                <div className="h-6 w-px bg-slate-200 hidden sm:block"></div>
                                <h2 className="text-lg font-bold text-slate-800 truncate max-w-[150px] sm:max-w-none">{currentTopic.title}</h2>
                            </div>
                            
                            <div className="flex items-center gap-2 bg-slate-100 px-4 py-1.5 rounded-full text-sm font-medium text-slate-600 shadow-inner">
                                <span className="text-blue-600 font-bold">{currentQuestionIndex + 1}</span>
                                <span className="text-slate-300">/</span>
                                <span>{currentTopic.questions.length}</span>
                            </div>
                        </div>
                    </div>

                    <main className="flex-1 max-w-7xl mx-auto w-full p-4 md:p-6 lg:p-8 flex flex-col">
                        <div className="w-full bg-slate-200 h-2.5 rounded-full mb-8 overflow-hidden shadow-inner">
                            <div 
                                className="bg-blue-500 h-full transition-all duration-700 ease-out rounded-full"
                                style={{ width: `${((currentStep) / (currentQuestion.steps.length + 1)) * 100}%` }}
                            ></div>
                        </div>

                        <div className="bg-white rounded-[2rem] shadow-lg border border-slate-100 overflow-hidden flex flex-col lg:flex-row min-h-[60vh]">
                            
                            <div className="lg:w-5/12 xl:w-1/2 bg-slate-50/50 p-6 md:p-10 flex flex-col justify-center border-b lg:border-b-0 lg:border-r border-slate-100 relative">
                                <div className="absolute top-6 left-6">
                                    <span className="inline-block px-4 py-1.5 bg-blue-100 text-blue-700 rounded-full text-sm font-bold shadow-sm">
                                        {currentQuestion.title}
                                    </span>
                                </div>

                                <div className="flex flex-col items-center text-center mt-8 lg:mt-0 w-full px-4">
                                    {currentQuestion.type === 'geometry' && (
                                        <div className="mb-6 transform hover:scale-105 transition-transform duration-500">
                                             <RightTriangle {...currentQuestion.geometryProps} />
                                        </div>
                                    )}

                                    <div className="text-2xl md:text-3xl text-slate-800 font-bold w-full max-w-lg">
                                        <FormattedText text={currentQuestion.question} />
                                    </div>
                                </div>
                            </div>

                            <div className="lg:w-7/12 xl:w-1/2 p-6 md:p-10 flex flex-col bg-white">
                                <div className="flex-1 space-y-6 overflow-y-auto max-h-[600px] custom-scrollbar pr-2">
                                    
                                    {currentStep === 0 && (
                                        <div className="h-full flex flex-col items-center justify-center text-slate-400 py-12 animate-in fade-in duration-700">
                                            <div className="bg-slate-50 p-6 rounded-full mb-4">
                                                <Brain className="w-12 h-12 text-blue-300" />
                                            </div>
                                            <p className="font-medium text-lg">準備好了嗎？點擊下方按鈕開始解題</p>
                                        </div>
                                    )}

                                    {currentQuestion.steps.map((step, idx) => (
                                        <div 
                                            key={idx} 
                                            className={`transition-all duration-500 ease-out transform
                                                ${idx < currentStep 
                                                    ? 'opacity-100 translate-y-0' 
                                                    : 'opacity-0 translate-y-8 hidden'
                                                }
                                            `}
                                        >
                                            <div className="flex gap-4 group">
                                                <div className="flex flex-col items-center pt-1">
                                                    <div className="w-10 h-10 rounded-full bg-blue-600 text-white flex items-center justify-center font-bold text-lg shadow-md shrink-0 group-hover:scale-110 transition-transform">
                                                        {idx + 1}
                                                    </div>
                                                    {idx !== currentQuestion.steps.length - 1 && (
                                                        <div className="w-0.5 h-full bg-blue-100 my-2 min-h-[3rem]"></div>
                                                    )}
                                                </div>
                                                <div className="flex-1 pb-4">
                                                    <p className="text-slate-600 text-lg mb-3 font-medium leading-relaxed">{step.text}</p>
                                                    <div className="bg-blue-50/50 p-5 rounded-2xl border border-blue-100 shadow-sm hover:shadow-md transition-shadow">
                                                        <MathDisplay latex={step.math} className="text-2xl text-slate-800" />
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    ))}

                                    <div className={`transition-all duration-700 delay-200 transform
                                        ${isFinished 
                                            ? 'opacity-100 translate-y-0' 
                                            : 'opacity-0 translate-y-8 hidden'
                                        }
                                    `}>
                                        <div className="bg-green-50 border-2 border-green-200 rounded-2xl p-8 text-center animate-pulse-once mt-4 relative overflow-hidden">
                                            <div className="absolute top-0 left-0 w-full h-1 bg-green-300"></div>
                                            <div className="flex justify-center items-center gap-2 text-green-700 font-bold mb-3 uppercase tracking-wider text-sm">
                                                <Star className="fill-green-600 text-green-600 w-5 h-5" />
                                                Final Answer
                                            </div>
                                            <div className="text-4xl md:text-5xl text-green-800 font-bold">
                                                <MathDisplay latex={currentQuestion.final} />
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div ref={stepsEndRef} />
                                </div>

                                <div className="pt-8 mt-auto border-t border-slate-100">
                                    <div className="flex flex-wrap items-center gap-3 md:gap-4">
                                        <button
                                            onClick={handlePrevQuestion}
                                            disabled={currentQuestionIndex === 0}
                                            className="p-4 rounded-2xl bg-slate-100 hover:bg-slate-200 disabled:opacity-30 disabled:hover:bg-slate-100 transition-colors text-slate-500"
                                            title="上一題"
                                        >
                                            <ArrowRight className="w-6 h-6 rotate-180" />
                                        </button>

                                        {!isFinished ? (
                                            <button
                                                onClick={handleNextStep}
                                                className="flex-1 bg-blue-600 hover:bg-blue-700 text-white text-xl font-bold py-4 px-8 rounded-2xl shadow-lg shadow-blue-200 active:scale-95 transition-all flex items-center justify-center gap-3 group"
                                            >
                                                <span>{currentStep === 0 ? '開始解題' : '顯示下一步'}</span>
                                                <ChevronRight className="w-6 h-6 group-hover:translate-x-1 transition-transform" />
                                            </button>
                                        ) : (
                                             <div className="flex gap-3 flex-1">
                                                <button
                                                    onClick={handleReset}
                                                    className="flex-1 bg-white border-2 border-slate-200 hover:border-slate-300 hover:bg-slate-50 text-slate-600 font-bold py-4 rounded-2xl transition-all flex items-center justify-center gap-2"
                                                >
                                                    <RefreshCcw className="w-5 h-5" />
                                                    <span className="hidden sm:inline">重算</span>
                                                </button>
                                                {currentQuestionIndex < currentTopic.questions.length - 1 ? (
                                                     <button
                                                        onClick={handleNextQuestion}
                                                        className="flex-[2] bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded-2xl shadow-lg shadow-green-200 transition-colors flex items-center justify-center gap-2 group"
                                                    >
                                                        <span>下一題</span>
                                                        <ArrowRight className="w-5 h-5 group-hover:translate-x-1 transition-transform" />
                                                    </button>
                                                ) : (
                                                    <button
                                                        onClick={() => setCurrentTopicId(null)}
                                                        className="flex-[2] bg-slate-800 hover:bg-slate-900 text-white font-bold py-4 rounded-2xl shadow-lg transition-colors flex items-center justify-center gap-2"
                                                    >
                                                        <span>完成單元</span>
                                                        <CheckCircle className="w-5 h-5" />
                                                    </button>
                                                )}
                                            </div>
                                        )}
                                        
                                        <button
                                            onClick={handleNextQuestion}
                                            disabled={currentQuestionIndex === currentTopic.questions.length - 1}
                                            className="p-4 rounded-2xl bg-slate-100 hover:bg-slate-200 disabled:opacity-30 disabled:hover:bg-slate-100 transition-colors text-slate-500"
                                            title="下一題"
                                        >
                                            <ArrowRight className="w-6 h-6" />
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </main>

                    {showConfetti && (
                        <div className="fixed inset-0 pointer-events-none flex justify-center items-start pt-32 z-50">
                            <div className="animate-bounce bg-white px-8 py-4 rounded-full shadow-2xl border-4 border-yellow-400 text-yellow-600 font-bold text-2xl flex items-center gap-3 transform rotate-[-2deg]">
                                <Star className="fill-yellow-400 text-yellow-400 w-8 h-8" />
                                太棒了！答對了！
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
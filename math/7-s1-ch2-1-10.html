<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>互動式學習單：標準分解式與質因數</title>
    <link rel="icon" href="images/dog.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/auto-render.min.js"></script>
    <style>
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: #f0fdfa; }
        .step-container { transition: all 0.5s ease-in-out; border: 1px solid #cce3e3; }
        .step-locked { opacity: 0.4; pointer-events: none; filter: grayscale(100%); }
        .feedback-message { transition: opacity 0.3s; padding: 0.75rem 1.25rem; border-radius: 0.5rem; font-weight: 500; }
        .feedback-correct { background-color: #e6fffa; color: #065f46; border: 1px solid #4fd1c5; }
        .feedback-incorrect { background-color: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }
        .highlight { background: linear-gradient(to top, #bae6fd 60%, transparent 60%); padding: 0 0.2rem; font-weight: bold; }
        .input-box { width: 70px; padding: 8px; border-radius: 4px; border: 1px solid #9ca3af; text-align: center; font-size: 1.1rem; transition: all 0.2s; }
        .math-symbol { font-size: 1.5rem; font-weight: 700; color: #1e2b3b; }
        .katex { font-size: 1.1em; }
        #drawing-canvas { cursor: crosshair; touch-action: none; }
        .tool-btn { border: 2px solid transparent; padding: 0.5rem; border-radius: 0.375rem; transition: all 0.2s; }
        .tool-btn.active { border-color: #0d9488; background-color: #ccfbf1; }
        .color-btn { width: 2rem; height: 2rem; border-radius: 9999px; cursor: pointer; border: 2px solid #e5e7eb; }
        .color-btn.active { border-color: #0d9488; transform: scale(1.1); }
        .nav-btn { padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; transition: all 0.2s; border: 2px solid transparent;}
        .nav-btn.active { background-color: #14b8a6; color: white; border-color: #0f766e;}
        .nav-btn:not(.active) { background-color: #f1f5f9; color: #475569; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4 bg-cyan-50">
    <div class="w-full max-w-2xl bg-white rounded-xl shadow-2xl p-6 md:p-8">
        
        <!-- 題庫導覽 -->
        <div id="question-nav" class="flex justify-center items-center flex-wrap gap-2 mb-6 border-b pb-4">
            <!-- Nav buttons will be inserted by JS -->
        </div>

        <div class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-extrabold text-teal-700 mb-2">標準分解式與質因數</h1>
            <p class="text-slate-500 text-lg">互動式學習單：個案調整</p>
        </div>
        <div id="prompt-container" class="bg-cyan-100 p-5 rounded-lg mb-6 border-l-4 border-cyan-400">
            <!-- Prompt will be inserted by JS -->
        </div>
        <div id="global-feedback" class="text-center h-12 mb-4"></div>

        <!-- 步驟 1: 畫布 -->
        <div id="step1" class="step-container p-5 rounded-lg bg-slate-50 mb-4">
            <h3 class="font-bold text-xl text-teal-700 mb-2">步驟一：短除法計算（畫布區）</h3>
            <p id="canvas-prompt" class="text-base text-slate-500 mb-4"></p>
            <div class="flex flex-wrap justify-center items-center mb-4 gap-4 p-2 bg-slate-200 rounded-lg" id="canvas-controls">
                <div class="flex items-center gap-2">
                    <button id="pen-tool" class="tool-btn active" title="畫筆">✏️</button>
                    <button id="eraser-tool" class="tool-btn" title="橡皮擦">🧼</button>
                </div>
                <div class="flex items-center gap-2">
                    <button class="color-btn active" style="background-color: #000000;" data-color="#000000"></button>
                    <button class="color-btn" style="background-color: #ef4444;" data-color="#ef4444"></button>
                    <button class="color-btn" style="background-color: #3b82f6;" data-color="#3b82f6"></button>
                </div>
                <div class="flex items-center gap-2">
                    <label for="pen-width" class="text-sm">粗細:</label>
                    <input type="range" id="pen-width" min="1" max="10" value="3" class="w-24">
                </div>
                <button id="clear-canvas" class="tool-btn bg-red-200" title="全部清除">🗑️</button>
            </div>
            <div class="flex justify-center">
                <canvas id="drawing-canvas" class="bg-white border-2 border-slate-300 rounded-lg"></canvas>
            </div>
        </div>
        
        <!-- 步驟 2 & 3 -->
        <div id="step2" class="step-container p-5 rounded-lg bg-white mb-4">
            <h3 class="font-bold text-xl text-teal-700 mb-2">步驟二：寫出標準分解式</h3>
            <p class="text-base text-slate-500 mb-4">將分解結果寫成指數形式。</p>
            <div id="step2-inputs-container" class="flex flex-wrap items-center justify-center gap-x-2 gap-y-4 md:space-x-4">
                <!-- Step 2 inputs will be generated by JS -->
            </div>
             <div class="text-center mt-6"><button id="check-s2-btn" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-6 rounded-lg transition-colors text-lg">檢查答案</button></div>
        </div>
        <div id="step3" class="step-container p-5 rounded-lg bg-white mb-4 step-locked">
            <h3 class="font-bold text-xl text-teal-700 mb-2">步驟三：找出所有的質因數</h3>
            <p class="text-base text-slate-500 mb-4">質因數是標準分解式中「底數」的部分，請由小到大填寫。</p>
            <div id="step3-inputs-container" class="flex items-center justify-center flex-wrap gap-x-2 gap-y-4">
                <!-- Step 3 inputs will be generated by JS -->
            </div>
             <div class="text-center mt-6"><button id="check-s3-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition-colors text-lg">提交最終答案</button></div>
        </div>
        
        <div id="completion-message" class="text-center mt-8 p-6 bg-cyan-100 border-2 border-cyan-400 rounded-lg" style="display: none;">
            <h2 class="text-3xl font-bold text-teal-700">恭喜你，完成練習！</h2>
            <p class="mt-2 text-teal-600 text-lg">你已經掌握了這個概念！</p>
            <button id="reset-btn" class="mt-4 bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg transition-colors text-lg">重新練習</button>
        </div>
    </div>
    <footer style="font-size:12px; color:gray; text-align:center; line-height:1.6;">
© 2025 特教米克師｜採用 
<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh_TW" target="_blank">
CC BY-NC-SA 4.0 創用CC授權
</a>  
<br>
非商業用途歡迎轉載或改編，請保留署名並附上原始連結。
</footer>

    <script>
        const questions = [
            { number: 180, answers: { step2: [ { base: 2, exp: 2 }, { base: 3, exp: 2 }, { base: 5, exp: 1 } ], step3: [ 2, 3, 5 ] }},
            { number: 60,  answers: { step2: [ { base: 2, exp: 2 }, { base: 3, exp: 1 }, { base: 5, exp: 1 } ], step3: [ 2, 3, 5 ] }},
            { number: 30,  answers: { step2: [ { base: 2, exp: 1 }, { base: 3, exp: 1 }, { base: 5, exp: 1 } ], step3: [ 2, 3, 5 ] }},
            { number: 345, answers: { step2: [ { base: 3, exp: 1 }, { base: 5, exp: 1 }, { base: 23, exp: 1 } ], step3: [ 3, 5, 23 ] }},
            { number: 117, answers: { step2: [ { base: 3, exp: 2 }, { base: 13, exp: 1 } ], step3: [ 3, 13 ] }},
            { number: 456, answers: { step2: [ { base: 2, exp: 3 }, { base: 3, exp: 1 }, { base: 19, exp: 1 } ], step3: [ 2, 3, 19 ] }}
        ];
        let currentQuestionIndex = 0;

        const feedbackEl = document.getElementById('global-feedback');
        
        function showFeedback(message, isCorrect) {
            feedbackEl.innerHTML = `<div class="feedback-message ${isCorrect ? 'feedback-correct' : 'feedback-incorrect'}">${message}</div>`;
            setTimeout(() => { feedbackEl.innerHTML = ''; }, 3000);
        }

        function setStepLock(stepId, locked) {
            const step = document.getElementById(stepId);
            step.classList.toggle('step-locked', locked);
            if (!locked && step.querySelector('input:not([disabled])')) {
                 step.querySelector('input:not([disabled])').focus();
            }
        }
        
        function loadQuestion(index) {
            currentQuestionIndex = index;
            const question = questions[index];
            
            // Update nav
            document.querySelectorAll('#question-nav .nav-btn').forEach((btn, i) => btn.classList.toggle('active', i === index));
            
            // Update prompts
            document.getElementById('prompt-container').innerHTML = `<p class="text-slate-700 leading-relaxed text-lg"><strong>題目：</strong>將 <span class="highlight">${question.number}</span> 以 <span class="highlight">標準分解式</span> 表示，並寫出所有的 <span class="highlight">質因數</span>。</p>`;
            document.getElementById('canvas-prompt').innerText = `請利用下方畫布計算 ${question.number} 的短除法，就像在紙上一樣。`;

            generateStep2Inputs();
            generateStep3Inputs();
            resetAllSteps();
        }
        
        function generateStep2Inputs() {
            const container = document.getElementById('step2-inputs-container');
            const question = questions[currentQuestionIndex];
            container.innerHTML = `<span class="math-symbol">${question.number} = </span>`;
            
            question.answers.step2.forEach((factor, index) => {
                const baseInput = document.createElement('input');
                baseInput.id = `s2_b_${index}`;
                baseInput.type = 'number';
                baseInput.className = 'input-box';
                baseInput.placeholder = '底數';
                container.appendChild(baseInput);

                if (factor.exp > 1) {
                    const sup = document.createElement('sup');
                    sup.className = 'math-symbol';
                    const expInput = document.createElement('input');
                    expInput.id = `s2_e_${index}`;
                    expInput.type = 'number';
                    expInput.className = 'w-10 p-1 border rounded text-center text-base';
                    sup.appendChild(expInput);
                    container.appendChild(sup);
                }

                if (index < question.answers.step2.length - 1) {
                    const multiply = document.createElement('span');
                    multiply.className = 'math-symbol';
                    multiply.innerHTML = ' &times; ';
                    container.appendChild(multiply);
                }
            });
        }
        
        function generateStep3Inputs() {
            const container = document.getElementById('step3-inputs-container');
             const question = questions[currentQuestionIndex];
            container.innerHTML = `<span class="math-symbol">${question.number} 的質因數為：</span>`;

            question.answers.step3.forEach((factor, index) => {
                const input = document.createElement('input');
                input.id = `s3_p_${index}`;
                input.type = 'number';
                input.className = 'input-box w-16';
                container.appendChild(input);

                if (index < question.answers.step3.length - 1) {
                    const comma = document.createElement('span');
                    comma.className = 'math-symbol';
                    comma.innerText = '、';
                    container.appendChild(comma);
                }
            });
        }

        function resetAllSteps() {
            setStepLock('step1', false);
            setStepLock('step2', false);
            setStepLock('step3', true);
            document.querySelectorAll('#step2 input, #step3 input').forEach(i => i.value = '');

            document.getElementById('completion-message').style.display = 'none';
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            const canvas = document.getElementById('drawing-canvas');
            if (canvas.getContext) {
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
        }

        function checkStep2() {
            const question = questions[currentQuestionIndex];
            let isCorrect = true;
            question.answers.step2.forEach((factor, index) => {
                const baseInput = document.getElementById(`s2_b_${index}`);
                if (baseInput.value.trim() != factor.base) isCorrect = false;

                if (factor.exp > 1) {
                    const expInput = document.getElementById(`s2_e_${index}`);
                    if (expInput.value.trim() != factor.exp) isCorrect = false;
                }
            });
            
            if (isCorrect) {
                showFeedback('標準分解式正確！', true);
                // As requested, do not lock the step.
                // setStepLock('step2', true); 
                setStepLock('step3', false);
            } else {
                showFeedback('標準分解式有誤，請檢查底數和指數。', false);
            }
        }

        function checkStep3() {
            const question = questions[currentQuestionIndex];
            let isCorrect = true;
            question.answers.step3.forEach((factor, index) => {
                const factorInput = document.getElementById(`s3_p_${index}`);
                if (factorInput.value.trim() != factor) isCorrect = false;
            });
            
            if (isCorrect) {
                showFeedback('質因數正確！你已成功完成這道題！', true);
                setStepLock('step3', true);
                document.getElementById('completion-message').style.display = 'block';
                document.getElementById('completion-message').scrollIntoView({ behavior: 'smooth', block: 'center' });
            } else {
                showFeedback('質因數有誤，請再檢查一次。', false);
            }
        }

        function initializeCanvas() {
            // ... (canvas logic is unchanged)
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            renderMathInElement(document.body, { delimiters: [ {left: "$$", right: "$$", display: true}, {left: "$", right: "$", display: false} ] });
            
            // Generate Nav
            const navContainer = document.getElementById('question-nav');
            questions.forEach((q, i) => {
                const btn = document.createElement('button');
                btn.className = 'nav-btn';
                btn.innerText = `第 ${i + 1} 題`;
                btn.onclick = () => loadQuestion(i);
                navContainer.appendChild(btn);
            });
            
            initializeCanvas();
            loadQuestion(0);
            
            document.getElementById('check-s2-btn').onclick = checkStep2;
            document.getElementById('check-s3-btn').onclick = checkStep3;
            document.getElementById('reset-btn').onclick = () => loadQuestion(currentQuestionIndex);
            
            // Canvas logic from previous version
            const canvas = document.getElementById('drawing-canvas');
            const ctx = canvas.getContext('2d');
            const container = canvas.parentElement;
            
            let drawing = false;
            let penColor = '#000000';
            let penWidth = 3;
            let isErasing = false;

            function resizeCanvas() {
                // Save drawing only if canvas has dimensions
                let imageData = null;
                if (canvas.width > 0 && canvas.height > 0) {
                    imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                }
                
                canvas.width = container.clientWidth;
                canvas.height = 300;

                // Restore drawing if it was saved
                if (imageData) {
                    ctx.putImageData(imageData, 0, 0);
                }
            }
            
            function getPos(e) {
                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                const touch = e.touches ? e.touches[0] : e;
                return {
                    x: (touch.clientX - rect.left) * scaleX,
                    y: (touch.clientY - rect.top) * scaleY
                };
            }

            function startDrawing(e) {
                e.preventDefault();
                drawing = true;
                const { x, y } = getPos(e);
                ctx.beginPath();
                ctx.moveTo(x, y);
            }

            function draw(e) {
                if (!drawing) return;
                e.preventDefault();
                const { x, y } = getPos(e);
                ctx.lineWidth = isErasing ? penWidth * 5 : penWidth;
                ctx.lineCap = 'round';
                ctx.strokeStyle = isErasing ? '#FFFFFF' : penColor;
                ctx.lineTo(x, y);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(x, y);
            }

            function stopDrawing() {
                drawing = false;
                ctx.beginPath();
            }

            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            canvas.addEventListener('touchstart', startDrawing);
            canvas.addEventListener('touchmove', draw);
            canvas.addEventListener('touchend', stopDrawing);

            window.addEventListener('resize', resizeCanvas);
            resizeCanvas();
            
            const controls = document.getElementById('canvas-controls');
            controls.addEventListener('click', (e) => {
                if (e.target.id === 'pen-tool') {
                    isErasing = false;
                    document.getElementById('pen-tool').classList.add('active');
                    document.getElementById('eraser-tool').classList.remove('active');
                } else if (e.target.id === 'eraser-tool') {
                    isErasing = true;
                    document.getElementById('eraser-tool').classList.add('active');
                    document.getElementById('pen-tool').classList.remove('active');
                } else if (e.target.dataset.color) {
                    penColor = e.target.dataset.color;
                    controls.querySelectorAll('.color-btn').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                } else if (e.target.id === 'clear-canvas') {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                }
            });
            document.getElementById('pen-width').addEventListener('input', (e) => {
                penWidth = e.target.value;
            });
        });
    </script>
</body>
</html>



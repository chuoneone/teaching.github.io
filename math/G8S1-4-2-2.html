<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>互動式數學學習單 - 配方法填空練習</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            light: '#E0F2FE',
                            DEFAULT: '#0284C7',
                            dark: '#0369A1',
                        },
                        success: '#22C55E',
                        warning: '#F59E0B',
                        error: '#EF4444'
                    },
                    animation: {
                        'tada': 'tada 1s ease-in-out',
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                        'slide-up': 'slideUp 0.5s ease-out forwards',
                    },
                    keyframes: {
                        tada: {
                            '0%': { transform: 'scale(1)' },
                            '10%, 20%': { transform: 'scale(0.9) rotate(-3deg)' },
                            '30%, 50%, 70%, 90%': { transform: 'scale(1.1) rotate(3deg)' },
                            '40%, 60%, 80%': { transform: 'scale(1.1) rotate(-3deg)' },
                            '100%': { transform: 'scale(1) rotate(0)' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom Scrollbar for Nav */
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Math Styles (Strict HTML) */
        .math-text {
            font-family: 'Comic Sans MS', 'Microsoft JhengHei', sans-serif;
            font-size: 1.5rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            color: #1f2937;
            flex-wrap: wrap; /* Allow wrapping on small screens */
        }
        
        .fraction {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            vertical-align: middle;
            margin: 0 4px;
            line-height: 1.1;
        }
        
        .fraction span:first-child {
            border-bottom: 2px solid #000;
            padding: 0 4px;
            width: 100%;
            text-align: center;
            display: block;
        }
        
        .fraction span:last-child {
            padding: 0 4px;
            width: 100%;
            text-align: center;
            display: block;
        }

        .power {
            font-size: 0.7em;
            vertical-align: super;
            margin-left: 2px;
            color: #e63946;
            position: relative;
            top: -8px; /* 次方位置修正 */
        }

        .sqrt::before {
            content: "√";
            font-size: 1.2em;
            margin-right: 2px;
        }
        
        .abs::before { content: "|"; } 
        .abs::after { content: "|"; }

        .mixed {
            display: inline-flex;
            align-items: center;
            gap: 2px;
        }

        /* Slot Styles */
        .slot {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 3rem;
            height: 3rem;
            border: 2px dashed #9ca3af;
            border-radius: 0.5rem;
            background-color: #f9fafb;
            color: #0284C7;
            font-weight: bold;
            font-size: 1.25rem;
            margin: 0 4px;
            cursor: pointer;
            transition: all 0.2s;
            vertical-align: middle;
            padding: 0 0.5rem;
        }

        .slot:hover {
            border-color: #0284C7;
            background-color: #e0f2fe;
        }

        .slot.filled {
            border-style: solid;
            border-color: #0284C7;
            background-color: #ffffff;
        }

        .slot.correct {
            border-color: #22c55e;
            color: #22c55e;
            background-color: #f0fdf4;
            pointer-events: none; /* Lock after correct */
        }
        
        .slot.completed-step {
             border-color: #22c55e; 
             border-bottom: 3px solid #22c55e;
        }

        /* Option Button Styles */
        .option-btn {
            background-color: white;
            border: 2px solid #e5e7eb;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border-radius: 0.75rem;
            padding: 0.75rem 1.25rem;
            font-size: 1.25rem;
            font-weight: bold;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }

        .option-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            border-color: #0284C7;
            color: #0284C7;
        }

        .option-btn:active:not(:disabled) {
            transform: translateY(0);
        }

        .option-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            background-color: #f3f4f6;
            transform: none;
            box-shadow: none;
        }

        /* Modal Overlay */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        /* Highlight */
        mark {
            background-color: #fef08a;
            padding: 0 4px;
            border-radius: 4px;
            color: #854d0e;
        }
        
        /* Step Container */
        .step-container {
            border-left: 4px solid #e5e7eb;
            padding-left: 1.5rem;
            margin-bottom: 2rem;
            position: relative;
            opacity: 0.6;
            filter: grayscale(0.8);
            pointer-events: none;
            transition: all 0.5s ease;
        }

        .step-container.active {
            border-left-color: #0284C7;
            opacity: 1;
            filter: grayscale(0);
            pointer-events: auto;
        }

        .step-container.completed {
            border-left-color: #22c55e;
            opacity: 1;
            filter: grayscale(0);
        }

        .step-badge {
            position: absolute;
            left: -1.25rem; /* half of width roughly plus border width */
            top: 0;
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            background-color: white;
            border: 4px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #9ca3af;
            font-size: 0.875rem;
            transition: all 0.3s;
        }

        .step-container.active .step-badge {
            border-color: #0284C7;
            color: #0284C7;
            transform: scale(1.1);
        }

        .step-container.completed .step-badge {
            border-color: #22c55e;
            color: white;
            background-color: #22c55e;
        }
    </style>
</head>
<body class="bg-gray-50 h-screen flex flex-col overflow-hidden text-gray-800 font-[sans-serif]">

    <!-- 1. Top Navigation Bar (Sticky) -->
    <nav class="bg-white shadow-md z-30 shrink-0">
        <div class="flex items-center h-16">
            <!-- Unit Title -->
            <div class="px-4 py-2 bg-brand text-white font-bold text-lg whitespace-nowrap shadow-md h-full flex items-center">
                <i class="fas fa-edit mr-2"></i> 配方法填空練習
            </div>
            
            <!-- Problem Scroller -->
            <div class="flex-1 overflow-x-auto hide-scrollbar flex items-center px-2 space-x-2" id="nav-items">
                <!-- Buttons injected by JS -->
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <div class="flex-1 overflow-hidden relative">
        <div class="h-full flex flex-col md:flex-row max-w-7xl mx-auto w-full">
            
            <!-- Left Panel: Question (Sticky on Desktop) -->
            <div class="w-full md:w-1/3 bg-white p-6 md:p-8 shadow-sm border-b md:border-b-0 md:border-r border-gray-200 overflow-y-auto z-20 md:h-full shrink-0 flex flex-col justify-start">
                <div class="sticky top-0 bg-white pb-4">
                    <h2 class="text-sm font-bold text-brand uppercase tracking-wider mb-2">題目 Question</h2>
                    <div id="question-display" class="text-2xl md:text-3xl font-bold text-gray-800 leading-relaxed">
                        <!-- Question content injected here -->
                    </div>
                    <div class="mt-4 p-4 bg-blue-50 rounded-xl border border-blue-100 text-sm md:text-base text-blue-800">
                        <i class="fas fa-info-circle mr-1"></i> <span id="question-hint">請依序填入空格，完成配方步驟。</span>
                    </div>
                </div>
            </div>

            <!-- Right Panel: Interactive Steps -->
            <div class="w-full md:w-2/3 p-4 md:p-8 overflow-y-auto scroll-smooth pb-32" id="steps-area">
                <!-- Steps injected by JS -->
            </div>
        </div>
    </div>

    <!-- Completion Modal -->
    <div id="completion-modal" class="fixed inset-0 modal-overlay z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl max-w-sm w-full p-8 text-center transform transition-all scale-95 opacity-0" id="modal-content">
            <div class="w-24 h-24 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
                <i class="fas fa-check text-5xl text-green-500"></i>
            </div>
            <h3 class="text-2xl font-bold text-gray-800 mb-2">太棒了！完成！</h3>
            <p class="text-gray-500 mb-8">你已經完成了這道題目的配方練習。</p>
            <div class="flex flex-col gap-3">
                <button onclick="resetCurrentProblem()" class="w-full bg-brand hover:bg-brand-dark text-white font-bold py-3 px-6 rounded-xl transition duration-300 shadow-lg shadow-blue-200">
                    <i class="fas fa-redo mr-2"></i> 再做一次
                </button>
                <button onclick="closeModal()" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-3 px-6 rounded-xl transition duration-300">
                    關閉視窗
                </button>
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="toast" class="fixed bottom-8 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full shadow-lg transition-all duration-300 opacity-0 translate-y-10 z-50 flex items-center gap-2">
        <span id="toast-icon"></span>
        <span id="toast-msg"></span>
    </div>

    <script>
        // --- Data Structure ---
        // 4道題目，只進行配方法步驟，不求出 x
        const problems = [
            {
                id: 1,
                title: "題目 1",
                questionHtml: `
                    <div class="mb-2">填入適當的數，完成配方：</div>
                    <div class="math-text">
                        x<span class="power">2</span> + 4x = 5
                    </div>
                `,
                steps: [
                    {
                        instruction: "第一步：<mark>配方</mark>，兩邊加上 (4÷2)<span class='power'>2</span>。",
                        template: `<div class="math-text">x<span class="power">2</span> + 4x + <div class="slot" data-idx="0"></div> = 5 + <div class="slot" data-idx="1"></div></div>`,
                        options: ["2", "4", "4", "16"], 
                        correctAnswers: ["4", "4"] // (4/2)^2 = 4
                    },
                    {
                        instruction: "第二步：整理成<mark>完全平方式</mark>。",
                        template: `<div class="math-text">( x + <div class="slot" data-idx="0"></div> )<span class="power">2</span> = <div class="slot" data-idx="1"></div></div>`,
                        options: ["2", "4", "9"],
                        correctAnswers: ["2", "9"] // (x+2)^2 = 9
                    }
                ]
            },
            {
                id: 2,
                title: "題目 2",
                questionHtml: `
                    <div class="mb-2">填入適當的數，完成配方：</div>
                    <div class="math-text">
                        x<span class="power">2</span> - 6x = 16
                    </div>
                `,
                steps: [
                    {
                        instruction: "第一步：<mark>配方</mark>，兩邊加上 (6÷2)<span class='power'>2</span>。",
                        template: `<div class="math-text">x<span class="power">2</span> - 6x + <div class="slot" data-idx="0"></div> = 16 + <div class="slot" data-idx="1"></div></div>`,
                        options: ["3", "9", "9", "36"], 
                        correctAnswers: ["9", "9"] // (6/2)^2 = 9
                    },
                    {
                        instruction: "第二步：整理成<mark>完全平方式</mark>。",
                        template: `<div class="math-text">( x - <div class="slot" data-idx="0"></div> )<span class="power">2</span> = <div class="slot" data-idx="1"></div></div>`,
                        options: ["3", "6", "25"],
                        correctAnswers: ["3", "25"] // (x-3)^2 = 25
                    }
                ]
            },
            {
                id: 3,
                title: "題目 3",
                questionHtml: `
                    <div class="mb-2">填入適當的數，完成配方：</div>
                    <div class="math-text">
                        x<span class="power">2</span> + 8x - 20 = 0
                    </div>
                `,
                steps: [
                    {
                        instruction: "第一步：<mark>移項</mark>，將常數項移到等號右邊。",
                        template: `<div class="math-text">x<span class="power">2</span> + 8x = <div class="slot" data-idx="0"></div></div>`,
                        options: ["20", "-20", "8"],
                        correctAnswers: ["20"]
                    },
                    {
                        instruction: "第二步：<mark>配方</mark>，兩邊加上 (8÷2)<span class='power'>2</span>。",
                        template: `<div class="math-text">x<span class="power">2</span> + 8x + <div class="slot" data-idx="0"></div> = 20 + <div class="slot" data-idx="1"></div></div>`,
                        options: ["4", "16", "16", "64"], 
                        correctAnswers: ["16", "16"] // (8/2)^2 = 16
                    },
                    {
                        instruction: "第三步：整理成<mark>完全平方式</mark>。",
                        template: `<div class="math-text">( x + <div class="slot" data-idx="0"></div> )<span class="power">2</span> = <div class="slot" data-idx="1"></div></div>`,
                        options: ["4", "8", "36"],
                        correctAnswers: ["4", "36"] // (x+4)^2 = 36
                    }
                ]
            },
            {
                id: 4,
                title: "題目 4",
                questionHtml: `
                    <div class="mb-2">填入適當的數，完成配方：</div>
                    <div class="math-text">
                        x<span class="power">2</span> - 10x + 9 = 0
                    </div>
                `,
                steps: [
                    {
                        instruction: "第一步：<mark>移項</mark>，將常數項移到等號右邊。",
                        template: `<div class="math-text">x<span class="power">2</span> - 10x = <div class="slot" data-idx="0"></div></div>`,
                        options: ["9", "-9", "10"],
                        correctAnswers: ["-9"]
                    },
                    {
                        instruction: "第二步：<mark>配方</mark>，兩邊加上 (10÷2)<span class='power'>2</span>。",
                        template: `<div class="math-text">x<span class="power">2</span> - 10x + <div class="slot" data-idx="0"></div> = -9 + <div class="slot" data-idx="1"></div></div>`,
                        options: ["5", "25", "25", "100"], 
                        correctAnswers: ["25", "25"] // (10/2)^2 = 25
                    },
                    {
                        instruction: "第三步：整理成<mark>完全平方式</mark>。",
                        template: `<div class="math-text">( x - <div class="slot" data-idx="0"></div> )<span class="power">2</span> = <div class="slot" data-idx="1"></div></div>`,
                        options: ["5", "10", "16"],
                        correctAnswers: ["5", "16"] // -9 + 25 = 16
                    }
                ]
            }
        ];

        // --- State Management ---
        let currentProblemIndex = 0;
        let problemStates = [];

        function initStates() {
            problemStates = problems.map(p => ({
                currentStep: 0,
                userAnswers: {}, 
                completed: false
            }));
        }

        // --- DOM Elements ---
        const navItemsEl = document.getElementById('nav-items');
        const questionDisplayEl = document.getElementById('question-display');
        const stepsAreaEl = document.getElementById('steps-area');
        const modalEl = document.getElementById('completion-modal');
        const modalContentEl = document.getElementById('modal-content');

        // --- Initialization ---
        initStates();
        renderNav();
        loadProblem(0);

        // --- Core Logic ---

        function renderNav() {
            navItemsEl.innerHTML = problems.map((p, idx) => `
                <button onclick="switchProblem(${idx})" 
                    class="px-4 py-2 rounded-lg text-sm font-bold transition-all whitespace-nowrap border-2
                    ${currentProblemIndex === idx 
                        ? 'bg-brand text-white border-brand shadow-md transform scale-105' 
                        : 'bg-white text-gray-500 border-gray-200 hover:border-brand-light'}"
                >
                    ${p.title}
                    ${problemStates[idx].completed ? '<i class="fas fa-check-circle ml-1 text-green-400"></i>' : ''}
                </button>
            `).join('');
        }

        function switchProblem(idx) {
            currentProblemIndex = idx;
            renderNav();
            loadProblem(idx);
        }

        function loadProblem(idx) {
            const p = problems[idx];
            const state = problemStates[idx];

            questionDisplayEl.innerHTML = p.questionHtml;
            stepsAreaEl.innerHTML = '';
            
            p.steps.forEach((step, stepIdx) => {
                const isActive = stepIdx === state.currentStep;
                const isCompleted = stepIdx < state.currentStep;

                const stepEl = document.createElement('div');
                stepEl.className = `step-container ${isActive ? 'active' : ''} ${isCompleted ? 'completed' : ''}`;
                stepEl.id = `step-${stepIdx}`;
                
                let badgeIcon = stepIdx + 1;
                if (isCompleted) badgeIcon = '<i class="fas fa-check"></i>';
                
                let optionsHtml = '';
                if (!isCompleted) {
                    optionsHtml = `
                        <div class="mt-6">
                            <div class="flex flex-wrap gap-3" id="options-container-${stepIdx}">
                                ${step.options.map((opt, optIdx) => `
                                    <button class="option-btn" 
                                        onclick="handleOptionClick(${stepIdx}, '${opt}', this)"
                                        data-val="${opt}"
                                    >${opt}</button>
                                `).join('')}
                            </div>
                            <div class="mt-4 flex items-center gap-3">
                                <button onclick="checkStep(${stepIdx})" 
                                    class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg shadow-md transition-colors flex items-center">
                                    <i class="fas fa-search mr-2"></i> 檢查答案
                                </button>
                                <span id="feedback-${stepIdx}" class="text-lg font-bold"></span>
                            </div>
                        </div>
                    `;
                }

                stepEl.innerHTML = `
                    <div class="step-badge shadow-sm">${badgeIcon}</div>
                    <div class="flex items-center justify-between">
                        <h3 class="font-bold text-gray-700 text-lg md:text-xl">${step.instruction}</h3>
                        ${isCompleted ? '<span class="text-green-500 font-bold text-sm bg-green-50 px-2 py-1 rounded">✔ 完成</span>' : ''}
                    </div>
                    
                    <div class="mt-4 p-4 bg-white rounded-xl border-2 border-gray-100 shadow-sm">
                        ${step.template}
                    </div>

                    ${optionsHtml}
                `;

                stepsAreaEl.appendChild(stepEl);

                const savedAnswers = state.userAnswers[stepIdx] || [];
                const slots = stepEl.querySelectorAll('.slot');
                savedAnswers.forEach((val, i) => {
                    if (val && slots[i]) {
                        fillSlot(slots[i], val, stepIdx, true);
                    }
                });

                if (isCompleted) {
                    slots.forEach(s => {
                        s.classList.add('correct', 'completed-step');
                        s.style.pointerEvents = 'none';
                    });
                }
            });

            setTimeout(() => {
                const activeEl = document.getElementById(`step-${state.currentStep}`);
                if (activeEl) {
                    activeEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 100);
        }

        // --- Interaction Logic ---

        function handleOptionClick(stepIdx, value, btnEl) {
            const stepEl = document.getElementById(`step-${stepIdx}`);
            const emptySlots = Array.from(stepEl.querySelectorAll('.slot:not(.filled)'));

            if (emptySlots.length > 0) {
                const targetSlot = emptySlots[0];
                fillSlot(targetSlot, value, stepIdx);
                btnEl.disabled = true;
                btnEl.classList.add('opacity-50');
                saveState(stepIdx);
            } else {
                showToast('請點擊方格清除內容後再填入', 'warning');
            }
        }

        function fillSlot(slot, value, stepIdx, isRestore = false) {
            slot.textContent = value;
            slot.classList.add('filled');
            slot.dataset.value = value;
            
            if (!isRestore) {
                slot.onclick = () => clearSlot(slot, stepIdx);
                slot.classList.remove('animate-tada');
                void slot.offsetWidth; 
                slot.classList.add('animate-tada');
            } else {
                 const isCompleted = stepIdx < problemStates[currentProblemIndex].currentStep;
                 if(!isCompleted) slot.onclick = () => clearSlot(slot, stepIdx);
            }
        }

        function clearSlot(slot, stepIdx) {
            const val = slot.dataset.value;
            if (!val) return;

            const btn = Array.from(document.querySelectorAll(`#options-container-${stepIdx} .option-btn`))
                             .find(b => b.dataset.val === val && b.disabled);
            if (btn) {
                btn.disabled = false;
                btn.classList.remove('opacity-50');
            }

            slot.textContent = '';
            slot.classList.remove('filled', 'correct', 'error');
            delete slot.dataset.value;

            saveState(stepIdx);
        }

        function saveState(stepIdx) {
            const stepEl = document.getElementById(`step-${stepIdx}`);
            const slots = stepEl.querySelectorAll('.slot');
            const answers = Array.from(slots).map(s => s.dataset.value || null);
            problemStates[currentProblemIndex].userAnswers[stepIdx] = answers;
        }

        function checkStep(stepIdx) {
            const stepEl = document.getElementById(`step-${stepIdx}`);
            const slots = Array.from(stepEl.querySelectorAll('.slot'));
            const currentProblem = problems[currentProblemIndex];
            const currentStepData = currentProblem.steps[stepIdx];
            const correctAnswers = currentStepData.correctAnswers;
            const userValues = slots.map(s => s.dataset.value);
            const feedbackEl = document.getElementById(`feedback-${stepIdx}`);

            if (userValues.some(v => !v)) {
                showToast('請填滿所有空格', 'warning');
                return;
            }

            let allCorrect = true;
            
            // Check if unordered is allowed
            const allowUnordered = currentStepData.allowUnordered || false;

            if (allowUnordered) {
                 // Sort both and compare for loose equality
                 const sortedUser = [...userValues].sort();
                 const sortedCorrect = [...correctAnswers].sort();
                 if (JSON.stringify(sortedUser) !== JSON.stringify(sortedCorrect)) {
                     allCorrect = false;
                 }
            } else {
                // Strict check
                slots.forEach((slot, i) => {
                    if (slot.dataset.value !== correctAnswers[i]) {
                        allCorrect = false;
                    }
                });
            }

            if (allCorrect) {
                // Mark all slots as correct regardless of order
                slots.forEach(slot => {
                    slot.classList.add('correct');
                    slot.classList.remove('filled');
                });

                feedbackEl.innerHTML = '<span class="text-green-500"><i class="fas fa-check"></i> 正確！</span>';
                feedbackEl.classList.add('animate-tada');
                playSound('success');

                problemStates[currentProblemIndex].currentStep++;

                if (problemStates[currentProblemIndex].currentStep >= currentProblem.steps.length) {
                    problemStates[currentProblemIndex].completed = true;
                    setTimeout(() => showCompletionModal(), 800);
                }

                setTimeout(() => {
                    loadProblem(currentProblemIndex);
                }, 1000);

            } else {
                feedbackEl.innerHTML = '<span class="text-orange-500"><i class="fas fa-times"></i> 再想想看</span>';
                playSound('error');
                showToast('答案不正確，請檢查', 'error');
            }
        }

        // --- UI Utilities ---

        function showToast(msg, type = 'info') {
            const toast = document.getElementById('toast');
            const msgEl = document.getElementById('toast-msg');
            const iconEl = document.getElementById('toast-icon');

            msgEl.textContent = msg;
            
            if (type === 'success') {
                iconEl.innerHTML = '<i class="fas fa-check-circle text-green-400"></i>';
            } else if (type === 'error') {
                iconEl.innerHTML = '<i class="fas fa-exclamation-circle text-red-400"></i>';
            } else {
                iconEl.innerHTML = '<i class="fas fa-info-circle text-blue-400"></i>';
            }

            toast.classList.remove('translate-y-10', 'opacity-0');
            
            setTimeout(() => {
                toast.classList.add('translate-y-10', 'opacity-0');
            }, 3000);
        }

        function showCompletionModal() {
            renderNav();
            modalEl.classList.remove('hidden');
            setTimeout(() => {
                modalContentEl.classList.remove('scale-95', 'opacity-0');
                modalContentEl.classList.add('scale-100', 'opacity-100', 'animate-tada');
            }, 10);
        }

        function closeModal() {
            modalContentEl.classList.remove('scale-100', 'opacity-100', 'animate-tada');
            modalContentEl.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                modalEl.classList.add('hidden');
            }, 300);
        }

        function resetCurrentProblem() {
            closeModal();
            problemStates[currentProblemIndex].currentStep = 0;
            problemStates[currentProblemIndex].userAnswers = {};
            problemStates[currentProblemIndex].completed = false;
            renderNav();
            loadProblem(currentProblemIndex);
        }

        function playSound(type) {
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (!AudioContext) return;
                
                const ctx = new AudioContext();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();

                osc.connect(gain);
                gain.connect(ctx.destination);

                if (type === 'success') {
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(500, ctx.currentTime);
                    osc.frequency.exponentialRampToValueAtTime(1000, ctx.currentTime + 0.1);
                    gain.gain.setValueAtTime(0.2, ctx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
                    osc.start();
                    osc.stop(ctx.currentTime + 0.5);
                } else {
                    osc.type = 'sawtooth';
                    osc.frequency.setValueAtTime(300, ctx.currentTime);
                    osc.frequency.linearRampToValueAtTime(200, ctx.currentTime + 0.2);
                    gain.gain.setValueAtTime(0.1, ctx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
                    osc.start();
                    osc.stop(ctx.currentTime + 0.3);
                }
            } catch (e) {
                // Ignore audio errors
            }
        }
    </script>
</body>
</html>
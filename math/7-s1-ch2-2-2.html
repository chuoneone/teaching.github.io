<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>判斷是否互質 - 互動學習</title>
    <link rel="icon" href="dog.png" type="image/png">
    
    <!-- 1. 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. 引入 KaTeX (數學公式) - 修正 xintegrity 錯字 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" xintegrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" xintegrity="sha384-XjKyOOlGjKlcjCoMbBOobuC7ivVjQeYadFRGOstEbeYKAoLyKEMITvFWkkv3mdlF" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" xintegrity="sha384-+VBxd3r6XgURPlLJSytFmsEUHFrSVvK+RprDCHrJFUNzdp9DVjLVEgBl+dVYd8Gq" crossorigin="anonymous"></script>
    
    <!-- 3. 引入指定字型 (Chiron GoRound TC) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Chiron+GoRound+TC:wght@200..900&display=swap" rel="stylesheet">
    
    <!-- 4. 自訂樣式 -->
    <style>
        body {
            /* 應用指定字型 */
            font-family: "Chiron GoRound TC", sans-serif;
            font-weight: 400;
            font-style: normal;
            background-color: #f7fafc; /* 淺灰色背景 */
        }
        
        /* 螢光筆效果 */
        .highlight {
            background: linear-gradient(to top, #fff799 50%, transparent 50%);
            padding: 0 4px;
            border-radius: 3px;
        }

        /* 讓 KaTeX 顯示更自然 */
        .katex-display {
            margin: 0.5em 0;
        }
        
        /* 答題卡片樣式 */
        .step-card {
            background-color: white;
            border-radius: 12px;
            padding: 2rem 1.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
            margin-top: 1rem;
            transition: all 0.3s ease-in-out;
        }
        
        /* 答題按鈕 */
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.2s;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .btn-primary {
            background-color: #3b82f6; /* 藍色 */
            color: white;
        }
        .btn-primary:hover {
            background-color: #2563eb;
        }
        
        .btn-secondary {
            background-color: #e2e8f0; /* 灰色 */
            color: #1e293b;
        }
        .btn-secondary:hover {
            background-color: #cbd5e1;
        }
        
        /* 新增：題目切換按鈕 */
        .q-btn {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.875rem; /* 14px */
            font-weight: 600;
            transition: all 0.2s;
            cursor: pointer;
            border: none;
        }


        /* 輸入框樣式 */
        .answer-input {
            /* 移除 w-5rem 固定寬度 */
            text-align: center;
            border: 2px solid #cbd5e1;
            border-radius: 8px;
            padding: 0.5rem;
            font-size: 1.25rem; /* 20px */
            transition: border-color 0.2s, background-color 0.2s;
            /* 恢復固定寬度，用於小格子 */
            width: 5rem;
        }
        .answer-input:focus {
            border-color: #3b82f6;
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        /* 針對已完成 (disabled) 狀態的樣式 */
        .btn:disabled {
            background-color: #cbd5e1; /* 變更為灰色 */
            color: #94a3b8;
            cursor: not-allowed;
            opacity: 0.7;
        }
        .answer-input:disabled {
            background-color: #f1f5f9;
            color: #94a3b8;
            border-color: #e2e8f0;
        }

        /* 即時回饋樣式 */
        .answer-input.correct {
            background-color: #dcfce7; /* green-100 */
            border-color: #22c55e; /* green-500 */
        }
        .answer-input.incorrect {
            background-color: #fee2e2; /* red-100 */
            border-color: #ef4444; /* red-500 */
        }

        /* 新增：按鈕選擇後的樣式 */
        .btn-selected {
            background-color: #3b82f6; /* 藍色 */
            color: white;
            opacity: 1;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: not-allowed;
        }
        .btn-deselected-disabled {
            background-color: #f1f5f9; /* 更淺的灰色 */
            color: #94a3b8;
            cursor: not-allowed;
            opacity: 0.7;
            box-shadow: none;
        }
        
        /* 隱藏 number input 的箭頭 */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
          -webkit-appearance: none; 
          margin: 0; 
        }
        input[type=number] {
          -moz-appearance: textfield; /* Firefox */
        }
    </style>
</head>

<body class="min-h-screen flex flex-col items-center justify-center py-10 px-4">

    <!-- 新增：題目切換按鈕 -->
    <div class="mb-4 flex justify-center space-x-2">
        <button id="q-btn-0" onclick="loadQuestion(0)" class="q-btn btn-primary">題目 1 (14, 15)</button>
        <button id="q-btn-1" onclick="loadQuestion(1)" class="q-btn btn-secondary">題目 2 (2, 8)</button>
        <button id="q-btn-2" onclick="loadQuestion(2)" class="q-btn btn-secondary">題目 3 (15, 30)</button>
    </div>

    <!-- 主要內容容器 -->
    <main class="w-full max-w-2xl mx-auto">
        <h1 class="text-3xl md:text-4xl font-bold text-center text-gray-800 mb-2">
            二、判斷是否互質
        </h1>
        <p class="text-center text-gray-500 mb-6">對應課本：P.107 隨堂練習</p>

        <!-- 互動學習區 -->
        <div class="bg-white p-6 md:p-8 rounded-2xl shadow-lg border border-gray-200">
            
            <!-- 標題：改為動態載入 -->
            <h2 id="question-title" class="text-2xl md:text-3xl font-semibold text-gray-900 mb-6 text-center">
                <!-- JS 會載入題目 -->
            </h2>

            <!-- 進度提示 -->
            <div id="progress-indicator" class="text-center text-sm font-medium text-gray-500 mb-4 tracking-wider">
                第 1 步 / 共 4 步
            </div>

            <!-- 即時回饋訊息欄 -->
            <div id="feedback-message" class="h-10 text-center font-semibold mb-4 transition-all duration-300">
                <!-- JS 會在這裡插入回饋 -->
            </div>

            <!-- 步驟 1：質因數分解 (改為單行文字) -->
            <div id="step-1" class="step-card">
                <p class="mb-2 text-lg text-center">
                    首先，找出 <span id="q1-num1" class="font-bold">14</span> 的所有質因數：
                </p>
                <!-- 修正提示文字 -->
                <p class="text-center text-sm text-gray-500 mb-4">(請填入<strong class="text-blue-600">不重複</strong>的所有質因數)</p>
                <div class="flex items-center justify-center space-x-3 text-2xl md:text-3xl">
                    <!-- JS 會動態填入 input 格子 -->
                    <div id="ans1-container" class="flex items-center justify-center space-x-3 flex-wrap gap-y-3">
                        <!-- e.g. <input type="number" class="answer-input" ...> -->
                    </div>
                </div>
            </div>

            <!-- 步驟 2：質因數分解 (改為單行文字) -->
            <div id="step-2" class="step-card hidden">
                <p class="mb-2 text-lg text-center">
                    接著，找出 <span id="q2-num1" class="font-bold">15</span> 的所有質因數：
                </p>
                <!-- 修正提示文字 -->
                <p class="text-center text-sm text-gray-500 mb-4">(請填入<strong class="text-blue-600">不重複</strong>的所有質因數)</p>
                <div class="flex items-center justify-center space-x-3 text-2xl md:text-3xl">
                    <!-- JS 會動態填入 input 格子 -->
                    <div id="ans2-container" class="flex items-center justify-center space-x-3 flex-wrap gap-y-3">
                        <!-- e.g. <input type="number" class="answer-input" ...> -->
                    </div>
                </div>
            </div>

            <!-- 步驟 3：比較共同質因數 (改為動態) -->
            <div id="step-3" class="step-card hidden">
                <p class="mb-4 text-lg text-center">比較一下兩組質因數：</p>
                <ul class="list-none text-left max-w-xs mx-auto space-y-2 text-xl">
                    <li><span id="q3-num1">14</span> 的質因數： <span id="q3-ans1">2, 7</span></li>
                    <li><span id="q3-num2">15</span> 的質因數： <span id="q3-ans2">3, 5</span></li>
                </ul>
                <p id="q3-text" class="mt-6 text-lg text-center">兩者... 共同的質因數？</p>
                <div class="flex justify-center space-x-4 mt-4">
                    <button onclick="checkStep3('yes', this)" class="btn btn-secondary text-lg px-8">□ 有</button>
                    <button onclick="checkStep3('no', this)" class="btn btn-secondary text-lg px-8">□ 沒有</button>
                </div>
            </div>

            <!-- 步驟 4：判斷是否互質 (改為動態) -->
            <div id="step-4" class="step-card hidden">
                <p id="q4-text" class="mb-4 text-lg text-center leading-relaxed">
                    <!-- JS 載入 -->
                </p>
                <div class="flex justify-center space-x-4 mt-4">
                    <button onclick="checkStep4('yes', this)" class="btn btn-secondary text-lg px-8">□ 是</button>
                    <button onclick="checkStep4('no', this)" class="btn btn-secondary text-lg px-8">□ 否</button>
                </div>
            </div>

            <!-- 完成訊息 (改為動態) -->
            <div id="completion-message" class="step-card hidden text-center">
                <h3 class="text-2xl font-bold text-green-600 mb-4">恭喜你，全部答對了！</h3>
                <p id="completion-text1" class="text-lg text-gray-700">
                    <!-- JS 載入 -->
                </p>
                <p id="completion-text2" class="text-lg text-gray-700 mt-4 p-4 bg-gray-100 rounded-lg">
                    <!-- JS 載入 -->
                </p>
                <button onclick="restart()" class="btn btn-primary mt-8">再做一次</button>
            </div>

        </div>
    </main>
    
    <!-- 頁尾固定區塊 -->
    <footer class="fixed bottom-0 left-0 w-full text-center text-gray-400 text-sm bg-white bg-opacity-80 py-2 border-t border-gray-200 backdrop-blur-sm">
        © 2025 特教米克師｜採用 
        <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh_TW" target="_blank" class="text-sky-600 hover:underline">
            CC BY-NC-SA 4.0 創用CC授權
        </a>｜非商業用途歡迎轉載或改編，請保留署名並附上原始連結。
    </footer>

    <!-- JavaScript 邏輯 -->
    <script>
        const TOTAL_STEPS = 4;
        let feedbackTimer;
        let currentQuestionIndex = 0; // 追蹤目前題目

        // 題目資料庫
        const questions = [
            {
                title: "1. <span class='highlight'>14 與 15</span> 是否互質？",
                nums: [14, 15],
                answers: {
                    step1: ["2", "7"], // 質因數 (順序不拘)
                    step2: ["3", "5"],
                    step3: "no",    // 有共同質因數嗎？
                step4: "yes"    // 是否互質？
            },
                step3Text: "兩者... 共同的質因數？",
                step3AnsDisplay: ["2, 7", "3, 5"],
                step4Text: "因為它們<span class='font-bold text-blue-600'>沒有</span>共同的質因數，<br>所以 14 與 15 <span class='highlight'>是否互質</span>？",
                completion: {
                    text1: "你已經學會了判斷 14 和 15 是否互質。",
                    text2: "結論：因為 14 和 15 的最大公因數是 1，<br>所以它們<span class='font-bold text-blue-700'>互質</span>。"
                }
            },
            {
                title: "2. <span class='highlight'>2 與 8</span> 是否互質？",
                nums: [2, 8],
                answers: {
                    step1: ["2"],
                    step2: ["2"], // 修正：8 的質因數只有 2
                    step3: "yes",
                    step4: "no"
                },
                step3Text: "兩者... 共同的質因數？",
                step3AnsDisplay: ["2", "2"], // 修正：顯示用
                step4Text: "因為它們<span class='font-bold text-red-600'>有</span>共同的質因數 ( $2$ )，<br>所以 2 與 8 <span class='highlight'>是否互質</span>？",
                completion: {
                    text1: "你已經學會了判斷 2 和 8 是否互質。",
                    text2: "結論：因為 2 和 8 有共同質因數 2 (最大公因數是 2)，<br>所以它們<span class='font-bold text-red-700'>不互質</span>。"
                }
            },
            {
                title: "3. <span class='highlight'>15 與 30</span> 是否互質？",
                nums: [15, 30],
                answers: {
                    step1: ["3", "5"],
                    step2: ["2", "3", "5"],
                    step3: "yes",
                    step4: "no"
                },
                step3Text: "兩者... 共同的質因數？",
                step3AnsDisplay: ["3, 5", "2, 3, 5"],
                step4Text: "因為它們<span class='font-bold text-red-600'>有</span>共同的質因數 ( $3, 5$ )，<br>所以 15 與 30 <span class='highlight'>是否互質</span>？",
                completion: {
                    text1: "你已經學會了判斷 15 和 30 是否互質。",
                    text2: "結論：因為 15 和 30 有共同質因數 3 和 5 (最大公因數是 15)，<br>所以它們<span class='font-bold text-red-700'>不互質</span>。"
                }
            }
        ];

        // 顯示回饋訊息
        function showFeedback(message, isSuccess) {
            const feedbackEl = document.getElementById('feedback-message');
            if (feedbackTimer) clearTimeout(feedbackTimer);

            feedbackEl.textContent = message;
            feedbackEl.className = isSuccess 
                ? 'h-10 text-center font-semibold mb-4 text-green-600'
                : 'h-10 text-center font-semibold mb-4 text-red-600';

            feedbackTimer = setTimeout(() => {
                feedbackEl.textContent = '';
                feedbackEl.className = 'h-10 text-center font-semibold mb-4';
            }, 3000);
        }

        // --- FIX: 重新加回 updateProgress 函數 ---
        // 更新進度
        function updateProgress(current, total) {
            const indicator = document.getElementById('progress-indicator');
            if (indicator) {
                indicator.textContent = `第 ${current} 步 / 共 ${total} 步`;
            }
        }
        // --- END OF FIX ---

        // --- 新功能：動態產生輸入格 ---
        function createInputBoxes(containerId, answersArray, stepNumber) {
            const container = document.getElementById(containerId);
            container.innerHTML = ''; // 清空
            const numBoxes = answersArray.length;

            for (let i = 0; i < numBoxes; i++) {
                const input = document.createElement('input');
                input.type = "number"; // 改為 number 類型
                input.className = "answer-input";
                input.id = `ans${stepNumber}-box-${i}`;
                input.maxLength = 3; // 限制長度
                // 核心：輸入時觸發驗證
                input.oninput = (e) => {
                    // 自動跳格
                    if (e.target.value.length >= e.target.maxLength && i < numBoxes - 1) {
                         document.getElementById(`ans${stepNumber}-box-${i+1}`).focus();
                    }
                    validateIndividualBox(stepNumber);
                };
                container.appendChild(input);
            }
        }

        // 獨立 KaTeX 渲染函數
        function renderKaTeX() {
            try {
                if (typeof renderMathInElement === 'function') {
                    renderMathInElement(document.body, {
                        delimiters: [
                            {left: "$$", right: "$$", display: true},
                            {left: "$", right: "$", display: false}
                        ],
                        throwOnError: false
                    });
                }
            } catch (error) {
                console.error("KaTeX rendering error:", error);
            }
        }
        
        // --- 核心功能：載入題目 ---
        function loadQuestion(index) {
            currentQuestionIndex = index;
            const q = questions[index];

            // 1. 更新按鈕選中狀態
            document.querySelectorAll('.q-btn').forEach((btn, i) => {
                btn.classList.toggle('btn-primary', i === index);
                btn.classList.toggle('btn-secondary', i !== index);
            });

            // 2. 填入題目內容
            document.getElementById('question-title').innerHTML = q.title;
            // 2. 填入題目內容 (HTML)
            document.getElementById('question-title').innerHTML = q.title;
            document.getElementById('q1-num1').textContent = q.nums[0];
            document.getElementById('q2-num1').textContent = q.nums[1];
            document.getElementById('q3-num1').textContent = q.nums[0];
            document.getElementById('q3-num2').textContent = q.nums[1];
            document.getElementById('q3-ans1').innerHTML = q.step3AnsDisplay[0];
            document.getElementById('q3-ans2').innerHTML = q.step3AnsDisplay[1];
            document.getElementById('q3-text').innerHTML = q.step3Text;
            document.getElementById('q4-text').innerHTML = q.step4Text;
            document.getElementById('completion-text1').innerHTML = q.completion.text1;
            document.getElementById('completion-text2').innerHTML = q.completion.text2;

            // 3. 重設作答介面 (JS)
            // 3a. 建立新的輸入格
            createInputBoxes('ans1-container', q.answers.step1, 1);
            createInputBoxes('ans2-container', q.answers.step2, 2);
            
            // 3b. 隱藏/重設步驟
            restartUI();
            
            // 4. 重新渲染 KaTeX
            renderKaTeX();

            // 5. 自動聚焦
            document.getElementById('ans1-box-0').focus();
        }

        // 輔助函數：檢查陣列是否相等 (忽略順序)
        function checkArrayEquality(arrA, arrB) {
            if (arrA.length !== arrB.length) return false;
            const sortedA = [...arrA].sort();
            const sortedB = [...arrB].sort();
            return JSON.stringify(sortedA) === JSON.stringify(sortedB);
        }

        // --- 檢查各步驟答案 (已重構為動態) ---

        // 新：步驟 1 & 2：即時驗證 (取代 validateStep1 和 validateStep2)
        function validateIndividualBox(stepNumber) {
            const q = questions[currentQuestionIndex];
            const containerId = `ans${stepNumber}-container`;
            const inputs = document.querySelectorAll(`#${containerId} input`);
            const expected = (stepNumber === 1) ? q.answers.step1 : q.answers.step2;
            
            let remainingAnswers = [...expected]; // 複製一份標準答案
            let inputValues = [];
            let allCorrect = true;
            let allFilled = true;

            // 第一次遍歷：檢查答案正確性並上色
            inputs.forEach(input => {
                const val = input.value.trim();
                inputValues.push(val);
                
                if (val === '') {
                    allFilled = false; // 還有格子沒填
                    input.classList.remove('correct', 'incorrect');
                    return;
                }

                const answerIndex = remainingAnswers.indexOf(val);
                if (answerIndex > -1) {
                    // 答對，且是唯一
                    input.classList.add('correct');
                    input.classList.remove('incorrect');
                    remainingAnswers.splice(answerIndex, 1); // 從標準答案中移除
                } else {
                    // 答錯 (重複或不在答案中)
                    input.classList.add('incorrect');
                    input.classList.remove('correct');
                    allCorrect = false;
                }
            });

            // 如果所有格子都填滿了
            if (allFilled) {
                if (allCorrect && remainingAnswers.length === 0) {
                    // 完全正確
                    showFeedback(stepNumber === 1 ? '太棒了！質因數都找到了。' : '做得好！質因數都找到了。', true);
                    inputs.forEach(input => input.disabled = true); // 鎖定
                    
                    if (stepNumber === 1) {
                        // 解鎖步驟 2
                        document.getElementById('step-2').classList.remove('hidden');
                        updateProgress(2, TOTAL_STEPS);
                        document.getElementById('step-2').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        document.getElementById('ans2-box-0').focus(); // 聚焦下一個
                    } else {
                        // 解鎖步驟 3
                        document.getElementById('step-3').classList.remove('hidden');
                        updateProgress(3, TOTAL_STEPS);
                        document.getElementById('step-3').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        renderKaTeX(); // 步驟 3 有 KaTeX，需渲染
                    }
                } else {
                    // 填滿了，但答案不對
                    showFeedback('嗯...有數字不對或重複了喔，再檢查一下！', false);
                }
            } else if (!allCorrect) {
                // 邊填邊錯
                showFeedback('這個數字好像不對喔？', false);
            }
        }
        
        // 步驟 3
        function checkStep3(answer, button) {
            const q = questions[currentQuestionIndex];
            const expected = q.answers.step3; // 'yes' or 'no'

            if (answer === expected) {
                showFeedback(expected === 'no' ? '完全正確！它們沒有共同的質因數。' : '完全正確！它們有共同的質因數。', true);

                // 禁用按鈕並顯示選擇
                document.querySelectorAll('#step-3 button').forEach(btn => {
                    btn.disabled = true;
                    btn.classList.remove('btn-secondary');
                    btn.classList.add(btn === button ? 'btn-selected' : 'btn-deselected-disabled');
                });

                document.getElementById('step-4').classList.remove('hidden');
                updateProgress(4, TOTAL_STEPS);
                document.getElementById('step-4').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                renderKaTeX(); // 步驟 4 有 KaTeX
            } else {
                showFeedback('咦？你再仔細看看，有沒有一樣的數字呢？', false);
            }
        }
        
        // 步驟 4
        function checkStep4(answer, button) {
            const q = questions[currentQuestionIndex];
            const expected = q.answers.step4; // 'yes' or 'no'

            if (answer === expected) {
                showFeedback('太厲害了！你完成了所有步驟！', true);
                
                // 禁用按鈕並顯示選擇
                document.querySelectorAll('#step-4 button').forEach(btn => {
                    btn.disabled = true;
                    btn.classList.remove('btn-secondary');
                    btn.classList.add(btn === button ? 'btn-selected' : 'btn-deselected-disabled');
                });

                document.getElementById('completion-message').classList.remove('hidden');
                document.getElementById('progress-indicator').classList.add('hidden');
                document.getElementById('completion-message').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                renderKaTeX(); // 完成訊息有 KaTeX
            } else {
                showFeedback(expected === 'yes' ? '再想一下，「互質」的定義喔！' : '不對喔，有共同質因數，就「不互質」喔！', false);
            }
        }

        // 重新開始 (目前題目) - 只重設 UI
        function restartUI() {
            // 1. 隱藏步驟 2-4 和完成訊息
            document.getElementById('step-2').classList.add('hidden');
            document.getElementById('step-3').classList.add('hidden');
            document.getElementById('step-4').classList.add('hidden');
            document.getElementById('completion-message').classList.add('hidden');

            // 2. (清除輸入格的動作改由 createInputBoxes 執行)
            
            // 3. 啟用所有按鈕 (步驟 3 和 4) 並還原樣式
            document.querySelectorAll('#step-3 button, #step-4 button').forEach(btn => {
                btn.disabled = false;
                btn.classList.remove('btn-selected', 'btn-deselected-disabled');
                btn.classList.add('btn-secondary');
            });

            // 5. 清除回饋
            showFeedback('', true);
            if (feedbackTimer) clearTimeout(feedbackTimer);
            
            // 6. 重設並顯示進度條
            document.getElementById('progress-indicator').classList.remove('hidden');
            updateProgress(1, TOTAL_STEPS);

            // 7. 滾動回頂部
            document.querySelector('main').scrollIntoView({ behavior: 'smooth' });

            // 8. (自動聚焦改到 loadQuestion)
        }

        // 重新開始按鈕 (重載題目)
        function restart() {
            loadQuestion(currentQuestionIndex);
        }

        // --- 頁面載入時執行 ---
        document.addEventListener('DOMContentLoaded', () => {
            // 載入第一題
            loadQuestion(0);
        });
    </script>
</body>
</html>
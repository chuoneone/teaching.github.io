<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>互動學習單：倍數的判別</title>
    <link rel="icon" href="dog.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Chiron+GoRound+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: "Chiron GoRound TC", sans-serif;
        }
        .step-container {
            transition: all 0.5s ease-in-out;
        }
        .step-locked {
            opacity: 0.3;
            pointer-events: none;
        }
        .feedback-message {
            transition: opacity 0.3s;
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            font-weight: 700;
        }
        .feedback-correct {
            background-color: #d1fae5;
            color: #065f46;
        }
        .feedback-incorrect {
            background-color: #fee2e2;
            color: #991b1b;
        }
        .highlight {
            background: linear-gradient(to top, #fef08a 60%, transparent 60%);
            padding: 0 0.2rem;
            font-weight: 700;
        }
        .nav-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        .nav-btn.active {
            background-color: #818cf8;
            color: white;
            border-color: #4f46e5;
        }
        .nav-btn:not(.active) {
            background-color: #e5e7eb;
            color: #4b5563;
        }
        .digit-input {
             width: 5rem;
             text-align: center;
             font-size: 1.5rem;
             padding: 0.5rem;
             border-radius: 0.375rem;
             border: 2px solid #9ca3af;
        }
        .number-box {
            font-size: 2.5rem;
            font-weight: 900;
            letter-spacing: 0.2em;
            color: #374151;
        }
        .number-list-box {
            font-size: 1.8rem;
            font-weight: 700;
            color: #374151;
            line-height: 1.6;
            padding: 0 1rem;
        }
        .final-answer-box {
            font-size: 1.5rem;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            border: 2px solid #6b7280;
            min-width: 8rem;
            text-align: center;
        }
        .multi-check-btn.selected, .num-btn.selected {
            background-color: #6366f1;
            color: white;
            border-color: #4338ca;
        }
        .num-btn {
            width: 3rem;
            height: 3rem;
            font-size: 1.25rem;
        }
    </style>
</head>
<body class="bg-indigo-50 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-4xl bg-white rounded-xl shadow-2xl p-6 md:p-8">
        <!-- 題庫導覽 -->
        <div id="question-nav" class="flex justify-center items-center flex-wrap gap-3 mb-6 border-b-2 border-gray-200 pb-4">
            <!-- Navigation buttons will be inserted by JavaScript -->
        </div>

        <!-- 標題部分 -->
        <div class="text-center mb-8">
            <h1 id="main-title" class="text-3xl md:text-4xl font-bold text-gray-800">判別 2、3、4、5、9、11 的倍數</h1>
            <p class="text-gray-500 mt-2 text-lg">互動式練習</p>
        </div>

        <div id="prompt-container" class="bg-gray-100 p-5 rounded-lg mb-6">
             <div id="number-display" class="number-box text-center mb-4"></div>
            <p id="prompt-text" class="text-gray-800 leading-relaxed text-xl text-center">
                <!-- Prompt will be inserted by JavaScript -->
            </p>
        </div>

        <div id="global-feedback" class="text-center h-14 mb-4"></div>

        <!-- 解題步驟 -->
        <div class="space-y-6">
            <div id="step1" class="step-container p-6 border-2 border-dashed rounded-lg bg-white">
                <h3 id="s1-title" class="font-bold text-2xl text-purple-700 mb-3"></h3>
                <p id="s1-hint" class="text-base text-gray-600 mb-6"></p>
                <div id="s1-content-wrapper"></div>
            </div>

            <div id="step2" class="step-container p-6 border-2 border-dashed rounded-lg bg-white">
                <h3 id="s2-title" class="font-bold text-2xl text-teal-700 mb-3"></h3>
                <p id="s2-hint" class="text-base text-gray-600 mb-6"></p>
                 <div id="s2-content-wrapper"></div>
            </div>
            
            <div id="step3" class="step-container p-6 border-2 border-dashed rounded-lg bg-white" style="display: none;">
                <h3 id="s3-title" class="font-bold text-2xl text-indigo-700 mb-3"></h3>
                <p id="s3-hint" class="text-base text-gray-600 mb-6"></p>
                 <div id="s3-content-wrapper"></div>
            </div>
        </div>

        <!-- 完成訊息 -->
        <div id="completion-message" class="text-center mt-10 p-8 bg-green-100 border-2 border-green-400 rounded-lg" style="display: none;">
            <h2 class="text-3xl font-bold text-green-800">太棒了，完全正確！</h2>
            <p id="completion-text" class="mt-3 text-green-700 text-lg">你已經掌握了倍數的判別方法！</p>
            <button id="next-q-btn" class="mt-6 bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg transition-colors text-xl">下一題</button>
        </div>
    </div>

    <script>
        // --- 資料庫 ---
        const questions = [
            {
                navTitle: '判別 2&5 (題1)',
                type: 'multi-step-select',
                baseNumber: "8351□",
                prompt: "若五位數 8351□ 是<span class='highlight'>5 的倍數</span>，也是<span class='highlight'>2 的倍數</span>，則 □ 可以填入哪些數？",
                steps: [
                    { 
                        title: "步驟一：找出 2 的倍數個位數",
                        hint: "一個數字是 2 的倍數 (偶數)，它的個位數可能是哪些？請點擊下面的數字。",
                        correct: ["0","2","4","6","8"]
                    },
                    { 
                        title: "步驟二：找出 5 的倍數個位數",
                        hint: "一個數字是 5 的倍數，它的個位數可能是哪些？請點擊下面的數字。",
                        correct: ["0", "5"]
                    },
                    {
                        title: "步驟三：找出共同的數字",
                        hint: "同時是 2 的倍數也是 5 的倍數，表示個位數必須是步驟一和步驟二<span class='highlight'>共同擁有</span>的數字。請問是哪一個？",
                        correct: ["0"]
                    }
                ]
            },
            {
                navTitle: '判別 2&5 (題2)',
                type: 'multi-step-select',
                baseNumber: "395□",
                prompt: "若四位數 395□ 是<span class='highlight'>2 的倍數</span>，但<span class='highlight'>不是 5 的倍數</span>，則 □ 可以填入哪些數？",
                steps: [
                    { 
                        title: "步驟一：找出 2 的倍數個位數",
                        hint: "是 2 的倍數，個位數可能是？",
                        correct: ["0","2","4","6","8"]
                    },
                    { 
                        title: "步驟二：找出 5 的倍數個位數",
                        hint: "是 5 的倍數，個位數可能是？",
                        correct: ["0","5"]
                    },
                    {
                        title: "步驟三：找出不共同的數字",
                        hint: "是 2 的倍數，但<span class='highlight'>不是 5 的倍數</span>，表示個位數在步驟一的答案中，但<span class='highlight'>要去掉</span>步驟二的答案。剩下哪些？",
                        correct: ["2","4","6","8"]
                    }
                ]
            },
            {
                navTitle: '判別 4 (題1)',
                type: 'multi-check',
                checkType: 4,
                numberListString: "496, 89228, 240, 525, 44044, 1136",
                numberList: [
                    { num: '496', lastTwo: '96', isMultiple: true },
                    { num: '89228', lastTwo: '28', isMultiple: true },
                    { num: '240', lastTwo: '40', isMultiple: true },
                    { num: '525', lastTwo: '25', isMultiple: false },
                    { num: '44044', lastTwo: '44', isMultiple: true },
                    { num: '1136', lastTwo: '36', isMultiple: true }
                ],
                prompt: "下列各數中，有哪些是 <span class='highlight'>4 的倍數</span>？",
                finalAnswer: "4 的倍數有：240, 496, 1136, 44044, 89228",
                steps: [
                    {
                        title: "逐一判斷",
                        hint: "判斷 4 的倍數要看<span class='highlight'>末兩位數</span>。請點擊「是」或「否」，再按「檢查」來判斷下面每個數字是不是 4 的倍數。"
                    }
                ]
            },
            {
                navTitle: '判別 4 (題2)',
                type: 'select-then-deduce',
                baseNumber: "851□",
                prompt: "若四位數 851□ 是 <span class='highlight'>4 的倍數</span>，則 □ 可以填入哪些數？",
                steps: [
                    {
                        title: "步驟一：找出可能的末兩位數",
                        hint: "我們要讓末兩位數「1□」是 4 的倍數。請從下面選出 10-19 中，所有 4 的倍數。",
                        options: { start: 10, end: 19 },
                        correct: ["12", "16"]
                    },
                    {
                        title: "步驟二：□ 可以填入什麼？",
                        hint: "根據上一步的答案 (12, 16)，□ 可以是??。請選出這兩個數字。",
                        options: { start: 0, end: 9 },
                        correct: ["2", "6"]
                    }
                ]
            },
            {
                navTitle: '判別 9 (題1)',
                type: 'multi-check',
                checkType: 9,
                numberListString: "495, 920, 204, 2838, 103056, 1276",
                numberList: [
                    { num: '495', sumText: '4+9+5 = 18', isMultiple: true },
                    { num: '920', sumText: '9+2+0 = 11', isMultiple: false },
                    { num: '204', sumText: '2+0+4 = 6', isMultiple: false },
                    { num: '2838', sumText: '2+8+3+8 = 21', isMultiple: false },
                    { num: '103056', sumText: '1+0+3+0+5+6 = 15', isMultiple: false },
                    { num: '1276', sumText: '1+2+7+6 = 16', isMultiple: false }
                ],
                prompt: "下列各數中，有哪些是 <span class='highlight'>9 的倍數</span>？",
                finalAnswer: "9 的倍數有：495",
                steps: [
                    {
                        title: "逐一判斷",
                        hint: "一個數是「9的倍數」，代表它<span class='highlight'>所有位數的數字和</span>也是 9 的倍數。請根據數字和，點擊「是」或「否」，再按「檢查」來判斷。"
                    }
                ]
            },
            {
                navTitle: '判別 9 (題2)',
                baseNumber: "36□",
                prompt: "若三位數 36□ 是 <span class='highlight'>9 的倍數</span>，則 □ 可以填入哪些數？",
                steps: [
                    {
                        title: "步驟一：計算已知數字和",
                        hint: "我們先把知道的數字加起來。 3 + 6 = ?",
                        prefix: "數字和是：",
                        correct: ["9"]
                    },
                    {
                        title: "步驟二：找出 □",
                        hint: "數字和 (9 + □) 必須是 9 的倍數。<br>情況一：9 + □ = 9<br>情況二：9 + □ = 18<br>（請由小到大，用逗號 , 隔開）",
                        prefix: "□ 可以是：",
                        correct: ["0,9", "9,0"]
                    }
                ]
            },
            {
                navTitle: '判別 3 (題1)',
                type: 'multi-check',
                checkType: 3,
                numberListString: "495, 920, 204, 2838, 103056, 1276",
                numberList: [
                    { num: '495', sumText: '4+9+5 = 18', isMultiple: true },
                    { num: '920', sumText: '9+2+0 = 11', isMultiple: false },
                    { num: '204', sumText: '2+0+4 = 6', isMultiple: true },
                    { num: '2838', sumText: '2+8+3+8 = 21', isMultiple: true },
                    { num: '103056', sumText: '1+0+3+0+5+6 = 15', isMultiple: true },
                    { num: '1276', sumText: '1+2+7+6 = 16', isMultiple: false }
                ],
                prompt: "下列各數中，有哪些是 <span class='highlight'>3 的倍數</span>？",
                finalAnswer: "3 的倍數有：204, 495, 2838, 103056",
                steps: [
                    {
                        title: "逐一判斷",
                        hint: "一個數是「3的倍數」，代表它<span class='highlight'>所有位數的數字和</span>也是 3 的倍數。請根據數字和，點擊「是」或「否」，再按「檢查」來判斷。"
                    }
                ]
            },
            {
                navTitle: '判別 3 (題2)',
                baseNumber: "5□62",
                prompt: "若四位數 5□62 是 <span class='highlight'>3 的倍數</span>，則 □ 可以填入哪些數？",
                steps: [
                    {
                        title: "步驟一：計算已知數字和",
                        hint: "我們先把知道的數字加起來。 5 + 6 + 2 = ?",
                        prefix: "數字和是：",
                        correct: ["13"]
                    },
                    {
                        title: "步驟二：找出 □",
                        hint: "數字和 (13 + □) 必須是 3 的倍數，例如 15, 18, 21 ...<br>如果 13 + □ = 15<br>如果 13 + □ = 18<br>如果 13 + □ = 21<br>（請由小到大，用逗號 , 隔開）",
                        prefix: "□ 可以是：",
                        correct: ["2,5,8"]
                    }
                ]
            },
            {
                navTitle: '判別 11',
                type: 'multi-check-11',
                numberListString: "495, 920, 2838, 103056",
                numberList: [
                    { num: '495', oddSumText: '5+4=9', evenSumText: '9', diffText: '9-9=0', isMultiple: true },
                    { num: '920', oddSumText: '0+9=9', evenSumText: '2', diffText: '9-2=7', isMultiple: false },
                    { num: '2838', oddSumText: '8+8=16', evenSumText: '3+2=5', diffText: '16-5=11', isMultiple: true },
                    { num: '103056', oddSumText: '6+0+0=6', evenSumText: '5+3+1=9', diffText: '9-6=3', isMultiple: false }
                ],
                prompt: "下列各數中，有哪些是 <span class='highlight'>11 的倍數</span>？",
                finalAnswer: "11 的倍數有：495, 2838",
                steps: [
                    {
                        title: "逐一判斷",
                        hint: "判別11的倍數：將數字<span class='highlight'>奇數位</span>相加，<span class='highlight'>偶數位</span>相加，兩組數字的<span class='highlight'>差</span>如果是 0 或 11 的倍數，就是11的倍數。"
                    }
                ]
            }
        ];
        let currentQuestionIndex = 0;

        // --- 功能函數 ---
        function showFeedback(message, isCorrect, duration = 2500) {
            const feedbackEl = document.getElementById('global-feedback');
            feedbackEl.innerHTML = `<div class="feedback-message ${isCorrect ? 'feedback-correct' : 'feedback-incorrect'}">${message}</div>`;
            setTimeout(() => {
                if (feedbackEl.firstChild) feedbackEl.firstChild.style.opacity = '0';
            }, duration);
            setTimeout(() => { feedbackEl.innerHTML = ''; }, duration + 300);
        }

        function setStepLock(stepId, locked) {
            const step = document.getElementById(stepId);
            if (locked) step.classList.add('step-locked');
            else step.classList.remove('step-locked');
        }
        
        // --- 核心互動邏輯 ---
        function loadQuestion(index) {
            currentQuestionIndex = index;
            const data = questions[index];

            document.querySelectorAll('#question-nav .nav-btn').forEach((btn, i) => btn.classList.toggle('active', i === index));
            
            const numberDisplay = document.getElementById('number-display');
            if (data.baseNumber) numberDisplay.className = 'number-box text-center mb-4';
            else if (data.numberListString) numberDisplay.className = 'number-list-box text-center mb-4';
            numberDisplay.innerText = data.baseNumber || data.numberListString || '';

            document.getElementById('prompt-text').innerHTML = data.prompt;

            // 顯示/隱藏步驟
            document.getElementById('step1').style.display = 'block';
            document.getElementById('step2').style.display = data.steps[1] ? 'block' : 'none';
            document.getElementById('step3').style.display = data.steps[2] ? 'block' : 'none';

            // 根據題目類型，產生對應的互動介面
            data.steps.forEach((step, i) => {
                const stepIndex = i + 1;
                const contentWrapper = document.getElementById(`s${stepIndex}-content-wrapper`);
                const titleEl = document.getElementById(`s${stepIndex}-title`);
                const hintEl = document.getElementById(`s${stepIndex}-hint`);
                titleEl.textContent = step.title;
                hintEl.innerHTML = step.hint;

                if (data.type === 'multi-step-select' || data.type === 'select-then-deduce') {
                    contentWrapper.innerHTML = `
                        <div id="s${stepIndex}-number-buttons" class="flex flex-wrap justify-center gap-2 my-4"></div>
                        <div class="flex items-center justify-center gap-2 mt-4">
                            <span class="text-lg">你選的答案是：</span>
                            <div id="s${stepIndex}-selection-display" class="font-bold text-xl text-indigo-600 p-2 rounded-lg bg-indigo-50 min-w-[8rem] text-center h-12"></div>
                        </div>
                        <div class="text-center mt-6">
                            <button id="check-s${stepIndex}-btn" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-8 rounded-lg transition-colors text-lg">檢查答案</button>
                        </div>
                    `;
                    const numberContainer = document.getElementById(`s${stepIndex}-number-buttons`);
                    const options = step.options || { start: 0, end: 9 };
                    for (let j = options.start; j <= options.end; j++) {
                        const btn = document.createElement('button');
                        btn.className = 'num-btn border-2 border-gray-300 bg-white hover:bg-indigo-100 rounded-md transition-colors';
                        btn.textContent = j;
                        btn.onclick = () => {
                            btn.classList.toggle('selected');
                            updateSelectionDisplay(stepIndex);
                        };
                        numberContainer.appendChild(btn);
                    }
                } else if (data.type && data.type.startsWith('multi-check')) {
                     contentWrapper.innerHTML = `<div id="s1-multi-check-container" class="space-y-3"></div>`;
                     renderMultiCheck();
                } else {
                     contentWrapper.innerHTML = `
                        <div class="flex items-center justify-center gap-4">
                            <span class="text-xl font-medium">${step.prefix || ""}</span>
                            <input id="s${stepIndex}-answer" type="text" class="${ i===0 ? 'digit-input' : 'final-answer-box'}" placeholder="答案">
                             <div class="text-center">
                                <button id="check-s${stepIndex}-btn" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-8 rounded-lg transition-colors text-lg">檢查答案</button>
                            </div>
                        </div>
                     `;
                }
            });
            
            // 綁定事件
            document.getElementById('check-s1-btn')?.addEventListener('click', () => checkStep(0));
            document.getElementById('check-s2-btn')?.addEventListener('click', () => checkStep(1));
            document.getElementById('check-s3-btn')?.addEventListener('click', () => checkStep(2));

            resetCurrentQuestionState();
        }

        function updateSelectionDisplay(stepIndex) {
            const container = document.getElementById(`s${stepIndex}-number-buttons`);
            const display = document.getElementById(`s${stepIndex}-selection-display`);
            const selected = Array.from(container.querySelectorAll('.selected')).map(b => b.textContent).sort((a,b) => a-b);
            display.textContent = selected.join(', ');
        }

        function renderMultiCheck() {
            const data = questions[currentQuestionIndex];
            const container = document.getElementById('s1-multi-check-container');
            container.innerHTML = '';
             data.numberList.forEach((item, itemIndex) => {
                    const div = document.createElement('div');
                    let questionHTML = '';
                    if (data.type === 'multi-check-11') {
                        div.className = 'p-4 bg-gray-50 rounded-lg flex flex-col gap-2';
                        const createHighlightedNumber = (numStr) => numStr.split('').reverse().map((d, i) => `<span class='${(i % 2 === 0) ? 'text-red-500' : 'text-blue-500'} font-bold'>${d}</span>`).reverse().join('');
                        questionHTML = `
                            <div class="flex items-center justify-between flex-wrap gap-x-4 gap-y-2"><span class="text-3xl font-bold tracking-wider">${createHighlightedNumber(item.num)}</span></div>
                            <div class="text-base text-gray-700 bg-white p-2 rounded-md flex flex-wrap gap-x-4">
                                <div><span class="text-red-500">奇數位和:</span> ${item.oddSumText}</div><div><span class="text-blue-500">偶數位和:</span> ${item.evenSumText}</div><div><span>相差:</span> ${item.diffText}</div>
                            </div>`;
                    } else {
                        div.className = 'p-3 bg-gray-50 rounded-lg flex items-center justify-between flex-wrap gap-x-4 gap-y-2';
                        let questionText = (data.checkType === 4) ? `<span class="text-gray-600">末兩位是 ${item.lastTwo}，</span><span>是 4 的倍數嗎？</span>` : `<span class="text-gray-600">${item.sumText}，</span><span>是 ${data.checkType} 的倍數嗎？</span>`;
                        questionHTML = `<div class="flex items-center flex-wrap"><span class="text-2xl font-bold w-32">${item.num}</span><div class="flex items-center text-lg">${questionText}</div></div>`;
                    }
                    div.innerHTML = `${questionHTML}
                        <div class="flex items-center gap-2" data-index="${itemIndex}">
                            <div class="flex gap-2">
                                <button class="multi-check-btn border-2 border-gray-300 bg-white hover:bg-indigo-100 px-5 py-1 rounded-md" data-choice="true">是</button>
                                <button class="multi-check-btn border-2 border-gray-300 bg-white hover:bg-indigo-100 px-5 py-1 rounded-md" data-choice="false">否</button>
                            </div>
                            <button class="row-check-btn bg-purple-500 hover:bg-purple-600 text-white text-sm font-bold py-1 px-3 rounded-md transition-colors">檢查</button>
                        </div>`;
                    container.appendChild(div);
                });
            container.querySelectorAll('.multi-check-btn').forEach(btn => btn.addEventListener('click', () => {
                const parent = btn.parentElement;
                parent.querySelectorAll('.multi-check-btn').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
            }));
            container.querySelectorAll('.row-check-btn').forEach(btn => btn.addEventListener('click', () => checkSingleMultiChoiceItem(btn)));
        }
        
        function resetCurrentQuestionState() {
            const data = questions[currentQuestionIndex];
            // 只有多步驟選擇題會預先解鎖第一步
            setStepLock('step1', false);
            setStepLock('step2', true);
            setStepLock('step3', true);
            
            document.getElementById('completion-message').style.display = 'none';
            const nextBtn = document.getElementById('next-q-btn');
            nextBtn.style.display = 'block';
            nextBtn.disabled = currentQuestionIndex >= questions.length - 1;
            nextBtn.innerText = (currentQuestionIndex >= questions.length - 1) ? "全部完成！" : "下一題";
            
            showFeedback(`第 ${currentQuestionIndex + 1} 題載入完成！`, true);
        }

        function checkSingleMultiChoiceItem(checkButton) {
            const parent = checkButton.parentElement;
            const selectedBtn = parent.querySelector('.selected');
            if (!selectedBtn) { showFeedback('請先選擇「是」或「否」！', false, 1500); return; }
            if (parent.dataset.answered) return;
            const itemIndex = parseInt(parent.dataset.index, 10);
            const userChoice = selectedBtn.dataset.choice === 'true';
            const correctChoice = questions[currentQuestionIndex].numberList[itemIndex].isMultiple;
            if (userChoice === correctChoice) {
                showFeedback('答對了！', true, 1000);
                parent.dataset.answered = "true";
                parent.querySelectorAll('.multi-check-btn').forEach(b => b.disabled = true);
                selectedBtn.classList.add('bg-green-500', 'text-white', 'border-green-600');
                checkButton.disabled = true;
                checkButton.classList.add('bg-gray-400', 'cursor-not-allowed');
                const totalItems = questions[currentQuestionIndex].numberList.length;
                const answeredCorrectly = document.querySelectorAll('#s1-multi-check-container div[data-answered="true"]').length;
                if (answeredCorrectly === totalItems) {
                    setTimeout(() => {
                        const data = questions[currentQuestionIndex];
                        document.getElementById('completion-text').innerText = data.finalAnswer;
                        document.getElementById('completion-message').style.display = 'block';
                    }, 500);
                }
            } else {
                showFeedback('不對喔，再想一想！', false, 1500);
                selectedBtn.classList.add('bg-red-500', 'border-red-600');
                setTimeout(() => selectedBtn.classList.remove('bg-red-500', 'border-red-600', 'selected'), 800);
            }
        }
        
        function checkStep(stepIndex) {
            const data = questions[currentQuestionIndex];
            const stepData = data.steps[stepIndex];
            let userInput;
            const isSelectType = data.type === 'multi-step-select' || data.type === 'select-then-deduce';
            
            if (isSelectType) {
                const container = document.getElementById(`s${stepIndex+1}-number-buttons`);
                userInput = Array.from(container.querySelectorAll('.selected')).map(b => b.textContent).sort((a,b)=>a-b);
            } else {
                const inputEl = document.getElementById(`s${stepIndex+1}-answer`);
                userInput = inputEl.value.replace(/，/g, ',').split(',').map(s => s.trim()).filter(Boolean).sort();
            }

            const correctAnswers = Array.isArray(stepData.correct[0]) ? stepData.correct : [stepData.correct];
            let isCorrect = false;

            if (isSelectType) {
                 isCorrect = JSON.stringify(userInput) === JSON.stringify(stepData.correct.sort((a,b)=>a-b));
            } else {
                const userInputStr = userInput.join(',');
                isCorrect = stepData.correct.includes(userInputStr);
            }

            if (isCorrect) {
                showFeedback(`步驟 ${stepIndex + 1} 正確！`, true);
                if (stepIndex < data.steps.length - 1) {
                    setStepLock(`step${stepIndex + 2}`, false);
                } else {
                    document.getElementById('completion-text').innerText = "你已經掌握了倍數的判別方法！";
                    document.getElementById('completion-message').style.display = 'block';
                }
                
                if (!isSelectType) {
                    document.getElementById(`check-s${stepIndex+1}-btn`).disabled = true;
                }
            } else {
                showFeedback('答案不對喔，再想一想！', false);
            }
        }
        
        // --- 初始化 ---
        document.addEventListener('DOMContentLoaded', () => {
            const navContainer = document.getElementById('question-nav');
            questions.forEach((q, i) => {
                const btn = document.createElement('button');
                btn.className = 'nav-btn';
                btn.innerText = q.navTitle || `第 ${i + 1} 題`;
                btn.onclick = () => loadQuestion(i);
                navContainer.appendChild(btn);
            });

            document.getElementById('next-q-btn').onclick = () => {
                if (currentQuestionIndex < questions.length - 1) {
                    loadQuestion(currentQuestionIndex + 1);
                }
            };
            loadQuestion(0);
        });
    </script>
</body>
</html>


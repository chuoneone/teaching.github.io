<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸€å…ƒä¸€æ¬¡æ–¹ç¨‹å¼ï¼šå…«å¤§ç§»é …æ³•å‰‡å¤§å¸« (åš´æ ¼è¨ˆåˆ†ç‰ˆ)</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;600;800&family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <style>
        body {
             font-family: 'Lexend', 'Noto Sans TC', sans-serif;
         }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            height: 300px;
            margin: 0 auto;
        }
        @media (min-width: 768px) {
            .chart-container { height: 350px; }
        }
        /* KaTeX ç‰¹æ®Šè™•ç† */
        .katex-display { margin: 0.5em 0; overflow-x: auto; overflow-y: hidden; }
        .katex { white-space: nowrap; }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f5f5f4; }
        ::-webkit-scrollbar-thumb { background: #d6d3d1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a29e; }
        
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .btn-correct { border-color: #10b981 !important; background-color: #ecfdf5 !important; color: #047857 !important; pointer-events: none; }
        .btn-wrong { border-color: #ef4444 !important; background-color: #fef2f2 !important; color: #b91c1c !important; opacity: 0.6; pointer-events: none; }
        
        /* æ–°å¢ï¼šé¸å–ç‹€æ…‹æ¨£å¼ */
        .btn-selected { 
            border-color: #f59e0b !important; 
            background-color: #fffbeb !important; 
            color: #b45309 !important; 
            box-shadow: 0 0 0 4px #fde68a !important;
            transform: scale(1.02);
        }

        /* é€£æ¥ç·šæ¨£å¼ */
        .step-connector {
            width: 2px;
            height: 20px;
            background-color: #e5e7eb;
            margin: 0 auto;
        }
    </style>
    </head>
<body class="bg-stone-50 text-stone-800 antialiased h-screen flex flex-col md:flex-row overflow-hidden">

    <div class="md:hidden bg-white border-b border-stone-200 p-4 flex justify-between items-center z-20">
        <h1 class="text-lg font-bold text-stone-900">ç§»é …æ³•å‰‡å¤§å¸«</h1>
        <button id="mobile-menu-btn" class="text-stone-600 p-2 rounded hover:bg-stone-100">
            <span class="text-2xl">â˜°</span>
        </button>
    </div>

    <aside id="sidebar" class="fixed md:relative transform -translate-x-full md:translate-x-0 transition-transform duration-300 z-30 w-64 h-full bg-white border-r border-stone-200 flex flex-col shadow-xl md:shadow-none">
        <div class="p-6 border-b border-stone-200">
            <h1 class="text-2xl font-black text-amber-600 tracking-tight leading-none">EQUATION</h1>
            <h2 class="text-sm font-bold text-stone-400 mt-1">ç§»é …æ³•å‰‡å¤§å¸«</h2>
        </div>
        
        <nav class="flex-1 overflow-y-auto p-4 space-y-1" id="nav-container">
            </nav>

        <div class="p-4 border-t border-stone-200 bg-stone-50">
            <button onclick="clearProgress()" class="w-full py-2 text-[10px] text-stone-400 hover:text-red-500 font-bold transition-colors">
                æ¸…ç©ºæ•¸æ“šèˆ‡é‡æ–°é–‹å§‹
            </button>
        </div>
    </aside>

    <div id="sidebar-overlay" class="fixed inset-0 bg-black/30 z-20 hidden md:hidden"></div>

    <main class="flex-1 overflow-y-auto p-4 md:p-8 relative" id="main-content">
        </main>

    <script>
        // --- Data Source ---
        const appData = {
            modules: [
                {
                    id: 1, title: "åŠ æ³•ç§»é …", subtitle: "åŠ è®Šæ¸›", type: "simple",
                    desc: "ç•¶æœªçŸ¥æ•¸æ—æœ‰åŠ æ•¸ï¼Œç§»å‘ç­‰è™Ÿå¦ä¸€é‚Šæ™‚éœ€æ”¹ç‚ºæ¸›æ³•ã€‚",
                    demo: { q: "x + 6 = 14", steps: ["x = 14 - 6", "x = 8"] },
                    practice: [
                        { q: "x + 13 = 25", options: ["x = 12", "x = 38", "x = 13", "x = 15"], correctStr: "x = 12" },
                        { q: "x + 20 = 5", options: ["x = 25", "x = -15", "x = 15", "x = -25"], correctStr: "x = -15" },
                        { q: "12 + x = 30", options: ["x = 42", "x = 18", "x = 22", "x = 12"], correctStr: "x = 18" },
                        { q: "x + 4.2 = 10", options: ["x = 14.2", "x = 6.2", "x = 5.8", "x = 4.8"], correctStr: "x = 5.8" }
                    ]
                },
                {
                    id: 2, title: "æ¸›æ³•ç§»é …", subtitle: "æ¸›è®ŠåŠ ", type: "simple",
                    desc: "ç•¶æœªçŸ¥æ•¸æ—æœ‰æ¸›æ•¸ï¼Œç§»å‘ç­‰è™Ÿå¦ä¸€é‚Šæ™‚éœ€æ”¹ç‚ºåŠ æ³•ã€‚",
                    demo: { q: "x - 9 = 11", steps: ["x = 11 + 9", "x = 20"] },
                    practice: [
                        { q: "x - 8 = 4", options: ["x = 12", "x = -4", "x = 4", "x = 2"], correctStr: "x = 12" },
                        { q: "x - 15 = -5", options: ["x = -20", "x = 10", "x = -10", "x = 20"], correctStr: "x = 10" },
                        { q: "x - 0.5 = 3.5", options: ["x = 3.0", "x = 4.0", "x = 4.5", "x = -3.0"], correctStr: "x = 4.0" },
                        { q: "x - 100 = 250", options: ["x = 150", "x = 350", "x = 300", "x = 250"], correctStr: "x = 350" }
                    ]
                },
                {
                    id: 3, title: "ä¹˜æ³•ç§»é …", subtitle: "ä¹˜è®Šåˆ†æ¯", type: "simple",
                    desc: "ä¿‚æ•¸å¦‚æœæ˜¯ä¹˜æ³•é—œä¿‚ï¼Œç§»é …å¾Œè®Šç‚ºé™¤æ³•ï¼Œé€šå¸¸å¯«æˆåˆ†æ¯ã€‚",
                    demo: { q: "3x = 12", steps: ["x = \\frac{12}{3}", "x = 4"] },
                    practice: [
                        { q: "7x = 42", options: ["x = 6", "x = 7", "x = 49", "x = 35"], correctStr: "x = 6" },
                        { q: "-4x = 16", options: ["x = 4", "x = -4", "x = -12", "x = -20"], correctStr: "x = -4" },
                        { q: "10x = 2", options: ["x = 5", "x = 0.2", "x = 20", "x = 0.1"], correctStr: "x = 0.2" },
                        { q: "0.1x = 7", options: ["x = 0.7", "x = 70", "x = 7", "x = 0.07"], correctStr: "x = 70" }
                    ]
                },
                {
                    id: 4, title: "é™¤æ³•ç§»é …", subtitle: "é™¤è®Šä¹˜", type: "simple",
                    desc: "åˆ†æ¯çš„æ•¸å€¼ç§»å‘ç­‰è™Ÿå¦ä¸€é‚Šæ™‚æ”¹ç‚ºä¹˜æ³•ã€‚",
                    demo: { q: "\\frac{1}{5}x = 4", steps: ["x = 4 \\times 5", "x = 20"] },
                    practice: [
                        { q: "\\frac{1}{2}x = 9", options: ["x = 4.5", "x = 18", "x = 11", "x = 7"], correctStr: "x = 18" },
                        { q: "\\frac{1}{3}x = -5", options: ["x = -15", "x = -2", "x = 15", "x = -8"], correctStr: "x = -15" },
                        { q: "\\frac{1}{0.5}x = 10", options: ["x = 20", "x = 5", "x = 15", "x = 50"], correctStr: "x = 5" },
                        { q: "\\frac{1}{-6}x = 3", options: ["x = -18", "x = 18", "x = -2", "x = -3"], correctStr: "x = -18" }
                    ]
                },
                {
                    id: 5, title: "å…©æ­¥é©Ÿç¶œåˆ", subtitle: "å…ˆåŠ æ¸›ï¼Œå¾Œä¹˜é™¤", type: "simple",
                    desc: "æ··åˆé‹ç®—æ™‚ï¼Œå…ˆå°‡å¸¸æ•¸é …ç§»èµ°ï¼Œæœ€å¾Œå†è™•ç†æœªçŸ¥æ•¸çš„ä¿‚æ•¸ã€‚",
                    demo: { q: "2x + 1 = 5", steps: ["2x = 5 - 1", "2x = 4", "x = \\frac{4}{2}", "x = 2"] },
                    practice: [
                        { q: "3x - 4 = 11", options: ["x = 5", "x = 7/3", "x = 15", "x = 4"], correctStr: "x = 5" },
                        { q: "5x + 10 = 30", options: ["x = 8", "x = 4", "x = 5", "x = 6"], correctStr: "x = 4" },
                        { q: "4x - 7 = 13", options: ["x = 5", "x = 1.5", "x = 20", "x = 6"], correctStr: "x = 5" },
                        { q: "6x + 8 = 2", options: ["x = 1", "x = -1", "x = -6", "x = 0"], correctStr: "x = -1" }
                    ]
                },
                {
                    id: 6, title: "å«æœ‰æ‹¬è™Ÿ", subtitle: "å…ˆå»æ‹¬è™Ÿå†ç§»é …", type: "step-by-step",
                    desc: "å…ˆç”¨åˆ†é…å¾‹å±•é–‹æ‹¬è™Ÿï¼Œå°‡å•é¡ŒåŒ–ç°¡ç‚ºå…©æ­¥é©Ÿå‹æ…‹å¾Œå†æ±‚è§£ã€‚è«‹ä¾ç…§æ­¥é©Ÿå®Œæˆç·´ç¿’ã€‚",
                    demo: { q: "2(x + 1) = 6", steps: ["2x + 2 = 6", "2x = 6 - 2", "2x = 4", "x = \\frac{4}{2}", "x = 2"] },
                    practice: [
                        {
                            q: "3(x - 2) = 12",
                            steps: [
                                { instruction: "æ­¥é©Ÿä¸€ï¼šåˆ†é…å¾‹å»æ‹¬è™Ÿ", q: "3(x - 2) = 12", options: ["3x - 2 = 12", "3x - 6 = 12", "3x + 6 = 12"], correctStr: "3x - 6 = 12" },
                                { instruction: "æ­¥é©ŸäºŒï¼šç§»é … (å¸¸æ•¸é …)", q: "3x - 6 = 12", options: ["3x = 6", "3x = 18", "3x = 12"], correctStr: "3x = 18" },
                                { instruction: "æ­¥é©Ÿä¸‰ï¼šæ±‚è§£ x", q: "3x = 18", options: ["x = 6", "x = 15", "x = 9"], correctStr: "x = 6" }
                            ]
                        },
                        {
                            q: "5(x + 4) = 35",
                            steps: [
                                { instruction: "æ­¥é©Ÿä¸€ï¼šåˆ†é…å¾‹å»æ‹¬è™Ÿ", q: "5(x + 4) = 35", options: ["5x + 4 = 35", "5x + 20 = 35", "5x - 20 = 35"], correctStr: "5x + 20 = 35" },
                                { instruction: "æ­¥é©ŸäºŒï¼šç§»é … (å¸¸æ•¸é …)", q: "5x + 20 = 35", options: ["5x = 15", "5x = 55", "5x = 35"], correctStr: "5x = 15" },
                                { instruction: "æ­¥é©Ÿä¸‰ï¼šæ±‚è§£ x", q: "5x = 15", options: ["x = 3", "x = 5", "x = 7"], correctStr: "x = 3" }
                            ]
                        }
                    ]
                },
                {
                    id: 7, title: "é€²éšå»æ‹¬è™Ÿ", subtitle: "è² è™Ÿåˆ†é…è®Šè™Ÿ", type: "step-by-step",
                    desc: "æ³¨æ„ï¼æ‹¬è™Ÿå‰æœ‰è² è™Ÿï¼Œå±•é–‹å¾Œæ¯ä¸€é …éƒ½è¦è®Šè™Ÿã€‚è«‹ä¾ç…§æ­¥é©Ÿå®Œæˆç·´ç¿’ã€‚",
                    demo: { q: "-2(3x + 5) = 10", steps: ["-6x - 10 = 10", "-6x = 10 + 10", "-6x = 20", "x = \\frac{20}{-6}", "x = -\\frac{10}{3}"] },
                    practice: [
                        {
                            q: "-3(x - 4) = 15",
                            steps: [
                                { instruction: "æ­¥é©Ÿä¸€ï¼šå»æ‹¬è™Ÿ (æ³¨æ„è®Šè™Ÿ)", q: "-3(x - 4) = 15", options: ["-3x - 12 = 15", "-3x + 12 = 15", "-3x - 4 = 15"], correctStr: "-3x + 12 = 15" },
                                { instruction: "æ­¥é©ŸäºŒï¼šç§»é … (å¸¸æ•¸é …)", q: "-3x + 12 = 15", options: ["-3x = 27", "-3x = 3", "-3x = 15"], correctStr: "-3x = 3" },
                                { instruction: "æ­¥é©Ÿä¸‰ï¼šæ±‚è§£ x", q: "-3x = 3", options: ["x = 1", "x = -1", "x = 0"], correctStr: "x = -1" }
                            ]
                        },
                        {
                            q: "-5(2x + 1) = 25",
                            steps: [
                                { instruction: "æ­¥é©Ÿä¸€ï¼šå»æ‹¬è™Ÿ (æ³¨æ„è®Šè™Ÿ)", q: "-5(2x + 1) = 25", options: ["-10x + 5 = 25", "-10x - 5 = 25", "10x + 5 = 25"], correctStr: "-10x - 5 = 25" },
                                { instruction: "æ­¥é©ŸäºŒï¼šç§»é … (å¸¸æ•¸é …)", q: "-10x - 5 = 25", options: ["-10x = 20", "-10x = 30", "-10x = 25"], correctStr: "-10x = 30" },
                                { instruction: "æ­¥é©Ÿä¸‰ï¼šæ±‚è§£ x", q: "-10x = 30", options: ["x = 3", "x = -3", "x = -30"], correctStr: "x = -3" }
                            ]
                        }
                    ]
                },
                {
                    id: 8, title: "é›™é‡æ‹¬è™Ÿ", subtitle: "åˆ†é…å¾‹èˆ‡åŒé¡é …åˆä½µ", type: "step-by-step",
                    desc: "æŒ‘æˆ°ç´šï¼šæ‹†è§£æ‰€æœ‰æ‹¬è™Ÿï¼Œåˆä½µ x é …èˆ‡å¸¸æ•¸é …å¾Œï¼Œé€²è¡Œæœ€å¾Œç§»é …ã€‚",
                    demo: { q: "2(3x + 5) - 3(5x - 10) = 50", steps: ["6x + 10 - 15x + 30 = 50", "-9x + 40 = 50", "-9x = 50 - 40", "-9x = 10", "x = -\\frac{10}{9}"] },
                    practice: [
                        {
                            q: "3(2x - 1) + 2(x + 4) = 21",
                            steps: [
                                { instruction: "æ­¥é©Ÿä¸€ï¼šå±•é–‹æ‹¬è™Ÿ", q: "3(2x - 1) + 2(x + 4) = 21", options: ["6x - 3 + 2x + 8 = 21", "6x - 1 + 2x + 4 = 21", "6x - 3 + 2x + 4 = 21"], correctStr: "6x - 3 + 2x + 8 = 21" },
                                { instruction: "æ­¥é©ŸäºŒï¼šåˆä½µåŒé¡é …", q: "6x - 3 + 2x + 8 = 21", options: ["8x + 5 = 21", "8x - 11 = 21", "4x + 5 = 21"], correctStr: "8x + 5 = 21" },
                                { instruction: "æ­¥é©Ÿä¸‰ï¼šç§»é …æ±‚è§£", q: "8x + 5 = 21", options: ["8x = 26", "8x = 16", "x = 3"], correctStr: "8x = 16" },
                                { instruction: "æ­¥é©Ÿå››ï¼šæœ€çµ‚ç­”æ¡ˆ", q: "8x = 16", options: ["x = 2", "x = 1/2", "x = 8"], correctStr: "x = 2" }
                            ]
                        },
                        {
                            q: "4(x + 2) - 3(2x - 1) = 1",
                            steps: [
                                { instruction: "æ­¥é©Ÿä¸€ï¼šå±•é–‹æ‹¬è™Ÿ (å°å¿ƒè² è™Ÿ!)", q: "4(x + 2) - 3(2x - 1) = 1", options: ["4x + 8 - 6x - 3 = 1", "4x + 8 - 6x + 3 = 1", "4x + 2 - 6x + 3 = 1"], correctStr: "4x + 8 - 6x + 3 = 1" },
                                { instruction: "æ­¥é©ŸäºŒï¼šåˆä½µåŒé¡é …", q: "4x + 8 - 6x + 3 = 1", options: ["-2x + 11 = 1", "-2x + 5 = 1", "2x + 11 = 1"], correctStr: "-2x + 11 = 1" },
                                { instruction: "æ­¥é©Ÿä¸‰ï¼šç§»é …æ±‚è§£", q: "-2x + 11 = 1", options: ["-2x = 12", "-2x = -10", "-2x = 10"], correctStr: "-2x = -10" },
                                { instruction: "æ­¥é©Ÿå››ï¼šæœ€çµ‚ç­”æ¡ˆ", q: "-2x = -10", options: ["x = -5", "x = 5", "x = 20"], correctStr: "x = 5" }
                            ]
                        }
                    ]
                }
            ]
        };

        // --- State ---
        let currentView = 'overview';
        let demoStep = 0;
        let scores = JSON.parse(localStorage.getItem('equations_mastery_v4') || '{}');
        let currentModuleData = [];
        let answeredInCurrentSession = new Set();
        // step state
        let currentProblemIdx = 0;
        let currentStepIdx = 0;
        let currentModuleCorrectCount = 0;
        let currentStepFailed = false; // Tracks if user messed up current step
        
        // --- Selection State (New) ---
        let simpleSelections = {}; // Store { qIdx: oIdx }
        let stepSelection = null; // Store oIdx for current step

        // --- DOM Elements ---
        let mainContent, navContainer, sidebar, mobileMenuBtn, sidebarOverlay;

        function initDOMElements() {
            mainContent = document.getElementById('main-content');
            navContainer = document.getElementById('nav-container');
            sidebar = document.getElementById('sidebar');
            mobileMenuBtn = document.getElementById('mobile-menu-btn');
            sidebarOverlay = document.getElementById('sidebar-overlay');
        }

        // --- Utilities ---
        function shuffleArray(array) {
            let arr = [...array];
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        function triggerKatex() {
            renderMathInElement(document.body, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false}
                ],
                throwOnError: false
            });
        }

        function getModuleMaxScore(index) {
            const mod = appData.modules[index];
            if (mod.type === 'step-by-step') {
                return mod.practice.reduce((acc, p) => acc + p.steps.length, 0);
            }
            return 4; // Simple modules have 4 questions
        }

        function saveScore(moduleId, currentCorrect) {
            if (!scores[moduleId]) {
                scores[moduleId] = { best: currentCorrect, first: currentCorrect, history: [currentCorrect] };
            } else {
                scores[moduleId].best = Math.max(scores[moduleId].best, currentCorrect);
                scores[moduleId].history.push(currentCorrect);
            }
            localStorage.setItem('equations_mastery_v4', JSON.stringify(scores));
            renderNav();
        }

        function clearProgress() {
            if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å­¸ç¿’ç´€éŒ„å—ï¼Ÿ')) {
                localStorage.removeItem('equations_mastery_v4');
                scores = {};
                switchView('overview');
            }
        }

        // --- Views ---
        function renderNav() {
            if (!navContainer) return;
            let html = `
                <button onclick="switchView('overview')" class="w-full text-left px-4 py-3 rounded-xl mb-3 transition-all ${currentView === 'overview' ? 'bg-amber-100 text-amber-900 font-bold shadow-sm' : 'text-stone-600 hover:bg-stone-50'}">
                    <span class="mr-2">ğŸ“ˆ</span> å­¸ç¿’å„€è¡¨æ¿
                </button>
                <div class="px-2 pb-2 text-[10px] font-black text-stone-300 uppercase tracking-widest">ç§»é …æ³•å‰‡æŒ‘æˆ°</div>
            `;
            
            appData.modules.forEach((m, i) => {
                const modScore = scores[i] || { best: 0 };
                const maxScore = getModuleMaxScore(i);
                const isActive = currentView === i;
                html += `
                    <button onclick="switchView(${i})" class="w-full text-left p-3 rounded-xl mb-1 flex items-center group transition-all ${isActive ? 'bg-white shadow-md border-l-4 border-amber-500' : 'hover:bg-stone-100'}">
                        <div class="w-8 h-8 rounded-full flex items-center justify-center text-[10px] font-black mr-3 ${isActive ? 'bg-amber-500 text-white' : 'bg-stone-100 text-stone-400 group-hover:bg-amber-200'}">
                            ${m.id}
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="text-xs font-bold truncate ${isActive ? 'text-amber-900' : 'text-stone-700'}">${m.title}</div>
                            <div class="text-[9px] text-stone-400">æœ€ä½³: ${modScore.best}/${maxScore}</div>
                        </div>
                    </button>
                `;
            });
            navContainer.innerHTML = html;
        }

        function renderOverview() {
            if (!mainContent) return;
            
            // Normalize scores to percentages for charts
            const percentages = appData.modules.map((m, i) => {
                const s = scores[i] || { best: 0 };
                const max = getModuleMaxScore(i);
                return (s.best / max) * 100;
            });

            const firstScores = appData.modules.map((m, i) => scores[i]?.first || 0);
            const bestScores = appData.modules.map((m, i) => scores[i]?.best || 0);
            
            // Calc total completion
            let totalMax = appData.modules.reduce((acc, m, i) => acc + getModuleMaxScore(i), 0);
            let totalCurrent = bestScores.reduce((acc, v) => acc + v, 0);
            let overallProgress = Math.round((totalCurrent / totalMax) * 100);

            mainContent.innerHTML = `
                <div class="max-w-5xl mx-auto fade-in">
                    <header class="mb-10 flex flex-col md:flex-row md:items-end md:justify-between gap-6">
                        <div>
                            <h2 class="text-4xl font-black text-stone-900 tracking-tighter">å­¸ç¿’å„€è¡¨æ¿</h2>
                            <p class="text-stone-500 mt-2 font-medium">Data-driven learning progress tracking.</p>
                        </div>
                        <div class="bg-green-600 px-6 py-4 rounded-3xl flex items-center shadow-xl shadow-green-200">
                            <div class="mr-6">
                                <div class="text-[10px] font-black text-green-200 uppercase tracking-widest">ç¸½é«”ç†Ÿç·´åº¦</div>
                                <div class="text-3xl font-black text-white">${overallProgress}%</div>
                            </div>
                            <div class="text-3xl">ğŸ¯</div>
                        </div>
                    </header>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-10">
                        <div class="bg-white p-8 rounded-[40px] shadow-sm border border-stone-200">
                            <h3 class="font-bold text-stone-800 mb-6 flex items-center"><span class="mr-2">ğŸ“ˆ</span> å¯¦åŠ›æ¼”é€² (é¦–æ¬¡æŒ‘æˆ° vs æœ€ä½³ç´€éŒ„)</h3>
                            <div class="chart-container"><canvas id="progressChart"></canvas></div>
                        </div>
                        <div class="bg-white p-8 rounded-[40px] shadow-sm border border-stone-200">
                            <h3 class="font-bold text-stone-800 mb-6 flex items-center"><span class="mr-2">ğŸ“Š</span> æ¦‚å¿µç†Ÿç·´åˆ†å¸ƒ</h3>
                            <div class="chart-container"><canvas id="radarChart"></canvas></div>
                        </div>
                    </div>

                    <div class="bg-amber-500 text-white p-10 rounded-[40px] shadow-2xl shadow-amber-100 flex flex-col md:flex-row items-center gap-8">
                        <div class="flex-1">
                            <h3 class="text-3xl font-black mb-3 italic">READY TO GO?</h3>
                            <p class="text-amber-50 font-medium">å¾æœ€ç°¡å–®çš„åŠ æ³•é–‹å§‹ï¼Œä¸€æ­¥æ­¥æ”€ç™»è‡³é›™é‡æ‹¬è™Ÿçš„å·”å³°ã€‚æ¯ä¸€é¡Œéƒ½æ˜¯é€šå¾€å¤§å¸«ä¹‹è·¯çš„åŸºçŸ³ã€‚</p>
                        </div>
                        <button onclick="switchView(0)" class="bg-white text-amber-600 font-black px-10 py-5 rounded-2xl shadow-lg hover:scale-105 active:scale-95 transition-all text-xl">
                            é€²å…¥ç¬¬ä¸€å–®å…ƒ
                        </button>
                    </div>
                </div>
            `;

            initCharts(firstScores, bestScores, percentages);
        }

        function renderModule(index) {
            if (!mainContent) return;
            const mod = appData.modules[index];
            demoStep = 0;
            answeredInCurrentSession.clear();
            currentModuleCorrectCount = 0;
            currentProblemIdx = 0;
            currentStepIdx = 0;
            currentStepFailed = false;
            
            // Reset Selections
            simpleSelections = {};
            stepSelection = null;

            // Prepare Data
            if (mod.type === 'step-by-step') {
                currentModuleData = shuffleArray(mod.practice).map(p => {
                    const newSteps = p.steps.map(s => ({
                        ...s,
                        options: shuffleArray([...s.options])
                    }));
                    return { ...p, steps: newSteps };
                });
            } else {
                currentModuleData = shuffleArray(mod.practice.map(q => {
                    return { ...q, options: shuffleArray([...q.options]) };
                }));
            }

            const maxScore = getModuleMaxScore(index);

            mainContent.innerHTML = `
                <div class="max-w-4xl mx-auto fade-in pb-20">
                    <div class="flex items-center space-x-3 mb-4 text-amber-600 font-black text-xs tracking-[0.2em] uppercase">
                        <span>STAGE 0${mod.id}</span>
                        <span class="w-1.5 h-1.5 bg-amber-200 rounded-full"></span>
                        <span>${mod.subtitle}</span>
                    </div>
                    <h2 class="text-5xl font-black text-stone-900 mb-6 tracking-tighter">${mod.title}</h2>
                    <p class="text-xl text-stone-600 bg-white p-6 rounded-3xl border-l-[12px] border-amber-400 mb-12 shadow-sm leading-relaxed font-medium">${mod.desc}</p>

                    <div class="flex flex-col gap-12">
                        
                        <div class="w-full max-w-3xl mx-auto flex flex-col">
                            <div class="bg-stone-900 rounded-[40px] overflow-hidden shadow-2xl flex-1 flex flex-col">
                                <div class="p-5 bg-stone-800/50 flex justify-between items-center border-b border-stone-800">
                                    <span class="text-[10px] font-black text-stone-500 tracking-widest uppercase">Tutorial Classroom</span>
                                    <button onclick="resetDemo(${index})" class="text-[10px] text-stone-400 hover:text-white px-3 py-1 border border-stone-700 rounded-full transition-all">RESTART</button>
                                </div>
                                <div class="flex-1 p-8 flex flex-col items-center justify-center text-white min-h-[350px]">
                                    <div class="text-3xl font-bold mb-12 pb-6 border-b border-stone-700 w-full text-center">$${mod.demo.q}$</div>
                                    <div id="demo-list" class="space-y-6 w-full text-center"></div>
                                </div>
                                <div class="p-8 bg-black/20">
                                    <button id="next-btn" onclick="nextDemo(${index})" class="w-full py-5 bg-amber-500 hover:bg-amber-400 text-white font-black rounded-3xl shadow-xl transition-all active:scale-95 text-lg">
                                        ä¸‹ä¸€æ­¥æ¼”ç¤º âœ
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="w-full">
                            <div class="bg-white p-10 rounded-[40px] shadow-sm border border-stone-200 h-full relative overflow-hidden">
                                <div class="flex justify-between items-center mb-10 border-b border-stone-100 pb-6">
                                    <h3 class="text-2xl font-black text-stone-800 flex items-center">
                                        <span class="w-3 h-8 bg-green-500 rounded-full mr-4"></span>
                                        ${mod.type === 'step-by-step' ? 'åˆ†æ­¥å¼•å°å¼è§£é¡Œ' : 'å¯¦æˆ°éš¨æ©Ÿé¡Œåº«'}
                                    </h3>
                                    <div id="score-badge" class="px-5 py-2 bg-green-100 text-green-700 rounded-2xl font-black text-xs">Score: 0/${maxScore}</div>
                                </div>
                                
                                <div id="quiz-area">
                                    ${mod.type === 'step-by-step' ? renderStepByStepUI(index) : renderSimpleQuizUI()}
                                </div>

                                <div id="retry-footer" class="mt-10 hidden fade-in">
                                    <button onclick="renderModule(${index})" class="w-full py-5 bg-stone-900 hover:bg-stone-800 text-white font-black rounded-3xl transition-all shadow-xl text-lg">
                                        æ´—ç‰Œä¸¦é‡æ–°æŒ‘æˆ° â†º
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            triggerKatex();
        }

        // --- Render Helpers ---

        function renderSimpleQuizUI() {
            return `<div class="space-y-8" id="quiz-container">
                ${currentModuleData.map((q, qIdx) => `
                <div id="q-block-${qIdx}" class="p-6 rounded-3xl bg-stone-50 border border-stone-100 transition-all">
                    <div class="text-lg font-bold text-stone-700 mb-6 flex items-start">
                        <span class="w-7 h-7 bg-stone-200 text-stone-500 rounded-xl text-[10px] font-black flex items-center justify-center mr-4 flex-shrink-0 mt-1">${qIdx+1}</span>
                        <div class="pt-1">$${q.q}$</div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        ${q.options.map((opt, oIdx) => `
                            <button 
                                id="btn-${qIdx}-${oIdx}"
                                onclick="selectSimpleOption(${qIdx}, ${oIdx})"
                                class="opt-btn-${qIdx} py-4 px-5 rounded-2xl border-2 border-white bg-white shadow-sm text-stone-600 font-bold hover:border-amber-400 transition-all text-sm"
                            >
                                $${opt}$
                            </button>
                        `).join('')}
                    </div>
                    <div class="flex justify-end">
                        <button 
                            id="check-btn-${qIdx}"
                            onclick="confirmSimpleAnswer(${qIdx})"
                            class="py-2 px-6 bg-stone-800 hover:bg-stone-700 text-white text-xs font-bold rounded-xl shadow-md transition-all active:scale-95"
                        >
                            ç¢ºèªé€å‡º
                        </button>
                    </div>
                </div>`).join('')}
            </div>`;
        }

        function renderStepByStepUI(modIdx) {
            // Check if finished
            if (currentProblemIdx >= currentModuleData.length) {
                return `<div class="text-center py-10 fade-in">
                    <div class="text-6xl mb-4">ğŸ‰</div>
                    <h3 class="text-2xl font-black text-stone-800 mb-2">æœ¬å–®å…ƒç·´ç¿’å®Œæˆï¼</h3>
                    <p class="text-stone-500">åšå¾—å¥½ï¼æ‚¨å·²ç¶“å®Œæˆäº†æ‰€æœ‰è©³ç´°æ­¥é©Ÿè§£é¡Œã€‚</p>
                </div>`;
            }

            const pData = currentModuleData[currentProblemIdx];
            const sData = pData.steps[currentStepIdx];
            const totalSteps = pData.steps.length;

            // Render History (Previous Steps)
            let historyHTML = '';
            // Show Initial Problem
            historyHTML += `
                <div class="text-stone-400 text-[10px] font-bold uppercase tracking-widest mb-1">Original Equation</div>
                <div class="bg-stone-100 rounded-xl p-4 text-center text-xl font-bold text-stone-500 mb-2 opacity-70">
                    $${pData.q}$
                </div>
                <div class="step-connector mb-2"></div>
            `;
            
            for(let i=0; i<currentStepIdx; i++) {
                const pastStep = pData.steps[i];
                historyHTML += `
                    <div class="text-green-600 text-[10px] font-bold uppercase tracking-widest mb-1 flex items-center justify-center">
                        <span class="mr-1">âœ“</span> ${pastStep.instruction}
                    </div>
                    <div class="bg-green-50 border border-green-100 rounded-xl p-4 text-center text-xl font-bold text-green-700 mb-2">
                        $${pastStep.correctStr}$
                    </div>
                    <div class="step-connector mb-2"></div>
                `;
            }

            return `
            <div class="fade-in" id="step-container">
                <div class="mb-6 flex justify-between items-center text-xs font-bold text-stone-400 uppercase tracking-widest">
                    <span>Problem ${currentProblemIdx + 1} of ${currentModuleData.length}</span>
                    <span>Step ${currentStepIdx + 1}/${totalSteps}</span>
                </div>
                
                <div class="mb-6">
                    ${historyHTML}
                </div>

                <div class="bg-amber-50 border-2 border-amber-400 rounded-3xl p-8 mb-8 text-center relative overflow-hidden shadow-lg transform transition-all">
                    <div class="text-amber-600 text-xs font-black mb-2 uppercase tracking-widest">CURRENT STEP: ${sData.instruction}</div>
                    <div class="text-3xl font-black text-stone-800 mb-6">$${sData.q}$</div>
                    
                    <div class="grid grid-cols-1 gap-4 mb-6">
                        ${sData.options.map((opt, oIdx) => `
                            <button 
                                id="step-btn-${oIdx}"
                                onclick="selectStepOption(${oIdx})"
                                class="step-opt-btn py-5 px-6 rounded-2xl border-2 border-stone-100 bg-white shadow-sm text-stone-600 font-bold hover:border-amber-400 hover:bg-amber-50 transition-all text-base text-left flex items-center"
                            >
                                <span class="w-6 h-6 rounded-full border border-stone-200 mr-4 flex items-center justify-center text-[10px] text-stone-400 font-black">${String.fromCharCode(65+oIdx)}</span>
                                $${opt}$
                            </button>
                        `).join('')}
                    </div>
                    <div class="flex justify-center">
                        <button 
                            onclick="confirmStepAnswer(${modIdx})"
                            class="w-full max-w-xs py-3 bg-stone-800 hover:bg-stone-700 text-white font-bold rounded-2xl shadow-lg transition-all active:scale-95 text-sm"
                        >
                            ç¢ºèªæ­¥é©Ÿ
                        </button>
                    </div>
                </div>
            </div>`;
        }

        // --- Interaction Handlers ---

        function switchView(view) {
            currentView = view;
            renderNav();
            if (view === 'overview') renderOverview();
            else renderModule(view);
            if (mainContent) mainContent.scrollTop = 0;
            if (window.innerWidth < 768) toggleMobileMenu(false);
        }

        function nextDemo(idx) {
            const steps = appData.modules[idx].demo.steps;
            const list = document.getElementById('demo-list');
            const btn = document.getElementById('next-btn');
            if (demoStep < steps.length) {
                const el = document.createElement('div');
                el.className = 'text-2xl font-bold text-amber-400 fade-in';
                el.innerHTML = `$${steps[demoStep]}$`;
                list.appendChild(el);
                demoStep++;
                triggerKatex();
                if (demoStep === steps.length) {
                    btn.textContent = "å·²å®Œæˆæ¼”ç¤º â†º";
                    btn.classList.replace('bg-amber-500', 'bg-stone-700');
                    btn.onclick = () => resetDemo(idx);
                }
            }
        }

        function resetDemo(idx) {
            demoStep = 0;
            const list = document.getElementById('demo-list');
            if (list) list.innerHTML = '';
            const btn = document.getElementById('next-btn');
            if (btn) {
                btn.textContent = "ä¸‹ä¸€æ­¥æ¼”ç¤º âœ";
                btn.classList.replace('bg-stone-700', 'bg-amber-500');
                btn.onclick = () => nextDemo(idx);
            }
        }

        // --- Handler for Modules 1-5 (Simple: Select -> Confirm) ---
        
        function selectSimpleOption(qIdx, oIdx) {
            if (answeredInCurrentSession.has(qIdx)) return; // Already answered

            // Update State
            simpleSelections[qIdx] = oIdx;

            // Update UI Visually
            const allBtns = document.querySelectorAll(`.opt-btn-${qIdx}`);
            allBtns.forEach((btn, idx) => {
                if (idx === oIdx) {
                    btn.classList.add('btn-selected');
                } else {
                    btn.classList.remove('btn-selected');
                }
            });
        }

        function confirmSimpleAnswer(qIdx) {
            if (answeredInCurrentSession.has(qIdx)) return;
            
            const selectedOIdx = simpleSelections[qIdx];
            if (selectedOIdx === undefined) return; // Nothing selected

            // Logic from old checkSimpleAnswer
            const qData = currentModuleData[qIdx];
            const correctStr = qData.correctStr;
            const chosenStr = qData.options[selectedOIdx];
            const targetBtn = document.getElementById(`btn-${qIdx}-${selectedOIdx}`);

            answeredInCurrentSession.add(qIdx);
            
            // Remove selection highlight
            targetBtn.classList.remove('btn-selected');

            if (chosenStr === correctStr) {
                targetBtn.classList.add('btn-correct');
                currentModuleCorrectCount++;
            } else {
                targetBtn.classList.add('btn-wrong');
                const correctOptionIdx = qData.options.findIndex(opt => opt === correctStr);
                const correctBtn = document.getElementById(`btn-${qIdx}-${correctOptionIdx}`);
                correctBtn.classList.add('btn-correct');
            }

            // Hide the Check Button
            const checkBtn = document.getElementById(`check-btn-${qIdx}`);
            if(checkBtn) checkBtn.style.display = 'none';

            // Disable all buttons for this question
            const allBtns = document.querySelectorAll(`.opt-btn-${qIdx}`);
            allBtns.forEach(b => b.onclick = null);

            document.getElementById('score-badge').textContent = `Score: ${currentModuleCorrectCount}/4`;

            if (answeredInCurrentSession.size === 4) {
                saveScore(currentView, currentModuleCorrectCount);
                document.getElementById('retry-footer').classList.remove('hidden');
            }
        }

        // --- Handler for Modules 6-8 (Step by Step: Select -> Confirm) ---

        function selectStepOption(oIdx) {
            // Update State
            stepSelection = oIdx;

            // Update UI Visually
            const btns = document.querySelectorAll('.step-opt-btn');
            btns.forEach((btn, idx) => {
                if (idx === oIdx) {
                    btn.classList.add('btn-selected');
                } else {
                    btn.classList.remove('btn-selected');
                }
            });
        }

        function confirmStepAnswer(modIdx) {
            if (stepSelection === null) return; // Nothing selected

            const oIdx = stepSelection;
            const pData = currentModuleData[currentProblemIdx];
            const sData = pData.steps[currentStepIdx];
            const correctStr = sData.correctStr;
            const chosenStr = sData.options[oIdx];
            
            const targetBtn = document.getElementById(`step-btn-${oIdx}`);
            targetBtn.classList.remove('btn-selected');

            if (chosenStr === correctStr) {
                // Correct Choice
                targetBtn.classList.add('btn-correct');
                
                // Disable further clicks
                const btns = document.querySelectorAll('.step-opt-btn');
                btns.forEach(b => b.onclick = null);

                // Only award point if NO error was made on this specific step
                if (!currentStepFailed) {
                    currentModuleCorrectCount++;
                }

                // Reset fail flag and selection for next step
                currentStepFailed = false;
                stepSelection = null;

                // Move to next step
                setTimeout(() => {
                    currentStepIdx++;
                    if (currentStepIdx >= pData.steps.length) {
                        currentProblemIdx++;
                        currentStepIdx = 0;
                    }
                    updateStepUI(modIdx);
                }, 1000);

            } else {
                // Wrong Choice
                targetBtn.classList.add('btn-wrong');
                // Mark this step as failed (point lost forever for this step)
                currentStepFailed = true;
                // Allow user to select again (don't clear selection state fully, just visual?)
                // Actually, let's reset visual selection so they pick again
                stepSelection = null; 
            }
        }

        function updateStepUI(modIdx) {
            const quizArea = document.getElementById('quiz-area');
            const maxScore = getModuleMaxScore(modIdx);
            
            if (currentProblemIdx >= currentModuleData.length) {
                saveScore(currentView, currentModuleCorrectCount);
                document.getElementById('retry-footer').classList.remove('hidden');
            }
            
            document.getElementById('score-badge').textContent = `Score: ${currentModuleCorrectCount}/${maxScore}`;
            quizArea.innerHTML = renderStepByStepUI(modIdx);
            triggerKatex();
        }

        function toggleMobileMenu(force) {
            if (!sidebar || !sidebarOverlay) return;
            const isClosing = force === false || !sidebar.classList.contains('-translate-x-full');
            if (isClosing) {
                sidebar.classList.add('-translate-x-full');
                sidebarOverlay.classList.add('hidden');
            } else {
                sidebar.classList.remove('-translate-x-full');
                sidebarOverlay.classList.remove('hidden');
            }
        }

        // --- Charts ---
        function initCharts(firstScores, bestScores, percentages) {
            const pCtx = document.getElementById('progressChart').getContext('2d');
            new Chart(pCtx, {
                type: 'bar',
                data: {
                    labels: appData.modules.map(m => `P${m.id}`),
                    datasets: [
                        { label: 'é¦–æ¬¡æŒ‘æˆ°', data: firstScores, backgroundColor: '#e7e5e4', borderRadius: 8 },
                        { label: 'æœ€ä½³è¡¨ç¾', data: bestScores, backgroundColor: '#10b981', borderRadius: 8 }
                    ]
                },
                options: {
                    maintainAspectRatio: false,
                    scales: { y: { min: 0, max: 8, ticks: { stepSize: 2 } }, x: { grid: { display: false } } },
                    plugins: { legend: { position: 'bottom', labels: { font: { family: 'Lexend', size: 10, weight: 'bold' } } } }
                }
            });

            const rCtx = document.getElementById('radarChart').getContext('2d');
            new Chart(rCtx, {
                type: 'radar',
                data: {
                    labels: appData.modules.map(m => m.title),
                    datasets: [{
                        label: 'èƒ½åŠ›åˆ†å¸ƒ (%)',
                        data: percentages,
                        backgroundColor: 'rgba(245, 158, 11, 0.2)',
                        borderColor: '#f59e0b',
                        pointBackgroundColor: '#f59e0b',
                        borderWidth: 3
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    scales: { r: { min: 0, max: 100, ticks: { display: false }, grid: { color: '#f5f5f4' } } },
                    plugins: { legend: { display: false } }
                }
            });
        }

        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            initDOMElements();
            renderNav();
            renderOverview();
            if (mobileMenuBtn) mobileMenuBtn.onclick = () => toggleMobileMenu();
            if (sidebarOverlay) sidebarOverlay.onclick = () => toggleMobileMenu(false);
            setTimeout(triggerKatex, 500);
        });
    </script>
</body>
</html>

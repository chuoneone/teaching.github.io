<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº’å‹•å¼å¹¾ä½•è§£é¡Œï¼šå…§å¿ƒèˆ‡é¢ç©</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f8fafc;
            /* é¿å… iOS Safari é»æ“Šé–ƒçˆ */
            -webkit-tap-highlight-color: transparent;
        }

        /* æ•¸å­¸å¼æ¨£å¼ */
        .math {
            font-family: 'Times New Roman', serif;
            font-style: italic;
            font-weight: 600;
            padding: 0 2px;
        }
        
        /* ç·šæ®µç¬¦è™Ÿ */
        .segment {
            text-decoration: overline;
        }

        /* å¡«ç­”æ ¼ Slot */
        .slot {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            min-width: 60px;
            height: 48px;
            padding: 0 10px;
            border: 2px dashed #94a3b8; /* slate-400 */
            border-radius: 8px;
            background-color: white;
            color: #334155;
            font-weight: bold;
            font-size: 1.25rem;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            margin: 0 4px;
            vertical-align: middle;
            user-select: none;
        }
        
        .slot.filled {
            border-style: solid;
            border-color: #3b82f6; /* blue-500 */
            background-color: #eff6ff; /* blue-50 */
            color: #1d4ed8; /* blue-700 */
            transform: scale(1.05);
        }
        
        .slot.correct {
            border-color: #22c55e; /* green-500 */
            background-color: #f0fdf4; /* green-50 */
            color: #15803d; /* green-700 */
            border-style: solid;
        }

        .slot.error {
            border-color: #ef4444;
            animation: shake 0.5s;
        }

        /* é¸é …æŒ‰éˆ• */
        .option-btn {
            background-color: white;
            border: 2px solid #cbd5e1; /* slate-300 */
            border-bottom-width: 4px;
            padding: 10px 20px;
            border-radius: 12px;
            font-size: 1.25rem;
            font-weight: bold;
            color: #475569;
            cursor: pointer;
            transition: all 0.1s;
            position: relative;
            top: 0;
        }

        .option-btn:active {
            border-bottom-width: 2px;
            top: 2px;
            background-color: #f1f5f9;
        }

        .option-btn:disabled {
            background-color: #e2e8f0;
            color: #cbd5e1;
            border-color: #e2e8f0;
            border-bottom-width: 2px;
            top: 2px;
            cursor: not-allowed;
            pointer-events: none;
        }

        /* å‹•ç•« */
        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        .animate-pop { animation: pop 0.3s ease-out; }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in-up { animation: fadeInUp 0.5s ease-out forwards; }

        /* å®Œæˆå‹¾å‹¾ SVG å‹•ç•« */
        .check-path {
            stroke-dasharray: 100;
            stroke-dashoffset: 100;
            animation: drawCheck 0.6s ease-out forwards;
        }
        @keyframes drawCheck {
            to { stroke-dashoffset: 0; }
        }

        /* éš±è— Scrollbar ä½†ä¿æŒåŠŸèƒ½ */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-slate-800">

    <!-- é ‚éƒ¨å°è¦½åˆ— -->
    <nav class="flex-none bg-indigo-600 text-white shadow-lg z-20">
        <div class="max-w-7xl mx-auto px-2">
            <div class="flex items-center h-14 gap-4 overflow-x-auto no-scrollbar">
                <div class="flex-none font-bold text-lg px-2 flex items-center gap-2">
                    <span>ğŸ“</span>
                    <span class="hidden sm:inline">å…§å¿ƒèˆ‡é¢ç©</span>
                </div>
                <!-- é¡Œç›®æŒ‰éˆ•å°‡ç”± JS ç”Ÿæˆ -->
                <div id="nav-buttons" class="flex gap-2 p-1"></div>
            </div>
        </div>
    </nav>

    <!-- ä¸»å…§å®¹å€ï¼šå·¦é¡Œå³è§£ -->
    <main class="flex-1 flex flex-col md:flex-row overflow-hidden relative">
        
        <!-- å·¦å´ï¼šé¡Œç›®å€ (å›ºå®š) -->
        <section class="w-full md:w-5/12 bg-white border-b md:border-b-0 md:border-r border-slate-200 z-10 flex flex-col h-[40vh] md:h-full shadow-sm">
            <div class="p-5 overflow-y-auto flex-1">
                <!-- é¡Œç›®æ¨™ç±¤ -->
                <div class="mb-3">
                    <span id="problem-tag" class="inline-block bg-indigo-100 text-indigo-700 text-xs font-bold px-2 py-1 rounded-full uppercase tracking-wide">
                        å¹¾ä½•æ¦‚å¿µ
                    </span>
                </div>

                <!-- é¡Œç›®æ•˜è¿° -->
                <div id="problem-desc" class="text-lg leading-relaxed space-y-4 mb-6">
                    <!-- JS å¡«å…¥ -->
                </div>

                <!-- SVG åœ–å½¢å€ -->
                <div class="flex justify-center items-center bg-slate-50 rounded-xl border border-slate-100 p-4 min-h-[200px]">
                    <svg id="problem-svg" width="100%" height="100%" viewBox="0 0 320 220" preserveAspectRatio="xMidYMid meet">
                        <!-- JS ç¹ªè£½ -->
                    </svg>
                </div>
            </div>
        </section>

        <!-- å³å´ï¼šäº’å‹•æ­¥é©Ÿå€ (å¯æ²å‹•) -->
        <section class="w-full md:w-7/12 bg-slate-50 relative h-[60vh] md:h-full overflow-y-auto scroll-smooth" id="steps-scroll-area">
            <div class="max-w-3xl mx-auto p-4 md:p-8 space-y-6 pb-32" id="steps-container">
                <!-- æ­¥é©Ÿå¡ç‰‡ JS ç”Ÿæˆ -->
            </div>
        </section>

    </main>

    <!-- å®Œæˆå½ˆçª— -->
    <div id="completion-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4 opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-2xl shadow-2xl p-6 md:p-8 w-full max-w-sm text-center transform scale-90 transition-transform duration-300" id="modal-box">
            <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-5">
                <svg class="w-10 h-10 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                </svg>
            </div>
            <h2 class="text-2xl font-bold text-slate-800 mb-2">å¤ªæ£’äº†ï¼</h2>
            <p class="text-slate-600 mb-8">ä½ å·²ç¶“å®Œæˆæœ¬é¡Œæ‰€æœ‰æ­¥é©Ÿã€‚</p>
            <div class="space-y-3">
                <button onclick="app.resetProblem()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-xl transition shadow-md active:scale-95">
                    å†åšä¸€æ¬¡
                </button>
                <button onclick="app.closeModal()" class="w-full bg-white border-2 border-slate-200 text-slate-600 hover:bg-slate-50 font-bold py-3 px-6 rounded-xl transition active:scale-95">
                    ä¿ç•™ç´€éŒ„ä¸¦é—œé–‰
                </button>
            </div>
        </div>
    </div>

    <!-- éŸ³æ•ˆ (ä½¿ç”¨ Base64 Data URI æˆ–ç°¡å–®é »ç‡) -->
    <!-- é€™è£¡ä½¿ç”¨ JS Web Audio API ç”¢ç”Ÿç°¡å–®éŸ³æ•ˆï¼Œé¿å…å¤–éƒ¨è³‡æºä¾è³´ -->

    <script>
        // --- é¡Œç›®è³‡æ–™åº« ---
        const problems = [
            {
                id: 1,
                type: "å¹¾ä½•ï¼šå…§å¿ƒèˆ‡é¢ç©",
                title: "é¡Œç›® 1",
                desc: `è‹¥ <span class="math">I</span> é»ç‚º <span class="math">â–³ABC</span> çš„å…§å¿ƒï¼Œ<br>
                       <span class="math">â–³AIB</span> çš„é¢ç©ç‚º <mark class="bg-yellow-200 px-1 rounded">12</mark>ï¼Œ<br>
                       <span class="math">â–³BIC</span> çš„é¢ç©ç‚º <mark class="bg-yellow-200 px-1 rounded">14</mark>ï¼Œ<br>
                       <span class="math">â–³CIA</span> çš„é¢ç©ç‚º <mark class="bg-yellow-200 px-1 rounded">16</mark>ã€‚<br>
                       å‰‡ <span class="math"><span class="segment">AB</span> : <span class="segment">BC</span> : <span class="segment">CA</span> = ?</span>`,
                svgData: { type: 'ratio', labels: ['12', '14', '16'] },
                steps: [
                    {
                        title: "è§€å¿µç¢ºèª",
                        instruction: "å…§å¿ƒåˆ°ä¸‰é‚Šè·é›¢ç›¸ç­‰ï¼ˆçš†ç‚ºåŠå¾‘ rï¼‰ã€‚ç•¶é«˜ç›¸ç­‰æ™‚ï¼Œé¢ç©æ¯”ç­‰æ–¼ä»€éº¼æ¯”ï¼Ÿ",
                        slots: 1,
                        options: ["åº•é‚Šé•·çš„æ¯”", "é«˜çš„æ¯”", "è§’åº¦çš„æ¯”"],
                        answer: ["åº•é‚Šé•·çš„æ¯”"]
                    },
                    {
                        title: "å¡«å…¥é¢ç©æ•¸å€¼",
                        instruction: "é¢ç©æ¯” = é‚Šé•·æ¯”ã€‚è«‹å…ˆä¾åºå¡«å…¥é¡Œç›®çµ¦çš„é¢ç©ã€‚",
                        template: `<div class="flex items-center flex-wrap gap-2 text-lg">
                            <span class="math"><span class="segment">AB</span> : <span class="segment">BC</span> : <span class="segment">CA</span></span> = 
                            <span class="slot" data-idx="0"></span> : <span class="slot" data-idx="1"></span> : <span class="slot" data-idx="2"></span>
                        </div>`,
                        slots: 3,
                        options: ["12", "14", "16"],
                        answer: ["12", "14", "16"]
                    },
                    {
                        title: "åŒ–ç°¡æ¯”",
                        instruction: "å°‡ 12 : 14 : 16 åŒé™¤ä»¥ 2ï¼Œå¾—åˆ°æœ€ç°¡æ•´æ•¸æ¯”ã€‚",
                        template: `<div class="flex items-center flex-wrap gap-2 text-lg">
                            <span class="math"><span class="segment">AB</span> : <span class="segment">BC</span> : <span class="segment">CA</span></span> = 
                            <span class="slot" data-idx="0"></span> : <span class="slot" data-idx="1"></span> : <span class="slot" data-idx="2"></span>
                        </div>`,
                        slots: 3,
                        options: ["6", "7", "8"],
                        answer: ["6", "7", "8"]
                    }
                ]
            },
            {
                id: 2,
                type: "å¹¾ä½•ï¼šå…§å¿ƒèˆ‡é¢ç© (é€²éš)",
                title: "é¡Œç›® 2",
                desc: `è‹¥ <span class="math">I</span> é»ç‚º <span class="math">â–³ABC</span> çš„å…§å¿ƒï¼Œ<br>
                       <span class="math">â–³AIB</span> çš„é¢ç©ç‚º <mark class="bg-yellow-200 px-1 rounded">39</mark>ï¼Œ<br>
                       <span class="math">â–³BIC</span> çš„é¢ç©ç‚º <mark class="bg-yellow-200 px-1 rounded">24</mark>ï¼Œ<br>
                       <span class="math">â–³CIA</span> çš„é¢ç©ç‚º <mark class="bg-yellow-200 px-1 rounded">30</mark>ã€‚<br>
                       å‰‡ <span class="math"><span class="segment">AB</span> : <span class="segment">BC</span> : <span class="segment">CA</span> = ?</span>`,
                svgData: { type: 'ratio', labels: ['39', '24', '30'] },
                steps: [
                    {
                        title: "åˆ—å‡ºæ¯”ä¾‹å¼",
                        instruction: "å› ç‚ºå…§å¿ƒåˆ°ä¸‰é‚Šç­‰è·ï¼Œæ‰€ä»¥é‚Šé•·æ¯” = é¢ç©æ¯”ã€‚",
                        template: `<div class="flex items-center flex-wrap gap-2 text-lg">
                            <span class="math"><span class="segment">AB</span> : <span class="segment">BC</span> : <span class="segment">CA</span></span> = 
                            <span class="slot" data-idx="0"></span> : <span class="slot" data-idx="1"></span> : <span class="slot" data-idx="2"></span>
                        </div>`,
                        slots: 3,
                        options: ["39", "24", "30"],
                        answer: ["39", "24", "30"]
                    },
                    {
                        title: "åŒ–ç°¡æ¯”",
                        instruction: "å°‡ 39 : 24 : 30 åŒé™¤ä»¥ 3ï¼Œå¾—åˆ°æœ€ç°¡æ•´æ•¸æ¯”ã€‚",
                        template: `<div class="flex items-center flex-wrap gap-2 text-lg">
                            <span class="math"><span class="segment">AB</span> : <span class="segment">BC</span> : <span class="segment">CA</span></span> = 
                            <span class="slot" data-idx="0"></span> : <span class="slot" data-idx="1"></span> : <span class="slot" data-idx="2"></span>
                        </div>`,
                        slots: 3,
                        options: ["13", "8", "10"],
                        answer: ["13", "8", "10"]
                    }
                ]
            },
            {
                id: 3,
                type: "å¹¾ä½•ï¼šå…§åˆ‡åœ“åŠå¾‘æ±‚é¢ç©",
                title: "é¡Œç›® 3",
                desc: `è‹¥ <span class="math">â–³ABC</span> çš„<mark class="bg-yellow-200 px-1 rounded">å‘¨é•·ç‚º 56</mark>ï¼Œ<br>
                       å…§åˆ‡åœ“çš„<mark class="bg-yellow-200 px-1 rounded">åŠå¾‘ r ç‚º 3</mark>ï¼Œ<br>
                       å‰‡ <span class="math">â–³ABC</span> çš„é¢ç©ç‚ºä½•ï¼Ÿ`,
                svgData: { type: 'formula', r: '3' },
                steps: [
                    {
                        title: "å¡«å…¥å…¬å¼",
                        instruction: "ä¸‰è§’å½¢é¢ç© = å…§åˆ‡åœ“åŠå¾‘ Ã— å‘¨é•· Ã· 2",
                        template: `<div class="flex items-center flex-wrap gap-2 text-xl font-bold">
                            é¢ç© = <span class="slot" data-idx="0"></span> Ã— <span class="slot" data-idx="1"></span> Ã· 2
                        </div>`,
                        slots: 2,
                        options: ["3", "56"],
                        answer: ["3", "56"]
                    },
                    {
                        title: "è¨ˆç®—çµæœ",
                        instruction: "3 Ã— 56 = 168ï¼Œå†é™¤ä»¥ 2ã€‚",
                        template: `<div class="flex items-center flex-wrap gap-2 text-xl font-bold">
                            é¢ç© = <span class="slot" data-idx="0"></span>
                        </div>`,
                        slots: 1,
                        options: ["84", "168", "28"],
                        answer: ["84"]
                    }
                ]
            },
            {
                id: 4,
                type: "å¹¾ä½•ï¼šå…§åˆ‡åœ“åŠå¾‘æ±‚é¢ç© (ç·´ç¿’)",
                title: "é¡Œç›® 4",
                desc: `è‹¥ <span class="math">â–³ABC</span> çš„<mark class="bg-yellow-200 px-1 rounded">å‘¨é•·ç‚º 24</mark>ï¼Œ<br>
                       å…§åˆ‡åœ“çš„<mark class="bg-yellow-200 px-1 rounded">åŠå¾‘ r ç‚º 16</mark>ï¼Œ<br>
                       å‰‡ <span class="math">â–³ABC</span> çš„é¢ç©ç‚ºä½•ï¼Ÿ`,
                svgData: { type: 'formula', r: '16' },
                steps: [
                    {
                        title: "é¸æ“‡ç®—å¼",
                        instruction: "è«‹é¸æ“‡æ­£ç¢ºçš„è¨ˆç®—å¼ã€‚",
                        slots: 1,
                        options: ["16Ã—24Ã·2", "16Ã—24", "24Ã·16"],
                        answer: ["16Ã—24Ã·2"]
                    },
                    {
                        title: "è¨ˆç®—çµæœ",
                        instruction: "16 Ã— 24 = 384ï¼Œå†é™¤ä»¥ 2ã€‚",
                        template: `<div class="flex items-center flex-wrap gap-2 text-xl font-bold">
                            é¢ç© = <span class="slot" data-idx="0"></span>
                        </div>`,
                        slots: 1,
                        options: ["192", "384", "48"],
                        answer: ["192"]
                    }
                ]
            }
        ];

        // --- æ‡‰ç”¨ç¨‹å¼é‚è¼¯ ---
        class App {
            constructor() {
                this.currentIdx = 0;
                this.stepStatus = [];
                this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                
                this.initNav();
                this.renderProblem(0);
            }

            // åˆå§‹åŒ–å°è¦½åˆ—
            initNav() {
                const navContainer = document.getElementById('nav-buttons');
                navContainer.innerHTML = problems.map((p, idx) => `
                    <button 
                        onclick="app.switchProblem(${idx})" 
                        class="nav-btn whitespace-nowrap px-4 py-1.5 rounded-full text-sm font-bold transition-all border-2 border-transparent ${idx === 0 ? 'bg-indigo-800 border-indigo-400' : 'bg-indigo-500 hover:bg-indigo-400'}"
                        id="nav-btn-${idx}"
                    >
                        ${p.title}
                    </button>
                `).join('');
            }

            // åˆ‡æ›é¡Œç›®
            switchProblem(idx) {
                // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
                document.querySelectorAll('.nav-btn').forEach((btn, i) => {
                    if (i === idx) {
                        btn.classList.add('bg-indigo-800', 'border-indigo-400');
                        btn.classList.remove('bg-indigo-500', 'hover:bg-indigo-400');
                    } else {
                        btn.classList.remove('bg-indigo-800', 'border-indigo-400');
                        btn.classList.add('bg-indigo-500', 'hover:bg-indigo-400');
                    }
                });
                this.renderProblem(idx);
            }

            // æ¸²æŸ“é¡Œç›®
            renderProblem(idx) {
                this.currentIdx = idx;
                const problem = problems[idx];
                this.stepStatus = new Array(problem.steps.length).fill(false);

                // æ›´æ–°å·¦å´è³‡è¨Š
                document.getElementById('problem-tag').textContent = problem.type;
                document.getElementById('problem-desc').innerHTML = problem.desc;
                this.renderSVG(problem.svgData);

                // ç”Ÿæˆæ­¥é©Ÿå€
                const container = document.getElementById('steps-container');
                container.innerHTML = ''; // æ¸…ç©º

                problem.steps.forEach((step, stepIdx) => {
                    const stepEl = document.createElement('div');
                    stepEl.id = `step-${stepIdx}`;
                    stepEl.className = `bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden transition-all duration-500 ${stepIdx === 0 ? 'opacity-100 translate-y-0' : 'opacity-50 blur-[2px] pointer-events-none translate-y-4'}`;
                    
                    // æ­¥é©Ÿæ¨™é¡Œ
                    let html = `
                        <div class="bg-slate-50 border-b border-slate-100 px-6 py-4 flex justify-between items-center">
                            <h3 class="font-bold text-slate-700 text-lg flex items-center gap-2">
                                <span class="bg-indigo-600 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs">${stepIdx + 1}</span>
                                ${step.title}
                            </h3>
                            <span id="status-icon-${stepIdx}" class="hidden text-green-500">
                                <svg class="w-6 h-6 check-path" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                            </span>
                        </div>
                        <div class="p-6">
                            <p class="text-slate-600 mb-4 text-lg font-medium">${step.instruction}</p>
                    `;

                    // Slot å€åŸŸ
                    html += `<div class="bg-indigo-50/50 rounded-xl p-4 mb-6 border border-indigo-100/50 flex justify-center min-h-[80px] items-center" id="slot-area-${stepIdx}">`;
                    if (step.template) {
                        html += step.template;
                    } else {
                        // é è¨­ Slot æ’åˆ—
                        html += `<div class="flex flex-wrap gap-2 justify-center">`;
                        for(let i=0; i<step.slots; i++) {
                            html += `<span class="slot" data-idx="${i}"></span>`;
                        }
                        html += `</div>`;
                    }
                    html += `</div>`;

                    // é¸é …å€åŸŸ
                    html += `<div class="flex flex-wrap gap-3 justify-center mb-4" id="options-area-${stepIdx}">`;
                    step.options.forEach(opt => {
                        html += `<button class="option-btn" onclick="app.handleOptionClick(${stepIdx}, '${opt}', this)">${opt}</button>`;
                    });
                    html += `</div>`;

                    // æª¢æŸ¥æŒ‰éˆ•èˆ‡è¨Šæ¯
                    html += `
                        <div class="flex flex-col items-center gap-2">
                            <div id="msg-${stepIdx}" class="h-6 text-sm font-bold transition-all opacity-0 text-red-500">æç¤ºå€</div>
                            <button 
                                id="check-btn-${stepIdx}"
                                onclick="app.checkAnswer(${stepIdx})"
                                class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-xl shadow-md transition transform active:scale-[0.98] flex items-center justify-center gap-2"
                            >
                                <span>æª¢æŸ¥ç­”æ¡ˆ</span>
                            </button>
                        </div>
                    </div>`;

                    stepEl.innerHTML = html;
                    container.appendChild(stepEl);

                    // ç¶å®š Slot æ¸…é™¤äº‹ä»¶
                    const slots = stepEl.querySelectorAll('.slot');
                    slots.forEach(slot => {
                        slot.addEventListener('click', () => this.clearSlot(stepIdx, slot));
                    });
                });

                // æ²å‹•å›é ‚éƒ¨
                document.getElementById('steps-scroll-area').scrollTop = 0;
            }

            // ç¹ªè£½ SVG
            renderSVG(data) {
                const svg = document.getElementById('problem-svg');
                let content = '';
                
                // åŸºç¤ä¸‰è§’å½¢èˆ‡åº§æ¨™ (ä½¿ç”¨ç²¾ç¢ºè¨ˆç®—çš„åº§æ¨™ä»¥ç¬¦åˆå…§åˆ‡åœ“)
                // ç‚ºäº†è®“ r=60 å®Œç¾åˆ‡åˆ°é‚Šï¼Œæˆ‘å€‘è¨­å®šä¸€å€‹ç‰¹å®šçš„ä¸‰è§’å½¢
                // A=(160, 30), B=(40, 190), C=(280, 190)
                // é€™æ˜¯ä¸€å€‹åº•ç‚º 240, é«˜ç‚º 160 çš„ç­‰è…°ä¸‰è§’å½¢
                // å…§å¿ƒ I = (160, 130), å…§åˆ‡åœ“åŠå¾‘ r = 60
                const A = {x: 160, y: 30};
                const B = {x: 40, y: 190};
                const C = {x: 280, y: 190};
                const I = {x: 160, y: 130}; 

                // ä¸‰è§’å½¢é‚Šæ¡†
                content += `<polygon points="${A.x},${A.y} ${B.x},${B.y} ${C.x},${C.y}" fill="none" stroke="#1e293b" stroke-width="2.5" stroke-linejoin="round"/>`;
                
                // é ‚é»æ¨™ç±¤
                content += `<text x="${A.x}" y="${A.y-10}" text-anchor="middle" font-weight="bold" fill="#1e293b">A</text>`;
                content += `<text x="${B.x-10}" y="${B.y}" text-anchor="middle" font-weight="bold" fill="#1e293b">B</text>`;
                content += `<text x="${C.x+10}" y="${C.y}" text-anchor="middle" font-weight="bold" fill="#1e293b">C</text>`;

                if (data.type === 'ratio') {
                    // ç•«å…§å¿ƒé€£ç·š
                    content += `<line x1="${A.x}" y1="${A.y}" x2="${I.x}" y2="${I.y}" stroke="#94a3b8" stroke-dasharray="5,3" stroke-width="2"/>`;
                    content += `<line x1="${B.x}" y1="${B.y}" x2="${I.x}" y2="${I.y}" stroke="#94a3b8" stroke-dasharray="5,3" stroke-width="2"/>`;
                    content += `<line x1="${C.x}" y1="${C.y}" x2="${I.x}" y2="${I.y}" stroke="#94a3b8" stroke-dasharray="5,3" stroke-width="2"/>`;
                    
                    // å…§å¿ƒé»
                    content += `<circle cx="${I.x}" cy="${I.y}" r="4" fill="#ef4444"/>`;
                    content += `<text x="${I.x}" y="${I.y+20}" text-anchor="middle" font-weight="bold" fill="#ef4444">I</text>`;

                    // é¢ç©æ•¸å€¼
                    if (data.labels) {
                        content += `<text x="100" y="120" fill="#64748b" font-size="14">${data.labels[0]}</text>`; // å·¦
                        content += `<text x="160" y="170" fill="#64748b" font-size="14" text-anchor="middle">${data.labels[1]}</text>`; // ä¸‹
                        content += `<text x="220" y="120" fill="#64748b" font-size="14">${data.labels[2]}</text>`; // å³
                    }
                } else if (data.type === 'formula') {
                    // ç•«å…§åˆ‡åœ“ (r=60 ç²¾ç¢ºåˆ‡é‚Š)
                    const r = 60; 
                    content += `<circle cx="${I.x}" cy="${I.y}" r="${r}" fill="#fecaca" fill-opacity="0.3" stroke="#ef4444" stroke-width="2"/>`;
                    
                    // åŠå¾‘æŒ‡ç¤ºç·š (å‚ç›´å‘ä¸‹)
                    content += `<line x1="${I.x}" y1="${I.y}" x2="${I.x}" y2="${I.y+r}" stroke="#ef4444" stroke-width="2"/>`;
                    // å‚ç›´ç¬¦è™Ÿ
                    content += `<polyline points="${I.x-5},${I.y+r} ${I.x-5},${I.y+r-5} ${I.x},${I.y+r-5}" fill="none" stroke="#ef4444" stroke-width="1.5"/>`;
                    
                    content += `<text x="${I.x+5}" y="${I.y+r/2}" fill="#ef4444" font-weight="bold" font-size="14">r=${data.r}</text>`;
                    
                    // å…§å¿ƒé»
                    content += `<circle cx="${I.x}" cy="${I.y}" r="3" fill="#ef4444"/>`;
                }

                svg.innerHTML = content;
            }

            // è™•ç†é¸é …é»æ“Š
            handleOptionClick(stepIdx, value, btn) {
                // æ’­æ”¾è¼•å¾®é»æ“Šè²
                this.playTone(400, 0.05);

                const slotArea = document.getElementById(`slot-area-${stepIdx}`);
                const emptySlots = Array.from(slotArea.querySelectorAll('.slot:not(.filled)'));

                if (emptySlots.length > 0) {
                    const targetSlot = emptySlots[0];
                    targetSlot.textContent = value;
                    targetSlot.dataset.value = value;
                    targetSlot.classList.add('filled', 'animate-pop');
                    
                    // ç§»é™¤å‹•ç•« class 
                    setTimeout(() => targetSlot.classList.remove('animate-pop'), 300);

                    // ç¦ç”¨æŒ‰éˆ•
                    btn.disabled = true;
                    btn.dataset.val = value; // æ¨™è¨˜ä»¥ä¾¿æ¢å¾©

                    // éš±è—éŒ¯èª¤è¨Šæ¯
                    const msg = document.getElementById(`msg-${stepIdx}`);
                    msg.style.opacity = '0';
                }
            }

            // æ¸…é™¤ Slot
            clearSlot(stepIdx, slot) {
                if (!slot.classList.contains('filled')) return;
                if (this.stepStatus[stepIdx]) return; // å·²é–å®š

                this.playTone(300, 0.05);

                const value = slot.textContent;
                
                // æ¢å¾©æŒ‰éˆ•
                const optionsArea = document.getElementById(`options-area-${stepIdx}`);
                const btn = Array.from(optionsArea.querySelectorAll('button')).find(b => b.textContent === value && b.disabled);
                if (btn) btn.disabled = false;

                // é‡ç½® Slot
                slot.textContent = '';
                slot.classList.remove('filled', 'error');
                delete slot.dataset.value;
            }

            // æª¢æŸ¥ç­”æ¡ˆ
            checkAnswer(stepIdx) {
                const problem = problems[this.currentIdx];
                const step = problem.steps[stepIdx];
                const slotArea = document.getElementById(`slot-area-${stepIdx}`);
                const slots = Array.from(slotArea.querySelectorAll('.slot'));
                const msg = document.getElementById(`msg-${stepIdx}`);

                // æª¢æŸ¥æ˜¯å¦å¡«æ»¿
                if (slots.some(s => !s.classList.contains('filled'))) {
                    this.showMsg(stepIdx, "è«‹å¡«æ»¿æ‰€æœ‰ç©ºæ ¼", "text-slate-500");
                    this.playTone(200, 0.2, 'square');
                    return;
                }

                const userVals = slots.map(s => s.dataset.value);
                let isCorrect = false;

                // å½ˆæ€§æ¯”å°é‚è¼¯ (é‡å°ä¹˜æ³•äº¤æ›å¾‹)
                // å¦‚æœæ˜¯é¡Œç›®3çš„æ­¥é©Ÿ1ï¼Œå…è¨± [3, 56] æˆ– [56, 3]
                if (problem.id === 3 && stepIdx === 0) {
                    const sortedUser = [...userVals].sort();
                    const sortedAns = [...step.answer].sort();
                    isCorrect = JSON.stringify(sortedUser) === JSON.stringify(sortedAns);
                } else {
                    // é è¨­åš´æ ¼é †åº
                    isCorrect = JSON.stringify(userVals) === JSON.stringify(step.answer);
                }

                if (isCorrect) {
                    // ç­”å°
                    this.playSuccessSound();
                    this.stepStatus[stepIdx] = true;
                    
                    // è¦–è¦ºå›é¥‹
                    slots.forEach(s => s.classList.add('correct'));
                    document.getElementById(`status-icon-${stepIdx}`).classList.remove('hidden');
                    document.getElementById(`check-btn-${stepIdx}`).classList.add('hidden');
                    document.getElementById(`options-area-${stepIdx}`).style.display = 'none'; // éš±è—é¸é …è®“ç•«é¢ä¹¾æ·¨
                    this.showMsg(stepIdx, "ç­”å°äº†ï¼", "text-green-600");

                    // è§£é–ä¸‹ä¸€æ­¥
                    if (stepIdx < problem.steps.length - 1) {
                        setTimeout(() => this.unlockStep(stepIdx + 1), 500);
                    } else {
                        setTimeout(() => this.showCompletion(), 800);
                    }

                } else {
                    // ç­”éŒ¯
                    this.playErrorSound();
                    slots.forEach(s => {
                        s.classList.add('error');
                        setTimeout(() => s.classList.remove('error'), 500);
                    });
                    this.showMsg(stepIdx, "å†æƒ³æƒ³çœ‹ï¼Œé †åºå°å—ï¼Ÿ", "text-red-500");
                }
            }

            unlockStep(idx) {
                const stepEl = document.getElementById(`step-${idx}`);
                stepEl.classList.remove('opacity-50', 'blur-[2px]', 'pointer-events-none', 'translate-y-4');
                stepEl.classList.add('opacity-100', 'translate-y-0');
                
                stepEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }

            showMsg(stepIdx, text, colorClass) {
                const msg = document.getElementById(`msg-${stepIdx}`);
                msg.textContent = text;
                msg.className = `h-6 text-sm font-bold transition-all opacity-100 ${colorClass}`;
            }

            // å®Œæˆè¦–çª—
            showCompletion() {
                const modal = document.getElementById('completion-modal');
                const box = document.getElementById('modal-box');
                modal.classList.remove('hidden');
                
                // å‹•ç•«
                requestAnimationFrame(() => {
                    modal.classList.remove('opacity-0');
                    box.classList.remove('scale-90');
                    box.classList.add('scale-100');
                });
                
                this.playTone(600, 0.1, 'sine');
                setTimeout(() => this.playTone(800, 0.2, 'sine'), 150);
            }

            closeModal() {
                const modal = document.getElementById('completion-modal');
                const box = document.getElementById('modal-box');
                
                modal.classList.add('opacity-0');
                box.classList.add('scale-90');
                
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 300);
            }

            resetProblem() {
                this.renderProblem(this.currentIdx);
                this.closeModal();
            }

            // éŸ³æ•ˆè¼”åŠ©
            playTone(freq, duration, type = 'sine') {
                try {
                    const osc = this.audioCtx.createOscillator();
                    const gain = this.audioCtx.createGain();
                    osc.type = type;
                    osc.frequency.value = freq;
                    osc.connect(gain);
                    gain.connect(this.audioCtx.destination);
                    osc.start();
                    gain.gain.exponentialRampToValueAtTime(0.00001, this.audioCtx.currentTime + duration);
                    osc.stop(this.audioCtx.currentTime + duration);
                } catch(e) {}
            }

            playSuccessSound() {
                this.playTone(523.25, 0.1); // C5
                setTimeout(() => this.playTone(659.25, 0.2), 100); // E5
            }

            playErrorSound() {
                this.playTone(150, 0.2, 'sawtooth');
            }
        }

        // å•Ÿå‹• App
        const app = new App();

    </script>
</body>
</html>
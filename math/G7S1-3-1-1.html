<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡å­—ç¬¦è™Ÿä»£è¡¨æ•¸ - äº’å‹•ç·´ç¿’</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f0f9ff; /* Light Blue bg */
        }

        /* -------------------------------------- */
        /* æ•¸å­¸å¼å°ˆç”¨ CSS (ç¬¦åˆæ•™ç§‘æ›¸æ’ç‰ˆè¦å‰‡) */
        /* -------------------------------------- */
        .math {
            font-family: 'Times New Roman', serif; /* æ•¸å­¸è®Šæ•¸å¸¸æ•¸å¸¸ç”¨è¥¯ç·šå­— */
            font-size: 28px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: #1e3a8a; /* Dark Blue */
            vertical-align: middle;
        }

        .fraction {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            line-height: 1;
            vertical-align: middle;
            margin: 0 4px;
        }
        
        .fraction span:first-child {
            border-bottom: 2px solid #000;
            padding: 2px 4px;
            display: block;
            width: 100%;
            text-align: center;
        }

        .fraction span:last-child {
            padding-top: 2px;
            display: block;
        }

        .power {
            font-size: 16px;
            vertical-align: super;
            margin-left: 2px;
            transform: translateY(-8px);
            color: #e63946;
        }

        .sqrt::before {
            content: "âˆš";
            font-size: 28px;
            margin-right: -2px;
        }
        
        .sqrt {
            border-top: 2px solid #000;
            padding-top: 1px;
            display: inline-block;
        }

        /* -------------------------------------- */
        /* äº’å‹•å…ƒä»¶ CSS */
        /* -------------------------------------- */
        
        /* å¡«ç­”æ§½ (Slot) */
        .slot {
            width: 60px;
            height: 50px;
            border: 2px dashed #94a3b8;
            border-radius: 8px;
            background-color: #ffffff;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            font-weight: bold;
            color: #333;
            cursor: pointer;
            transition: all 0.2s;
            margin: 0 4px;
            vertical-align: middle;
        }

        .slot.filled {
            border: 2px solid #3b82f6; /* Blue border when filled */
            background-color: #eff6ff;
            border-style: solid;
        }

        .slot.correct {
            border: 2px solid #22c55e; /* Green border */
            background-color: #dcfce7;
            color: #15803d;
        }

        .slot.active-target {
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2);
            border-color: #3b82f6;
        }

        /* é¸é …æŒ‰éˆ• (Option Button) */
        .option-btn {
            min-width: 60px;
            height: 60px;
            padding: 0 16px;
            margin: 6px;
            background-color: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 24px;
            font-family: 'Times New Roman', serif;
            font-weight: bold;
            color: #334155;
            box-shadow: 0 4px 0 #cbd5e1;
            transition: all 0.1s;
            display: inline-flex;
            justify-content: center;
            align-items: center;
        }

        .option-btn:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 #cbd5e1;
        }

        .option-btn:disabled {
            background-color: #f1f5f9;
            color: #cbd5e1;
            border-color: #f1f5f9;
            box-shadow: none;
            cursor: not-allowed;
            transform: translateY(4px);
        }

        /* æ­¥é©Ÿå®¹å™¨ */
        .step-container {
            opacity: 0.5;
            pointer-events: none;
            transition: opacity 0.5s ease;
            filter: grayscale(0.8);
        }

        .step-container.active {
            opacity: 1;
            pointer-events: auto;
            filter: grayscale(0);
            background-color: white;
            border: 2px solid #3b82f6;
            transform: scale(1.01);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .step-container.completed {
            opacity: 1;
            filter: grayscale(0);
            border: 2px solid #22c55e;
            background-color: #f0fdf4;
        }

        /* é‡é»é«˜äº® */
        mark {
            background-color: #fef08a; /* Yellow-200 */
            padding: 2px 6px;
            border-radius: 4px;
            color: #854d0e;
            font-weight: bold;
        }

        /* éš±è—å…ƒç´ ä½†ä¿ç•™ç©ºé–“ (Fade out) */
        .fade-enter {
            opacity: 0;
            transform: translateY(20px);
        }
        .fade-enter-active {
            opacity: 1;
            transform: translateY(0);
            transition: all 0.5s ease;
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen flex flex-col items-center">

    <!-- Header -->
    <header class="w-full max-w-3xl mb-8 text-center">
        <div class="inline-block bg-indigo-600 text-white px-6 py-2 rounded-full text-lg font-bold mb-4 shadow-md">
            ğŸ§© ç†Ÿç·´ 1ï¼šä»¥æ–‡å­—ç¬¦è™Ÿä»£è¡¨æ•¸
        </div>
        <p class="text-slate-600 text-lg">
            è«‹æ ¹æ“šé¡Œæ„ï¼Œé»æ“Šä¸‹æ–¹æŒ‰éˆ•å°‡æ­£ç¢ºçš„ç¬¦è™Ÿæˆ–æ•¸å­—å¡«å…¥ç©ºæ ¼ä¸­ã€‚
        </p>
    </header>

    <!-- Main Game Area -->
    <main id="game-area" class="w-full max-w-3xl space-y-6">
        <!-- Steps will be injected here by JS -->
    </main>

    <!-- Global Feedback Area (Fixed Bottom or inline) -->
    <div id="feedback-modal" class="fixed bottom-8 left-1/2 transform -translate-x-1/2 bg-white px-6 py-4 rounded-xl shadow-2xl border-l-8 border-yellow-500 hidden z-50 flex items-center gap-4 transition-all duration-300">
        <span id="feedback-icon" class="text-3xl">ğŸ¤”</span>
        <span id="feedback-text" class="text-xl font-bold text-slate-700">æç¤ºè¨Šæ¯</span>
    </div>

    <!-- JavaScript Logic -->
    <script>
        // é¡Œç›®è³‡æ–™çµæ§‹
        const stepsData = [
            {
                id: 1,
                title: "é¡Œç›® 1-1ï¼šå¹´é½¡å•é¡Œ",
                question: "åª½åª½æ¯”å°å¦ <mark>å¤§ 23 æ­²</mark>ã€‚<br>å¦‚æœå°å¦ä»Šå¹´ <span class='math'>x</span> æ­²ï¼Œå‰‡åª½åª½ä»Šå¹´å¹¾æ­²ï¼Ÿ",
                slots: 3, // x + 23
                options: ["x", "y", "+", "-", "23"],
                correctAnswer: ["x", "+", "23"], // é †åºå¿…é ˆå®Œå…¨ä¸€è‡´
                hint: "ã€Œæ¯”...å¤§ã€é€šå¸¸æ˜¯ç”¨åŠ æ³•å–”ï¼",
                illustration: null
            },
            {
                id: 2,
                title: "é¡Œç›® 1-2ï¼šåå‘æ€è€ƒ",
                question: "æ‰¿ä¸Šé¡Œï¼Œå¦‚æœåª½åª½ä»Šå¹´ <span class='math'>y</span> æ­²ï¼Œ<br>å‰‡å°å¦ä»Šå¹´å¹¾æ­²ï¼Ÿ",
                slots: 3, // y - 23
                options: ["x", "y", "+", "-", "23"],
                correctAnswer: ["y", "-", "23"],
                hint: "å¦‚æœæ˜¯å¾å°å¦ç®—åª½åª½æ˜¯åŠ ï¼Œé‚£å¾åª½åª½ç®—å›å°å¦å‘¢ï¼Ÿ",
                illustration: null
            },
            {
                id: 3,
                title: "é¡Œç›® 2-1ï¼šç¥¨åƒ¹è¨ˆç®—",
                question: "æ£’çƒè³½é–€ç¥¨ <mark>æ¯å¼µ 300 å…ƒ</mark>ã€‚<br>å¦‚æœå°ç¥è²·äº† <span class='math'>x</span> å¼µé–€ç¥¨ï¼Œå‰‡ä»–å…±éœ€ä»˜å¤šå°‘å…ƒï¼Ÿ",
                slots: 3, // x * 300 (ä¾é¡Œç›®åœ–ç‰‡é¡¯ç¤ºé‚è¼¯)
                options: ["x", "y", "300", "Ã—", "Ã·"],
                correctAnswer: [["x", "Ã—", "300"], ["300", "Ã—", "x"]], 
                hint: "ç¸½é‡‘é¡ = å–®åƒ¹ Ã— æ•¸é‡ (ä¹Ÿå¯ä»¥æ˜¯ æ•¸é‡ Ã— å–®åƒ¹ å–”ï¼)",
                illustration: null
            },
            {
                id: 4,
                title: "é¡Œç›® 2-2ï¼šæ•¸é‡è¨ˆç®—",
                question: "æ‰¿ä¸Šé¡Œï¼Œå¦‚æœå°ç¥å…±ä»˜äº† <span class='math'>y</span> å…ƒï¼Œ<br>å‰‡ä»–è²·äº†å¹¾å¼µé–€ç¥¨ï¼Ÿ",
                slots: 3, // y / 300
                options: ["x", "y", "300", "Ã—", "Ã·"],
                correctAnswer: ["y", "Ã·", "300"],
                hint: "æ•¸é‡ = ç¸½é‡‘é¡ Ã· å–®åƒ¹",
                illustration: null
            }
        ];

        let currentStep = 0;
        let userAnswers = {}; // Store answers per step: { 1: [val, val], ... }
        let stepCompleted = {}; // Store completion status

        const gameArea = document.getElementById('game-area');
        const feedbackModal = document.getElementById('feedback-modal');
        const feedbackText = document.getElementById('feedback-text');
        const feedbackIcon = document.getElementById('feedback-icon');
        const feedbackBorder = document.getElementById('feedback-modal');

        // åˆå§‹åŒ–
        function init() {
            renderSteps();
            activateStep(0);
        }

        // æ¸²æŸ“æ‰€æœ‰æ­¥é©Ÿ
        function renderSteps() {
            gameArea.innerHTML = '';
            stepsData.forEach((step, index) => {
                // å»ºç«‹æ­¥é©Ÿå®¹å™¨
                const stepEl = document.createElement('div');
                stepEl.id = `step-${index}`;
                stepEl.className = `step-container bg-white p-6 rounded-2xl border border-slate-200 shadow-sm relative overflow-hidden`;
                
                // åˆå§‹åŒ–ç­”æ¡ˆé™£åˆ—
                userAnswers[index] = new Array(step.slots).fill(null);
                stepCompleted[index] = false;

                // æ§‹å»º HTML
                stepEl.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-lg font-bold text-slate-400 step-title">Step ${index + 1}</h3>
                        <span class="status-icon hidden text-green-500 text-xl font-bold">âœ”ï¸ å®Œæˆ</span>
                    </div>
                    
                    <div class="mb-6 text-xl text-slate-800 leading-relaxed">
                        ${step.question}
                    </div>

                    <div class="flex flex-col items-center gap-6">
                        <!-- ç­”é¡Œå€ (Slots) -->
                        <div class="flex items-center gap-2 bg-slate-50 p-4 rounded-xl w-full justify-center min-h-[100px]" id="slots-area-${index}">
                            ${generateSlotsHTML(index, step.slots)}
                            <span class="text-xl font-bold ml-2 text-slate-500 unit-label">${getUnitLabel(index)}</span>
                        </div>

                        <!-- é¸é …å€ (Options) -->
                        <div class="flex flex-wrap justify-center gap-2" id="options-area-${index}">
                            ${generateOptionsHTML(index, step.options)}
                        </div>

                        <!-- æª¢æŸ¥æŒ‰éˆ• -->
                        <button onclick="checkStep(${index})" class="check-btn bg-indigo-600 hover:bg-indigo-700 text-white text-lg font-bold py-3 px-8 rounded-xl shadow-lg transform transition active:scale-95 w-full md:w-auto mt-2">
                            æª¢æŸ¥ç­”æ¡ˆ
                        </button>
                    </div>
                `;
                gameArea.appendChild(stepEl);
            });
        }

        function getUnitLabel(index) {
            if (index === 0 || index === 1) return "æ­²";
            if (index === 2) return "å…ƒ";
            if (index === 3) return "å¼µ";
            return "";
        }

        function generateSlotsHTML(stepIndex, count) {
            let html = '<div class="math">'; // å¤–å±¤åŒ…è£¹ math é¡åˆ¥ä»¥ç¢ºä¿ç¬¦è™Ÿå‚ç›´ç½®ä¸­
            for (let i = 0; i < count; i++) {
                html += `<div class="slot" data-step="${stepIndex}" data-slot-index="${i}" onclick="handleSlotClick(${stepIndex}, ${i})"></div>`;
            }
            html += '</div>';
            return html;
        }

        function generateOptionsHTML(stepIndex, options) {
            return options.map(opt => `
                <button class="option-btn" data-step="${stepIndex}" data-val="${opt}" onclick="handleOptionClick(${stepIndex}, '${opt}', this)">
                    ${opt}
                </button>
            `).join('');
        }

        // å•Ÿå‹•ç‰¹å®šæ­¥é©Ÿ
        function activateStep(index) {
            currentStep = index;
            const stepEl = document.getElementById(`step-${index}`);
            if (stepEl) {
                stepEl.classList.add('active');
                // èšç„¦æ»¾å‹•
                setTimeout(() => {
                    stepEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 300);
            }
        }

        // è™•ç†é¸é …é»æ“Š
        window.handleOptionClick = function(stepIndex, value, btnEl) {
            if (stepCompleted[stepIndex]) return; // å·²å®Œæˆä¸å¯æ“ä½œ

            // å°‹æ‰¾è©²æ­¥é©Ÿç¬¬ä¸€å€‹ç©ºçš„ slot
            const emptySlotIndex = userAnswers[stepIndex].findIndex(val => val === null);
            
            if (emptySlotIndex !== -1) {
                // å¡«å…¥è³‡æ–™
                userAnswers[stepIndex][emptySlotIndex] = value;
                
                // æ›´æ–° UI
                const slotEl = document.querySelector(`.slot[data-step="${stepIndex}"][data-slot-index="${emptySlotIndex}"]`);
                slotEl.innerHTML = renderMathContent(value);
                slotEl.classList.add('filled');
                
                // ç¦ç”¨æŒ‰éˆ•
                btnEl.disabled = true;
                btnEl.dataset.linkedSlot = emptySlotIndex; // è¨˜ä½é€™å€‹æŒ‰éˆ•å°æ‡‰å“ªå€‹ slotï¼Œä»¥ä¾¿æ¸…é™¤æ™‚æ¢å¾©

                playSound('pop');
            } else {
                showFeedback('ç©ºæ ¼å·²ç¶“æ»¿å›‰ï¼è«‹å…ˆæª¢æŸ¥æˆ–é»æ“Šç©ºæ ¼æ¸…é™¤ã€‚', 'warning');
            }
        }

        // è™•ç† Slot é»æ“Š (æ¸…é™¤)
        window.handleSlotClick = function(stepIndex, slotIndex) {
            if (stepCompleted[stepIndex]) return;

            const currentVal = userAnswers[stepIndex][slotIndex];
            if (currentVal) {
                // æ¸…é™¤è³‡æ–™
                userAnswers[stepIndex][slotIndex] = null;

                // æ¸…é™¤ UI
                const slotEl = document.querySelector(`.slot[data-step="${stepIndex}"][data-slot-index="${slotIndex}"]`);
                slotEl.innerHTML = '';
                slotEl.classList.remove('filled');

                // æ¢å¾©å°æ‡‰çš„æŒ‰éˆ•
                // æ³¨æ„ï¼šé€™è£¡å¦‚æœæœ‰å¤šå€‹ç›¸åŒé¸é …(ä¾‹å¦‚å…©å€‹x)ï¼Œé‚è¼¯éœ€è¦æ›´åš´è¬¹ã€‚
                // ç°¡å–®ä½œæ³•ï¼šæ‰¾åˆ°è©²æ­¥é©Ÿä¸­ï¼Œå€¼ç­‰æ–¼ currentVal ä¸”è¢«ç¦ç”¨çš„æŒ‰éˆ•ï¼Œæ¢å¾©ä¸€å€‹ã€‚
                const optionBtns = document.querySelectorAll(`#options-area-${stepIndex} .option-btn`);
                for (let btn of optionBtns) {
                    if (btn.disabled && btn.dataset.val === currentVal) {
                        btn.disabled = false;
                        break; // åªæ¢å¾©ä¸€å€‹
                    }
                }
                
                // å¦‚æœæ¸…é™¤çš„æ˜¯ä¸­é–“çš„æ ¼ï¼Œå¾Œé¢çš„æ ¼ä¸éœ€è¦è‡ªå‹•ç§»ä½(ä¾éœ€æ±‚)ï¼Œä½†ç‚ºäº†ç°¡å–®ï¼Œé€™è£¡ä¸ç§»ä½ã€‚
            }
        }

        // æª¢æŸ¥ç­”æ¡ˆ
        window.checkStep = function(stepIndex) {
            const currentAnswers = userAnswers[stepIndex];
            const correctData = stepsData[stepIndex].correctAnswer;

            // 1. æª¢æŸ¥æ˜¯å¦å¡«æ»¿
            if (currentAnswers.includes(null)) {
                showFeedback('è«‹å¡«æ»¿æ‰€æœ‰ç©ºæ ¼å†æŒ‰æª¢æŸ¥å–”ï¼', 'warning');
                return;
            }

            // 2. æª¢æŸ¥æ­£ç¢ºæ€§ (æ”¯æ´å¤šçµ„æ­£ç¢ºç­”æ¡ˆ)
            let isCorrect = false;

            // åˆ¤æ–· correctData æ˜¯ã€Œå–®ä¸€ç­”æ¡ˆé™£åˆ—ã€é‚„æ˜¯ã€Œå¤šçµ„ç­”æ¡ˆé™£åˆ—ã€
            // å¦‚æœç¬¬ä¸€å€‹å…ƒç´ ä¹Ÿæ˜¯é™£åˆ—ï¼Œä»£è¡¨æœ‰å¤šçµ„æ­£ç¢ºè§£ (ä¾‹å¦‚ [["x","*","300"], ["300","*","x"]])
            if (Array.isArray(correctData[0])) {
                isCorrect = correctData.some(ans => JSON.stringify(ans) === JSON.stringify(currentAnswers));
            } else {
                // å–®ä¸€æ¨™æº–ç­”æ¡ˆ (èˆŠé‚è¼¯ç¶­æŒç›¸å®¹)
                isCorrect = JSON.stringify(currentAnswers) === JSON.stringify(correctData);
            }

            if (isCorrect) {
                handleSuccess(stepIndex);
            } else {
                handleFailure(stepIndex);
            }
        }

        function handleSuccess(stepIndex) {
            stepCompleted[stepIndex] = true;
            
            // è¦–è¦ºè®ŠåŒ–
            const stepEl = document.getElementById(`step-${stepIndex}`);
            stepEl.classList.remove('active');
            stepEl.classList.add('completed');
            
            // æ¨™é¡Œè®ŠåŒ–
            stepEl.querySelector('.status-icon').classList.remove('hidden');
            stepEl.querySelector('.check-btn').classList.add('hidden'); // éš±è—æŒ‰éˆ•
            
            // Slot è®Šç¶ 
            const slots = stepEl.querySelectorAll('.slot');
            slots.forEach(s => s.classList.add('correct'));

            showFeedback('å¤ªæ£’äº†ï¼ç­”å°äº†ï¼ ğŸ‰', 'success');
            playSound('success');

            // è§£é–ä¸‹ä¸€æ­¥
            if (stepIndex < stepsData.length - 1) {
                setTimeout(() => {
                    activateStep(stepIndex + 1);
                }, 1500);
            } else {
                // å…¨æ•¸å®Œæˆ
                setTimeout(() => {
                    showFeedback('æ­å–œï¼æ‰€æœ‰é¡Œç›®éƒ½å®Œæˆäº†ï¼ä½ æ˜¯æ•¸å­¸å°å¤©æ‰ï¼ ğŸ†', 'success');
                    confettiEffect();
                }, 1000);
            }
        }

        function handleFailure(stepIndex) {
            showFeedback('å†æƒ³æƒ³çœ‹ï¼Œé †åºå°å—ï¼Ÿ ğŸ¤”', 'error');
            playSound('error');
            
            // éŒ¯èª¤æ–æ™ƒå‹•ç•«
            const slotsArea = document.getElementById(`slots-area-${stepIndex}`);
            slotsArea.classList.add('animate-pulse'); // Tailwind simple pulse or custom shake
            setTimeout(() => slotsArea.classList.remove('animate-pulse'), 500);
        }

        // è¼”åŠ©å‡½å¼ï¼šæ¸²æŸ“æ•¸å­¸å…§å®¹ (é›–ç„¶æ­¤é¡Œå¤§å¤šæ˜¯ç´”æ–‡å­—ï¼Œä½†ä¿ç•™æ“´å……æ€§)
        function renderMathContent(val) {
            if (val === "/") return "Ã·";
            if (val === "*") return "Ã—";
            return val;
        }

        // è¼”åŠ©å‡½å¼ï¼šé¡¯ç¤ºå›é¥‹
        function showFeedback(msg, type) {
            feedbackText.innerText = msg;
            feedbackModal.classList.remove('hidden');
            
            // æ¨£å¼è¨­å®š
            feedbackModal.className = "fixed bottom-8 left-1/2 transform -translate-x-1/2 bg-white px-8 py-4 rounded-xl shadow-2xl border-l-8 z-50 flex items-center gap-4 transition-all duration-300 min-w-[300px]";
            
            if (type === 'success') {
                feedbackModal.classList.add('border-green-500');
                feedbackIcon.innerText = "ğŸ˜„";
            } else if (type === 'error') {
                feedbackModal.classList.add('border-red-500');
                feedbackIcon.innerText = "ğŸ’¡";
            } else {
                feedbackModal.classList.add('border-yellow-500');
                feedbackIcon.innerText = "â˜ï¸";
            }

            // 3ç§’å¾Œè‡ªå‹•æ¶ˆå¤±
            setTimeout(() => {
                feedbackModal.classList.add('hidden');
            }, 3000);
        }

        // ç°¡å–®éŸ³æ•ˆæ¨¡æ“¬ (å¦‚æœä¸æƒ³è¦çœŸå¯¦éŸ³æ•ˆæª”ï¼Œå¯ç•™ç©º)
        function playSound(type) {
            // åœ¨çœŸå¯¦éƒ¨ç½²æ™‚ï¼Œå¯ä»¥ä½¿ç”¨ Audio() è¼‰å…¥ mp3
            // é€™è£¡åƒ…ä½œçµæ§‹é ç•™
            console.log(`Playing sound: ${type}`);
        }
        
        // ç°¡æ˜“å½©å¸¶æ•ˆæœ
        function confettiEffect() {
            const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff'];
            for(let i=0; i<50; i++) {
                const conf = document.createElement('div');
                conf.style.position = 'fixed';
                conf.style.left = Math.random() * 100 + 'vw';
                conf.style.top = '-10px';
                conf.style.width = '10px';
                conf.style.height = '10px';
                conf.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                conf.style.transition = 'top 3s ease-out, transform 3s linear';
                conf.style.zIndex = '9999';
                document.body.appendChild(conf);
                
                setTimeout(() => {
                    conf.style.top = '105vh';
                    conf.style.transform = `rotate(${Math.random() * 360}deg)`;
                }, 100);
            }
        }

        // Start
        init();

    </script>
</body>
</html>
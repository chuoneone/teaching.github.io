<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unit 6: äº’å‹•å¼å­¸ç¿’å–® (èªéŸ³å¼·åŒ–ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #fdfbf7;
            color: #333;
            user-select: none;
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        .btn-large {
            min-height: 60px;
            font-size: 1.1rem;
        }

        .nav-active {
            border-bottom: 4px solid #f97316;
            color: #c2410c;
            font-weight: 700;
            background-color: #fff7ed;
        }
        
        /* Selection & Answer States */
        .selected-option {
            background-color: #e0f2fe !important;
            border-color: #3b82f6 !important;
            color: #1e40af !important;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }

        .correct-answer {
            background-color: #d1fae5 !important;
            border-color: #10b981 !important;
            color: #065f46 !important;
            font-weight: bold;
        }
        
        .wrong-answer {
            background-color: #fee2e2 !important;
            border-color: #ef4444 !important;
            color: #991b1b !important;
            opacity: 0.7;
        }

        /* Animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }

        .tts-btn {
            background-color: #e0f2fe;
            color: #0369a1;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-left: 8px;
            cursor: pointer;
            border: 2px solid #bae6fd;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        .tts-btn:hover {
            background-color: #bae6fd;
            transform: scale(1.1);
        }
    </style>
</head>
<body class="flex flex-col min-h-screen bg-orange-50/30">

    <!-- Navigation -->
    <nav class="bg-white shadow-lg sticky top-0 z-50 border-b-4 border-orange-200">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between h-20">
                <div class="flex items-center cursor-pointer" onclick="window.app.navigate('dashboard')">
                    <span class="text-3xl mr-2">ğŸ˜</span> 
                    <div class="flex flex-col">
                        <span class="text-xl font-bold text-gray-800 tracking-tight">Unit 6 äº’å‹•ç·´ç¿’</span>
                        <span class="text-xs text-gray-500 font-normal">There Are Some Elephants</span>
                    </div>
                </div>
                <div class="hidden md:flex space-x-2 items-center overflow-x-auto" id="desktop-nav"></div>
                <div class="flex items-center md:hidden">
                    <button id="mobile-menu-btn" class="p-3 rounded-lg text-gray-600 hover:bg-gray-100">
                        â˜°
                    </button>
                </div>
            </div>
        </div>
        <div id="mobile-menu" class="hidden md:hidden bg-white border-t border-gray-100 p-4 space-y-2 shadow-xl absolute w-full z-50"></div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow max-w-6xl mx-auto px-4 py-8 w-full">
        
        <!-- DASHBOARD -->
        <div id="view-dashboard" class="view-section animate-fade-in">
            <div class="bg-white rounded-3xl shadow-xl p-6 mb-8 border border-orange-100">
                <div class="text-center mb-6">
                    <h1 class="text-4xl font-extrabold text-gray-900 mb-2">å­¸ç¿’è¨ºæ–·å„€è¡¨æ¿</h1>
                    <p class="text-gray-600">
                        æŸ¥çœ‹å„å€‹å¤§é¡Œçš„å¼·å¼±é …ã€‚è—è‰²æ˜¯ç¬¬ä¸€æ¬¡çš„å¯¦åŠ›ï¼Œç¶ è‰²æ˜¯è¨‚æ­£å¾Œçš„æˆæœã€‚
                    </p>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <!-- Radar Chart -->
                    <div class="bg-gray-50 rounded-2xl p-4 border border-gray-200 shadow-inner">
                        <h3 class="text-center font-bold text-gray-700 mb-2">å„é¡Œå‹èƒ½åŠ›åˆ†æ (Radar)</h3>
                        <div class="chart-container">
                            <canvas id="radarChart"></canvas>
                        </div>
                    </div>
                    <!-- Bar Chart -->
                    <div class="bg-gray-50 rounded-2xl p-4 border border-gray-200 shadow-inner">
                        <h3 class="text-center font-bold text-gray-700 mb-2">ç¸½åˆ†é€²åº¦ (Total Progress)</h3>
                        <div class="chart-container">
                            <canvas id="barChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="text-center">
                    <button onclick="window.app.hardReset()" class="text-sm text-gray-400 underline hover:text-red-500">
                        [æ¸…é™¤æ‰€æœ‰ç´€éŒ„å®Œå…¨é‡ä¾†]
                    </button>
                </div>
            </div>

            <!-- Quick Links -->
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
                <button onclick="window.app.navigate('section-a')" class="p-6 bg-white rounded-2xl shadow-md border-b-4 border-yellow-400 hover:bg-yellow-50 transition-all text-left group">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-lg font-bold text-yellow-700 bg-yellow-100 px-3 py-1 rounded-lg">Part A</span>
                        <span class="text-2xl group-hover:translate-x-1 transition-transform">ğŸ¦</span>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800">å–®å­— Vocabulary</h3>
                    <p class="text-gray-500 text-sm mt-1">çœ‹åœ–é¸å–®å­— (å››é¸ä¸€)</p>
                </button>
                <button onclick="window.app.navigate('section-b')" class="p-6 bg-white rounded-2xl shadow-md border-b-4 border-blue-400 hover:bg-blue-50 transition-all text-left group">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-lg font-bold text-blue-700 bg-blue-100 px-3 py-1 rounded-lg">Part B-D</span>
                        <span class="text-2xl group-hover:translate-x-1 transition-transform">âœï¸</span>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800">æ–‡æ³• Grammar</h3>
                    <p class="text-gray-500 text-sm mt-1">é¸æ“‡ã€é‡çµ„ã€å¡«å……</p>
                </button>
                <button onclick="window.app.navigate('section-e')" class="p-6 bg-white rounded-2xl shadow-md border-b-4 border-purple-400 hover:bg-purple-50 transition-all text-left group">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-lg font-bold text-purple-700 bg-purple-100 px-3 py-1 rounded-lg">Part E-G</span>
                        <span class="text-2xl group-hover:translate-x-1 transition-transform">ğŸ“</span>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800">ç¶œåˆç·´ç¿’ Integrated</h3>
                    <p class="text-gray-500 text-sm mt-1">é€ å¥ã€å•ç­”ã€é–±è®€</p>
                </button>
            </div>
        </div>

        <!-- SECTION A: Vocabulary (Multiple Choice) -->
        <div id="view-section-a" class="view-section hidden">
            <div class="bg-yellow-50 p-4 rounded-xl border border-yellow-200 shadow-sm mb-6 flex justify-between items-center sticky top-20 z-40">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                        <span class="bg-yellow-500 text-white w-8 h-8 flex items-center justify-center rounded-full text-lg">A</span>
                        Look and choose (å–®å­—å››é¸ä¸€)
                    </h2>
                    <p class="text-yellow-800 text-sm">çœ‹åœ–ç‰‡ï¼Œè½é¸é …ï¼Œé¸å‡ºæ­£ç¢ºçš„è‹±æ–‡å–®å­—ã€‚</p>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="container-vocab-a">
                <!-- Injected via JS -->
            </div>
            
            <div class="mt-8 text-center space-x-4 pb-8">
                <button onclick="window.resetSection('a')" class="px-6 py-3 bg-red-100 hover:bg-red-200 text-red-700 rounded-lg font-bold transition-colors">ğŸ”„ é‡æ–°æŒ‘æˆ°ä¸€æ¬¡ (A)</button>
                <button onclick="window.app.navigate('dashboard')" class="px-6 py-3 bg-gray-200 hover:bg-gray-300 rounded-lg font-bold text-gray-700 transition-colors">å›å„€è¡¨æ¿</button>
            </div>
        </div>

        <!-- SECTION B/C/D: Grammar -->
        <div id="view-section-b" class="view-section hidden">
            <div class="sticky top-20 z-40 bg-white/95 backdrop-blur-sm p-2 rounded-xl shadow-sm mb-6 overflow-x-auto whitespace-nowrap border border-gray-100">
                <button class="grammar-tab active px-5 py-2 rounded-lg font-bold bg-blue-600 text-white mr-2 transition-colors" data-target="grammar-choice">B. Circle (é¸æ“‡)</button>
                <button class="grammar-tab px-5 py-2 rounded-lg font-bold bg-gray-100 text-gray-600 hover:bg-gray-200 mr-2 transition-colors" data-target="grammar-unscramble">C. Unscramble (é‡çµ„)</button>
                <button class="grammar-tab px-5 py-2 rounded-lg font-bold bg-gray-100 text-gray-600 hover:bg-gray-200 transition-colors" data-target="grammar-fill">D. Fill In (å¡«å……)</button>
            </div>

            <div id="grammar-choice" class="grammar-content animate-fade-in">
                <div class="bg-blue-50 p-4 rounded-xl border-l-4 border-blue-500 mb-6">
                    <h3 class="font-bold text-blue-900 text-lg">B. Circle the answers (p.32)</h3>
                </div>
                <div id="container-choice" class="space-y-8"></div>
                <div class="mt-8 text-center"><button onclick="window.resetSection('b')" class="px-6 py-3 bg-red-100 hover:bg-red-200 text-red-700 rounded-lg font-bold transition-colors">ğŸ”„ é‡æ–°æŒ‘æˆ°ä¸€æ¬¡</button></div>
            </div>

            <div id="grammar-unscramble" class="grammar-content hidden animate-fade-in">
                <div class="bg-green-50 p-4 rounded-xl border-l-4 border-green-500 mb-6">
                    <h3 class="font-bold text-green-900 text-lg">C. Unscramble (p.32)</h3>
                    <p class="text-green-700">é»æ“Šå­—å¡æ’åˆ—æˆæ­£ç¢ºå¥å­ã€‚</p>
                </div>
                <div id="container-unscramble" class="space-y-10"></div>
                <div class="mt-8 text-center"><button onclick="window.resetSection('c')" class="px-6 py-3 bg-red-100 hover:bg-red-200 text-red-700 rounded-lg font-bold transition-colors">ğŸ”„ é‡æ–°æŒ‘æˆ°ä¸€æ¬¡</button></div>
            </div>

            <div id="grammar-fill" class="grammar-content hidden animate-fade-in">
                <div class="bg-indigo-50 p-4 rounded-xl border-l-4 border-indigo-500 mb-6">
                    <h3 class="font-bold text-indigo-900 text-lg">D. Fill in the blanks (p.33)</h3>
                </div>
                <div id="container-fill" class="space-y-8"></div>
                <div class="mt-8 text-center"><button onclick="window.resetSection('d')" class="px-6 py-3 bg-red-100 hover:bg-red-200 text-red-700 rounded-lg font-bold transition-colors">ğŸ”„ é‡æ–°æŒ‘æˆ°ä¸€æ¬¡</button></div>
            </div>
            
            <div class="mt-8 text-center pb-8 border-t pt-4">
                <button onclick="window.app.navigate('dashboard')" class="px-6 py-3 bg-gray-200 hover:bg-gray-300 rounded-lg font-bold text-gray-700 transition-colors">å›å„€è¡¨æ¿</button>
            </div>
        </div>

        <!-- SECTION E/F/G: Integrated -->
        <div id="view-section-e" class="view-section hidden">
             <div class="sticky top-20 z-40 bg-white/95 backdrop-blur-sm p-2 rounded-xl shadow-sm mb-6 overflow-x-auto whitespace-nowrap border border-gray-100">
                <button class="lr-tab active px-5 py-2 rounded-lg font-bold bg-purple-600 text-white mr-2 transition-colors" data-target="part-e">E. Look & Write (p.34)</button>
                <button class="lr-tab px-5 py-2 rounded-lg font-bold bg-gray-100 text-gray-600 hover:bg-gray-200 mr-2 transition-colors" data-target="part-f">F. QA (p.35)</button>
                <button class="lr-tab px-5 py-2 rounded-lg font-bold bg-gray-100 text-gray-600 hover:bg-gray-200 transition-colors" data-target="part-g">G. Reading (p.36)</button>
            </div>

            <div id="part-e" class="lr-content animate-fade-in">
                <div class="bg-purple-50 p-4 rounded-xl border-l-4 border-purple-500 mb-6">
                    <h3 class="font-bold text-purple-900 text-lg">E. Look and write (p.34)</h3>
                    <p class="text-purple-700">é»æ“Šå­—å¡é€ å¥ã€‚</p>
                </div>
                <div id="container-writing-e" class="space-y-10"></div>
                <div class="mt-8 text-center"><button onclick="window.resetSection('e')" class="px-6 py-3 bg-red-100 hover:bg-red-200 text-red-700 rounded-lg font-bold transition-colors">ğŸ”„ é‡æ–°æŒ‘æˆ°ä¸€æ¬¡</button></div>
            </div>
            
            <div id="part-f" class="lr-content hidden animate-fade-in">
                <div class="bg-pink-50 p-4 rounded-xl border-l-4 border-pink-500 mb-6">
                    <h3 class="font-bold text-pink-900 text-lg">F. Answer the questions (p.35)</h3>
                </div>
                <div id="container-answering-f" class="space-y-8"></div>
                <div class="mt-8 text-center"><button onclick="window.resetSection('f')" class="px-6 py-3 bg-red-100 hover:bg-red-200 text-red-700 rounded-lg font-bold transition-colors">ğŸ”„ é‡æ–°æŒ‘æˆ°ä¸€æ¬¡</button></div>
            </div>

            <div id="part-g" class="lr-content hidden animate-fade-in">
                <div class="bg-orange-50 p-4 rounded-xl border-l-4 border-orange-500 mb-6">
                    <h3 class="font-bold text-orange-900 text-lg">G. Read and choose (p.36)</h3>
                </div>
                <div class="bg-white p-6 rounded-2xl border border-gray-200 shadow-sm mb-6 relative">
                    <button onclick="window.app.speak(document.getElementById('reading-text').innerText, 'en-US')" class="absolute top-4 right-4 bg-orange-100 text-orange-700 px-3 py-1 rounded-full text-sm font-bold flex items-center gap-1 hover:bg-orange-200 transition-colors">ğŸ”Š æœ—è®€</button>
                    <div class="prose max-w-none text-gray-800 text-lg leading-loose font-serif p-2" id="reading-text">
                        <p class="mb-2">Ashura is an animal lover. His favorite place is <span class="font-bold text-green-700">Ruguru National Park</span>. There, Ashura can see big animals and small animals. There are birds, monkeys, zebras, and elephants. There is a lion, too.</p>
                        <p class="mb-2">But these are not Ashura's favorite animals. His favorite animal is the <span class="font-bold text-orange-700">mountain bongo</span>. The coat of a mountain bongo is beautiful. It is brown, and there are white lines on it.</p>
                    </div>
                </div>
                <div id="container-reading-g" class="space-y-8"></div>
                <div class="mt-8 text-center"><button onclick="window.resetSection('g')" class="px-6 py-3 bg-red-100 hover:bg-red-200 text-red-700 rounded-lg font-bold transition-colors">ğŸ”„ é‡æ–°æŒ‘æˆ°ä¸€æ¬¡</button></div>
            </div>

            <div class="mt-8 text-center pb-8 border-t pt-4">
                <button onclick="window.app.navigate('dashboard')" class="px-6 py-3 bg-gray-200 hover:bg-gray-300 rounded-lg font-bold text-gray-700 transition-colors">å›å„€è¡¨æ¿</button>
            </div>
        </div>

    </main>

    <script>
        // --- DATA ---
        // Pre-shuffled options for stability
        const vocabData = [
            { id: 'a1', word: "elephant", icon: "ğŸ˜", options: ["bear", "elephant", "tiger", "lion"] },
            { id: 'a2', word: "lion", icon: "ğŸ¦", options: ["zebra", "lion", "fox", "monkey"] },
            { id: 'a3', word: "bear", icon: "ğŸ»", options: ["bear", "elephant", "horse", "fox"] },
            { id: 'a4', word: "zebra", icon: "ğŸ¦“", options: ["monkey", "tiger", "zebra", "lion"] },
            { id: 'a5', word: "monkey", icon: "ğŸ’", options: ["horse", "monkey", "bear", "zebra"] },
            { id: 'a6', word: "fox", icon: "ğŸ¦Š", options: ["lion", "fox", "tiger", "elephant"] },
            { id: 'a7', word: "horse", icon: "ğŸ", options: ["monkey", "bear", "horse", "zebra"] },
            { id: 'a8', word: "tiger", icon: "ğŸ…", options: ["fox", "tiger", "lion", "elephant"] }
        ];

        const choiceData = [
            { id: 'b1', q: "There is ( a / any / some ) dog over there.", options: ["a", "any", "some"], correct: "a" },
            { id: 'b2', q: "There are ( some / any ) rabbits under the tree.", options: ["some", "any"], correct: "some" },
            { id: 'b3', q: "There are ( some / any ) oranges on the dining table.", options: ["some", "any"], correct: "some" },
            { id: 'b4', q: "There aren't ( some / any ) zebras near the tree.", options: ["some", "any"], correct: "any" },
            { id: 'b5', q: "A: This is a nice park. B: Yes, there are ( some / any ) beautiful trees.", options: ["some", "any"], correct: "some" }
        ];

        const unscrambleData = [
            { id: 'c1', words: ["There", "is", "a", "picture", "on", "the", "wall", "."], correctSequence: ["There", "is", "a", "picture", "on", "the", "wall", "."] },
            { id: 'c2', words: ["There", "are", "some", "markers", "in", "the", "pencil case", "."], correctSequence: ["There", "are", "some", "markers", "in", "the", "pencil case", "."] },
            { id: 'c3', words: ["Are", "there", "any", "rats", "under", "the", "table", "?"], correctSequence: ["Are", "there", "any", "rats", "under", "the", "table", "?"] }
        ];

        const fillData = [
            { id: 'd1', text: "Room A: There is a book bag on the bed, but _____ a book bag on the bed in Room B.", options: ["there is", "there isn't", "there are"], correct: "there isn't" },
            { id: 'd2', text: "Room A: There are some books in Room A, but _____ in Room B.", options: ["there aren't any books", "there is no book", "there are some books"], correct: "there aren't any books" }
        ];

        const writingEData = [
            { id: 'e1', hint: "a fox / in the zoo", words: ["There", "is", "a", "fox", "in", "the", "zoo", "."], correctSequence: ["There", "is", "a", "fox", "in", "the", "zoo", "."] },
            { id: 'e2', hint: "two babies / on the bed", words: ["There", "are", "two", "babies", "on", "the", "bed", "."], correctSequence: ["There", "are", "two", "babies", "on", "the", "bed", "."] },
            { id: 'e3', hint: "four elephants / in the park", words: ["There", "are", "four", "elephants", "in", "the", "park", "."], correctSequence: ["There", "are", "four", "elephants", "in", "the", "park", "."] },
            { id: 'e4', hint: "many students / in the classroom", words: ["There", "are", "many", "students", "in", "the", "classroom", "."], correctSequence: ["There", "are", "many", "students", "in", "the", "classroom", "."] }
        ];

        const answeringFData = [
            { id: 'f1', q: "Is there a bug on the tree?", options: ["Yes, there is.", "No, there isn't.", "Yes, there are."], correct: "Yes, there is." },
            { id: 'f2', q: "Are there four horses on the farm?", options: ["Yes, there are.", "No, there aren't.", "No, there isn't."], correct: "No, there aren't." },
            { id: 'f3', q: "Are there any birds on the zebra's back?", options: ["Yes, there are.", "No, there aren't.", "Yes, it is."], correct: "No, there aren't." }
        ];

        const readingData = [
            { id: 'g1', q: "æ–‡ä¸­æåˆ°äº†å¹¾ç¨®å‹•ç‰© (animal species)?", options: ["four (4)", "five (5)", "six (6)"], correct: "six (6)" },
            { id: 'g2', q: "Mountain Bongo çš„çš®æ¯›æ˜¯ä»€éº¼é¡è‰²?", options: ["black (é»‘)", "brown (æ£•)", "grey (ç°)"], correct: "brown (æ£•)" }
        ];

        // --- STATE ---
        const defaultState = {
            attempts: {},
            answeredInRound: {},
            // Track selections before checking
            currentSelection: {} 
        };
        let state = JSON.parse(JSON.stringify(defaultState));
        let voice = null;
        let radarChartInstance = null;
        let barChartInstance = null;
        let audioCtx = null;

        // --- GLOBAL RESET FUNCTION ---
        window.resetSection = function(prefix) {
            if(confirm(`ç¢ºå®šè¦é‡æ–°æŒ‘æˆ° ${prefix.toUpperCase()} å¤§é¡Œå—ï¼Ÿ`)) {
                Object.keys(state.answeredInRound).forEach(key => {
                    if(key.startsWith(prefix)) delete state.answeredInRound[key];
                });
                // Clear selections for this section
                Object.keys(state.currentSelection).forEach(key => {
                    if(key.startsWith(prefix)) delete state.currentSelection[key];
                });
                window.app.saveState();
                window.app.refreshUI();
            }
        };

        // --- APP ---
        window.app = {
            init() {
                try {
                    this.initAudio();
                    this.loadState();
                    this.initVoice();
                    this.renderNav();
                    this.renderCharts();
                    
                    this.renderVocabA(); 
                    this.renderChoice();
                    this.renderUnscramble();
                    this.renderFill();
                    this.renderWritingE();
                    this.renderAnsweringF();
                    this.renderReading();

                    this.setupTabs();
                    window.speechSynthesis.onvoiceschanged = () => this.initVoice();
                    this.navigate('dashboard');
                } catch (e) {
                    console.error("Init Error:", e);
                }
            },

            initAudio() {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (AudioContext) audioCtx = new AudioContext();
            },

            playSound(type) {
                if (!audioCtx) return;
                if (audioCtx.state === 'suspended') audioCtx.resume();
                
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain);
                gain.connect(audioCtx.destination);

                if (type === 'correct') {
                    // Ding: High sine wave
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(600, audioCtx.currentTime);
                    osc.frequency.exponentialRampToValueAtTime(1000, audioCtx.currentTime + 0.1);
                    gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
                    osc.start();
                    osc.stop(audioCtx.currentTime + 0.5);
                } else {
                    // Wrong: Low saw wave
                    osc.type = 'sawtooth';
                    osc.frequency.setValueAtTime(150, audioCtx.currentTime);
                    osc.frequency.linearRampToValueAtTime(100, audioCtx.currentTime + 0.3);
                    gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
                    gain.gain.linearRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                    osc.start();
                    osc.stop(audioCtx.currentTime + 0.3);
                }
            },

            initVoice() {
                const voices = window.speechSynthesis.getVoices();
                this.voice = voices.find(v => v.name.includes('Google US English')) || 
                             voices.find(v => v.name.includes('Zira')) ||
                             voices.find(v => v.lang === 'en-US');
            },

            loadState() {
                const s = localStorage.getItem('u6_final_state');
                if (s) state = JSON.parse(s);
                if (!state.answeredInRound) state.answeredInRound = {};
                if (!state.currentSelection) state.currentSelection = {};
            },

            saveState() {
                localStorage.setItem('u6_final_state', JSON.stringify(state));
                this.updateCharts();
            },

            hardReset() {
                if(confirm("è­¦å‘Šï¼šé€™æœƒæ¸…é™¤æ‰€æœ‰æ­·å²æˆç¸¾ã€‚ç¢ºå®šå—ï¼Ÿ")) {
                    state = JSON.parse(JSON.stringify(defaultState));
                    this.saveState();
                    location.reload();
                }
            },

            renderNav() {
                const views = [
                    { id: 'dashboard', label: 'ğŸ“Š å„€è¡¨æ¿' },
                    { id: 'section-a', label: 'A. å–®å­—' },
                    { id: 'section-b', label: 'B-D. æ–‡æ³•' },
                    { id: 'section-e', label: 'E-G. ç¶œåˆ' }
                ];
                const dNav = document.getElementById('desktop-nav');
                const mNav = document.getElementById('mobile-menu');
                dNav.innerHTML = ''; mNav.innerHTML = '';

                views.forEach(v => {
                    const btn = document.createElement('button');
                    btn.className = `px-4 py-2 rounded-lg text-gray-600 hover:bg-gray-100 font-bold transition-all whitespace-nowrap nav-btn mr-1`;
                    btn.innerText = v.label;
                    btn.dataset.target = v.id;
                    btn.onclick = () => this.navigate(v.id);
                    dNav.appendChild(btn);

                    const mBtn = document.createElement('button');
                    mBtn.className = `w-full text-left px-4 py-3 border-b border-gray-100 text-gray-700 font-medium active:bg-gray-50`;
                    mBtn.innerText = v.label;
                    mBtn.onclick = () => {
                        this.navigate(v.id);
                        document.getElementById('mobile-menu').classList.add('hidden');
                    };
                    mNav.appendChild(mBtn);
                });
            },

            navigate(viewId) {
                document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
                document.getElementById('view-' + viewId).classList.remove('hidden');
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    if (btn.dataset.target === viewId) btn.classList.add('nav-active');
                    else btn.classList.remove('nav-active');
                });
                window.scrollTo(0,0);
                if(viewId === 'dashboard') this.updateCharts();
            },

            isLocked(id) { return !!state.answeredInRound[id]; },

            recordAttempt(id, isCorrect) {
                state.answeredInRound[id] = true;
                if (!state.attempts[id]) state.attempts[id] = { count: 0, firstCorrect: false, bestCorrect: false };
                const rec = state.attempts[id];
                rec.count++;
                if (isCorrect) {
                    if (rec.count === 1) rec.firstCorrect = true;
                    rec.bestCorrect = true;
                }
                this.saveState();
                return { isCorrect };
            },

            getSectionStats(prefix) {
                let total = 0, first = 0, best = 0;
                const count = (dataset, p) => {
                    dataset.forEach(item => {
                        if (item.id.startsWith(p)) {
                            total++;
                            if (state.attempts[item.id]?.firstCorrect) first++;
                            if (state.attempts[item.id]?.bestCorrect) best++;
                        }
                    });
                };
                if (prefix === 'a') count(vocabData, 'a');
                if (prefix === 'b') count(choiceData, 'b');
                if (prefix === 'c') count(unscrambleData, 'c');
                if (prefix === 'd') fillData.forEach(i => { total++; if(state.attempts[i.id]?.firstCorrect) first++; if(state.attempts[i.id]?.bestCorrect) best++; }); 
                if (prefix === 'e') count(writingEData, 'e');
                if (prefix === 'f') count(answeringFData, 'f');
                if (prefix === 'g') count(readingData, 'g');
                return { total, first, best, firstPct: total ? (first/total)*100 : 0, bestPct: total ? (best/total)*100 : 0 };
            },

            renderCharts() {
                const radarCtx = document.getElementById('radarChart').getContext('2d');
                radarChartInstance = new Chart(radarCtx, {
                    type: 'radar',
                    data: {
                        labels: ['A. å–®å­—', 'B. é¸æ“‡', 'C. é‡çµ„', 'D. å¡«å……', 'E. é€ å¥', 'F. å•ç­”', 'G. é–±è®€'],
                        datasets: [
                            { label: 'ç¬¬ä¸€æ¬¡æˆç¸¾ %', data: [0,0,0,0,0,0,0], borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.2)' },
                            { label: 'æœ€ä½³æˆç¸¾ %', data: [0,0,0,0,0,0,0], borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.2)' }
                        ]
                    },
                    options: { responsive: true, maintainAspectRatio: false, scales: { r: { min: 0, max: 100, ticks: { stepSize: 20 } } } }
                });

                const barCtx = document.getElementById('barChart').getContext('2d');
                barChartInstance = new Chart(barCtx, {
                    type: 'bar',
                    data: {
                        labels: ['ç¬¬ä¸€æ¬¡ç¸½åˆ†', 'æœ€ä½³ç¸½åˆ†'],
                        datasets: [{ label: 'å¾—åˆ†', data: [0, 0], backgroundColor: ['#3b82f6', '#10b981'] }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
                });
            },

            updateCharts() {
                if(!radarChartInstance) return;
                const sections = ['a', 'b', 'c', 'd', 'e', 'f', 'g'];
                const stats = sections.map(s => this.getSectionStats(s));
                radarChartInstance.data.datasets[0].data = stats.map(s => s.firstPct);
                radarChartInstance.data.datasets[1].data = stats.map(s => s.bestPct);
                radarChartInstance.update();
                let totalFirst = stats.reduce((acc, s) => acc + s.first, 0);
                let totalBest = stats.reduce((acc, s) => acc + s.best, 0);
                let totalQs = stats.reduce((acc, s) => acc + s.total, 0);
                barChartInstance.data.datasets[0].data = [totalFirst, totalBest];
                barChartInstance.options.scales.y.max = totalQs;
                barChartInstance.update();
            },

            // --- Selection Handlers ---
            selectOption(id, value) {
                if (this.isLocked(id)) return;
                state.currentSelection[id] = value;
                this.speak(value, 'en-US'); // Pronounce on click
                this.saveState();
                this.refreshUI(); // Highlight selected
            },

            checkSelection(id, correctValue) {
                const selected = state.currentSelection[id];
                if (!selected) {
                    alert("è«‹å…ˆé¸æ“‡ä¸€å€‹ç­”æ¡ˆï¼");
                    return;
                }
                const isCorrect = (selected === correctValue);
                this.playSound(isCorrect ? 'correct' : 'wrong');
                this.recordAttempt(id, isCorrect);
                this.refreshUI();
            },

            // --- Renderers ---

            renderVocabA() {
                const container = document.getElementById('container-vocab-a');
                container.innerHTML = '';
                vocabData.forEach((item, idx) => {
                    const locked = this.isLocked(item.id);
                    const rec = state.attempts[item.id];
                    const selected = state.currentSelection[item.id];
                    
                    let bgClass = "bg-white", borderClass = "border-gray-100";
                    if (locked) {
                        if (rec && rec.bestCorrect && rec.firstCorrect) { bgClass = "bg-green-50"; borderClass = "border-green-200"; }
                        else if (rec && rec.bestCorrect) { bgClass = "bg-blue-50"; borderClass = "border-blue-200"; }
                        else { bgClass = "bg-red-50"; borderClass = "border-red-200"; }
                    }

                    const el = document.createElement('div');
                    el.className = `${bgClass} p-6 rounded-2xl shadow-sm border ${borderClass} flex flex-col items-center`;
                    
                    const btns = item.options.map(opt => {
                        let btnClass = "w-full py-2 px-4 rounded-lg border mb-2 font-bold text-lg transition-colors ";
                        if (locked) {
                            if (opt === item.word) btnClass += "bg-green-500 text-white border-green-600";
                            else if (opt === selected) btnClass += "bg-red-100 text-red-500 border-red-200"; // Wrong selection
                            else btnClass += "bg-gray-100 text-gray-400 opacity-50";
                        } else {
                            if (opt === selected) btnClass += "selected-option";
                            else btnClass += "bg-white border-orange-200 text-gray-700 hover:bg-orange-100";
                        }
                        return `<button class="${btnClass}" onclick="window.app.selectOption('${item.id}', '${opt}')" ${locked ? 'disabled' : ''}>${opt}</button>`;
                    }).join('');

                    const checkBtn = locked ? '' : `<button onclick="window.app.checkSelection('${item.id}', '${item.word}')" class="mt-2 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-lg transition-colors shadow">æª¢æŸ¥ (Check)</button>`;

                    el.innerHTML = `
                        <div class="text-6xl mb-4">${item.icon}</div>
                        <div class="w-full">${btns}</div>
                        ${checkBtn}
                    `;
                    container.appendChild(el);
                });
            },

            renderMultipleChoice(containerId, data, prefix) {
                const container = document.getElementById(containerId);
                container.innerHTML = '';
                data.forEach((item, idx) => {
                    const locked = this.isLocked(item.id);
                    const rec = state.attempts[item.id];
                    const selected = state.currentSelection[item.id];

                    let bgClass = "bg-white", borderClass = "border-gray-100";
                    if (locked) {
                        if (rec && rec.bestCorrect && rec.firstCorrect) { bgClass = "bg-green-50"; borderClass = "border-green-200"; }
                        else if (rec && rec.bestCorrect) { bgClass = "bg-blue-50"; borderClass = "border-blue-200"; }
                        else { bgClass = "bg-red-50"; borderClass = "border-red-200"; }
                    }

                    const el = document.createElement('div');
                    el.className = `${bgClass} p-6 rounded-2xl shadow-sm border ${borderClass} transition-colors`;
                    
                    const rawQ = item.q || item.text || "";
                    const displayText = rawQ.replace(/\(.*\)/, '_____');

                    const btns = item.options.map(opt => {
                        let btnClass = "w-full text-left px-5 py-3 rounded-xl border mb-2 font-medium transition-all ";
                        if (locked) {
                             if (opt === item.correct) btnClass += "bg-green-200 border-green-400 text-green-900";
                             else if (opt === selected) btnClass += "bg-red-100 border-red-300 text-red-800";
                             else btnClass += "opacity-40 border-transparent bg-gray-50";
                        } else {
                            if (opt === selected) btnClass += "selected-option";
                            else btnClass += "bg-white border-gray-200 hover:border-blue-300 hover:bg-blue-50";
                        }
                        // Use raw text for value to avoid quote issues in function call
                        return `<button class="${btnClass}" onclick="window.app.selectOption('${item.id}', '${opt.replace(/'/g, "\\'")}')" ${locked ? 'disabled' : ''}>${opt}</button>`;
                    }).join('');

                    const checkBtn = locked ? '' : `<button onclick="window.app.checkSelection('${item.id}', '${item.correct.replace(/'/g, "\\'")}')" class="mt-3 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition-colors shadow">æª¢æŸ¥ç­”æ¡ˆ</button>`;

                    el.innerHTML = `
                        <div class="flex justify-between mb-2">
                            <span class="bg-gray-200 px-2 py-1 rounded text-sm font-bold h-fit">${prefix}${idx+1}</span>
                            <button onclick="window.app.speak('${rawQ.replace(/'/g, "\\'")}', 'en-US')" class="tts-btn">ğŸ”Š</button>
                        </div>
                        <div class="text-xl font-bold text-gray-800 mb-4 leading-snug">${displayText}</div>
                        <div>${btns}</div>
                        <div class="text-right">${checkBtn}</div>
                    `;
                    container.appendChild(el);
                });
            },

            renderChoice() { this.renderMultipleChoice('container-choice', choiceData, 'Q'); },
            renderFill() { this.renderMultipleChoice('container-fill', fillData, 'Q'); },
            renderAnsweringF() { this.renderMultipleChoice('container-answering-f', answeringFData, 'Q'); },
            renderReading() { this.renderMultipleChoice('container-reading-g', readingData, 'Q'); },

            renderUnscrambleGeneric(containerId, data, prefix) {
                const container = document.getElementById(containerId);
                container.innerHTML = '';
                data.forEach((item, idx) => {
                    const locked = this.isLocked(item.id);
                    const rec = state.attempts[item.id];
                    let containerClass = "bg-white border-gray-100";
                    let feedback = "";

                    if (locked) {
                         if (rec && rec.bestCorrect) { containerClass = "bg-green-50 border-green-200"; feedback = "âœ… Correct!"; }
                         else { containerClass = "bg-red-50 border-red-200"; feedback = `âŒ Answer: ${item.correctSequence.join(' ')}`; }
                    }

                    const el = document.createElement('div');
                    el.className = `${containerClass} p-6 rounded-2xl shadow-sm border mb-4`;
                    const hintHtml = item.hint ? `<div class="mb-2 text-purple-700 font-bold text-sm bg-purple-100 p-1 rounded inline-block">Hint: ${item.hint}</div>` : '';

                    if (locked) {
                         el.innerHTML = `
                            <div class="flex justify-between items-center mb-2">
                                <span class="bg-gray-200 px-2 py-1 rounded text-sm font-bold">${prefix}${idx+1}</span>
                                <button onclick="window.app.speak('${item.correctSequence.join(' ').replace(/'/g, "\\'")}', 'en-US')" class="text-xs border px-2 py-1 rounded">ğŸ”Š Play Answer</button>
                            </div>
                            ${hintHtml}
                            <div class="font-bold text-gray-700 mt-2">${feedback}</div>
                        `;
                    } else {
                        const shuffled = [...item.words].sort(() => Math.random() - 0.5);
                        el.innerHTML = `
                            <div class="flex justify-between items-start mb-4">
                                <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-sm font-bold">${prefix}${idx+1}</span>
                                <button onclick="window.app.speak('${item.correctSequence.join(' ').replace(/'/g, "\\'")}', 'en-US')" class="text-xs bg-green-50 text-green-600 px-2 py-1 rounded border">ğŸ”Š Listen</button>
                            </div>
                            ${hintHtml}
                            <div id="zone-${item.id}" class="min-h-[60px] bg-gray-50 border-2 border-dashed border-gray-300 rounded-xl p-3 flex flex-wrap gap-2 mb-4"></div>
                            <div id="bank-${item.id}" class="flex flex-wrap gap-2 mb-4">
                                ${shuffled.map(w => `<button class="px-3 py-2 bg-white border text-gray-800 rounded shadow-sm font-bold active:scale-95" onclick="window.app.moveWord(this, '${item.id}')">${w}</button>`).join('')}
                            </div>
                            <div class="flex gap-2">
                                <button onclick="window.app.checkUnscramble('${item.id}', '${containerId === 'container-writing-e' ? 'E' : 'C'}')" class="flex-1 bg-green-600 text-white font-bold py-3 rounded-lg shadow hover:bg-green-700 transition-colors">æª¢æŸ¥</button>
                                <button onclick="window.app.refreshUI()" class="px-4 bg-gray-200 rounded-lg">â†º</button>
                            </div>
                        `;
                    }
                    container.appendChild(el);
                });
            },

            renderUnscramble() { this.renderUnscrambleGeneric('container-unscramble', unscrambleData, 'Q'); },
            renderWritingE() { this.renderUnscrambleGeneric('container-writing-e', writingEData, 'Q'); },

            moveWord(btn, id) {
                const zone = document.getElementById(`zone-${id}`);
                const bank = document.getElementById(`bank-${id}`);
                this.speak(btn.innerText, 'en-US'); // Speak on move
                
                if (btn.parentElement === bank) {
                    zone.appendChild(btn);
                    btn.className = "px-3 py-2 bg-blue-100 border-blue-300 text-blue-900 rounded font-bold";
                } else {
                    bank.appendChild(btn);
                    btn.className = "px-3 py-2 bg-white border text-gray-800 rounded shadow-sm font-bold";
                }
            },

            checkUnscramble(id, type) {
                const zone = document.getElementById(`zone-${id}`);
                const dataSet = type === 'E' ? writingEData : unscrambleData;
                const item = dataSet.find(i => i.id === id);
                const userWords = Array.from(zone.querySelectorAll('button')).map(b => b.innerText);
                const userStr = userWords.join(' ').replace(/[.,?!]/g, '').toLowerCase().trim();
                const correctStr = item.correctSequence.join(' ').replace(/[.,?!]/g, '').toLowerCase().trim();
                const isCorrect = (userStr === correctStr);
                
                this.playSound(isCorrect ? 'correct' : 'wrong');
                this.recordAttempt(id, isCorrect);
                this.refreshUI();
            },

            refreshUI() {
                this.renderVocabA();
                this.renderChoice();
                this.renderUnscramble();
                this.renderFill();
                this.renderWritingE();
                this.renderAnsweringF();
                this.renderReading();
                this.saveState(); 
            },

            setupTabs() {
                const setup = (tabClass, contentClass) => {
                    document.querySelectorAll(`.${tabClass}`).forEach(btn => {
                        btn.onclick = () => {
                            document.querySelectorAll(`.${tabClass}`).forEach(b => {
                                b.classList.remove('bg-blue-600', 'bg-purple-600', 'text-white');
                                b.classList.add('bg-gray-100', 'text-gray-600');
                            });
                            const targetId = btn.dataset.target;
                            if (tabClass === 'grammar-tab') btn.classList.add('bg-blue-600', 'text-white');
                            else btn.classList.add('bg-purple-600', 'text-white');
                            btn.classList.remove('bg-gray-100', 'text-gray-600');

                            document.querySelectorAll(`.${contentClass}`).forEach(c => c.classList.add('hidden'));
                            document.getElementById(targetId).classList.remove('hidden');
                        }
                    });
                };
                setup('grammar-tab', 'grammar-content');
                setup('lr-tab', 'lr-content');
            },

            speak(text, lang) {
                window.speechSynthesis.cancel();
                const u = new SpeechSynthesisUtterance(text);
                u.lang = lang;
                u.rate = 0.7;
                if (this.voice) u.voice = this.voice;
                window.speechSynthesis.speak(u);
            }
        };

        // Mobile Menu
        document.getElementById('mobile-menu-btn').onclick = () => {
            document.getElementById('mobile-menu').classList.toggle('hidden');
        };

        document.addEventListener('DOMContentLoaded', () => window.app.init());
    </script>
</body>
</html>
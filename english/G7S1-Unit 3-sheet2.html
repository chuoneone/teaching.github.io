<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>助動詞 can 文法練習</title>    
    <link rel="icon" href="dog.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f0f9ff;
        }
        .exercise-card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            padding: 24px;
            margin-bottom: 24px;
            transition: box-shadow 0.3s ease;
        }
        .section-header {
            background-color: #e0f2fe;
            color: #0c4a6e;
            padding: 16px 24px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        .example-box {
            background-color: #f8fafc;
            border-left: 4px solid #38bdf8;
            padding: 16px;
            border-radius: 0 8px 8px 0;
            margin-top: 12px;
            font-size: 1.05em;
        }
         .example-box p {
            margin-bottom: 4px;
        }
        .word-bank {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            padding: 12px;
            background-color: #f1f5f9;
            border-radius: 8px;
            min-height: 50px;
        }
        .drop-zone {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            padding: 12px;
            background-color: #ffffff;
            border: 2px dashed #94a3b8;
            border-radius: 8px;
            min-height: 50px;
            margin-top: 12px;
            transition: all 0.3s ease;
        }
        .word-item {
            padding: 8px 16px;
            background-color: #e0f2fe;
            border: 1px solid #7dd3fc;
            color: #075985;
            border-radius: 9999px;
            cursor: pointer;
            user-select: none;
            transition: all 0.2s ease;
            font-weight: 600;
        }
        .word-item:hover {
            background-color: #bae6fd;
            transform: scale(1.05);
        }
        .speaker-icon {
            cursor: pointer;
            display: inline-block;
            margin-left: 8px;
            color: #3b82f6;
            font-size: 1.2em;
            vertical-align: middle;
        }
        #tooltip {
            position: absolute;
            display: none;
            background-color: #1f2937;
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.9em;
            pointer-events: none;
            z-index: 100;
        }
        .drop-zone.correct, .selection-feedback.correct {
            border-color: #22c55e;
            background-color: #f0fdf4;
        }
        .drop-zone.incorrect, .selection-feedback.incorrect {
            border-color: #ef4444;
            background-color: #fef2f2;
        }
        .question-text {
             font-size: 1.1em;
        }
        .selection-btn {
            background-color: #f1f5f9;
            border: 1px solid #cbd5e1;
            transition: all 0.2s ease;
        }
        .selection-btn.selected {
            background-color: #bfdbfe;
            border-color: #3b82f6;
            color: #1e40af;
        }

        @keyframes card-correct-glow {
            0% { box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); }
            50% { box-shadow: 0 8px 30px rgba(34, 197, 94, 0.4); }
            100% { box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); }
        }

        .card-glow-animation {
            animation: card-correct-glow 1s ease-out;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div id="tooltip"></div>

    <div class="max-w-4xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-blue-800">Unit 3 Grammar Focus 2</h1>
            <p class="text-slate-600 mt-2">(搭配課本P.58)</p>
        </header>

        <div id="exercise-container">
            <!-- Exercises will be rendered here by JavaScript -->
        </div>
    </div>

    <script>
        const translations = {
            'I': '我', 'can': '可以', 'keep': '保持', 'quiet': '安靜', 'in': '在', 'the': '這個',
            'museum': '博物館', 'you': '你', 'read': '閱讀', 'books': '書本', 'library': '圖書館',
            'students': '學生們', 'use': '使用', 'cellphones': '手機', 'their': '他們的', 'bedrooms': '臥室',
            'she': '她', 'open': '打開', 'windows': '窗戶', 'now': '現在', 'Can': '可以...嗎?',
            'Yes': '是的', 'No': '不', 'they': '他們', "can't": '不行',
        };

        const exercisesBySection = {
            "一": {
                title: "請依提示，加入can寫出肯定句",
                type: "scramble",
                example: { q: "I / keep quiet(保持安靜) in the museum", a: "I can keep quiet in the museum." },
                questions: [
                    { id: 's1q1', question: "you / read books in the library", answer: "You can read books in the library.", chunks: ["You", "can", "read books", "in the library", "."] },
                    { id: 's1q2', question: "students / use cellphones in their bedrooms", answer: "Students can use cellphones in their bedrooms.", chunks: ["Students", "can", "use cellphones", "in their bedrooms", "."]},
                    { id: 's1q3', question: "she / open the windows now", answer: "She can open the windows now.", chunks: ["She", "can", "open the windows", "now", "."] }
                ]
            },
            "二": {
                title: "請將第一大題改為can開頭的疑問句",
                type: "scramble",
                example: { q: "I can keep quiet in the museum.", a: "Can I keep quiet in the museum?" },
                questions: [
                    { id: 's2q1', question: "You can read books in the library.", answer: "Can you read books in the library?", chunks: ["Can", "you", "read books", "in the library", "?"] },
                    { id: 's2q2', question: "Students can use cellphones in their bedrooms.", answer: "Can students use cellphones in their bedrooms?", chunks: ["Can", "students", "use cellphones", "in their bedrooms", "?"]},
                    { id: 's2q3', question: "She can open the windows now.", answer: "Can she open the windows now?", chunks: ["Can", "she", "open the windows", "now", "?"] }
                ]
            },
            "三": {
                title: "請依第二大題的問句寫出答句",
                type: "selection",
                questions: [
                    { id: 's3q1', question: "Can you read books in the library?", affirmative_answer: "Yes, I can.", negative_answer: "No, I can't.", choices: ["Yes, I can.", "Yes, they can.", "No, I can't.", "No, they can't."]},
                    { id: 's3q2', question: "Can students use cellphones in their bedrooms?", affirmative_answer: "Yes, they can.", negative_answer: "No, they can't.", choices: ["Yes, she can.", "Yes, they can.", "No, she can't.", "No, they can't."]},
                    { id: 's3q3', question: "Can she open the windows now?", affirmative_answer: "Yes, she can.", negative_answer: "No, she can't.", choices: ["Yes, she can.", "Yes, you can.", "No, she can't.", "No, you can't."]}
                ]
            }
        };

        const synth = window.speechSynthesis;

        function speak(text) {
            synth.cancel();
            if (text) {
                const utterThis = new SpeechSynthesisUtterance(text.replace(/[.,?\/]/g, ''));
                utterThis.lang = 'en-US';
                utterThis.rate = 0.8;
                synth.speak(utterThis);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const container = document.getElementById('exercise-container');
            
            Object.entries(exercisesBySection).forEach(([sectionNum, sectionData]) => {
                const sectionDiv = document.createElement('div');
                
                const header = document.createElement('div');
                header.className = 'section-header';
                header.innerHTML = `<h2 class="text-2xl font-bold">${sectionNum}、${sectionData.title}</h2>`;
                
                if(sectionData.example){
                    const exampleBox = document.createElement('div');
                    exampleBox.className = 'example-box';
                    exampleBox.innerHTML = 
                        `<p class="text-gray-800"><b>例：</b>${sectionData.example.q} ${createSpeakerIcon(sectionData.example.q)}</p>` +
                        `<p class="text-blue-600 font-semibold">→ ${sectionData.example.a} ${createSpeakerIcon(sectionData.example.a)}</p>`;
                    header.appendChild(exampleBox);
                }
                sectionDiv.appendChild(header);

                sectionData.questions.forEach((ex, index) => {
                    if (sectionData.type === 'scramble') {
                        sectionDiv.appendChild(createScrambleCard(ex, index + 1));
                    } else if (sectionData.type === 'selection') {
                        sectionDiv.appendChild(createSelectionCard(ex, index + 1));
                    }
                });
                container.appendChild(sectionDiv);
            });

            addEventListeners();
        });

        function createScrambleCard(ex, displayNum) {
            const card = document.createElement('div');
            card.className = 'exercise-card';
            card.id = `exercise-${ex.id}`;
            const words = ex.chunks || ex.answer.split(/([,.]|\s+)/).filter(w => w.trim());
            
            card.innerHTML = `
                <div class="flex items-center mb-2">
                    <p class="mr-2 text-lg font-bold">${displayNum}.</p>
                    <div class="question-text">${ex.question}</div>
                    ${createSpeakerIcon(ex.question.replace(/\//g, ''))}
                </div>
                <div class="word-bank mt-4">
                    ${[...words].sort(() => Math.random() - 0.5).map(word => `<div class="word-item">${word}</div>`).join('')}
                </div>
                <div class="drop-zone mt-3"></div>
                <div class="flex flex-wrap gap-3 mt-4">
                    <button class="check-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded" data-answer='${ex.answer}' data-id="${ex.id}">檢查答案</button>
                    <button class="reset-btn bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded" data-id="${ex.id}">重新作答</button>
                    <button class="hint-btn bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded" data-speak-hint="${ex.answer}">💡 提示 (聽答案)</button>
                </div>
                <p class="feedback mt-2 text-sm font-bold"></p>
            `;
            return card;
        }
        
        function createSelectionCard(ex, displayNum) {
            const card = document.createElement('div');
            card.className = 'exercise-card';
            card.id = `exercise-${ex.id}`;

            card.innerHTML = `
                <div class="flex items-center mb-4">
                    <p class="mr-2 text-lg font-bold">${displayNum}.</p>
                    <div class="question-text">${ex.question}</div>
                     ${createSpeakerIcon(ex.question)}
                </div>

                <div class="space-y-4">
                    <div>
                        <p class="font-semibold mb-2">(a) 肯定簡答</p>
                        <div class="flex flex-wrap gap-3 affirmative-choices">
                            ${ex.choices.filter(c => c.startsWith("Yes")).map(choice => `<button class="selection-btn font-semibold py-2 px-4 rounded-lg">${choice}</button>`).join('')}
                        </div>
                         <div class="selection-feedback p-2 rounded-lg mt-2 border-2 border-transparent"></div>
                    </div>
                    <div>
                        <p class="font-semibold mb-2">(b) 否定簡答</p>
                        <div class="flex flex-wrap gap-3 negative-choices">
                           ${ex.choices.filter(c => c.startsWith("No")).map(choice => `<button class="selection-btn font-semibold py-2 px-4 rounded-lg">${choice}</button>`).join('')}
                        </div>
                        <div class="selection-feedback p-2 rounded-lg mt-2 border-2 border-transparent"></div>
                    </div>
                </div>
                 <div class="flex gap-3 mt-4">
                    <button class="check-selection-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded" 
                        data-id="${ex.id}" 
                        data-affirmative-answer="${ex.affirmative_answer}" 
                        data-negative-answer="${ex.negative_answer}">
                        檢查答案
                    </button>
                 </div>
                 <p class="feedback-all mt-2 text-sm font-bold"></p>
            `;
            return card;
        }


        function addEventListeners() {
            const tooltip = document.getElementById('tooltip');
            document.body.addEventListener('mouseover', e => {
                const item = e.target.closest('.word-item');
                if (item) {
                    const text = item.textContent.trim();
                    const chinese = translations[text];
                    if (chinese) {
                        tooltip.textContent = chinese;
                        tooltip.style.display = 'block';
                    }
                }
            });
            document.body.addEventListener('mousemove', e => {
                if (tooltip.style.display === 'block') {
                    tooltip.style.left = `${e.pageX + 10}px`;
                    tooltip.style.top = `${e.pageY + 10}px`;
                }
            });
            document.body.addEventListener('mouseout', e => {
                if (e.target.closest('.word-item')) tooltip.style.display = 'none';
            });

            document.body.addEventListener('click', e => {
                const target = e.target;
                if (target.classList.contains('speaker-icon')) {
                    e.stopPropagation();
                    speak(target.dataset.speak);
                } else if (target.classList.contains('hint-btn')) {
                    speak(target.dataset.speakHint);
                } else if (target.classList.contains('word-item')) {
                    const card = target.closest('.exercise-card');
                    const wordBank = card.querySelector('.word-bank');
                    const dropZone = card.querySelector('.drop-zone');
                    if (target.parentElement === wordBank) {
                        speak(target.textContent);
                        dropZone.appendChild(target);
                    } else {
                        wordBank.appendChild(target);
                    }
                } else if (target.classList.contains('check-btn')) {
                    checkScrambleAnswer(target);
                } else if (target.classList.contains('reset-btn')) {
                    resetScrambleQuestion(target);
                } else if (target.classList.contains('selection-btn')) {
                    const parent = target.parentElement;
                    parent.querySelectorAll('.selection-btn').forEach(btn => btn.classList.remove('selected'));
                    target.classList.add('selected');
                    speak(target.textContent);
                } else if (target.classList.contains('check-selection-btn')) {
                    checkSelectionAnswer(target);
                }
            });
        }
        
        function checkScrambleAnswer(btn) {
            const exId = btn.dataset.id;
            const card = document.getElementById(`exercise-${exId}`);
            const dropZone = card.querySelector('.drop-zone');
            const feedbackEl = card.querySelector('.feedback');
            const words = Array.from(dropZone.children).map(child => child.textContent);
            const userAnswer = words.join(' ').replace(/ ,/g,',').replace(/ \./g,'.').replace(/ \?/g, '?');
            const correctAnswer = btn.dataset.answer;

            if (userAnswer === correctAnswer) {
                feedbackEl.textContent = '🎉 太棒了，答對了！';
                feedbackEl.className = 'feedback mt-2 text-sm font-bold text-green-600';
                dropZone.classList.remove('incorrect');
                dropZone.classList.add('correct');
                card.classList.add('card-glow-animation');
                setTimeout(() => card.classList.remove('card-glow-animation'), 1000);
            } else {
                feedbackEl.textContent = '🤔 再試一次看看！';
                feedbackEl.className = 'feedback mt-2 text-sm font-bold text-red-600';
                dropZone.classList.add('incorrect');
                dropZone.classList.remove('correct');
            }
        }

        function resetScrambleQuestion(btn) {
            const exId = btn.dataset.id;
            const card = document.getElementById(`exercise-${exId}`);
            const dropZone = card.querySelector('.drop-zone');
            const wordBank = card.querySelector('.word-bank');
            const feedbackEl = card.querySelector('.feedback');
            
            Array.from(dropZone.children).forEach(child => wordBank.appendChild(child));
            
            feedbackEl.textContent = '';
            dropZone.classList.remove('correct', 'incorrect');
        }
        
        function checkSelectionAnswer(btn) {
            const exId = btn.dataset.id;
            const card = document.getElementById(`exercise-${exId}`);
            const feedbackAllEl = card.querySelector('.feedback-all');

            const affChoices = card.querySelector('.affirmative-choices');
            const negChoices = card.querySelector('.negative-choices');
            
            const selectedAff = affChoices.querySelector('.selected');
            const selectedNeg = negChoices.querySelector('.selected');

            const affFeedback = affChoices.nextElementSibling;
            const negFeedback = negChoices.nextElementSibling;
            
            let affCorrect = false;
            let negCorrect = false;

            if(selectedAff) {
                if (selectedAff.textContent === btn.dataset.affirmativeAnswer) {
                    affFeedback.textContent = "正確！";
                    affFeedback.className = "selection-feedback p-2 rounded-lg mt-2 border-2 text-green-700 correct";
                    affCorrect = true;
                } else {
                    affFeedback.textContent = "錯誤！";
                    affFeedback.className = "selection-feedback p-2 rounded-lg mt-2 border-2 text-red-700 incorrect";
                }
            } else {
                 affFeedback.textContent = "請選擇一個答案";
                 affFeedback.className = "selection-feedback p-2 rounded-lg mt-2 border-2 text-gray-500 border-gray-300";
            }
            
             if(selectedNeg) {
                if (selectedNeg.textContent === btn.dataset.negativeAnswer) {
                    negFeedback.textContent = "正確！";
                    negFeedback.className = "selection-feedback p-2 rounded-lg mt-2 border-2 text-green-700 correct";
                    negCorrect = true;
                } else {
                    negFeedback.textContent = "錯誤！";
                    negFeedback.className = "selection-feedback p-2 rounded-lg mt-2 border-2 text-red-700 incorrect";
                }
            } else {
                 negFeedback.textContent = "請選擇一個答案";
                 negFeedback.className = "selection-feedback p-2 rounded-lg mt-2 border-2 text-gray-500 border-gray-300";
            }
            
            if(affCorrect && negCorrect) {
                 feedbackAllEl.textContent = '🎉 太棒了，全部答對了！';
                 feedbackAllEl.className = 'feedback-all mt-2 text-sm font-bold text-green-600';
                 card.classList.add('card-glow-animation');
                 setTimeout(() => card.classList.remove('card-glow-animation'), 1000);
            } else {
                feedbackAllEl.textContent = '🤔 有些答案需要再檢查一下喔！';
                feedbackAllEl.className = 'feedback-all mt-2 text-sm font-bold text-red-600';
            }
        }

        function createSpeakerIcon(textToSpeak) {
            const safeText = textToSpeak.replace(/<[^>]*>/g, '').replace(/"/g, '&quot;').replace(/\//g, '');
            return `<span class="speaker-icon" data-speak="${safeText}">🔊</span>`;
        }
    </script>
</body>
</html>


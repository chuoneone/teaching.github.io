<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸ƒä¸Šç¬¬ä¸‰æ¬¡æ®µè€ƒç¿’ä½œå¿…è€ƒé¡Œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #FDFBF7;
            color: #4A4A4A;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        .nav-item.active {
            background-color: #E6F0EB;
            color: #2D5B45;
            border-bottom: 3px solid #2D5B45;
        }

        .chart-container {
            position: relative;
            width: 100%;
            max-width: 700px;
            height: 350px;
            margin: 0 auto;
        }

        @media (min-width: 768px) {
            .chart-container { height: 400px; }
        }

        .option-btn { transition: all 0.2s; }
        .option-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            background-color: #F0F9FF;
            border-color: #3B82F6;
        }
        .option-correct {
            background-color: #DCFCE7 !important;
            border-color: #22C55E !important;
            color: #166534 !important;
            font-weight: bold;
        }
        .option-wrong {
            background-color: #FEE2E2 !important;
            border-color: #EF4444 !important;
            color: #991B1B !important;
        }
        
        .stat-card {
            border-radius: 1.5rem;
            padding: 1.25rem;
            border: 1px solid rgba(0,0,0,0.05);
            transition: transform 0.2s;
        }

        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .item-locked {
            pointer-events: none;
            opacity: 0.85;
        }

        .correct-answer-reveal {
            border-left: 4px solid #22C55E;
            background-color: #F0FDF4;
            color: #166534;
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-weight: 500;
            margin-top: 1rem;
            font-size: 0.875rem;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <nav class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <span class="text-2xl font-bold text-gray-800 tracking-tight">ğŸ“˜ ä¸ƒä¸Šç¬¬ä¸‰æ¬¡æ®µè€ƒ<span class="text-green-600">ç¿’ä½œå¿…è€ƒé¡Œ</span></span>
                </div>
                <div class="flex space-x-2 items-center overflow-x-auto">
                    <button onclick="switchTab('dashboard')" id="tab-dashboard" class="nav-item active px-4 py-2 rounded-md text-sm font-medium transition-colors whitespace-nowrap">å­¸ç¿’åˆ†æ Dashboard</button>
                    <button onclick="switchTab('vocab')" id="tab-vocab" class="nav-item px-4 py-2 rounded-md text-sm font-medium transition-colors whitespace-nowrap">å–®å­—ç·´ç¿’</button>
                    <button onclick="switchTab('zoo')" id="tab-zoo" class="nav-item px-4 py-2 rounded-md text-sm font-medium transition-colors whitespace-nowrap">å‹•ç‰©è¾¨è­˜</button>
                    <button onclick="switchTab('grammar')" id="tab-grammar" class="nav-item px-4 py-2 rounded-md text-sm font-medium transition-colors whitespace-nowrap">å¥å­é‡çµ„</button>
                </div>
            </div>
        </div>
    </nav>

    <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full">

        <!-- DASHBOARD VIEW -->
        <div id="view-dashboard" class="tab-content active space-y-8 fade-in">
            <header class="text-center mb-6">
                <h1 class="text-3xl font-extrabold text-gray-900 mb-2">è‹±èªæˆé•·æ•¸æ“šåˆ†æ</h1>
                <p class="text-gray-600">é€éé•·æ¢åœ–æ¯”è¼ƒå„é¡åˆ¥çš„ã€Œé¦–æ¬¡å¾—åˆ†ã€èˆ‡ã€Œæœ€é«˜ç´€éŒ„ã€ã€‚</p>
            </header>

            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                <!-- Summary Cards -->
                <div class="lg:col-span-1 space-y-4">
                    <div class="stat-card bg-white shadow-sm">
                        <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">æ•´é«”é¦–æ¸¬å¹³å‡</p>
                        <h2 class="text-3xl font-black text-gray-800 mt-1" id="overall-first">0%</h2>
                    </div>
                    <div class="stat-card bg-green-600 text-white shadow-md">
                        <p class="text-[10px] font-bold opacity-80 uppercase tracking-widest">ç›®å‰æœ€ä½³è¡¨ç¾</p>
                        <h2 class="text-4xl font-black mt-1" id="overall-best">0%</h2>
                        <p class="text-[10px] mt-4 opacity-75">æ•¸æ“šæ¡è¨ˆè‡ªç¬¬ä¸€æ¬¡ä½œç­”çš„æ­£ç¢ºç‡ã€‚</p>
                    </div>
                    <div class="stat-card bg-white border border-gray-100">
                        <h3 class="text-xs font-bold text-gray-400 mb-4 uppercase">é€²åº¦çµ±è¨ˆ</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-xs">å–®å­—æ¸¬é©—</span>
                                <span class="font-bold text-xs" id="p-v">0/6</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-xs">å‹•ç‰©è¾¨è­˜</span>
                                <span class="font-bold text-xs" id="p-z">0/8</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-xs">å¥å­é‡çµ„</span>
                                <span class="font-bold text-xs" id="p-g">0/3</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bar Chart Section -->
                <div class="lg:col-span-3 glass-panel p-6 rounded-3xl">
                    <h3 class="text-lg font-bold text-gray-800 mb-6 text-center">å„é¡Œå‹èƒ½åŠ›æˆé•·åˆ†å¸ƒ (é¦–æ¬¡ vs æœ€ä½³)</h3>
                    <div class="chart-container">
                        <canvas id="growthBarChart"></canvas>
                    </div>
                    <div class="mt-6 flex justify-center gap-6 text-[10px] font-bold">
                        <div class="flex items-center gap-2"><span class="w-4 h-3 bg-gray-300 rounded"></span> é¦–æ¬¡ä½œç­” (Initial)</div>
                        <div class="flex items-center gap-2"><span class="w-4 h-3 bg-green-500 rounded"></span> æœ€ä½³æˆç¸¾ (Best)</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- EXERCISE VIEWS -->
        <div id="view-vocab" class="tab-content fade-in">
            <div class="mb-8 border-b pb-4 border-gray-200 flex justify-between items-end">
                <div>
                    <h2 class="text-3xl font-bold text-gray-800">å–®å­—é¸æ“‡é¡Œ (ä¸€è©¦å®šå‹è² )</h2>
                    <p class="text-gray-600 mt-2">é»æ“Š ğŸ”Š è½ç™¼éŸ³ã€‚æ³¨æ„ï¼šä½œç­”å¾Œå³é–å®šä¸¦è¨˜éŒ„é¦–æ¸¬åˆ†æ•¸ã€‚</p>
                </div>
                <button onclick="resetCurrentSession('vocab')" class="text-xs bg-red-50 text-red-500 px-6 py-2 rounded-full font-bold hover:bg-red-100 transition-colors">â†º é‡æ–°ç·´ç¿’ (é¸é …éš¨æ©Ÿé‡æ’)</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="vocab-container"></div>
        </div>

        <div id="view-zoo" class="tab-content fade-in">
            <div class="mb-8 border-b pb-4 border-gray-200 flex justify-between items-end">
                <div>
                    <h2 class="text-3xl font-bold text-gray-800">å‹•ç‰©å–®å­—è¾¨è­˜ (ä¸€è©¦å®šå‹è² )</h2>
                    <p class="text-gray-600 mt-2">è§€å¯Ÿåœ–ç¤ºï¼Œé¸å‡ºæ­£ç¢ºåç¨±ã€‚ä½œç­”å¾Œå°‡è‡ªå‹•é¡¯ç¤ºç­”æ¡ˆã€‚</p>
                </div>
                <button onclick="resetCurrentSession('zoo')" class="text-xs bg-red-50 text-red-500 px-6 py-2 rounded-full font-bold hover:bg-red-100 transition-colors">â†º é‡æ–°ç·´ç¿’ (é¸é …éš¨æ©Ÿé‡æ’)</button>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-6" id="zoo-container"></div>
        </div>

        <div id="view-grammar" class="tab-content fade-in">
            <div class="mb-8 border-b pb-4 border-gray-200 flex justify-between items-end">
                <div>
                    <h2 class="text-3xl font-bold text-gray-800">å¥å­é‡çµ„å·¥å»  (ä¸€è©¦å®šå‹è² )</h2>
                    <p class="text-gray-600 mt-2">æŒ‰ä¸‹æª¢æŸ¥å¾Œï¼Œç³»çµ±å°‡æ ¹æ“šé †åºè¨ˆåˆ†ä¸¦é–å®šé¡Œç›®ã€‚</p>
                </div>
                <button onclick="resetCurrentSession('grammar')" class="text-xs bg-red-50 text-red-500 px-6 py-2 rounded-full font-bold hover:bg-red-100 transition-colors">â†º é‡æ–°ç·´ç¿’ (å–®å­—éš¨æ©Ÿé‡æ’)</button>
            </div>
            <div class="space-y-8" id="grammar-container"></div>
        </div>

    </main>

    <script>
        const config = {
            vocab: [
                { id: 1, sentence: "September 28 is Confuciusâ€™ birthday.", blank: "September 28 is Confuciusâ€™ ______.", answer: "birthday", options: ["birthday", "animal", "third", "holiday"], status: null, scoreEligible: true, completed: false, userChoice: null },
                { id: 2, sentence: "My family and friends are important to me.", blank: "My family and friends are ______ to me.", answer: "important", options: ["important", "animal", "turkey", "birthday"], status: null, scoreEligible: true, completed: false, userChoice: null },
                { id: 3, sentence: "A cow is an animal.", blank: "A cow is an ______.", answer: "animal", options: ["holiday", "animal", "third", "important"], status: null, scoreEligible: true, completed: false, userChoice: null },
                { id: 4, sentence: "Our Christmas dinner is a big turkey.", blank: "Our Christmas dinner is a big ______.", answer: "turkey", options: ["birthday", "turkey", "third", "animal"], status: null, scoreEligible: true, completed: false, userChoice: null },
                { id: 5, sentence: "Motherâ€™s Day is a holiday.", blank: "Motherâ€™s Day is a ______.", answer: "holiday", options: ["important", "holiday", "birthday", "turkey"], status: null, scoreEligible: true, completed: false, userChoice: null },
                { id: 6, sentence: "Lisa is the third person in the line.", blank: "Lisa is the ______ person in the line.", answer: "third", options: ["third", "animal", "holiday", "important"], status: null, scoreEligible: true, completed: false, userChoice: null }
            ],
            zoo: [
                { id: 1, icon: "ğŸ˜", name: "Elephant", options: ["Elephant", "Lion", "Tiger", "Fox"], status: null, scoreEligible: true, completed: false, userChoice: null },
                { id: 2, icon: "ğŸ¦", name: "Lion", options: ["Bear", "Lion", "Horse", "Zebra"], status: null, scoreEligible: true, completed: false, userChoice: null },
                { id: 3, icon: "ğŸ»", name: "Bear", options: ["Monkey", "Zebra", "Bear", "Lion"], status: null, scoreEligible: true, completed: false, userChoice: null },
                { id: 4, icon: "ğŸ¦“", name: "Zebra", options: ["Horse", "Zebra", "Elephant", "Fox"], status: null, scoreEligible: true, completed: false, userChoice: null },
                { id: 5, icon: "ğŸ’", name: "Monkey", options: ["Monkey", "Tiger", "Bear", "Horse"], status: null, scoreEligible: true, completed: false, userChoice: null },
                { id: 6, icon: "ğŸ¦Š", name: "Fox", options: ["Fox", "Elephant", "Zebra", "Monkey"], status: null, scoreEligible: true, completed: false, userChoice: null },
                { id: 7, icon: "ğŸ´", name: "Horse", options: ["Tiger", "Horse", "Lion", "Bear"], status: null, scoreEligible: true, completed: false, userChoice: null },
                { id: 8, icon: "ğŸ¯", name: "Tiger", options: ["Elephant", "Fox", "Tiger", "Zebra"], status: null, scoreEligible: true, completed: false, userChoice: null }
            ],
            grammar: [
                { id: 1, words: ["wall", "is", "a", "picture", "the", "on", "there", "."], correct: "There is a picture on the wall.", status: null, scoreEligible: true, completed: false },
                { id: 2, words: ["in", "some", "pencil case", "are", "markers", "there", "the", "."], correct: "There are some markers in the pencil case.", status: null, scoreEligible: true, completed: false },
                { id: 3, words: ["under", "rats", "there", "table", "any", "are", "the", "?"], correct: "Are there any rats under the table?", status: null, scoreEligible: true, completed: false }
            ]
        };

        // Added 'isFirstSession' flag to track if we are still in the first round
        let userStats = {
            vocab: { first: 0, best: 0, isFirstSession: true },
            zoo: { first: 0, best: 0, isFirstSession: true },
            grammar: { first: 0, best: 0, isFirstSession: true }
        };

        let growthChart;

        document.addEventListener('DOMContentLoaded', () => {
            initBarChart();
            
            // Randomize options on initial load
            shuffleAllCategories();

            renderVocab();
            renderZoo();
            renderGrammar();
            updateDashboard();
        });

        // Fisher-Yates Shuffle Algorithm
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function shuffleAllCategories() {
            config.vocab.forEach(q => shuffleArray(q.options));
            config.zoo.forEach(a => shuffleArray(a.options));
            config.grammar.forEach(t => shuffleArray(t.words));
        }

        function speak(text) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const u = new SpeechSynthesisUtterance(text);
                u.lang = 'en-US';
                u.rate = 0.95;
                window.speechSynthesis.speak(u);
            }
        }

        function switchTab(tabId) {
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            document.getElementById(`tab-${tabId}`).classList.add('active');
            document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
            document.getElementById(`view-${tabId}`).classList.add('active');
            if(tabId === 'dashboard') updateDashboard();
        }

        function initBarChart() {
            const ctx = document.getElementById('growthBarChart').getContext('2d');
            growthChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['å–®å­—æ¸¬é©—', 'å‹•ç‰©è¾¨è­˜', 'å¥å­é‡çµ„'],
                    datasets: [
                        {
                            label: 'é¦–æ¬¡ä½œç­”',
                            data: [0, 0, 0],
                            backgroundColor: 'rgba(209, 213, 219, 0.8)',
                            borderColor: '#9CA3AF',
                            borderWidth: 1,
                            borderRadius: 6
                        },
                        {
                            label: 'æœ€ä½³æˆç¸¾',
                            data: [0, 0, 0],
                            backgroundColor: 'rgba(34, 197, 94, 0.8)',
                            borderColor: '#16A34A',
                            borderWidth: 1,
                            borderRadius: 6
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, max: 100, ticks: { font: { size: 10 } } },
                        x: { ticks: { font: { size: 12, weight: 'bold' } } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function syncScore(category) {
            const list = config[category];
            const strictCorrectCount = list.filter(q => q.status === 'correct' && q.scoreEligible).length;
            const accuracy = Math.round((strictCorrectCount / list.length) * 100);

            // Update FIRST score only if we are still in the first session
            if (userStats[category].isFirstSession) {
                userStats[category].first = accuracy;
            }

            // Always update BEST score if current accuracy is higher
            if (accuracy > userStats[category].best) {
                userStats[category].best = accuracy;
            }
            
            updateChartData();
            updateDashboard();
        }

        function updateChartData() {
            growthChart.data.datasets[0].data = [
                userStats.vocab.first,
                userStats.zoo.first,
                userStats.grammar.first
            ];
            growthChart.data.datasets[1].data = [
                userStats.vocab.best,
                userStats.zoo.best,
                userStats.grammar.best
            ];
            growthChart.update();
        }

        function updateDashboard() {
            const bestV = userStats.vocab.best;
            const bestZ = userStats.zoo.best;
            const bestG = userStats.grammar.best;
            const avgBest = Math.round((bestV + bestZ + bestG) / 3);

            const firstV = userStats.vocab.first;
            const firstZ = userStats.zoo.first;
            const firstG = userStats.grammar.first;
            const avgFirst = Math.round((firstV + firstZ + firstG) / 3);

            document.getElementById('overall-first').textContent = `${avgFirst}%`;
            document.getElementById('overall-best').textContent = `${avgBest}%`;
            
            document.getElementById('p-v').textContent = `${config.vocab.filter(q=>q.completed).length}/${config.vocab.length}`;
            document.getElementById('p-z').textContent = `${config.zoo.filter(q=>q.completed).length}/${config.zoo.length}`;
            document.getElementById('p-g').textContent = `${config.grammar.filter(q=>q.completed).length}/${config.grammar.length}`;
        }

        // --- RENDER MODULES ---

        function renderVocab() {
            const container = document.getElementById('vocab-container');
            container.innerHTML = '';
            config.vocab.forEach(q => {
                const card = document.createElement('div');
                card.className = `glass-panel p-6 rounded-2xl border-t-4 transition-all 
                    ${q.completed ? (q.scoreEligible ? 'border-green-400 bg-green-50/10' : 'border-red-400 bg-red-50/10') : 'border-gray-100'}
                    ${q.completed ? 'item-locked' : ''}`;
                
                card.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-[10px] font-bold uppercase tracking-wider ${q.completed ? (q.scoreEligible ? 'text-green-500' : 'text-red-500') : 'text-gray-400'}">
                            ${!q.completed ? 'Vocabulary' : (q.scoreEligible ? 'âœ“ Correct' : 'âš  Mistake')}
                        </span>
                        <button onclick="speak('${q.sentence}')" class="text-green-500 hover:scale-110">ğŸ”Š</button>
                    </div>
                    <p class="text-lg font-semibold mb-6 leading-relaxed">${q.blank.replace('______', '<span class="text-green-600 border-b-2">______</span>')}</p>
                    <div class="grid grid-cols-2 gap-2">
                        ${q.options.map(o => `
                            <button onclick="checkVocab(${q.id},'${o}',this)" 
                                class="option-btn bg-white border border-gray-200 py-3 rounded-xl text-sm 
                                ${q.completed && o === q.answer ? 'option-correct' : ''} 
                                ${q.completed && o === q.userChoice && o !== q.answer ? 'option-wrong' : ''}">
                                ${o}
                            </button>
                        `).join('')}
                    </div>
                    ${q.completed && !q.scoreEligible ? `
                        <div class="correct-answer-reveal flex items-center gap-2">
                            <span>ğŸ’¡ æ­£ç¢ºè§£ç­”:</span>
                            <span class="underline font-bold">${q.answer}</span>
                        </div>` : ''}
                `;
                container.appendChild(card);
            });
        }

        function checkVocab(id, opt, btn) {
            const q = config.vocab.find(x => x.id === id);
            q.completed = true;
            q.userChoice = opt;
            if(opt === q.answer) {
                q.status = 'correct';
                speak("Correct!");
            } else {
                q.status = 'wrong';
                q.scoreEligible = false;
                speak("Incorrect. The answer is " + q.answer);
            }
            renderVocab();
            syncScore('vocab');
        }

        function renderZoo() {
            const container = document.getElementById('zoo-container');
            container.innerHTML = '';
            config.zoo.forEach(animal => {
                const card = document.createElement('div');
                card.className = `glass-panel p-4 rounded-2xl border-b-4 text-center transition-all 
                    ${animal.completed ? (animal.scoreEligible ? 'border-green-400 bg-green-50/10' : 'border-red-400 bg-red-50/10') : 'border-yellow-200'}
                    ${animal.completed ? 'item-locked' : ''}`;
                
                card.innerHTML = `
                    <div class="text-5xl mb-3 filter drop-shadow-sm">${animal.icon}</div>
                    <div class="grid grid-cols-1 gap-1">
                        ${animal.options.map(o => `
                            <button onclick="checkZoo(${animal.id},'${o}',this)" 
                                class="option-btn bg-white border border-gray-100 py-1.5 rounded-lg text-[10px] font-bold 
                                ${animal.completed && o === animal.name ? 'option-correct' : ''}
                                ${animal.completed && o === animal.userChoice && o !== animal.name ? 'option-wrong' : ''}">
                                ${o}
                            </button>
                        `).join('')}
                    </div>
                    ${animal.completed && !animal.scoreEligible ? `
                        <p class="text-[10px] text-green-600 font-bold mt-2">Ans: ${animal.name}</p>` : ''}
                `;
                container.appendChild(card);
            });
        }

        function checkZoo(id, opt, btn) {
            const a = config.zoo.find(x => x.id === id);
            a.completed = true;
            a.userChoice = opt;
            if(opt === a.name) {
                a.status = 'correct';
                speak(opt);
            } else {
                a.status = 'wrong';
                a.scoreEligible = false;
                speak("No, it is an " + a.name);
            }
            renderZoo();
            syncScore('zoo');
        }

        function renderGrammar() {
            const container = document.getElementById('grammar-container');
            container.innerHTML = '';
            config.grammar.forEach(task => {
                const wrapper = document.createElement('div');
                wrapper.className = `glass-panel p-6 rounded-2xl border-l-8 transition-all 
                    ${task.completed ? (task.scoreEligible ? 'border-green-400 bg-green-50/10' : 'border-red-400 bg-red-50/10') : 'border-blue-400'}
                    ${task.completed ? 'item-locked' : ''}`;
                
                wrapper.innerHTML = `
                    <div class="mb-4 flex justify-between items-center">
                        <span class="font-bold text-[10px] tracking-widest uppercase ${task.completed ? (task.scoreEligible ? 'text-green-600' : 'text-red-500') : 'text-blue-600'}">
                            Grammar Factory #${task.id}
                        </span>
                    </div>
                    <div id="u-target-${task.id}" class="min-h-[60px] bg-blue-50/30 border-2 border-dashed border-blue-100 rounded-xl p-3 flex flex-wrap gap-2 mb-4 items-center">
                        ${task.completed ? `<span class="text-blue-800 font-bold text-sm">${task.correct}</span>` : '<p class="text-blue-300 italic text-[10px] w-full text-center">è«‹é»æ“Šä¸‹æ–¹å–®å­—é€²è¡Œæ’åº...</p>'}
                    </div>
                    <div id="u-source-${task.id}" class="flex flex-wrap gap-2 ${task.completed ? 'hidden' : ''}">
                        ${task.words.map(w => `<button onclick="pickWord(${task.id},'${w}',this)" class="bg-white border border-gray-200 px-3 py-1.5 rounded-lg text-xs font-medium hover:border-blue-400">${w}</button>`).join('')}
                    </div>
                    <div class="mt-4 flex items-center justify-between">
                        <div id="u-fb-${task.id}" class="text-xs font-bold">
                            ${task.completed && !task.scoreEligible ? '<span class="text-red-500">âŒ éŒ¯èª¤ï¼ä»¥ä¸Šç‚ºæ­£ç¢ºå¥å­ã€‚</span>' : (task.completed ? '<span class="text-green-600">âœ¨ ç­”å°äº†ï¼</span>' : '')}
                        </div>
                        <button onclick="validateSentence(${task.id})" 
                            class="bg-blue-600 text-white px-8 py-2 rounded-xl font-bold hover:bg-blue-700 shadow-md text-xs ${task.completed ? 'hidden' : ''}">
                            æª¢æŸ¥æª¢æŸ¥
                        </button>
                    </div>
                `;
                container.appendChild(wrapper);
            });
        }

        function pickWord(tid, word, btn) {
            const target = document.getElementById(`u-target-${tid}`);
            const placeholder = target.querySelector('p');
            if(placeholder) placeholder.remove();
            speak(word);

            const chip = document.createElement('span');
            chip.className = "bg-blue-600 text-white px-3 py-1.5 rounded-md text-xs cursor-pointer hover:bg-blue-700 shadow-sm";
            chip.textContent = word;
            chip.onclick = () => {
                chip.remove();
                btn.classList.remove('opacity-0', 'pointer-events-none');
                if(target.children.length === 0) target.innerHTML = '<p class="text-blue-300 italic text-[10px] w-full text-center">è«‹é»æ“Šä¸‹æ–¹å–®å­—é€²è¡Œæ’åº...</p>';
            };
            target.appendChild(chip);
            btn.classList.add('opacity-0', 'pointer-events-none');
        }

        function validateSentence(tid) {
            const target = document.getElementById(`u-target-${tid}`);
            const task = config.grammar.find(t => t.id === tid);
            
            const userSentence = Array.from(target.getElementsByTagName('span')).map(s => s.textContent.trim()).join(' ');
            const normUser = userSentence.replace(/\s+([.?!])/g, '$1').toLowerCase();
            const normCorrect = task.correct.replace(/\s+([.?!])/g, '$1').toLowerCase();

            task.completed = true;
            if (normUser === normCorrect) {
                task.status = 'correct';
                speak(task.correct);
            } else {
                task.status = 'wrong';
                task.scoreEligible = false;
                speak("Not quite. The correct answer is " + task.correct);
            }
            renderGrammar();
            syncScore('grammar');
        }

        function resetCurrentSession(key) {
            // If the user resets, it means the FIRST SESSION is over (if it was active)
            if (userStats[key].isFirstSession) {
                userStats[key].isFirstSession = false;
            }

            config[key].forEach(q => { 
                q.status = null; 
                q.scoreEligible = true; 
                q.completed = false; 
                q.userChoice = null;
                
                // Shuffle logic on reset
                if (key === 'vocab') shuffleArray(q.options);
                if (key === 'zoo') shuffleArray(q.options);
                if (key === 'grammar') shuffleArray(q.words);
            });
            
            if(key === 'vocab') renderVocab();
            if(key === 'zoo') renderZoo();
            if(key === 'grammar') renderGrammar();
            updateDashboard();
        }
    </script>
</body>
</html>
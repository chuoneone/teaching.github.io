<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä½³éŸ³ç¿°æ— åœ‹ä¸­è‹±èª Unit 5-6 äº’å‹•æ¸¬é©—</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Nunito', 'Noto Sans TC', sans-serif; background-color: #f3f4f6; }
        .btn-option { transition: all 0.2s; }
        .btn-option:hover { transform: translateY(-2px); }
        .btn-option.selected { background-color: #3b82f6; color: white; border-color: #3b82f6; }
        .btn-word { user-select: none; }
        .btn-word:active { transform: scale(0.95); }
        .correct-ans { background-color: #d1fae5 !important; border-color: #10b981 !important; color: #065f46 !important; }
        .wrong-ans { background-color: #fee2e2 !important; border-color: #ef4444 !important; color: #991b1b !important; }
        .letter-chip { width: 2.5rem; height: 2.5rem; display: flex; align-items: center; justify-content: center; font-weight: bold; cursor: pointer; border-radius: 0.5rem; background: white; border: 2px solid #e5e7eb; transition: all 0.2s; }
        .letter-chip:hover { border-color: #3b82f6; color: #3b82f6; }
        .letter-chip.used { opacity: 0.3; cursor: not-allowed; background: #e5e7eb; pointer-events: none; }
        .blank-space { border-bottom: 2px solid #9ca3af; padding: 0 0.5rem; min-width: 2rem; display: inline-block; text-align: center; color: #3b82f6; font-weight: bold; cursor: pointer; }
        .blank-space:hover { background-color: #eff6ff; }
        
        /* Modal Overlay */
        .modal-overlay { background-color: rgba(0, 0, 0, 0.5); }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="min-h-screen pb-20">

    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-4xl mx-auto px-4 py-4 flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold text-gray-800">iEnglish Unit 5-6 ç¶œåˆæ¸¬é©—</h1>
                <p class="text-xs text-gray-500">ä½³éŸ³ç¿°æ— åœ‹ä¸­è‹±èª 1å¹´ç´š</p>
            </div>
            <div class="flex items-center gap-6">
                <!-- Timer Display -->
                <div class="flex flex-col items-end">
                    <span class="text-xs text-gray-500 font-bold uppercase tracking-wider">Time Elapsed</span>
                    <span class="text-xl font-mono font-bold text-gray-700" id="timer">00:00</span>
                </div>
                <!-- Score Display -->
                <div class="text-right border-l pl-6 hidden sm:block">
                    <div class="text-sm font-medium text-gray-600">å¾—åˆ†</div>
                    <div class="text-2xl font-bold text-blue-600" id="score-display">-- <span class="text-sm text-gray-400">/ 100</span></div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-4xl mx-auto px-4 py-6 space-y-8">

        <!-- Part I: Vocabulary -->
        <section id="part1" class="bg-white rounded-xl shadow-sm p-6">
            <div class="flex items-center mb-6 border-b pb-4">
                <div class="bg-blue-100 text-blue-600 px-3 py-1 rounded-full text-sm font-bold mr-3">Part I</div>
                <h2 class="text-lg font-bold">å–®å­—é¸æ“‡ (Vocabulary)</h2>
                <span class="ml-auto text-xs text-gray-400">æ¯é¡Œ 2 åˆ†ï¼Œå…± 40 åˆ†</span>
            </div>
            <div id="container-part1" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- JS Generated -->
            </div>
        </section>

        <!-- Part II: Grammar (When/On) -->
        <section id="part2" class="bg-white rounded-xl shadow-sm p-6">
            <div class="flex items-center mb-6 border-b pb-4">
                <div class="bg-green-100 text-green-600 px-3 py-1 rounded-full text-sm font-bold mr-3">Part II</div>
                <h2 class="text-lg font-bold">æ–‡æ³•é¸æ“‡ (When & On)</h2>
                <span class="ml-auto text-xs text-gray-400">æ¯é¡Œ 2 åˆ†ï¼Œå…± 10 åˆ†</span>
            </div>
            <div id="container-part2" class="space-y-4">
                <!-- JS Generated -->
            </div>
        </section>

        <!-- Part III: Grammar (There is/are) -->
        <section id="part3" class="bg-white rounded-xl shadow-sm p-6">
            <div class="flex items-center mb-6 border-b pb-4">
                <div class="bg-purple-100 text-purple-600 px-3 py-1 rounded-full text-sm font-bold mr-3">Part III</div>
                <h2 class="text-lg font-bold">èªæ³•é¸æ“‡ (There is/are)</h2>
                <span class="ml-auto text-xs text-gray-400">æ¯é¡Œ 2 åˆ†ï¼Œå…± 20 åˆ†</span>
            </div>
            <div id="container-part3" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- JS Generated -->
            </div>
        </section>

        <!-- Part IV A: Context Fill-in -->
        <section id="part4a" class="bg-white rounded-xl shadow-sm p-6">
            <div class="flex items-center mb-6 border-b pb-4">
                <div class="bg-yellow-100 text-yellow-600 px-3 py-1 rounded-full text-sm font-bold mr-3">Part IV (A)</div>
                <h2 class="text-lg font-bold">æ–‡æ„é¸å¡«</h2>
                <span class="ml-auto text-xs text-gray-400">æ¯é¡Œ 2 åˆ†ï¼Œå…± 12 åˆ†</span>
            </div>
            
            <!-- Word Bank -->
            <div class="bg-yellow-50 p-4 rounded-lg mb-6 border border-yellow-200 sticky top-20 z-40 shadow-sm">
                <p class="text-xs text-yellow-700 font-bold mb-2 uppercase tracking-wide">Word Bank (é»æ“Šå–®å­—ä»¥å¡«å…¥)</p>
                <div class="flex flex-wrap gap-2" id="word-bank-container">
                    <!-- JS Generated Chips -->
                </div>
            </div>

            <div id="container-part4a" class="space-y-6">
                <!-- JS Generated Sentences -->
            </div>
        </section>

        <!-- Part IV B: Spelling -->
        <section id="part4b" class="bg-white rounded-xl shadow-sm p-6">
            <div class="flex items-center mb-6 border-b pb-4">
                <div class="bg-yellow-100 text-yellow-600 px-3 py-1 rounded-full text-sm font-bold mr-3">Part IV (B)</div>
                <h2 class="text-lg font-bold">å‹•ç‰©æ‹¼å¯«</h2>
                <span class="ml-auto text-xs text-gray-400">æ¯é¡Œ 1 åˆ†ï¼Œå…± 9 åˆ†</span>
            </div>
            <p class="text-sm text-gray-500 mb-4">è«‹é»æ“Šä¸‹æ–¹çš„å­—æ¯ä¾†å®Œæˆå–®å­—ã€‚</p>
            <div id="container-part4b" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- JS Generated -->
            </div>
        </section>

        <!-- Part IV C: Unscramble -->
        <section id="part4c" class="bg-white rounded-xl shadow-sm p-6">
            <div class="flex items-center mb-6 border-b pb-4">
                <div class="bg-yellow-100 text-yellow-600 px-3 py-1 rounded-full text-sm font-bold mr-3">Part IV (C)</div>
                <h2 class="text-lg font-bold">å¥å­é‡çµ„</h2>
                <span class="ml-auto text-xs text-gray-400">æ¯é¡Œ 3 åˆ†ï¼Œå…± 9 åˆ†</span>
            </div>
            <div id="container-part4c" class="space-y-8">
                <!-- JS Generated -->
            </div>
        </section>

        <!-- Submit Button -->
        <div class="fixed bottom-0 left-0 right-0 p-4 bg-white border-t shadow-lg flex justify-center z-50">
            <button onclick="attemptSubmit()" id="submit-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-12 rounded-full shadow-lg transition-all transform hover:scale-105 flex items-center gap-2">
                <span>ğŸ“ äº¤å· (Check Answers)</span>
            </button>
            <button onclick="resetQuiz()" id="reset-btn" class="hidden bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-12 rounded-full shadow-lg transition-all flex items-center gap-2 ml-4">
                <span>ğŸ”„ é‡ä¾† (Reset)</span>
            </button>
        </div>

    </main>

    <!-- Results Modal -->
    <div id="results-modal" class="fixed inset-0 z-[60] hidden overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 modal-overlay transition-opacity" aria-hidden="true" onclick="closeModal()"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start justify-center">
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                            <h3 class="text-2xl leading-6 font-bold text-gray-900 text-center mb-4" id="modal-title">
                                ğŸ† æ¸¬é©—æˆç¸¾å–® (Score Report)
                            </h3>
                            
                            <!-- Score Table -->
                            <div class="mt-4 border rounded-lg overflow-hidden">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å¤§é¡Œ</th>
                                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">å¾—åˆ†</th>
                                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">ç¸½åˆ†</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200" id="result-table-body">
                                        <!-- JS Generated -->
                                    </tbody>
                                    <tfoot class="bg-gray-100 font-bold">
                                        <tr>
                                            <td class="px-6 py-3">ç¸½è¨ˆ (Total)</td>
                                            <td class="px-6 py-3 text-right text-blue-600 text-lg" id="modal-total-score">--</td>
                                            <td class="px-6 py-3 text-right">100</td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>

                            <!-- History Section -->
                            <div class="mt-6">
                                <h4 class="text-sm font-bold text-gray-500 uppercase tracking-wider mb-2">æ­·å²ç´€éŒ„ (Past Attempts)</h4>
                                <div class="bg-gray-50 rounded-lg p-3 max-h-40 overflow-y-auto text-sm" id="history-log">
                                    <!-- JS Generated -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" onclick="closeModal()" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">
                        æª¢è¦–éŒ¯é¡Œ (Review)
                    </button>
                    <button type="button" onclick="resetQuiz()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                        é‡ä¾† (Reset)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CONSTANTS ---
        const MIN_TIME_SECONDS = 1200; // 20 Minutes
        const STORAGE_KEY = 'quiz_unit56_history';

        // --- QUIZ DATA ---
        const part1Data = [
            { id: 1, q: "æ—¥æœŸ", opts: ["data", "date", "day", "door"], ans: 1 },
            { id: 2, q: "é‡è¦çš„", opts: ["important", "animal", "healthy", "lucky"], ans: 0 },
            { id: 3, q: "ç¯€æ—¥ï¼›å‡æ—¥", opts: ["honey", "hungry", "history", "holiday"], ans: 3 },
            { id: 4, q: "æ„Ÿæ©ç¯€", opts: ["Christmas", "Halloween", "Thanksgiving", "New Year's Eve"], ans: 2 },
            { id: 5, q: "ç”Ÿæ—¥", opts: ["birthday", "before", "budget", "business"], ans: 0 },
            { id: 6, q: "ä¸€æœˆ", opts: ["June", "July", "January", "May"], ans: 2 },
            { id: 7, q: "å…«æœˆ", opts: ["April", "August", "Autumn", "Also"], ans: 1 },
            { id: 8, q: "åäºŒæœˆ", opts: ["December", "November", "October", "September"], ans: 0 },
            { id: 9, q: "è–èª•ç¯€", opts: ["Church", "Clean", "Christmas", "Cow"], ans: 2 },
            { id: 10, q: "ç¬¬ä¸€ï¼ˆçš„ï¼‰", opts: ["four", "first", "fast", "fox"], ans: 1 },
            { id: 11, q: "å¤§è±¡", opts: ["elephant", "example", "exercise", "evening"], ans: 0 },
            { id: 12, q: "è€è™", opts: ["table", "thirsty", "tiger", "tail"], ans: 2 },
            { id: 13, q: "æ–‘é¦¬", opts: ["zero", "zoo", "zebra", "zone"], ans: 2 },
            { id: 14, q: "çŒ´å­", opts: ["money", "month", "monkey", "mouse"], ans: 2 },
            { id: 15, q: "ä¸–ç•Œ", opts: ["word", "world", "work", "wood"], ans: 1 },
            { id: 16, q: "å¯¦ä¾‹", opts: ["elephant", "enjoy", "example", "earth"], ans: 2 },
            { id: 17, q: "é£Ÿç‰©", opts: ["foot", "floor", "food", "fold"], ans: 2 },
            { id: 18, q: "å¥åº·çš„", opts: ["heavy", "healthy", "hungry", "happy"], ans: 1 },
            { id: 19, q: "ä¹¾æ·¨çš„", opts: ["clean", "clear", "clever", "clean up"], ans: 0 },
            { id: 20, q: "å‹•ç‰©", opts: ["animal", "any", "also", "around"], ans: 0 }
        ];

        const part2Data = [
            { id: 1, q: "A: ______ is the music festival? B: It is in May.", opts: ["What", "Who", "When", "How"], ans: 2 },
            { id: 2, q: "My birthday is ______ November 25th.", opts: ["in", "on", "at", "with"], ans: 1 },
            { id: 3, q: "Thanksgiving is ______ the fourth Thursday of November.", opts: ["on", "in", "around", "before"], ans: 0 },
            { id: 4, q: "______ is Christmas? It's on December 25th.", opts: ["What", "When", "How about", "Where"], ans: 1 },
            { id: 5, q: "The concert is ______ next Friday.", opts: ["on", "in", "X (ä¸åŠ )", "at"], ans: 2 }
        ];

        const part3Data = [
            { id: 1, q: "There ______ any cats under the car.", opts: ["is no", "isn't", "aren't", "are no"], ans: 2 },
            { id: 2, q: "There is ______ bird in the tree.", opts: ["no a", "not a", "not", "X"], ans: 1 },
            { id: 3, q: "______ there any notebooks on the desk?", opts: ["Is", "Are", "Be", "Can"], ans: 1 },
            { id: 4, q: "A: Are there any apple trees in the park? B: Yes, ______ are.", opts: ["these", "they", "there", "those"], ans: 2 },
            { id: 5, q: "A: Is there ______ over there? B: Yes, ______ is.", opts: ["a cat; it", "cat; it", "a cat; there", "cats; they"], ans: 2 },
            { id: 6, q: "Is there ______ in the house?", opts: ["any dogs", "some dogs", "a dog", "the dog"], ans: 2 },
            { id: 7, q: "A: Aren't there any eggs in the box? B: Yes, ______ .", opts: ["there aren't.", "there are two.", "there is", "they are"], ans: 1 },
            { id: 8, q: "Is there ______ elephant over there?", opts: ["a", "the", "no", "an"], ans: 3 },
            { id: 9, q: "There ______ a dog in the house.", opts: ["has", "is", "are", "have"], ans: 1 },
            { id: 10, q: "______ a scooter near the bike.", opts: ["That", "Its", "There's", "There are"], ans: 2 }
        ];

        const part4aData = {
            bank: ["animal", "birthday", "important", "turkey", "third", "holiday"],
            questions: [
                { id: 1, q: "September 28 is Confuciusâ€™ (å­”å­çš„) ______.", ans: "birthday" },
                { id: 2, q: "My family and friends are ______ to me.", ans: "important" },
                { id: 3, q: "A cow is an ______.", ans: "animal" },
                { id: 4, q: "Our Christmas dinner is a big ______.", ans: "turkey" },
                { id: 5, q: "Motherâ€™s Day is a ______.", ans: "holiday" },
                { id: 6, q: "Lisa is the ______ person in the line (éšŠä¼).", ans: "third" }
            ]
        };

        const part4bData = [
            { id: 1, label: "å¤§è±¡", ans: "elephant", pattern: "e _ _ _ _ _ _ t" },
            { id: 2, label: "ç…å­", ans: "lion", pattern: "l _ _ n" },
            { id: 3, label: "ç†Š", ans: "bear", pattern: "b _ _ r" },
            { id: 4, label: "æ–‘é¦¬", ans: "zebra", pattern: "z _ _ _ a" },
            { id: 5, label: "çŒ´å­", ans: "monkey", pattern: "m _ _ _ _ y" },
            { id: 6, label: "ç‹ç‹¸", ans: "fox", pattern: "f _ x" },
            { id: 7, label: "é¦¬", ans: "horse", pattern: "h _ _ _ e" },
            { id: 8, label: "è€è™", ans: "tiger", pattern: "t _ _ _ r" },
            { id: 9, label: "è€é¼ ", ans: "rat", pattern: "r _ t" }
        ];

        const part4cData = [
            { id: 1, parts: ["a", "picture", "is", "on", "there", "the", "wall", "."], ans: "There is a picture on the wall." },
            { id: 2, parts: ["pencil case", "are", "the", "some", "there", "markers", "in", "."], ans: "There are some markers in the pencil case." },
            { id: 3, parts: ["the", "rats", "table", "there", "under", "are", "any", "?"], ans: "Are there any rats under the table?" }
        ];

        // --- STATE ---
        let userAnswers = {
            p1: {}, p2: {}, p3: {}, p4a: {}, p4b: {}, p4c: {}
        };
        // For Reordering:
        let reorderState = {
            1: { pool: [], line: [] },
            2: { pool: [], line: [] },
            3: { pool: [], line: [] }
        };
        
        let timerInterval;
        let elapsedSeconds = 0;

        // --- RENDER FUNCTIONS ---

        function init() {
            renderMCQ('container-part1', part1Data, 'p1');
            renderMCQ('container-part2', part2Data, 'p2');
            renderMCQ('container-part3', part3Data, 'p3');
            renderPart4A();
            renderPart4B();
            renderPart4C();
            startTimer();
        }

        function startTimer() {
            elapsedSeconds = 0;
            updateTimerDisplay();
            timerInterval = setInterval(() => {
                elapsedSeconds++;
                updateTimerDisplay();
            }, 1000);
        }

        function updateTimerDisplay() {
            const m = Math.floor(elapsedSeconds / 60).toString().padStart(2, '0');
            const s = (elapsedSeconds % 60).toString().padStart(2, '0');
            const timerEl = document.getElementById('timer');
            timerEl.innerText = `${m}:${s}`;
            
            // Visual warning style if under minimum time
            if (elapsedSeconds < MIN_TIME_SECONDS) {
                timerEl.classList.add('text-red-500');
                timerEl.classList.remove('text-green-600');
            } else {
                timerEl.classList.remove('text-red-500');
                timerEl.classList.add('text-green-600');
            }
        }

        // Generic MCQ Renderer
        function renderMCQ(containerId, data, sectionKey) {
            const container = document.getElementById(containerId);
            container.innerHTML = data.map(item => `
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 hover:shadow-md transition-shadow" id="${sectionKey}-q${item.id}">
                    <div class="flex items-start gap-2 mb-3">
                        <span class="text-sm bg-gray-200 text-gray-600 px-2 py-0.5 rounded font-bold">${item.id}</span>
                        <p class="font-bold text-gray-800 flex-grow">${item.q}</p>
                        <button onclick="speak('${item.q.replace(/'/g, "\\'")}', '${isEnglish(item.q) ? 'en-US' : 'zh-TW'}')" class="text-blue-500 hover:text-blue-700 p-1 rounded-full hover:bg-blue-100 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" /></svg>
                        </button>
                    </div>
                    <div class="grid grid-cols-1 gap-2">
                        ${item.opts.map((opt, idx) => `
                            <button onclick="selectMCQ('${sectionKey}', ${item.id}, ${idx})" 
                                    id="btn-${sectionKey}-${item.id}-${idx}"
                                    class="btn-option w-full text-left px-4 py-2 rounded border border-gray-300 bg-white text-gray-700 flex items-center justify-between group">
                                <span class="group-hover:text-blue-600">(${['A','B','C','D'][idx]}) ${opt}</span>
                                <span class="hidden group-hover:block" onclick="event.stopPropagation(); speak('${opt.replace(/'/g, "\\'")}', 'en-US')">ğŸ”Š</span>
                            </button>
                        `).join('')}
                    </div>
                    <div class="mt-2 text-sm hidden font-bold" id="feedback-${sectionKey}-${item.id}"></div>
                </div>
            `).join('');
        }

        function isEnglish(text) {
            return /^[A-Za-z0-9\s.,?!'"_]+$/.test(text);
        }

        // Part 4A: Fill in Blank
        function renderPart4A() {
            // Render Bank
            const bankContainer = document.getElementById('word-bank-container');
            bankContainer.innerHTML = part4aData.bank.map(word => `
                <button onclick="fillWord('${word}')" class="btn-word bg-white border-2 border-yellow-400 text-yellow-800 px-3 py-1.5 rounded-full font-bold shadow-sm hover:bg-yellow-50 hover:shadow-md transition-all flex items-center gap-1">
                    ${word}
                    <span onclick="event.stopPropagation(); speak('${word}', 'en-US')" class="text-xs opacity-50 hover:opacity-100">ğŸ”Š</span>
                </button>
            `).join('');

            // Render Questions
            const qContainer = document.getElementById('container-part4a');
            qContainer.innerHTML = part4aData.questions.map(item => `
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200" id="p4a-q${item.id}">
                    <div class="flex items-center gap-2">
                        <span class="text-sm bg-gray-200 text-gray-600 px-2 py-0.5 rounded font-bold">${item.id}.</span>
                        <p class="text-lg leading-loose">
                            ${item.q.replace('______', `<span id="blank-p4a-${item.id}" onclick="clearBlank(${item.id})" class="blank-space px-4 min-w-[100px] bg-white mx-1 rounded border-b-2 border-blue-400 text-blue-600 select-none">______</span>`)}
                        </p>
                        <button onclick="speak('${item.q.replace(/['"()]/g, "")}', 'en-US')" class="ml-2 text-blue-400 hover:text-blue-600"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" /></svg></button>
                    </div>
                    <div class="mt-1 text-sm hidden font-bold" id="feedback-p4a-${item.id}"></div>
                </div>
            `).join('');
        }

        // Part 4B: Spelling (Scrambled Letters)
        function renderPart4B() {
            const container = document.getElementById('container-part4b');
            container.innerHTML = part4bData.map(item => {
                // Parse pattern: "e _ _ _ t" -> Keep 'e' and 't', scramble middle.
                const cleanPattern = item.pattern.replace(/\s/g, ''); // "e______t"
                const fullWord = item.ans;
                let displayHTML = '';
                let missingChars = [];
                let inputIndex = 0;

                // Build the UI for the word slots
                displayHTML += `<div class="flex items-center gap-1 mb-3 justify-center">`;
                for (let i = 0; i < cleanPattern.length; i++) {
                    const char = cleanPattern[i];
                    if (char === '_') {
                        // It's a slot
                        const correctChar = fullWord[i]; 
                        missingChars.push(correctChar);
                        displayHTML += `<div id="p4b-${item.id}-slot-${inputIndex}" class="w-8 h-10 border-b-2 border-gray-400 flex items-center justify-center text-xl font-bold text-blue-600 bg-white"></div>`;
                        inputIndex++;
                    } else {
                        // It's a fixed letter
                        displayHTML += `<div class="w-8 h-10 flex items-center justify-center text-xl font-bold text-gray-400">${char}</div>`;
                    }
                }
                displayHTML += `</div>`;

                // Scramble missing chars
                const scrambled = shuffleArray([...missingChars]);

                // Store state for this item
                userAnswers.p4b[item.id] = { 
                    slots: new Array(missingChars.length).fill(null), 
                    currentSlot: 0,
                    totalSlots: missingChars.length 
                };

                return `
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 text-center" id="p4b-q${item.id}">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-bold text-gray-500">${item.id}. ${item.label}</span>
                        <button onclick="speak('${item.ans}', 'en-US')">ğŸ”Š</button>
                    </div>
                    
                    ${displayHTML}

                    <!-- Letter Pool -->
                    <div class="flex flex-wrap justify-center gap-2 mt-2" id="pool-p4b-${item.id}">
                        ${scrambled.map((char, idx) => `
                            <button onclick="fillSpelling(${item.id}, '${char}', this)" class="letter-chip shadow-sm">${char}</button>
                        `).join('')}
                    </div>
                    
                    <button onclick="resetSpelling(${item.id})" class="text-xs text-red-400 mt-2 hover:text-red-600 underline">Clear</button>
                    <div class="mt-1 text-sm hidden font-bold" id="feedback-p4b-${item.id}"></div>
                </div>
                `;
            }).join('');
        }

        // Part 4C: Sentence Reordering
        function renderPart4C() {
            const container = document.getElementById('container-part4c');
            container.innerHTML = part4cData.map(item => {
                // Initialize State
                const shuffled = shuffleArray([...item.parts]);
                reorderState[item.id] = { pool: shuffled, line: [] };

                return `
                <div class="bg-gray-50 p-6 rounded-lg border border-gray-200" id="p4c-q${item.id}">
                    <div class="flex justify-between mb-4">
                         <span class="font-bold text-gray-600">${item.id}.</span>
                         <button onclick="speak('${item.ans.replace(/'/g, "\\'")}', 'en-US')">ğŸ”Š è§£ç­”ç™¼éŸ³ (Answer)</button>
                    </div>
                    
                    <!-- Answer Line (Click to remove) -->
                    <div class="min-h-[60px] bg-white border-2 border-dashed border-gray-300 rounded-lg p-3 flex flex-wrap gap-2 items-center mb-4 cursor-pointer hover:bg-gray-50 transition-colors" 
                         id="line-p4c-${item.id}">
                        <span class="text-gray-400 text-sm select-none italic w-full text-center" id="hint-p4c-${item.id}">é»æ“Šä¸‹æ–¹çš„å–®å­—å¡ä¾†çµ„è£å¥å­...</span>
                    </div>

                    <!-- Word Pool (Click to add) -->
                    <div class="flex flex-wrap gap-2 justify-center" id="pool-p4c-${item.id}">
                        <!-- JS renders this -->
                    </div>

                    <div class="mt-2 text-sm hidden font-bold text-center" id="feedback-p4c-${item.id}"></div>
                </div>
                `;
            }).join('');
            
            // Initial render of pools
            part4cData.forEach(item => updateReorderUI(item.id));
        }

        // --- LOGIC: MCQ ---

        function selectMCQ(section, qId, optIdx) {
            // Update UI
            const qData = (section === 'p1' ? part1Data : (section === 'p2' ? part2Data : part3Data)).find(q => q.id === qId);
            qData.opts.forEach((_, idx) => {
                document.getElementById(`btn-${section}-${qId}-${idx}`).classList.remove('selected', 'bg-blue-600', 'text-white');
            });
            document.getElementById(`btn-${section}-${qId}-${optIdx}`).classList.add('selected');
            
            // Save Answer
            userAnswers[section][qId] = optIdx;
        }

        // --- LOGIC: PART 4A (Fill) ---
        
        function fillWord(word) {
            // Find first empty blank
            for (let i = 1; i <= 6; i++) {
                if (!userAnswers.p4a[i]) {
                    userAnswers.p4a[i] = word;
                    document.getElementById(`blank-p4a-${i}`).innerText = word;
                    document.getElementById(`blank-p4a-${i}`).classList.remove('text-blue-600');
                    document.getElementById(`blank-p4a-${i}`).classList.add('text-black', 'bg-yellow-100');
                    return; 
                }
            }
        }

        function clearBlank(id) {
            userAnswers.p4a[id] = null;
            document.getElementById(`blank-p4a-${id}`).innerText = "______";
            document.getElementById(`blank-p4a-${id}`).classList.add('text-blue-600');
            document.getElementById(`blank-p4a-${id}`).classList.remove('text-black', 'bg-yellow-100');
        }

        // --- LOGIC: PART 4B (Spelling) ---

        function fillSpelling(qId, char, btn) {
            const state = userAnswers.p4b[qId];
            if (state.currentSlot < state.totalSlots) {
                state.slots[state.currentSlot] = char;
                document.getElementById(`p4b-${qId}-slot-${state.currentSlot}`).innerText = char;
                state.currentSlot++;
                btn.classList.add('used');
                btn.disabled = true;
            }
        }

        function resetSpelling(qId) {
            const state = userAnswers.p4b[qId];
            state.slots.fill(null);
            state.currentSlot = 0;
            
            for (let i=0; i<state.totalSlots; i++) {
                document.getElementById(`p4b-${qId}-slot-${i}`).innerText = "";
            }
            
            const pool = document.getElementById(`pool-p4b-${qId}`);
            Array.from(pool.children).forEach(btn => {
                btn.classList.remove('used');
                btn.disabled = false;
            });
        }

        // --- LOGIC: PART 4C (Reorder) ---

        function updateReorderUI(id) {
            const state = reorderState[id];
            
            const poolDiv = document.getElementById(`pool-p4c-${id}`);
            poolDiv.innerHTML = state.pool.map((word, idx) => `
                <button onclick="moveWord(${id}, 'pool', ${idx})" class="bg-white border shadow-sm px-3 py-1.5 rounded-lg hover:bg-blue-50 text-gray-700 font-medium">${word}</button>
            `).join('');

            const lineDiv = document.getElementById(`line-p4c-${id}`);
            if (state.line.length === 0) {
                lineDiv.innerHTML = `<span class="text-gray-400 text-sm select-none italic w-full text-center">é»æ“Šä¸‹æ–¹çš„å–®å­—å¡ä¾†çµ„è£å¥å­...</span>`;
            } else {
                lineDiv.innerHTML = state.line.map((word, idx) => `
                    <button onclick="moveWord(${id}, 'line', ${idx})" class="bg-blue-100 text-blue-800 border border-blue-200 px-3 py-1.5 rounded-lg hover:bg-red-100 hover:text-red-800 transition-colors">${word}</button>
                `).join('');
            }
        }

        function moveWord(id, source, index) {
            const state = reorderState[id];
            if (source === 'pool') {
                const word = state.pool.splice(index, 1)[0];
                state.line.push(word);
            } else {
                const word = state.line.splice(index, 1)[0];
                state.pool.push(word);
            }
            updateReorderUI(id);
        }

        // --- UTILS & TTS ---

        function speak(text, lang) {
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = lang;
            utterance.rate = 0.9;
            window.speechSynthesis.speak(utterance);
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // --- SUBMISSION & GRADING ---

        function attemptSubmit() {
            if (elapsedSeconds < MIN_TIME_SECONDS) {
                const remaining = MIN_TIME_SECONDS - elapsedSeconds;
                const m = Math.floor(remaining / 60);
                const s = remaining % 60;
                alert(`âš ï¸ è«‹å†æª¢æŸ¥ä¸€ä¸‹ï¼\n\nè€ƒè©¦è¦å®šè‡³å°‘éœ€è¦ 20 åˆ†é˜æ‰èƒ½äº¤å·ã€‚\nè·é›¢å¯äº¤å·æ™‚é–“é‚„æœ‰ï¼š${m}åˆ†${s}ç§’`);
                return;
            }
            
            if (confirm('ç¢ºå®šè¦äº¤å·äº†å—ï¼Ÿäº¤å·å¾Œå°‡ç„¡æ³•ä¿®æ”¹ç­”æ¡ˆã€‚')) {
                clearInterval(timerInterval);
                gradeQuiz();
            }
        }

        function gradeQuiz() {
            let breakdown = { p1: 0, p2: 0, p3: 0, p4a: 0, p4b: 0, p4c: 0 };
            let score = 0;

            // Part 1 (20 * 2 = 40)
            part1Data.forEach(q => {
                const userAns = userAnswers.p1[q.id];
                const card = document.getElementById(`p1-q${q.id}`);
                const feedback = document.getElementById(`feedback-p1-${q.id}`);
                feedback.classList.remove('hidden');
                
                if (userAns === q.ans) {
                    breakdown.p1 += 2;
                    card.classList.add('border-green-400', 'bg-green-50');
                    feedback.innerHTML = `<span class="text-green-600">Correct!</span>`;
                } else {
                    card.classList.add('border-red-400', 'bg-red-50');
                    feedback.innerHTML = `<span class="text-red-600">Wrong. Answer: ${q.opts[q.ans]}</span>`;
                }
            });

            // Part 2 (5 * 2 = 10)
            part2Data.forEach(q => {
                const userAns = userAnswers.p2[q.id];
                const card = document.getElementById(`p2-q${q.id}`);
                const feedback = document.getElementById(`feedback-p2-${q.id}`);
                feedback.classList.remove('hidden');

                if (userAns === q.ans) {
                    breakdown.p2 += 2;
                    card.classList.add('border-green-400', 'bg-green-50');
                    feedback.innerHTML = `<span class="text-green-600">Correct!</span>`;
                } else {
                    card.classList.add('border-red-400', 'bg-red-50');
                    feedback.innerHTML = `<span class="text-red-600">Answer: ${q.opts[q.ans]}</span>`;
                }
            });

            // Part 3 (10 * 2 = 20)
            part3Data.forEach(q => {
                const userAns = userAnswers.p3[q.id];
                const card = document.getElementById(`p3-q${q.id}`);
                const feedback = document.getElementById(`feedback-p3-${q.id}`);
                feedback.classList.remove('hidden');

                if (userAns === q.ans) {
                    breakdown.p3 += 2;
                    card.classList.add('border-green-400', 'bg-green-50');
                    feedback.innerHTML = `<span class="text-green-600">Correct!</span>`;
                } else {
                    card.classList.add('border-red-400', 'bg-red-50');
                    feedback.innerHTML = `<span class="text-red-600">Answer: ${q.opts[q.ans]}</span>`;
                }
            });

            // Part 4A (6 * 2 = 12)
            part4aData.questions.forEach(q => {
                const userAns = userAnswers.p4a[q.id];
                const card = document.getElementById(`p4a-q${q.id}`);
                const feedback = document.getElementById(`feedback-p4a-${q.id}`);
                feedback.classList.remove('hidden');

                if (userAns === q.ans) {
                    breakdown.p4a += 2;
                    card.classList.add('border-green-400', 'bg-green-50');
                    feedback.innerHTML = `<span class="text-green-600">âœ… Correct</span>`;
                } else {
                    card.classList.add('border-red-400', 'bg-red-50');
                    feedback.innerHTML = `<span class="text-red-600">Answer: ${q.ans}</span>`;
                }
            });

            // Part 4B (9 * 1 = 9)
            part4bData.forEach(q => {
                const state = userAnswers.p4b[q.id];
                const cleanPattern = q.pattern.replace(/\s/g, '');
                let fullAttempt = "";
                let slotIdx = 0;
                for(let char of cleanPattern) {
                    if (char === '_') {
                        fullAttempt += (state.slots[slotIdx] || "");
                        slotIdx++;
                    } else {
                        fullAttempt += char;
                    }
                }

                const card = document.getElementById(`p4b-q${q.id}`);
                const feedback = document.getElementById(`feedback-p4b-${q.id}`);
                feedback.classList.remove('hidden');

                if (fullAttempt === q.ans) {
                    breakdown.p4b += 1;
                    card.classList.add('border-green-400', 'bg-green-50');
                    feedback.innerHTML = `<span class="text-green-600">Correct!</span>`;
                } else {
                    card.classList.add('border-red-400', 'bg-red-50');
                    feedback.innerHTML = `<span class="text-red-600">Ans: ${q.ans}</span>`;
                }
            });

            // Part 4C (3 * 3 = 9)
            part4cData.forEach(q => {
                const attempt = reorderState[q.id].line.join(' ');
                const card = document.getElementById(`p4c-q${q.id}`);
                const feedback = document.getElementById(`feedback-p4c-${q.id}`);
                feedback.classList.remove('hidden');
                
                const cleanAttempt = attempt.replace(/\s+/g, ' ').trim();
                const cleanAns = q.ans.replace(/\s+/g, ' ').trim();

                if (cleanAttempt === cleanAns) {
                    breakdown.p4c += 3;
                    card.classList.add('border-green-400', 'bg-green-50');
                    feedback.innerHTML = `<span class="text-green-600">Perfect!</span>`;
                } else {
                    card.classList.add('border-red-400', 'bg-red-50');
                    feedback.innerHTML = `<span class="text-red-600">Answer: ${q.ans}</span>`;
                }
            });

            score = breakdown.p1 + breakdown.p2 + breakdown.p3 + breakdown.p4a + breakdown.p4b + breakdown.p4c;

            // Display Score in Header
            const scoreDisplay = document.getElementById('score-display');
            scoreDisplay.innerHTML = `${score} <span class="text-sm text-gray-400">/ 100</span>`;
            
            // Toggle Buttons
            document.getElementById('submit-btn').classList.add('hidden');
            document.getElementById('reset-btn').classList.remove('hidden');

            // Save and Show Modal
            saveAndShowResults(score, breakdown);
        }

        // --- STORAGE & RESULTS MODAL ---

        function saveAndShowResults(score, breakdown) {
            // 1. Save to LocalStorage
            const record = {
                date: new Date().toLocaleString('zh-TW'),
                score: score,
                duration: elapsedSeconds,
                breakdown: breakdown
            };

            let history = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            history.unshift(record); // Add to top
            if (history.length > 50) history.pop(); // Keep max 50 records
            localStorage.setItem(STORAGE_KEY, JSON.stringify(history));

            // 2. Populate Modal
            document.getElementById('modal-total-score').innerText = score;
            const tb = document.getElementById('result-table-body');
            tb.innerHTML = `
                <tr><td class="px-6 py-2">Part I: Vocabulary</td><td class="px-6 py-2 text-right">${breakdown.p1}</td><td class="px-6 py-2 text-right">40</td></tr>
                <tr><td class="px-6 py-2">Part II: Grammar (When/On)</td><td class="px-6 py-2 text-right">${breakdown.p2}</td><td class="px-6 py-2 text-right">10</td></tr>
                <tr><td class="px-6 py-2">Part III: Grammar (There is)</td><td class="px-6 py-2 text-right">${breakdown.p3}</td><td class="px-6 py-2 text-right">20</td></tr>
                <tr><td class="px-6 py-2">Part IV (A): Context</td><td class="px-6 py-2 text-right">${breakdown.p4a}</td><td class="px-6 py-2 text-right">12</td></tr>
                <tr><td class="px-6 py-2">Part IV (B): Spelling</td><td class="px-6 py-2 text-right">${breakdown.p4b}</td><td class="px-6 py-2 text-right">9</td></tr>
                <tr><td class="px-6 py-2">Part IV (C): Reorder</td><td class="px-6 py-2 text-right">${breakdown.p4c}</td><td class="px-6 py-2 text-right">9</td></tr>
            `;

            const historyDiv = document.getElementById('history-log');
            historyDiv.innerHTML = history.map((rec, i) => `
                <div class="flex justify-between border-b border-gray-200 py-2 last:border-0">
                    <span class="text-gray-600">${rec.date}</span>
                    <span class="font-bold ${rec.score >= 60 ? 'text-green-600' : 'text-red-500'}">${rec.score} åˆ†</span>
                </div>
            `).join('');

            // 3. Show Modal
            document.getElementById('results-modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('results-modal').classList.add('hidden');
        }

        function resetQuiz() {
            window.location.reload();
        }

        // Initialize
        init();

    </script>
</body>
</html>
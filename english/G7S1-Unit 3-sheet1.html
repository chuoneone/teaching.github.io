<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>祈使句文法練習</title>    
    <link rel="icon" href="dog.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f0f9ff;
        }
        .exercise-card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            padding: 24px;
            margin-bottom: 24px;
            transition: box-shadow 0.3s ease;
        }
        .section-header {
            background-color: #e0f2fe;
            color: #0c4a6e;
            padding: 16px 24px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        .example-box {
            background-color: #f8fafc;
            border-left: 4px solid #38bdf8;
            padding: 16px;
            border-radius: 0 8px 8px 0;
            margin-top: 12px;
            font-size: 1.05em;
        }
         .example-box p {
            margin-bottom: 4px;
        }
        .mnemonic-box {
            background-color: #fffbeb;
            border-left: 4px solid #facc15;
            padding: 16px;
            border-radius: 0 8px 8px 0;
            margin-top: 16px;
        }
        .word-bank {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            padding: 12px;
            background-color: #f1f5f9;
            border-radius: 8px;
            min-height: 50px;
        }
        .drop-zone {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            padding: 12px;
            background-color: #ffffff;
            border: 2px dashed #94a3b8;
            border-radius: 8px;
            min-height: 50px;
            margin-top: 12px;
            transition: all 0.3s ease;
        }
        .word-item {
            padding: 8px 16px;
            background-color: #e0f2fe;
            border: 1px solid #7dd3fc;
            color: #075985;
            border-radius: 9999px;
            cursor: pointer;
            user-select: none;
            transition: all 0.2s ease;
            font-weight: 600;
        }
        .word-item:hover {
            background-color: #bae6fd;
            transform: scale(1.05);
        }
        .speaker-icon {
            cursor: pointer;
            display: inline-block;
            margin-left: 8px;
            color: #3b82f6;
            font-size: 1.2em;
            vertical-align: middle;
        }
        #tooltip {
            position: absolute;
            display: none;
            background-color: #1f2937;
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.9em;
            pointer-events: none;
            z-index: 100;
        }
        .drop-zone.correct {
            border-color: #22c55e;
            background-color: #f0fdf4;
        }
        .drop-zone.incorrect {
            border-color: #ef4444;
            background-color: #fef2f2;
        }
        .question-text {
             font-size: 1.1em;
        }
        .found-answers-display {
            background-color: #f0fdf4;
            border: 1px solid #a7f3d0;
            border-radius: 8px;
        }
        .found-answers-display p {
            color: #047857;
            font-weight: 600;
        }

        @keyframes card-correct-glow {
            0% { box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); }
            50% { box-shadow: 0 8px 30px rgba(34, 197, 94, 0.4); }
            100% { box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); }
        }

        .card-glow-animation {
            animation: card-correct-glow 1s ease-out;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div id="tooltip"></div>

    <div class="max-w-4xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-blue-800">Unit 3 Grammar Focus 1AB</h1>
            <p class="text-slate-600 mt-2">(搭配課本P.55.56)</p>
        </header>

        <div id="exercise-container">
            <!-- Exercises will be rendered here by JavaScript -->
        </div>
    </div>

    <script>
        const translations = {
            'Please': '請', 'be': '保持', 'quiet': '安靜的', 'in': '在...裡面', 'the': '這個', 'classroom': '教室',
            'Look': '看', 'at': '在', 'me': '我', 'sign': '標誌', 'Don’t': '不要', 'sleep': '睡覺', 'class': '課堂', 'please': '請',
            'Open': '打開', 'your': '你的', 'book': '書', 'Helen': '海倫', 'Tom': '湯姆', 'a': '一個', 'good': '好的', 'boy': '男孩',
            'run': '跑', 'Vicky': '維琪', 'Close': '關上', 'Wake': '醒來', 'up': '起來', 'Cody': '寇弟',
            'John': '約翰', 'Go': '去', 'home': '家', 'Touch': '觸摸', 'magic': '神奇的', 'door': '門',
            'Use': '使用', 'cellphones': '手機', 'Let’s': '讓我們', 'not': '不', 'play': '玩', 'game': '遊戲', 'window': '窗戶',
            'don’t run': '不要跑', 'Don’t run': '不要跑', 'Don’t sleep': '不要睡覺', "don’t sleep": "不要睡覺",
            "Don’t touch": "不要觸摸", "Don’t use": "不要使用", "Let’s not": "我們不要"
        };

        const exercisesBySection = {
            "一": {
                title: "請依例將祈使句加入 please",
                example: { q: "Be quiet in the classroom. / please", a: ["Please be quiet in the classroom.", "Be quiet in the classroom, please."] },
                questions: [
                    { id: 's1q1', question: "Look at me. / please", answers: ["Look at me, please.", "Please look at me."] },
                    { id: 's1q2', question: "Don’t sleep in class. / please", answers: ["Don’t sleep in class, please.", "Please don’t sleep in class."] }
                ]
            },
            "二": {
                title: "請依例將祈使句加入人名",
                example: { q: "Open your book / Helen", a: ["Helen, open your book.", "Open your book, Helen."] },
                questions: [
                    { id: 's2q1', question: "Be a good boy. / Tom", answers: ["Tom, be a good boy.", "Be a good boy, Tom."] },
                    { id: 's2q2', question: "Don’t run. / Vicky", answers: ["Vicky, Don’t run.", "Don’t run, Vicky."], chunks: ['Vicky', ',', 'Don’t run', '.'] }
                ]
            },
            "三": {
                title: "請依例將祈使句加入人名與 please",
                example: { q: "Close your book. / Helen / please", a: ["Please close your book, Helen.", "Helen, please close your book.", "Helen, close your book, please."] },
                questions: [
                    { id: 's3q1', question: "Wake up. / Cody / please", answers: ["Please wake up, Cody.", "Cody, please wake up.", "Cody, wake up, please."] },
                    { id: 's3q2', question: "Don’t run in the classroom. / John / please", answers: ["Please don’t run in the classroom, John.", "John, please don’t run in the classroom.", "John, don’t run in the classroom, please."] }
                ]
            },
            "四": {
                title: "請依例將祈使句改為否定句",
                example: [
                    { q: "(例1) Go home.", a: ["Don’t go home."] },
                    { q: "(例2) Let’s go home.", a: ["Let’s not go home."] }
                ],
                questions: [
                    { id: 's4q1', question: "Touch the magic door.", answers: ["Don’t touch the magic door."], chunks: ["Don’t touch", "the magic door", "."] },
                    { id: 's4q2', question: "Use your cellphones.", answers: ["Don’t use your cellphones."], chunks: ["Don’t use", "your cellphones", "."] },
                    { id: 's4q3', question: "Let’s play game.", answers: ["Let’s not play game."], chunks: ["Let’s not", "play game", "."] },
                    { id: 's4q4', question: "Let’s open the window.", answers: ["Let’s not open the window."], chunks: ["Let’s not", "open the window", "."] }
                ]
            }
        };

        const synth = window.speechSynthesis;

        function speak(text) {
            synth.cancel();
            if (text) {
                const utterThis = new SpeechSynthesisUtterance(text.replace(/[.,?\/]/g, ''));
                utterThis.lang = 'en-US';
                utterThis.rate = 0.8; // Slowed down from 0.9
                synth.speak(utterThis);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const container = document.getElementById('exercise-container');
            
            const processedExercisesBySection = {};
            Object.entries(exercisesBySection).forEach(([sectionNum, sectionData]) => {
                const newSectionData = {
                    title: sectionData.title,
                    example: sectionData.example,
                    questions: []
                };
                sectionData.questions.forEach((originalQ, q_index) => {
                    if (originalQ.answers.length > 1) {
                        originalQ.answers.forEach((ans, ans_index) => {
                            newSectionData.questions.push({
                                id: `${originalQ.id}-${ans_index + 1}`,
                                question: originalQ.question,
                                displayNum: `${q_index + 1}-${ans_index + 1}`,
                                answers: [ans],
                                chunks: originalQ.chunks
                            });
                        });
                    } else {
                        newSectionData.questions.push({
                            ...originalQ,
                            displayNum: `${q_index + 1}`
                        });
                    }
                });
                processedExercisesBySection[sectionNum] = newSectionData;
            });

            Object.entries(processedExercisesBySection).forEach(([sectionNum, sectionData]) => {
                const sectionDiv = document.createElement('div');
                
                const header = document.createElement('div');
                header.className = 'section-header';
                header.innerHTML = `<h2 class="text-2xl font-bold">${sectionNum}、${sectionData.title}</h2>`;

                if (sectionNum === "一") {
                    const mnemonicDiv = document.createElement('div');
                    mnemonicDiv.className = 'mnemonic-box';
                    mnemonicDiv.innerHTML = `<p class="font-bold text-yellow-800">💡 記憶口訣：屁後痘</p><p class="mt-1 text-yellow-700">意思是 <b>p</b>lease 放在句尾（<b>後</b>面）時，前面要加<b>逗</b>點喔！</p>`;
                    header.appendChild(mnemonicDiv);
                }

                if (sectionNum === "二") {
                    const mnemonicDiv = document.createElement('div');
                    mnemonicDiv.className = 'mnemonic-box';
                    mnemonicDiv.innerHTML = `<p class="font-bold text-yellow-800">💡 記憶口訣：人類前後長痘痘</p><p class="mt-1 text-yellow-700">意思是<b>人</b>名不管放在句首（<b>前</b>）或句尾（<b>後</b>），都要加<b>逗</b>點！</p>`;
                    header.appendChild(mnemonicDiv);
                }
                
                const exampleBox = document.createElement('div');
                exampleBox.className = 'example-box';
                if (Array.isArray(sectionData.example)) {
                     exampleBox.innerHTML = sectionData.example.map(ex => 
                        `<p class="text-gray-800"><b>例：</b>${ex.q} ${createSpeakerIcon(ex.q)}</p>` +
                        `<p class="text-blue-600 font-semibold">→ ${ex.a[0]} ${createSpeakerIcon(ex.a[0])}</p>`
                    ).join('<br>');
                } else {
                     exampleBox.innerHTML = 
                        `<p class="text-gray-800"><b>例：</b>${sectionData.example.q} ${createSpeakerIcon(sectionData.example.q)}</p>` +
                        sectionData.example.a.map(ans => 
                            `<p class="text-blue-600 font-semibold">→ ${ans} ${createSpeakerIcon(ans)}</p>`
                        ).join('');
                }
                header.appendChild(exampleBox);
                sectionDiv.appendChild(header);

                sectionData.questions.forEach((ex) => {
                    const card = document.createElement('div');
                    card.className = 'exercise-card';
                    card.id = `exercise-${ex.id}`;

                    const words = ex.chunks || ex.answers[0].split(/([,.]|\s+)/).filter(w => w.trim());
                    
                    const contentHTML = `
                        <div class="flex items-center mb-2">
                            <p class="mr-2 text-lg font-bold">${ex.displayNum}.</p>
                            <div class="question-text">${ex.question}</div>
                            ${createSpeakerIcon(ex.question.replace(/\//g, ''))}
                        </div>
                        <div class="word-bank mt-4">
                            ${[...words].sort(() => Math.random() - 0.5).map(word => `<div class="word-item">${word}</div>`).join('')}
                        </div>
                        <div class="drop-zone mt-3"></div>
                        <div class="flex gap-3 mt-4">
                            <button class="check-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded" data-answers='${JSON.stringify(ex.answers)}' data-id="${ex.id}">檢查答案</button>
                            <button class="reset-btn bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded" data-id="${ex.id}">重新作答</button>
                            <button class="hint-btn bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded" data-speak-hint="${ex.answers[0]}">💡 提示 (聽答案)</button>
                        </div>
                        <p class="feedback mt-2 text-sm font-bold"></p>
                    `;
                    card.innerHTML = contentHTML;
                    sectionDiv.appendChild(card);
                });
                container.appendChild(sectionDiv);
            });

            addEventListeners();
        });

        function addEventListeners() {
            const tooltip = document.getElementById('tooltip');
            document.body.addEventListener('mouseover', e => {
                const item = e.target.closest('.word-item');
                if (item) {
                    const text = item.textContent.trim();
                    const chinese = translations[text];
                    if (chinese) {
                        tooltip.textContent = chinese;
                        tooltip.style.display = 'block';
                    }
                }
            });
            document.body.addEventListener('mousemove', e => {
                if (tooltip.style.display === 'block') {
                    tooltip.style.left = `${e.pageX + 10}px`;
                    tooltip.style.top = `${e.pageY + 10}px`;
                }
            });
            document.body.addEventListener('mouseout', e => {
                if (e.target.closest('.word-item')) tooltip.style.display = 'none';
            });

            document.body.addEventListener('click', e => {
                const target = e.target;
                if (target.classList.contains('speaker-icon')) {
                    e.stopPropagation();
                    speak(target.dataset.speak);
                } else if (target.classList.contains('hint-btn')) {
                    speak(target.dataset.speakHint);
                } else if (target.classList.contains('word-item')) {
                    const card = target.closest('.exercise-card');
                    const wordBank = card.querySelector('.word-bank');
                    const dropZone = card.querySelector('.drop-zone');
                    if (target.parentElement === wordBank) {
                        speak(target.textContent);
                        dropZone.appendChild(target);
                    } else {
                        wordBank.appendChild(target);
                    }
                } else if (target.classList.contains('check-btn')) {
                    checkAnswer(target);
                } else if (target.classList.contains('reset-btn')) {
                    resetQuestion(target);
                }
            });
        }
        
        function checkAnswer(btn) {
            const exId = btn.dataset.id;
            const card = document.getElementById(`exercise-${exId}`);
            const dropZone = card.querySelector('.drop-zone');
            const feedbackEl = card.querySelector('.feedback');
            const words = Array.from(dropZone.children).map(child => child.textContent);
            
            const userAnswer = words.join(' ').replace(/ ,/g,',').replace(/ \./g,'.');

            const correctAnswer = JSON.parse(btn.dataset.answers)[0];

            if (userAnswer === correctAnswer) {
                feedbackEl.textContent = '🎉 太棒了，答對了！';
                feedbackEl.className = 'feedback mt-2 text-sm font-bold text-green-600';
                dropZone.classList.remove('incorrect');
                dropZone.classList.add('correct');
                card.classList.add('card-glow-animation');
                setTimeout(() => card.classList.remove('card-glow-animation'), 1000);
            } else {
                feedbackEl.textContent = '🤔 再試一次看看！';
                feedbackEl.className = 'feedback mt-2 text-sm font-bold text-red-600';
                dropZone.classList.add('incorrect');
                dropZone.classList.remove('correct');
            }
        }

        function resetQuestion(btn) {
            const exId = btn.dataset.id;
            const card = document.getElementById(`exercise-${exId}`);
            const dropZone = card.querySelector('.drop-zone');
            const wordBank = card.querySelector('.word-bank');
            const feedbackEl = card.querySelector('.feedback');
            
            Array.from(dropZone.children).forEach(child => wordBank.appendChild(child));
            
            feedbackEl.textContent = '';
            dropZone.classList.remove('correct', 'incorrect');
        }

        function createSpeakerIcon(textToSpeak) {
            const safeText = textToSpeak.replace(/<[^>]*>/g, '').replace(/"/g, '&quot;').replace(/\//g, '');
            return `<span class="speaker-icon" data-speak="${safeText}">🔊</span>`;
        }
    </script>
</body>
</html>


<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>國中英語文法練習 Unit 3 & 4</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 FontAwesome 圖標 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body {
            font-family: 'Noto Sans TC', sans-serif;
        }
        /* 自定義捲軸樣式 (Optional) */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen text-gray-800 font-sans">

    <!-- 應用程式容器 -->
    <div id="app-container" class="flex flex-col md:flex-row min-h-screen">
        <!-- 內容將由 JavaScript 動態渲染 -->
    </div>

    <script>
        // --- 題庫資料 ---
        const unitsData = {
            unit3: {
                title: "Unit 3 文法選擇",
                description: "祈使句、Can、受格用法",
                questions: [
                    // 句型一: 祈使句
                    {
                        id: 'u3-1',
                        category: "句型一: 祈使句 (Please, 人名, 逗號)",
                        question: "Nick, _____ happy. (Nick，要開心)",
                        options: ["X", "be", "is", "do"],
                        answerIndex: 1, // (B) be
                        keywords: ["Nick", "happy"],
                        tip: "祈使句省略主詞 You，句首用原形動詞。形容詞 happy 前面要用 Be 動詞原形 (Be)。"
                    },
                    {
                        id: 'u3-2',
                        category: "句型一: 祈使句 (Let's)",
                        question: "A: Let’s _____ play the game now. \nB: OK.",
                        options: ["no", "not", "be not", "don’t"],
                        answerIndex: 1, // (B) not
                        keywords: ["Let's"],
                        tip: "Let's (我們一起...吧) 的否定形式是 「Let's not + 原形動詞」。"
                    },
                    {
                        id: 'u3-3',
                        category: "句型一: 祈使句 (否定)",
                        question: "_____ sing in the library (圖書館).",
                        options: ["Not", "Let’s", "Don’t", "Please"],
                        answerIndex: 2, // (C) Don't
                        keywords: ["sing", "library"],
                        tip: "否定祈使句 (不要...) 用 Don't 開頭，後面接原形動詞。"
                    },
                    {
                        id: 'u3-4',
                        category: "句型一: 祈使句 (位置)",
                        question: "Close your book, _____.",
                        options: ["please Lily", "Lily", "Lily please", "please to"],
                        answerIndex: 1, // (B) Lily
                        keywords: ["Close"],
                        tip: "這是對特定對象說話的祈使句。人名 (Lily) 放在句尾時，前面要加逗號。"
                    },
                    {
                        id: 'u3-5',
                        category: "句型一: 祈使句 (否定)",
                        question: "_____ run in the living room, boys.",
                        options: ["Not", "Don’t be", "No", "Don’t"],
                        answerIndex: 3, // (D) Don't
                        keywords: ["run", "boys"],
                        tip: "叫某人「不要跑」，否定祈使句用 Don't + 原形動詞 (run)。"
                    },
                    {
                        id: 'u3-6',
                        category: "句型一: 祈使句 (人名與逗號)",
                        question: "_____, stand up.",
                        options: ["John", "Please", "Don’t", "Let’s"],
                        answerIndex: 0, // (A) John
                        keywords: ["stand up"],
                        tip: "空格後面有逗號，表示是在稱呼某人 (John)。若是 Please 放句首通常不加逗號(雖然加也可以，但人名必定要加)。Don't 和 Let's 後面不直接加逗號。"
                    },
                    {
                        id: 'u3-7',
                        category: "句型一: 祈使句 (Let's)",
                        question: "_____ not eat or talk here.",
                        options: ["No", "Let’s", "Be", "Don’t"],
                        answerIndex: 1, // (B) Let's
                        keywords: ["not eat"],
                        tip: "看到 not + 原形動詞，前面搭配 Let's 形成建議的否定「Let's not...」(我們不要...吧)。若用 Don't 則不需加 not。"
                    },
                    {
                        id: 'u3-8',
                        category: "句型一: 祈使句",
                        question: "_____ your room. It’s very dirty (髒的).",
                        options: ["Be", "Let’s", "Clean", "Not clean"],
                        answerIndex: 2, // (C) Clean
                        keywords: ["dirty", "room"],
                        tip: "祈使句用原形動詞開頭。Clean your room (打掃你的房間)。"
                    },
                    {
                        id: 'u3-9',
                        category: "句型一: 錯誤句子判斷",
                        question: "選出錯誤的句子。",
                        options: [
                            "Please sing the song, students.",
                            "Please, students sing the song.",
                            "Students, please sing the song.",
                            "Students, sing the song, please."
                        ],
                        answerIndex: 1, // (B)
                        keywords: ["Please", "Students"],
                        tip: "Please 放句首通常不加逗號 (除非強調)，且語序通常是 Please sing..., students. 或 Students, please sing...。選項 (B) 結構怪異，看似把 students 當主詞但又像祈使句，語意不清。"
                    },
                    // 句型二: Can 的用法
                    {
                        id: 'u3-10',
                        category: "句型二: Can 的用法",
                        question: "A: Can your mother cook? \nB: No, but my father _____.",
                        options: ["cook", "is", "can", "can’t"],
                        answerIndex: 2, // (C) can
                        keywords: ["Can", "but"],
                        tip: "前面問 Can...? (會不會?)，回答用 can/can't。因為有 but (但是)，表示轉折，媽媽不會(No)，但是爸爸會(can)。"
                    },
                    {
                        id: 'u3-11',
                        category: "句型二: Can 的用法",
                        question: "The bird can _____ hello to people.",
                        options: ["speak", "speaking", "saying", "say"],
                        answerIndex: 3, // (D) say
                        keywords: ["can"],
                        tip: "助動詞 Can 後面一定要接「原形動詞」。say hello 是固定用法。"
                    },
                    {
                        id: 'u3-12',
                        category: "句型二: Can 的用法",
                        question: "A: Bob: Can you jump? \nB: Yes, I _____.",
                        options: ["am", "can", "jump", "do"],
                        answerIndex: 1, // (B) can
                        keywords: ["Can"],
                        tip: "用 Can 開頭的問句，簡答時也要用 can/can't 回答。"
                    },
                    {
                        id: 'u3-13',
                        category: "句型二: Can 的用法",
                        question: "A: Can they play tennis? \nB: No, ______________.",
                        options: ["they can’t", "they can’t play", "I can", "we can’t"],
                        answerIndex: 0, // (A) they can't
                        keywords: ["they", "No"],
                        tip: "問句主詞是 they，回答也要用 they。否定回答 No, they can't。"
                    },
                    {
                        id: 'u3-14',
                        category: "句型二: Can 的用法",
                        question: "A: Can you spell (拼) “happy”? \nB: Sure, I _____. “H-A-P-P-Y.”",
                        options: ["can", "do", "may", "am"],
                        answerIndex: 0, // (A) can
                        keywords: ["Can", "Sure"],
                        tip: "Sure (當然) 表示肯定，且用 Can 問就用 can 回答。"
                    },
                    // 句型三: 受格用法
                    {
                        id: 'u3-15',
                        category: "句型三: 受格的用法",
                        question: "Tony is in front of _____.",
                        options: ["I", "am", "my", "me"],
                        answerIndex: 3, // (D) me
                        keywords: ["in front of"],
                        tip: "介系詞 (of) 後面要接「受格」。I 的受格是 me。"
                    },
                    {
                        id: 'u3-16',
                        category: "句型三: 受格的用法",
                        question: "Today is Kelly’s birthday. I have a gift for _____.",
                        options: ["she", "her", "his", "he"],
                        answerIndex: 1, // (B) her
                        keywords: ["Kelly", "for"],
                        tip: "Kelly 是女生，介系詞 for 後面接代名詞受格。She 的受格是 her。"
                    },
                    {
                        id: 'u3-17',
                        category: "句型三: 受格的用法",
                        question: "I have two dolls. I like _____.",
                        options: ["them", "they", "their", "we"],
                        answerIndex: 0, // (A) them
                        keywords: ["dolls", "like"],
                        tip: "Dolls (娃娃) 是複數，且放在動詞 like 後面當受詞，要用複數受格 them。"
                    },
                    {
                        id: 'u3-18',
                        category: "句型三: 受格的用法",
                        question: "A: Are you and your sister in the living room? \nB: Yes, my parents are with _____.",
                        options: ["we", "our", "us", "the"],
                        answerIndex: 2, // (C) us
                        keywords: ["you and your sister", "with"],
                        tip: "回答者是 B (包含在 you and your sister 裡面)，所以變成了「我父母跟我們在一起」。介系詞 with 後面接 We 的受格 us。"
                    }
                ]
            },
            unit4: {
                title: "Unit 4 文法選擇",
                description: "What day/time, 現在進行式",
                questions: [
                    // 原有的 Unit 4 題目
                    {
                        id: 'u4-1',
                        category: "句型一: What day 詢問星期幾",
                        question: "Molly: What _____ is it?\nPaul: It’s Tuesday.",
                        options: ["today", "day", "a day", "the day"],
                        answerIndex: 1, // (B) day
                        keywords: ["What", "Tuesday"],
                        tip: "詢問「星期幾」固定句型為 What day is it? 回答是 Tuesday (星期二)，所以關鍵字是 day。"
                    },
                    {
                        id: 'u4-2',
                        category: "句型一: What day 詢問星期幾",
                        question: "The baseball game is ______ Wednesday.",
                        options: ["at", "in", "on", "X"],
                        answerIndex: 2, // (C) on
                        keywords: ["Wednesday"],
                        tip: "特定的一天（星期幾、日期）前面介系詞要用 on。"
                    },
                    {
                        id: 'u4-3',
                        category: "句型一: What day 詢問星期幾",
                        question: "The concert is _______ Thursday.",
                        options: ["on this", "this on", "X", "this"],
                        answerIndex: 0, // (A) on this (修正為 A)
                        keywords: ["Thursday"],
                        tip: "「on」是介系詞，用來搭配「星期幾」(例如 on Monday)。因此要說「音樂會在這個星期四」，要用 on this Thursday。"
                    },
                    {
                        id: 'u4-4',
                        category: "句型一: What day 詢問星期幾",
                        question: "Zoe: What ________ is the movie?\nJoe: It's _______ Saturday.",
                        options: ["day; on", "a day; in", "today; on", "the day; in"],
                        answerIndex: 0, // (A) day; on
                        keywords: ["What", "Saturday"],
                        tip: "問句問活動在哪一天用 What day。回答特定星期幾用 on。"
                    },
                    {
                        id: 'u4-5',
                        category: "句型一: What day 詢問星期幾",
                        question: "Today is _______ Monday.",
                        options: ["in", "at", "on", "X"],
                        answerIndex: 3, // (D) X
                        keywords: ["Today", "Monday"],
                        tip: "Today (今天) 是主詞，後面接 be動詞 和 星期，中間不需要介系詞。"
                    },
                    {
                        id: 'u4-6',
                        category: "句型二: What time 詢問幾點",
                        question: "The game is _____ two thirty.",
                        options: ["at", "in", "on", "X"],
                        answerIndex: 0, // (A) at
                        keywords: ["two thirty"],
                        tip: "在幾點幾分，介系詞要用 at。"
                    },
                    {
                        id: 'u4-7',
                        category: "句型二: What time 詢問幾點",
                        question: "A: What time is it?\nB: It’s _____ five forty.",
                        options: ["at", "in", "on", "X"],
                        answerIndex: 3, // (D) X
                        keywords: ["What time", "It's"],
                        tip: "單純回答「現在幾點」時 (It is ...)，直接接時間，不加 at。只有在講活動「在」幾點時才加 at。"
                    },
                    {
                        id: 'u4-8',
                        category: "句型二: What time 詢問幾點",
                        question: "The movie is ______ 8 p.m.",
                        options: ["at", "in", "on", "X"],
                        answerIndex: 0, // (A) at
                        keywords: ["8 p.m."],
                        tip: "8 p.m. 是明確的時間點，介系詞用 at。"
                    },
                    {
                        id: 'u4-9',
                        category: "句型二: What time 詢問幾點",
                        question: "A: What time is it?\nB: It's seven five _____ the evening.",
                        options: ["on", "at", "in", "X"],
                        answerIndex: 2, // (C) in
                        keywords: ["the evening"],
                        tip: "早中晚時段用 in (in the morning, in the afternoon, in the evening)。"
                    },
                    {
                        id: 'u4-10',
                        category: "句型二: What time 詢問幾點",
                        question: "Kelly’s birthday party is _______ Sunday morning.",
                        options: ["in", "at", "X", "on"],
                        answerIndex: 3, // (D) on
                        keywords: ["Sunday morning"],
                        tip: "雖然 morning 常用 in，但因為前面有指定「星期日」Sunday，變成特定的一天早晨，所以要用 on。"
                    },
                    {
                        id: 'u4-11',
                        category: "句型二: What time 詢問幾點",
                        question: "A: _____ is Mark’s concert at the park?\nB: Isn’t it _____ six p.m.?",
                        options: ["How old; on", "What time; at", "How about; at", "What day; on"],
                        answerIndex: 1, // (B) What time; at
                        keywords: ["six p.m."],
                        tip: "回答是時間點 (6 p.m.)，所以問句用 What time。時間點介系詞用 at。"
                    },
                    {
                        id: 'u4-12',
                        category: "句型三: 現在進行式 (S.+be+V.ing)",
                        question: "A: _____________ \nB: I’m waiting for my dad.",
                        options: ["How are you doing?", "What are you doing?", "Who’s jumping rope?", "Where are you doing?"],
                        answerIndex: 1, // (B) What are you doing?
                        keywords: ["waiting"],
                        tip: "回答是「我正在等...」，表示問句是問「你正在做什麼？(What are you doing?)」。"
                    },
                    {
                        id: 'u4-13',
                        category: "句型三: 現在進行式 (S.+be+V.ing)",
                        question: "A: What are you _____? \nB: I’m _____.",
                        options: ["do; study", "studying; studying", "doing; studying", "watching; studying"],
                        answerIndex: 2, // (C) doing; studying
                        keywords: ["are", "'m"],
                        tip: "問句有 be動詞 (are)，動詞要加 ing (doing)。回答有 be動詞 ('m)，動詞也要加 ing (studying)。"
                    },
                    {
                        id: 'u4-14',
                        category: "句型三: 現在進行式 (S.+be+V.ing)",
                        question: "Excuse me. I really need to go now. My kids _____ for me at school.",
                        options: ["are waiting", "were waiting", "wait", "waited"],
                        answerIndex: 0, // (A) are waiting
                        keywords: ["now"],
                        tip: "關鍵字 now (現在)，表示此刻正在發生，要用現在進行式 (be + V-ing)。Kids 是複數，用 are waiting。"
                    },
                    {
                        id: 'u4-15',
                        category: "句型三: 現在進行式 (S.+be+V.ing)",
                        question: "My parents _______ eating, not _______.",
                        options: ["is; drink", "are; drinking", "is; drinking", "are; drink"],
                        answerIndex: 1, // (B) are; drinking
                        keywords: ["parents"],
                        tip: "Parents (父母) 是複數，be動詞用 are。後面連接的動作也要維持 V-ing (drinking)。"
                    },
                    {
                        id: 'u4-16',
                        category: "句型三: 現在進行式 (S.+be+V.ing)",
                        question: "A: ________ \nB: I'm making Christmas cards.",
                        options: ["Where are you going?", "How are you doing?", "What are you doing?", "Who is talking?"],
                        answerIndex: 2, // (C) What are you doing?
                        keywords: ["making"],
                        tip: "回答是「我正在做卡片」，問句應為「你正在做什麼？」。"
                    }
                ]
            }
        };

        // --- 全域狀態 ---
        const state = {
            currentUnit: 'unit3', // 預設單元，可切換 'unit3' 或 'unit4'
            mode: 'menu',         // 'menu', 'learn', 'quiz', 'result'
            currentQIndex: 0,
            selectedOption: null, // 用於學習模式的當前選擇
            isSubmitted: false,   // 學習模式是否已提交
            quizAnswers: {}       // 測驗模式的答案 {questionIndex: selectedOptionIndex}
        };

        // --- 語音功能 ---
        function speak(text) {
            if (!window.speechSynthesis) return;
            const cleanText = text.replace(/_+/g, " blank ");
            const utterance = new SpeechSynthesisUtterance(cleanText);
            utterance.lang = 'en-US';
            utterance.rate = 0.9;
            window.speechSynthesis.cancel();
            window.speechSynthesis.speak(utterance);
        }

        // --- 狀態控制函式 ---
        function switchUnit(unitKey) {
            if (state.currentUnit === unitKey && state.mode === 'menu') return; // 如果已經在該單元首頁，不做動作
            
            // 如果正在測驗中，可以加個確認提示 (這裡簡化直接切換)
            state.currentUnit = unitKey;
            state.mode = 'menu';
            state.currentQIndex = 0;
            state.selectedOption = null;
            state.isSubmitted = false;
            state.quizAnswers = {};
            
            // 如果是手機版，切換後可以自動捲到上方 (Optional)
            window.scrollTo(0,0);
            render();
        }

        function changeMode(mode) {
            state.mode = mode;
            state.currentQIndex = 0;
            state.selectedOption = null;
            state.isSubmitted = false;
            if (mode === 'menu') {
                state.quizAnswers = {};
            }
            render();
        }

        function handleLearnSelect(idx) {
            if (state.isSubmitted) return;
            state.selectedOption = idx;
            render();
        }

        function handleLearnSubmit() {
            if (state.selectedOption === null) return;
            state.isSubmitted = true;
            render();
        }

        function handleLearnNext() {
            const questions = unitsData[state.currentUnit].questions;
            if (state.currentQIndex < questions.length - 1) {
                state.currentQIndex++;
                state.selectedOption = null;
                state.isSubmitted = false;
                render();
            } else {
                changeMode('menu');
            }
        }

        function handleQuizSelect(idx) {
            state.quizAnswers[state.currentQIndex] = idx;
            render();
        }

        function handleQuizNext() {
            const questions = unitsData[state.currentUnit].questions;
            if (state.currentQIndex < questions.length - 1) {
                state.currentQIndex++;
                render();
            } else {
                changeMode('result');
            }
        }

        // --- 渲染核心 ---
        function render() {
            const container = document.getElementById('app-container');
            container.innerHTML = ''; // 清空容器

            // 1. Sidebar (導覽列)
            const sidebar = document.createElement('aside');
            sidebar.className = "w-full md:w-72 bg-white md:min-h-screen shadow-md flex-shrink-0 flex flex-col z-10";
            sidebar.innerHTML = `
                <div class="p-6 bg-blue-800 text-white">
                    <h1 class="text-2xl font-bold flex items-center gap-2">
                        <i class="fa-solid fa-graduation-cap"></i>
                        文法練習站
                    </h1>
                    <p class="text-blue-200 text-sm mt-1">Class_____ Name_________</p>
                </div>
                <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
                    <button onclick="switchUnit('unit3')" 
                        class="w-full text-left p-4 rounded-xl transition-all duration-200 flex items-center gap-3 border ${state.currentUnit === 'unit3' ? 'bg-blue-50 border-blue-200 text-blue-800 shadow-sm' : 'hover:bg-gray-50 border-transparent text-gray-600'}">
                        <div class="w-8 h-8 rounded-full flex items-center justify-center ${state.currentUnit === 'unit3' ? 'bg-blue-200 text-blue-800' : 'bg-gray-100 text-gray-400'}">
                            3
                        </div>
                        <div>
                            <div class="font-bold">Unit 3</div>
                            <div class="text-xs opacity-70">祈使句、Can、受格</div>
                        </div>
                        ${state.currentUnit === 'unit3' ? '<i class="fa-solid fa-chevron-right ml-auto text-blue-400"></i>' : ''}
                    </button>

                    <button onclick="switchUnit('unit4')" 
                        class="w-full text-left p-4 rounded-xl transition-all duration-200 flex items-center gap-3 border ${state.currentUnit === 'unit4' ? 'bg-indigo-50 border-indigo-200 text-indigo-800 shadow-sm' : 'hover:bg-gray-50 border-transparent text-gray-600'}">
                        <div class="w-8 h-8 rounded-full flex items-center justify-center ${state.currentUnit === 'unit4' ? 'bg-indigo-200 text-indigo-800' : 'bg-gray-100 text-gray-400'}">
                            4
                        </div>
                        <div>
                            <div class="font-bold">Unit 4</div>
                            <div class="text-xs opacity-70">What day/time、進行式</div>
                        </div>
                        ${state.currentUnit === 'unit4' ? '<i class="fa-solid fa-chevron-right ml-auto text-indigo-400"></i>' : ''}
                    </button>
                </nav>
                <div class="p-4 border-t text-center text-xs text-gray-400">
                    &copy; English Grammar Quiz
                </div>
            `;
            container.appendChild(sidebar);

            // 2. Main Content Area (右側主內容)
            const mainContent = document.createElement('div');
            mainContent.className = "flex-1 flex flex-col h-screen overflow-hidden";
            
            // 頂部標題列 (在手機版顯示，或顯示當前狀態)
            const header = document.createElement('header');
            header.className = "bg-white border-b px-6 py-4 flex justify-between items-center shadow-sm";
            header.innerHTML = `
                <div class="flex items-center gap-2 text-gray-700 font-bold">
                    <span class="px-2 py-1 rounded text-sm ${state.currentUnit === 'unit3' ? 'bg-blue-100 text-blue-700' : 'bg-indigo-100 text-indigo-700'}">
                        ${state.currentUnit === 'unit3' ? 'Unit 3' : 'Unit 4'}
                    </span>
                    <span>${state.mode === 'menu' ? '首頁' : state.mode === 'learn' ? '學習模式' : state.mode === 'quiz' ? '測驗模式' : '結果'}</span>
                </div>
                ${state.mode !== 'menu' ? `
                <button onclick="changeMode('menu')" class="text-gray-500 hover:text-blue-600 transition-colors" title="回到單元首頁">
                    <i class="fa-solid fa-house text-xl"></i>
                </button>` : ''}
            `;
            mainContent.appendChild(header);

            // 內容捲動區
            const scrollArea = document.createElement('div');
            scrollArea.className = "flex-1 overflow-y-auto p-4 md:p-8";
            
            // 根據模式渲染內容
            if (state.mode === 'menu') {
                scrollArea.innerHTML = renderMenu();
            } else if (state.mode === 'learn') {
                scrollArea.innerHTML = renderLearnMode();
            } else if (state.mode === 'quiz') {
                scrollArea.innerHTML = renderQuizMode();
            } else if (state.mode === 'result') {
                scrollArea.innerHTML = renderResult();
            }

            mainContent.appendChild(scrollArea);
            container.appendChild(mainContent);
        }

        // --- HTML 生成函式 (內容部分) ---

        function renderMenu() {
            const unit = unitsData[state.currentUnit];
            const themeColor = state.currentUnit === 'unit3' ? 'blue' : 'indigo';
            
            return `
                <div class="flex flex-col items-center justify-center h-full max-w-4xl mx-auto space-y-8">
                    <div class="text-center space-y-4">
                        <div class="inline-block p-3 rounded-full bg-${themeColor}-100 text-${themeColor}-600 mb-2">
                            <i class="fa-solid fa-layer-group text-3xl"></i>
                        </div>
                        <h1 class="text-4xl font-bold text-gray-800 tracking-tight">${unit.title}</h1>
                        <p class="text-gray-500 text-xl">${unit.description}</p>
                    </div>
                    
                    <div class="grid md:grid-cols-2 gap-6 w-full max-w-2xl px-4 mt-8">
                        <button onclick="changeMode('learn')" class="group relative flex flex-col items-center p-8 bg-white border-2 border-blue-100 rounded-2xl shadow-sm hover:shadow-lg hover:border-blue-400 transition-all duration-300">
                            <div class="p-4 bg-blue-50 rounded-full mb-4 group-hover:bg-blue-100 transition-colors w-16 h-16 flex items-center justify-center">
                                <i class="fa-solid fa-book-open text-2xl text-blue-600"></i>
                            </div>
                            <h2 class="text-2xl font-bold text-gray-800 mb-2">學習版</h2>
                            <p class="text-gray-500 text-center text-sm">逐題練習，顯示關鍵字與發音，<br/>並提供詳細解題訣竅。</p>
                        </button>

                        <button onclick="changeMode('quiz')" class="group relative flex flex-col items-center p-8 bg-white border-2 border-purple-100 rounded-2xl shadow-sm hover:shadow-lg hover:border-purple-400 transition-all duration-300">
                            <div class="p-4 bg-purple-50 rounded-full mb-4 group-hover:bg-purple-100 transition-colors w-16 h-16 flex items-center justify-center">
                                <i class="fa-solid fa-graduation-cap text-2xl text-purple-600"></i>
                            </div>
                            <h2 class="text-2xl font-bold text-gray-800 mb-2">測驗版</h2>
                            <p class="text-gray-500 text-center text-sm">模擬考試，無提示，<br/>最後計算總成績。</p>
                        </button>
                    </div>
                </div>
            `;
        }

        function renderLearnMode() {
            const questions = unitsData[state.currentUnit].questions;
            const question = questions[state.currentQIndex];
            const qText = question.question;

            let optionsHTML = '';
            question.options.forEach((opt, idx) => {
                let btnClass = "w-full text-left p-4 rounded-xl border-2 transition-all duration-200 flex items-center ";
                let circleClass = "w-6 h-6 rounded-full border-2 mr-4 flex items-center justify-center flex-shrink-0 ";
                let iconHTML = '';

                if (state.isSubmitted) {
                    if (idx === question.answerIndex) {
                        btnClass += "bg-green-50 border-green-500 text-green-700";
                        circleClass += "border-green-500 bg-green-500 text-white";
                        iconHTML = '<i class="fa-solid fa-circle-check ml-auto text-green-600 text-xl"></i>';
                    } else if (idx === state.selectedOption) {
                        btnClass += "bg-red-50 border-red-500 text-red-700";
                        circleClass += "border-red-500 bg-red-500 text-white";
                        iconHTML = '<i class="fa-solid fa-circle-xmark ml-auto text-red-600 text-xl"></i>';
                    } else {
                        btnClass += "border-gray-100 text-gray-400 opacity-60";
                        circleClass += "border-gray-300";
                    }
                } else {
                    if (state.selectedOption === idx) {
                        btnClass += "border-blue-500 bg-blue-50 text-blue-700 shadow-md";
                        circleClass += "border-blue-500 bg-blue-500 text-white";
                    } else {
                        btnClass += "border-gray-200 hover:border-blue-300 hover:bg-gray-50 text-gray-700";
                        circleClass += "border-gray-300";
                    }
                }

                optionsHTML += `
                    <button onclick="handleLearnSelect(${idx})" class="${btnClass}" ${state.isSubmitted ? 'disabled' : ''}>
                        <div class="${circleClass}">
                            ${['A', 'B', 'C', 'D'][idx]}
                        </div>
                        <span class="text-lg">${opt}</span>
                        ${iconHTML}
                    </button>
                `;
            });

            return `
                <div class="max-w-3xl mx-auto w-full pb-8">
                    <div class="mb-6 flex justify-between items-center text-sm text-gray-500 font-medium">
                        <span class="bg-gray-100 px-3 py-1 rounded-full text-gray-600">${question.category}</span>
                        <span>Question ${state.currentQIndex + 1} / ${questions.length}</span>
                    </div>

                    <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
                        <div class="p-6 md:p-10">
                            <div class="flex justify-between items-start mb-6">
                                <p class="text-xl md:text-2xl font-medium text-gray-800 whitespace-pre-line leading-relaxed flex-1">${qText}</p>
                                <button onclick="speak(\`${qText.replace(/\n/g, ' ')}\`)" class="ml-4 p-3 rounded-full bg-blue-50 text-blue-600 hover:bg-blue-100 transition-colors flex-shrink-0" title="播放發音">
                                    <i class="fa-solid fa-volume-high text-xl"></i>
                                </button>
                            </div>
                            
                            <div class="mb-8 flex flex-wrap gap-2">
                                <span class="text-xs font-bold text-gray-400 uppercase tracking-wide self-center">Keywords:</span>
                                ${question.keywords.map(kw => `<span class="px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded-md font-bold">${kw}</span>`).join('')}
                            </div>

                            <div class="space-y-4">
                                ${optionsHTML}
                            </div>
                        </div>

                        <div class="bg-gray-50 p-6 border-t border-gray-100">
                            ${!state.isSubmitted ? `
                                <button onclick="handleLearnSubmit()" 
                                    class="w-full py-4 rounded-xl font-bold text-lg shadow-sm transition-all ${state.selectedOption !== null ? 'bg-blue-600 text-white hover:bg-blue-700 hover:shadow-md transform hover:-translate-y-0.5' : 'bg-gray-200 text-gray-400 cursor-not-allowed'}" 
                                    ${state.selectedOption === null ? 'disabled' : ''}>
                                    檢查答案
                                </button>
                            ` : `
                                <div>
                                    <div class="bg-blue-50 border border-blue-200 rounded-xl p-5 mb-6">
                                        <div class="flex items-center gap-2 mb-2 text-blue-800 font-bold text-lg">
                                           <i class="fa-regular fa-lightbulb"></i>
                                           解題訣竅
                                        </div>
                                        <p class="text-blue-900 leading-relaxed text-base">${question.tip}</p>
                                    </div>
                                    <button onclick="handleLearnNext()" class="w-full py-4 bg-gray-800 text-white rounded-xl font-bold text-lg hover:bg-gray-900 transition-all flex items-center justify-center gap-2">
                                        ${state.currentQIndex < questions.length - 1 ? '下一題' : '完成練習'} 
                                        <i class="fa-solid fa-arrow-right"></i>
                                    </button>
                                </div>
                            `}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderQuizMode() {
            const questions = unitsData[state.currentUnit].questions;
            const question = questions[state.currentQIndex];
            const currentAnswer = state.quizAnswers[state.currentQIndex];

            let optionsHTML = '';
            question.options.forEach((opt, idx) => {
                const isSelected = currentAnswer === idx;
                let btnClass = isSelected 
                    ? "border-purple-500 bg-purple-50 text-purple-700 shadow-md ring-1 ring-purple-500"
                    : "border-gray-200 hover:border-purple-300 hover:bg-gray-50 text-gray-700";
                
                let circleClass = isSelected
                    ? "border-purple-500 bg-purple-500 text-white"
                    : "border-gray-300";

                optionsHTML += `
                    <button onclick="handleQuizSelect(${idx})" class="w-full text-left p-4 rounded-xl border-2 transition-all duration-200 flex items-center ${btnClass}">
                        <div class="w-6 h-6 rounded-full border-2 mr-4 flex items-center justify-center ${circleClass}">
                           ${['A', 'B', 'C', 'D'][idx]}
                        </div>
                        <span class="text-lg">${opt}</span>
                    </button>
                `;
            });

            return `
                <div class="max-w-3xl mx-auto w-full pb-8">
                    <div class="mb-6 flex justify-between items-center text-sm font-medium">
                        <span class="text-purple-600 font-bold bg-purple-50 px-3 py-1 rounded-full">測驗模式</span>
                        <span class="text-gray-500">Question ${state.currentQIndex + 1} / ${questions.length}</span>
                    </div>

                    <div class="bg-white rounded-2xl shadow-sm border border-purple-100 overflow-hidden">
                        <div class="p-6 md:p-10">
                            <div class="flex justify-between items-start mb-8">
                                <p class="text-xl md:text-2xl font-medium text-gray-800 whitespace-pre-line flex-1 leading-relaxed">${question.question}</p>
                                <button onclick="speak(\`${question.question.replace(/\n/g, ' ')}\`)" class="ml-4 p-3 rounded-full bg-purple-50 text-purple-600 hover:bg-purple-100 transition-colors flex-shrink-0">
                                    <i class="fa-solid fa-volume-high text-xl"></i>
                                </button>
                            </div>

                            <div class="space-y-4">
                                ${optionsHTML}
                            </div>
                        </div>

                        <div class="bg-gray-50 p-6 border-t border-gray-100">
                           <button onclick="handleQuizNext()" 
                                class="w-full py-4 rounded-xl font-bold text-lg transition-all flex items-center justify-center gap-2 ${currentAnswer !== undefined ? 'bg-purple-600 text-white hover:bg-purple-700 shadow-md' : 'bg-gray-200 text-gray-400 cursor-not-allowed'}"
                                ${currentAnswer === undefined ? 'disabled' : ''}>
                                ${state.currentQIndex < questions.length - 1 ? '下一題' : '提交考卷'} 
                                <i class="fa-solid fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                     <div class="text-center mt-6">
                        <button onclick="changeMode('menu')" class="text-gray-400 hover:text-gray-600 text-sm underline">放棄測驗並離開</button>
                    </div>
                </div>
            `;
        }

        function renderResult() {
            const questions = unitsData[state.currentUnit].questions;
            let correctCount = 0;
            let wrongHTML = '';

            questions.forEach((q, idx) => {
                const userAnswer = state.quizAnswers[idx];
                const isCorrect = q.answerIndex === userAnswer;
                if (isCorrect) {
                    correctCount++;
                } else {
                    wrongHTML += `
                        <div class="bg-white p-5 rounded-xl border border-red-100 mb-4 shadow-sm hover:shadow-md transition-shadow">
                            <div class="flex items-start gap-3 mb-3">
                                <i class="fa-solid fa-circle-xmark text-red-500 mt-1 flex-shrink-0 text-xl"></i>
                                <div>
                                    <span class="text-xs font-bold text-gray-400 uppercase">Question ${idx + 1}</span>
                                    <p class="font-medium text-gray-800 whitespace-pre-line text-lg mt-1">${q.question}</p>
                                </div>
                            </div>
                            <div class="pl-9 text-sm space-y-2">
                                <div class="flex gap-4">
                                    <p class="text-red-600 font-medium">你的答案: ${q.options[userAnswer] || "未作答"}</p>
                                    <p class="text-green-600 font-bold">正確答案: ${q.options[q.answerIndex]}</p>
                                </div>
                                <div class="bg-gray-50 p-3 rounded-lg text-gray-600 border border-gray-100">
                                    <i class="fa-solid fa-info-circle mr-1"></i>
                                    ${q.tip}
                                </div>
                            </div>
                        </div>
                    `;
                }
            });

            const score = Math.round((correctCount / questions.length) * 100);

            return `
                <div class="max-w-3xl mx-auto w-full pb-8">
                    <div class="bg-white rounded-3xl shadow-xl overflow-hidden mb-8 border border-gray-100">
                        <div class="bg-gradient-to-r from-purple-600 to-blue-600 p-10 text-center text-white">
                            <h2 class="text-3xl font-bold mb-2 opacity-90">${unitsData[state.currentUnit].title}</h2>
                            <h3 class="text-2xl font-bold mb-6">測驗結果</h3>
                            <div class="text-7xl font-extrabold my-6 drop-shadow-md">${score} <span class="text-3xl font-normal opacity-80">分</span></div>
                            <div class="inline-block bg-white/20 px-6 py-2 rounded-full backdrop-blur-sm">
                                <p class="font-medium">答對 ${correctCount} 題 / 共 ${questions.length} 題</p>
                            </div>
                        </div>
                        
                        <div class="p-6 md:p-8 bg-gray-50">
                            <h3 class="font-bold text-gray-700 mb-6 px-2 flex items-center gap-2 text-xl">
                                <i class="fa-solid fa-clipboard-check"></i> 錯題檢討
                            </h3>
                            ${wrongHTML || `
                                <div class="text-center py-12 text-gray-500 flex flex-col items-center">
                                    <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mb-4 text-green-500 text-4xl">
                                        <i class="fa-solid fa-trophy"></i>
                                    </div>
                                    <p class="text-2xl font-bold text-gray-700">太棒了！全對！</p>
                                    <p class="mt-2 text-gray-500">你已經完全掌握了這個單元！</p>
                                </div>
                            `}
                        </div>

                        <div class="p-6 border-t border-gray-200 bg-white">
                            <button onclick="changeMode('menu')" class="w-full py-4 bg-gray-800 text-white rounded-xl font-bold text-lg hover:bg-gray-900 transition-all flex items-center justify-center gap-2 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                                <i class="fa-solid fa-rotate-left"></i> 回到單元選單
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // 初始化
        render();

    </script>
</body>
</html>
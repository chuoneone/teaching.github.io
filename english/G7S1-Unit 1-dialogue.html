<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸ƒä¸ŠU1æœ—è®€</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- æ•´é«”é é¢æ¨£å¼ --- */
        body {
            font-family: 'Noto Sans TC', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            color: #333;
            overflow: hidden;
        }

        /* --- ä¸»è¦å®¹å™¨ --- */
        .container {
            background-color: rgba(255, 255, 255, 0.9);
            padding: 40px 50px;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
            text-align: center;
            width: 90%;
            max-width: 650px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease;
        }

        .container.finished {
            transform: scale(1.05);
        }

        .location-tag {
            font-style: italic;
            color: #555;
            margin-bottom: 20px;
            font-size: 1.1em;
            font-weight: 700;
        }

        /* --- å°è©±å…§å®¹ --- */
        .speaker-line {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            min-height: 50px;
        }

        .speaker {
            font-weight: 700;
            color: #0056b3;
            margin-right: 12px;
            font-size: 1.6em;
        }

        .sentence {
            font-size: 1.8em;
            margin: 0;
            color: #000;
            font-weight: 400;
            line-height: 1.4;
        }
        
        .translation {
            font-size: 1.2em;
            color: #495057;
            margin: 5px 0 25px 0;
            min-height: 20px;
        }

        /* --- æŒ‰éˆ•æ¨£å¼ --- */
        button {
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1.1em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        button:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }
        
        button:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }

        #play-btn {
            background: linear-gradient(45deg, #007bff, #0056b3);
            color: white;
        }
        
        #play-chinese-btn {
            background: linear-gradient(45deg, #fd7e14, #ffc107);
            color: white;
        }

        #next-btn {
            background: linear-gradient(45deg, #28a745, #218838);
            color: white;
        }
        
        /* --- å½ˆå‡ºè¦–çª— --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            z-index: 1000;
        }

        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            min-width: 350px;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        
        .modal-overlay.visible .modal-content {
            transform: scale(1);
        }

        .modal-content h2 {
            margin-top: 0;
            color: #333;
        }
        
        #listen-again-btn {
            background-color: #ffc107;
            color: #333;
        }
        
        #record-btn {
            background-color: #dc3545;
            color: white;
        }
        
        #record-btn.recording {
            background-color: #c82333;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(220, 53, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
        }

        /* --- å›é¥‹å€ --- */
        .feedback-area {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        
        .feedback-area p {
            margin: 8px 0;
        }

        #recognition-result {
            font-style: italic;
            color: #6c757d;
        }

        #score-result {
            font-size: 1.3em;
            font-weight: bold;
        }
        
        /* --- éš±è—/é¡¯ç¤º --- */
        .hidden {
            display: none;
        }

        /* --- éŸ¿æ‡‰å¼è¨­è¨ˆ --- */
        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }
            .speaker, .sentence {
                font-size: 1.3em;
            }
            .sentence {
                font-size: 1.4em;
            }
            .translation {
                font-size: 1.1em;
            }
            .modal-content {
                width: 85%;
            }
            button {
                padding: 12px 24px;
                font-size: 1em;
            }
        }
    </style>
</head>
<body>

    <!-- ä¸»è¦å…§å®¹å€ -->
    <div class="container" id="main-container">
        <p class="location-tag" id="location-text"></p>
        <div class="speaker-line">
            <span class="speaker" id="speaker-text"></span>
            <p class="sentence" id="sentence-text"></p>
        </div>
        <p class="translation" id="translation-text"></p>
        <button id="play-btn">æœ—è®€è‹±æ–‡ â–¶</button>
        <button id="play-chinese-btn">æœ—è®€ä¸­æ–‡ ğŸ‡¹ğŸ‡¼</button>
    </div>

    <!-- å½ˆå‡ºè¦–çª— -->
    <div id="modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="modal-title">è½å®Œäº†ï¼</h2>
            <div id="modal-buttons">
                <button id="listen-again-btn">å†è½ä¸€æ¬¡ ğŸ”</button>
                <button id="record-btn">æ›æˆ‘å”¸ ğŸ™ï¸</button>
            </div>
            <div id="feedback" class="feedback-area hidden">
                <p id="sentence-to-read" style="font-size: 1.2em; font-weight: bold; color: #0056b3; margin-bottom: 15px;"></p>
                <p id="feedback-instruction">è«‹å°è‘—éº¥å…‹é¢¨å”¸å‡ºä¸Šé¢çš„å¥å­...</p>
                <p id="recognition-result"></p>
                <p id="score-result"></p>
                <button id="next-btn" class="hidden" style="margin-top: 15px;">ä¸‹ä¸€å¥ â†’</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. è³‡æ–™æº–å‚™ ---

        const dialogue = [
            { location: '(At school)', speaker: 'Jamie:', sentence: 'Good morning, Yuki.', translation: 'æ—©å®‰ï¼ŒYukiã€‚' },
            { location: '(At school)', speaker: 'Yuki:', sentence: 'Good morning, Jamie.', translation: 'æ—©å®‰ï¼ŒJamieã€‚' },
            { location: '(At school)', speaker: 'Jamie:', sentence: 'Look at that boy. Who is he?', translation: 'çœ‹çœ‹é‚£å€‹ç”·å­©ã€‚ä»–æ˜¯èª°ï¼Ÿ' },
            { location: '(At school)', speaker: 'Yuki:', sentence: 'Thatâ€™s Zac, our new classmate.', translation: 'é‚£æ˜¯Zacï¼Œæˆ‘å€‘çš„æ–°åŒå­¸ã€‚' },
            { location: '(At school)', speaker: 'Jamie:', sentence: 'And the girl?', translation: 'é‚£é‚£å€‹å¥³å­©å‘¢ï¼Ÿ' },
            { location: '(At school)', speaker: 'Yuki:', sentence: 'Thatâ€™s Zacâ€™s sister, Sophie. Sheâ€™s a student.', translation: 'é‚£æ˜¯Zacçš„å¦¹å¦¹ï¼ŒSophieã€‚å¥¹æ˜¯ä¸€ä½å­¸ç”Ÿã€‚' },
            { location: '(At school)', speaker: 'Jamie:', sentence: 'Sheâ€™s very tall.', translation: 'å¥¹éå¸¸é«˜ã€‚' },
            { location: '(At school)', speaker: 'Yuki:', sentence: 'Sheâ€™s smart, too.', translation: 'å¥¹ä¹Ÿå¾ˆè°æ˜ã€‚' },
            { location: '(In the classroom)', speaker: 'Zac:', sentence: 'Hi, Iâ€™m Zac Hugo. Nice to meet you.', translation: 'å—¨ï¼Œæˆ‘æ˜¯Zac Hugoã€‚å¾ˆé«˜èˆˆèªè­˜ä½ ã€‚' },
            { location: '(In the classroom)', speaker: 'Jamie:', sentence: 'Iâ€™m Jamie Parker. Nice to meet you, too.', translation: 'æˆ‘æ˜¯Jamie Parkerã€‚æˆ‘ä¹Ÿå¾ˆé«˜èˆˆèªè­˜ä½ ã€‚' },
            { location: '(In the classroom)', speaker: 'Zac:', sentence: 'Whoâ€™s this, Jamie? Is he your brother?', translation: 'é€™æ˜¯èª°ï¼ŒJamieï¼Ÿä»–æ˜¯ä½ çš„å…„å¼Ÿå—ï¼Ÿ' },
            { location: '(In the classroom)', speaker: 'Jamie:', sentence: 'No, he isnâ€™t. Heâ€™s my friend, Max. Max Banker.', translation: 'ä¸ï¼Œä»–ä¸æ˜¯ã€‚ä»–æ˜¯æˆ‘çš„æœ‹å‹ï¼ŒMaxã€‚Max Bankerã€‚' },
            { location: '(In the classroom)', speaker: 'Zac:', sentence: 'Is Max a student?', translation: 'Maxæ˜¯å­¸ç”Ÿå—ï¼Ÿ' },
            { location: '(In the classroom)', speaker: 'Jamie:', sentence: 'No, he isnâ€™t. Heâ€™s a teacher.', translation: 'ä¸ï¼Œä»–ä¸æ˜¯ã€‚ä»–æ˜¯ä¸€ä½è€å¸«ã€‚' },
            { location: '(In the classroom)', speaker: 'Zac:', sentence: 'Really? How old is he?', translation: 'çœŸçš„å—ï¼Ÿä»–å¹¾æ­²ï¼Ÿ' },
            { location: '(In the classroom)', speaker: 'Jamie:', sentence: 'Heâ€™s twenty-five years old.', translation: 'ä»–äºŒåäº”æ­²ã€‚' },
            { location: '(In the classroom)', speaker: 'Zac:', sentence: 'I see.', translation: 'æˆ‘æ˜ç™½äº†ã€‚' }
        ];

        // --- 2. ç²å–é é¢å…ƒç´  ---

        const locationText = document.getElementById('location-text');
        const speakerText = document.getElementById('speaker-text');
        const sentenceText = document.getElementById('sentence-text');
        const translationText = document.getElementById('translation-text');
        const playBtn = document.getElementById('play-btn');
        const playChineseBtn = document.getElementById('play-chinese-btn');
        const nextBtn = document.getElementById('next-btn');
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const modalButtons = document.getElementById('modal-buttons');
        const listenAgainBtn = document.getElementById('listen-again-btn');
        const recordBtn = document.getElementById('record-btn');
        const feedback = document.getElementById('feedback');
        const feedbackInstruction = document.getElementById('feedback-instruction');
        const recognitionResult = document.getElementById('recognition-result');
        const scoreResult = document.getElementById('score-result');
        const mainContainer = document.getElementById('main-container');
        const sentenceToRead = document.getElementById('sentence-to-read');

        // --- 3. ç‹€æ…‹ç®¡ç† ---

        let currentIndex = 0;
        let speechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        
        if (!speechRecognition) {
            alert("æŠ±æ­‰ï¼Œæ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜åŠŸèƒ½ã€‚æ¨è–¦ä½¿ç”¨ Chrome æˆ– Edgeã€‚");
            recordBtn.disabled = true;
        }

        // --- 4. æ ¸å¿ƒåŠŸèƒ½å‡½å¼ ---

        // é¡¯ç¤ºå¥å­
        function displaySentence() {
            const currentLine = dialogue[currentIndex];
            locationText.textContent = currentLine.location;
            speakerText.textContent = currentLine.speaker;
            sentenceText.textContent = currentLine.sentence;
            translationText.textContent = currentLine.translation;
        }

        // æœ—è®€è‹±æ–‡å¥å­ (TTS)
        function speakSentence() {
            const sentence = sentenceText.textContent;
            const utterance = new SpeechSynthesisUtterance(sentence);
            utterance.lang = 'en-US';
            utterance.rate = 0.5; // èªé€Ÿèª¿æ•´ç‚º 0.5 å€
            
            utterance.onstart = () => {
                playBtn.disabled = true;
                playBtn.textContent = 'æœ—è®€ä¸­...';
            };

            utterance.onend = () => {
                playBtn.disabled = false;
                playBtn.textContent = 'æœ—è®€è‹±æ–‡ â–¶';
                showModal();
            };

            speechSynthesis.speak(utterance);
        }
        
        // æœ—è®€ä¸­æ–‡å¥å­ (TTS)
        function speakChineseSentence() {
            const sentence = translationText.textContent;
            const utterance = new SpeechSynthesisUtterance(sentence);
            utterance.lang = 'zh-TW';
            utterance.rate = 1.0; 
            
            utterance.onstart = () => {
                playChineseBtn.disabled = true;
                playChineseBtn.textContent = 'æœ—è®€ä¸­...';
            };

            utterance.onend = () => {
                playChineseBtn.disabled = false;
                playChineseBtn.textContent = 'æœ—è®€ä¸­æ–‡ ğŸ‡¹ğŸ‡¼';
            };

            speechSynthesis.speak(utterance);
        }

        // é¡¯ç¤ºå½ˆå‡ºè¦–çª—
        function showModal() {
            modalTitle.textContent = 'è½å®Œäº†ï¼';
            modalButtons.classList.remove('hidden');
            feedback.classList.add('hidden');
            modal.classList.add('visible');
        }

        // éš±è—å½ˆå‡ºè¦–çª—
        function hideModal() {
            modal.classList.remove('visible');
        }

        // é–‹å§‹éŒ„éŸ³èˆ‡è¾¨è­˜
        function startRecording() {
            recognition = new speechRecognition();
            recognition.lang = 'en-US';
            recognition.interimResults = false;
            
            recognition.onstart = () => {
                recordBtn.classList.add('recording');
                recordBtn.textContent = 'æ­£åœ¨è†è½... ğŸ™ï¸';
                recordBtn.disabled = true;
                listenAgainBtn.disabled = true;
                feedbackInstruction.textContent = 'è«‹å°è‘—éº¥å…‹é¢¨å”¸å‡ºå¥å­...';
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                recognitionResult.textContent = 'æ‚¨å”¸çš„æ˜¯: ã€Œ' + transcript + 'ã€';
                calculateScore(transcript);
            };
            
            recognition.onerror = (event) => {
                 if(event.error == 'no-speech') {
                    feedbackInstruction.textContent = "è½ä¸åˆ°è²éŸ³ï¼Œè«‹å†è©¦ä¸€æ¬¡ã€‚";
                } else {
                    feedbackInstruction.textContent = 'ç™¼ç”ŸéŒ¯èª¤: ' + event.error;
                }
            };

            recognition.onend = () => {
                recordBtn.classList.remove('recording');
                recordBtn.textContent = 'æ›æˆ‘å”¸ ğŸ™ï¸';
                recordBtn.disabled = false;
                listenAgainBtn.disabled = false;
                nextBtn.classList.remove('hidden'); // é¡¯ç¤ºä¸‹ä¸€å¥æŒ‰éˆ•
            };
            
            sentenceToRead.textContent = sentenceText.textContent;
            modalButtons.classList.add('hidden');
            feedback.classList.remove('hidden');
            feedbackInstruction.textContent = 'è«‹é–‹å§‹èªªè©±...';
            recognitionResult.textContent = '';
            scoreResult.textContent = '';
            
            recognition.start();
        }

        // è¨ˆç®—åˆ†æ•¸ (ä¾å­—æ¯ç›¸ä¼¼åº¦)
        function calculateScore(transcript) {
            const original = sentenceText.textContent.toLowerCase().replace(/[^a-z0-9]/g, '');
            const spoken = transcript.toLowerCase().replace(/[^a-z0-9]/g, '');

            if (original.length === 0) {
                 scoreResult.textContent = `å¤ªæ£’äº†ï¼ (100åˆ†)`;
                 return;
            }

            const lcsLength = findLCSLength(original, spoken);
            const score = Math.round((lcsLength / original.length) * 100);
            
            let feedbackText = '';
            if (score >= 90) {
                feedbackText = `å¤ªæ£’äº†ï¼ (${score}åˆ†)`;
            } else if (score >= 70) {
                feedbackText = `ä¸éŒ¯å–”ï¼ (${score}åˆ†)`;
            } else if (score >= 50) {
                feedbackText = `é‚„æœ‰é€²æ­¥ç©ºé–“ï¼ (${score}åˆ†)`;
            } else {
                feedbackText = `å†è©¦ä¸€æ¬¡çœ‹çœ‹å§ï¼ (${score}åˆ†)`;
            }
            scoreResult.textContent = feedbackText;
        }

        // å°‹æ‰¾æœ€é•·å…¬å…±å­åºåˆ— (LCS) é•·åº¦
        function findLCSLength(s1, s2) {
            const m = s1.length;
            const n = s2.length;
            const dp = Array(m + 1).fill(0).map(() => Array(n + 1).fill(0));

            for (let i = 1; i <= m; i++) {
                for (let j = 1; j <= n; j++) {
                    if (s1[i - 1] === s2[j - 1]) {
                        dp[i][j] = dp[i - 1][j - 1] + 1;
                    } else {
                        dp[i][j] = Math.max(dp[i - 1][j], dp[i][j - 1]);
                    }
                }
            }
            return dp[m][n];
        }


        // --- 5. äº‹ä»¶ç›£è½ ---

        playBtn.addEventListener('click', speakSentence);
        playChineseBtn.addEventListener('click', speakChineseSentence);

        listenAgainBtn.addEventListener('click', () => {
            hideModal();
            setTimeout(speakSentence, 300);
        });

        recordBtn.addEventListener('click', startRecording);
        
        nextBtn.addEventListener('click', () => {
            hideModal();
            setTimeout(() => {
                currentIndex++;
                if (currentIndex < dialogue.length) {
                    displaySentence();
                } else {
                    locationText.textContent = 'Congratulations!';
                    speakerText.textContent = '';
                    sentenceText.textContent = 'æ‚¨å·²å®Œæˆæ‰€æœ‰å°è©±ï¼';
                    translationText.textContent = '';
                    mainContainer.classList.add('finished');
                    playBtn.classList.add('hidden');
                    playChineseBtn.classList.add('hidden');
                    nextBtn.classList.add('hidden');
                }
            }, 300);
        });

        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                hideModal();
            }
        });


        // --- 6. åˆå§‹è¨­å®š ---

        window.onload = () => {
            displaySentence();
            speechSynthesis.getVoices(); 
        };

    </script>
</body>
</html>


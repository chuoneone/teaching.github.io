<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æƒ…ç·’æ¢ç´¢è€…ï¼šæˆ‘çš„å¿ƒæƒ…å°ç™¾ç§‘ (å–®æ©Ÿå­˜æª”ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #fdfbf7; 
            color: #4b5563;
            overflow-x: hidden;
        }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #9ca3af; border-radius: 4px; }

        .chart-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
            height: 250px;
            max-height: 300px;
        }

        /* Learning Cards */
        .flip-card {
            background-color: transparent;
            perspective: 1000px;
            height: 240px;
        }
        .flip-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        .flip-card.flipped .flip-card-inner {
            transform: rotateY(180deg);
        }
        .flip-card-front, .flip-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            border-radius: 1.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1.25rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.03);
        }
        .flip-card-front { background-color: #ffffff; border: 2px solid #f3f4f6; }
        .flip-card-back {
            background-color: #ffffff;
            transform: rotateY(180deg);
            border: 3px solid #3b82f6;
        }

        /* Matching & Quiz */
        .match-item, .quiz-option { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .match-item.selected, .quiz-option.selected {
            border-color: #3b82f6;
            background-color: #eff6ff;
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.2);
        }
        .match-item.correct, .quiz-option.correct {
            border-color: #10b981;
            background-color: #ecfdf5;
            opacity: 0.8;
            pointer-events: none;
        }
        .quiz-option.wrong {
            border-color: #ef4444;
            background-color: #fef2f2;
        }

        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Status Pills */
        .status-pill {
            @apply px-2 py-0.5 rounded-full text-[10px] font-bold uppercase tracking-wider;
        }
    </style>
    <!-- Chosen Palette: Harmony Cream & Deep Sea Blue (Background: #fdfbf7, Primary: #3b82f6, Success: #10b981, Dashboard: #6366f1) -->
    <!-- Application Structure Plan: 
         1. Information Architecture: A centralized dashboard structure. 
         2. Persistence Layer: Use localStorage to save {practiceLevels: [], quizStats: {total, correct}, lastActive: date}.
         3. Navigation: Top bar with 4 distinct modes: 
            - ğŸ“– Learn (Initial content exploration)
            - ğŸ® Match (Connecting definitions/scenarios)
            - ğŸ“ Quiz (Multiple choice testing)
            - ğŸ“Š Stats (Data visualization of local storage)
         4. Interaction Flow: Student explores -> Practices -> Tests -> Reviews progress.
         Rationale: By providing a persistent "Score" and "Progress", students feel a sense of ownership over their local machine's data.
    -->
    <!-- Visualization & Content Choices:
         - Doughnut Chart: Overall completion of all 20 emotions.
         - Radar Chart: Mastery per Group (1-4) based on Quiz performance.
         - Logic: JS processes localStorage arrays into Chart.js datasets.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
</head>
<body class="min-h-screen flex flex-col">

    <!-- Header / Navigation -->
    <nav class="bg-white/90 backdrop-blur-md border-b border-gray-100 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-6 h-16 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <span class="text-3xl">ğŸ§©</span>
                <span class="font-black text-xl text-gray-800 tracking-tighter">å¿ƒæƒ…æ¢ç´¢è€… <span class="text-blue-500 font-medium text-sm ml-1">v2.0</span></span>
            </div>
            <div class="flex bg-gray-100 p-1.5 rounded-2xl overflow-x-auto">
                <button onclick="switchMode('learn')" id="nav-learn" class="px-4 py-2 rounded-xl text-sm font-bold transition-all bg-white shadow-sm text-blue-600">ğŸ“– èªè­˜</button>
                <button onclick="switchMode('practice')" id="nav-practice" class="px-4 py-2 rounded-xl text-sm font-bold transition-all text-gray-500">ğŸ® é…å°</button>
                <button onclick="switchMode('quiz')" id="nav-quiz" class="px-4 py-2 rounded-xl text-sm font-bold transition-all text-gray-500">ğŸ“ é¸æ“‡</button>
                <button onclick="switchMode('stats')" id="nav-stats" class="px-4 py-2 rounded-xl text-sm font-bold transition-all text-gray-500">ğŸ“Š æ•¸æ“š</button>
            </div>
        </div>
    </nav>

    <main class="flex-grow container mx-auto px-6 py-10 max-w-6xl">
        
        <!-- INTRO AREA (Dynamic Context) -->
        <div id="intro-area" class="text-center mb-10 fade-in">
            <h1 class="text-4xl font-black text-gray-900 mb-3" id="view-title">é–‹å§‹æ¢ç´¢å¿ƒæƒ…å§ï¼</h1>
            <p class="text-gray-500 text-lg max-w-2xl mx-auto leading-relaxed" id="view-desc">é€™è£¡è¨˜éŒ„äº†ä½ çš„å­¸ç¿’è¶³è·¡ï¼Œæ‰€æœ‰çš„ç­”æ¡ˆéƒ½æœƒä¿å­˜åœ¨é€™å°é›»è…¦è£¡å–”ã€‚</p>
        </div>

        <!-- VIEW: LEARNING MODE -->
        <div id="view-learn" class="space-y-10 fade-in">
            <div class="flex justify-center flex-wrap gap-3">
                <button onclick="filterLearnGroup('all')" class="l-filter-btn px-6 py-2.5 rounded-2xl bg-gray-800 text-white font-bold shadow-lg transition-transform active:scale-95">å…¨éƒ¨</button>
                <button onclick="filterLearnGroup(1)" class="l-filter-btn px-6 py-2.5 rounded-2xl bg-white text-gray-500 border-2 border-gray-100 font-bold hover:border-blue-200">ç¬¬ä¸€çµ„</button>
                <button onclick="filterLearnGroup(2)" class="l-filter-btn px-6 py-2.5 rounded-2xl bg-white text-gray-500 border-2 border-gray-100 font-bold hover:border-blue-200">ç¬¬äºŒçµ„</button>
                <button onclick="filterLearnGroup(3)" class="l-filter-btn px-6 py-2.5 rounded-2xl bg-white text-gray-500 border-2 border-gray-100 font-bold hover:border-blue-200">ç¬¬ä¸‰çµ„</button>
                <button onclick="filterLearnGroup(4)" class="l-filter-btn px-6 py-2.5 rounded-2xl bg-white text-gray-500 border-2 border-gray-100 font-bold hover:border-blue-200">ç¬¬å››çµ„</button>
            </div>

            <div id="cards-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                <!-- Cards Injected -->
            </div>
        </div>

        <!-- VIEW: PRACTICE MODE -->
        <div id="view-practice" class="hidden space-y-8 fade-in">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <!-- Sidebar: Level Selection & Progress -->
                <div class="lg:col-span-4 space-y-6">
                    <div class="bg-white rounded-[2rem] p-8 shadow-sm border border-gray-100 text-center">
                        <h3 class="text-xl font-bold text-gray-800 mb-6">é…å°æŒ‘æˆ°é€²åº¦</h3>
                        <div class="chart-container">
                            <canvas id="practiceProgressChart"></canvas>
                        </div>
                        <div class="mt-4 text-4xl font-black text-blue-600" id="practice-percent">0%</div>
                        <p class="text-gray-400 font-medium" id="practice-count">æœ¬é—œå®Œæˆï¼š0 / 5</p>
                    </div>

                    <div class="grid grid-cols-2 gap-3" id="level-buttons-container">
                        <!-- Buttons Injected -->
                    </div>
                </div>

                <!-- Game Board -->
                <div class="lg:col-span-8">
                    <div class="bg-white rounded-[3rem] p-8 shadow-2xl border-4 border-blue-50 relative min-h-[580px] overflow-hidden">
                        <div id="win-overlay" class="absolute inset-0 bg-white/95 z-20 hidden flex flex-col items-center justify-center p-10 text-center animate-fade-in">
                            <div class="text-8xl mb-6">ğŸ†</div>
                            <h2 class="text-4xl font-black text-gray-900 mb-2">é—–é—œå¤§æˆåŠŸï¼</h2>
                            <p class="text-xl text-gray-400 mb-8">ä½ å·²ç¶“å®Œå…¨æŒæ¡é€™ä¸€çµ„çš„å¿ƒæƒ…ä¾‹å­äº†ã€‚</p>
                            <button onclick="goToNextLevel()" class="px-12 py-4 bg-blue-600 text-white rounded-full text-xl font-bold shadow-xl hover:bg-blue-700 transition transform hover:scale-105">
                                é€²å…¥ä¸‹ä¸€é—œ âœ
                            </button>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8" id="game-elements">
                            <div class="space-y-4" id="game-emotions"></div>
                            <div class="space-y-4" id="game-scenarios"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW: QUIZ MODE -->
        <div id="view-quiz" class="hidden space-y-8 fade-in">
            <div class="max-w-3xl mx-auto">
                <div class="bg-white rounded-[3.5rem] p-12 shadow-2xl border-4 border-indigo-50 min-h-[550px] flex flex-col">
                    <div class="w-full bg-gray-100 h-4 rounded-full mb-10 overflow-hidden">
                        <div id="quiz-progress-bar" class="bg-indigo-500 h-full transition-all duration-500" style="width: 0%"></div>
                    </div>

                    <div id="quiz-question-container" class="text-center flex-grow flex flex-col justify-center">
                        <div class="inline-block px-5 py-2 bg-indigo-50 rounded-2xl mb-8">
                            <button onclick="speakCurrentQuestion()" class="text-3xl hover:scale-110 transition-transform flex items-center">
                                ğŸ”Š <span class="text-base font-bold text-indigo-600 ml-2 italic">è®€é¡Œç›®çµ¦æˆ‘è½</span>
                            </button>
                        </div>
                        <h2 id="quiz-question-text" class="text-3xl font-black text-gray-800 leading-snug mb-12">æº–å‚™å¥½é–‹å§‹æŒ‘æˆ°äº†å—ï¼Ÿ</h2>
                        
                        <div id="quiz-options-grid" class="grid grid-cols-1 sm:grid-cols-2 gap-5">
                            <!-- Options Injected -->
                        </div>
                    </div>

                    <div id="quiz-result-overlay" class="hidden flex-col items-center justify-center text-center py-10">
                        <div class="text-8xl mb-8">ğŸŒŸ</div>
                        <h2 class="text-4xl font-black text-gray-900 mb-2">æŒ‘æˆ°çµæŸï¼</h2>
                        <p id="quiz-score-text" class="text-2xl text-gray-500 mb-10">åšå¾—å¥½ï¼æˆç¸¾å·²å„²å­˜åœ¨å„€è¡¨æ¿ä¸­ã€‚</p>
                        <button onclick="startQuiz()" class="px-12 py-4 bg-indigo-600 text-white rounded-full text-xl font-bold shadow-lg hover:bg-indigo-700 transition transform hover:scale-105">
                            å†æŒ‘æˆ°ä¸€å› ğŸ”„
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW: STATS MODE -->
        <div id="view-stats" class="hidden space-y-10 fade-in">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Summary Stats -->
                <div class="bg-blue-600 rounded-[2.5rem] p-8 text-white shadow-xl">
                    <h4 class="text-blue-100 font-bold mb-2 uppercase text-xs tracking-widest">ç¸½å­¸ç¿’å¤©æ•¸</h4>
                    <div class="text-5xl font-black" id="stat-days">1</div>
                    <p class="mt-4 text-blue-200 text-sm">æŒä¹‹ä»¥æ†å°±æ˜¯æˆåŠŸï¼</p>
                </div>
                <div class="bg-emerald-500 rounded-[2.5rem] p-8 text-white shadow-xl">
                    <h4 class="text-emerald-100 font-bold mb-2 uppercase text-xs tracking-widest">ç´¯ç©æ­£ç¢ºé¡Œæ•¸</h4>
                    <div class="text-5xl font-black" id="stat-correct">0</div>
                    <p class="mt-4 text-emerald-100 text-sm">ä½ å°æƒ…ç·’è¶Šä¾†è¶Šäº†è§£äº†ã€‚</p>
                </div>
                <div class="bg-amber-500 rounded-[2.5rem] p-8 text-white shadow-xl">
                    <h4 class="text-amber-100 font-bold mb-2 uppercase text-xs tracking-widest">ç›®å‰ç­”é¡Œç‡</h4>
                    <div class="text-5xl font-black" id="stat-rate">0%</div>
                    <p class="mt-4 text-amber-100 text-sm">æ ¹æ“šæœ€è¿‘ 5 æ¬¡æ¸¬é©—è¨ˆç®—ã€‚</p>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white rounded-[3rem] p-10 shadow-sm border border-gray-100">
                    <h3 class="text-2xl font-black text-gray-800 mb-8">å¿ƒæƒ…é…å°å®Œæˆåº¦</h3>
                    <div class="chart-container" style="height: 350px;">
                        <canvas id="groupMasteryChart"></canvas>
                    </div>
                </div>
                <div class="bg-white rounded-[3rem] p-10 shadow-sm border border-gray-100">
                    <h3 class="text-2xl font-black text-gray-800 mb-8">æœ€è¿‘ç·´ç¿’è¡¨ç¾</h3>
                    <div class="chart-container" style="height: 350px;">
                        <canvas id="quizHistoryChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="text-center pb-10">
                <button onclick="clearAllData()" class="text-gray-400 hover:text-red-500 text-sm font-medium underline underline-offset-4 decoration-dashed">
                    é‡è¨­æ‰€æœ‰æœ¬æ©Ÿæ•¸æ“š (æ…ç”¨)
                </button>
            </div>
        </div>

    </main>

    <script>
        // --- EMOTION DATA ---
        const emotions = [
            { id: 1, g: 1, name: "ç„¦æ…®", icon: "ğŸ˜°", desc: "æ“”å¿ƒå£äº‹ç™¼ç”Ÿ", ex: "ä¾‹å¦‚æ˜å¤©è¦ä¸Šå°èªªè©±ã€‚", matchId: 'C' },
            { id: 2, g: 1, name: "å®³æ€•", icon: "ğŸ˜±", desc: "çœ‹åˆ°ææ€–çš„äº‹æƒ³èº²èµ·ä¾†", ex: "ä¾‹å¦‚çœ‹åˆ°å¾ˆå¤§è²å å«çš„ç‹—ã€‚", matchId: 'B' },
            { id: 3, g: 1, name: "ç”Ÿæ°£", icon: "ğŸ˜ ", desc: "è¦ºå¾—å¾ˆä¸å…¬å¹³", ex: "ä¾‹å¦‚è¢«æ’åˆ°æ²’é“æ­‰ã€‚", matchId: 'A' },
            { id: 4, g: 1, name: "å§”å±ˆ", icon: "ğŸ¥º", desc: "è¢«èª¤æœƒå¿ƒè£¡é…¸é…¸çš„", ex: "ä¾‹å¦‚æ²’èªªè¬Šå»è¢«ç½µã€‚", matchId: 'E' },
            { id: 5, g: 1, name: "æŒ«æŠ˜", icon: "ğŸ˜", desc: "åŠªåŠ›äº†å»å¤±æ•—", ex: "ä¾‹å¦‚å¿«å®Œæˆçš„æ‹¼åœ–è¢«å¼„å€’ã€‚", matchId: 'D' },
            { id: 6, g: 2, name: "å«‰å¦’", icon: "ğŸ˜’", desc: "çœ‹åˆ°åˆ¥äººæœ‰æˆ‘æƒ³è¦çš„", ex: "ä¾‹å¦‚åŒå­¸è²·äº†æˆ‘ä¹Ÿæƒ³è¦çš„éŠæˆ²æ©Ÿã€‚", matchId: 'F' },
            { id: 7, g: 2, name: "ææ…Œ", icon: "ğŸ˜µ", desc: "ä¸èƒ½å‘¼å¸", ex: "ä¾‹å¦‚åœ¨å•†å ´èµ°æ•£äº†ã€‚", matchId: 'I' },
            { id: 8, g: 2, name: "æ†¤æ€’", icon: "ğŸ˜¡", desc: "å¿ƒè£¡åƒç«åœ¨ç‡’", ex: "ä¾‹å¦‚æœ€æ„›çš„ç©å…·è¢«æ•…æ„è¸©å£ã€‚", matchId: 'J' },
            { id: 9, g: 2, name: "ç¾æ„§", icon: "ğŸ˜³", desc: "è¦ºå¾—ä¸Ÿè‡‰", ex: "ä¾‹å¦‚åœ¨å…¨ç­é¢å‰è·Œå€’äº†ã€‚", matchId: 'H' },
            { id: 10, g: 2, name: "ä¸å®‰", icon: "ğŸ˜Ÿ", desc: "æ²’å®‰å…¨æ„Ÿ", ex: "ä¾‹å¦‚åª½åª½ä»Šå¤©æ²’æº–æ™‚ä¾†æ¥æˆ‘ã€‚", matchId: 'G' },
            { id: 11, g: 3, name: "ç…©èº", icon: "ğŸ˜¤", desc: "è¦ºå¾—å¥½ç…©", ex: "ä¾‹å¦‚æ—é‚Šä¸€ç›´æœ‰æŒ‰åŸå­ç­†çš„è²éŸ³ã€‚", matchId: 'L' },
            { id: 12, g: 3, name: "å´©æ½°", icon: "ğŸ¤¯", desc: "å¤§è…¦ç•¶æ©Ÿ", ex: "ä¾‹å¦‚å»£æ’­è²è·Ÿèªªè©±è²å¤ªå¤§ã€‚", matchId: 'K' },
            { id: 13, g: 3, name: "å›°æƒ‘", icon: "ğŸ˜µâ€ğŸ’«", desc: "è½ä¸æ‡‚", ex: "ä¾‹å¦‚è€å¸«è¬›äº†æˆ‘ä¸æ‡‚çš„æŒ‡ä»¤ã€‚", matchId: 'N' },
            { id: 14, g: 3, name: "çµ•æœ›", icon: "ğŸŒ«ï¸", desc: "åŠªåŠ›ä¹Ÿæ²’ç”¨", ex: "ä¾‹å¦‚è€ƒå·ç™¼ä¸‹ä¾†ç™¼ç¾å…¨éƒ½ä¸æœƒã€‚", matchId: 'M' },
            { id: 15, g: 3, name: "è‡ªè²¬", icon: "ğŸ˜”", desc: "å°è‡ªå·±ç”Ÿæ°£", ex: "ä¾‹å¦‚å¿˜è¨˜å¸¶ç­”æ‡‰è¦å¸¶çš„æ±è¥¿ã€‚", matchId: 'O' },
            { id: 16, g: 4, name: "ç„¡åŠ›", icon: "ğŸ« ", desc: "ä¸æƒ³å‹•", ex: "ä¾‹å¦‚æ˜¨æ™šæ²’ç¡å¥½ï¼Œå…¨èº«æ²’åŠ›æ°£ã€‚", matchId: 'Q' },
            { id: 17, g: 4, name: "æŠ—æ‹’", icon: "ğŸ™…", desc: "ä¸æƒ³æ”¹è®Š", ex: "ä¾‹å¦‚ç•«ç•«åˆ°ä¸€åŠè¢«å«å»æ”¶èµ·ä¾†ã€‚", matchId: 'P' },
            { id: 18, g: 4, name: "å­¤å–®", icon: "ğŸ‚", desc: "åªæœ‰æˆ‘ä¸€å€‹äºº", ex: "ä¾‹å¦‚å¤§å®¶éƒ½åœ¨ç©ï¼Œåªæœ‰æˆ‘ååœ¨ä½ç½®ã€‚", matchId: 'S' },
            { id: 19, g: 4, name: "èˆˆå¥®", icon: "ğŸ¤©", desc: "åœä¸ä¸‹ä¾†", ex: "ä¾‹å¦‚æ˜å¤©è¦æ ¡å¤–æ•™å­¸ï¼Œç¡ä¸è‘—ã€‚", matchId: 'T' },
            { id: 20, g: 4, name: "å¹³éœ", icon: "ğŸ˜Œ", desc: "è¦ºå¾—æ”¾é¬†", ex: "ä¾‹å¦‚è½è‘—å–œæ­¡çš„éŸ³æ¨‚ï¼Œååœ¨è§’è½ã€‚", matchId: 'R' }
        ];

        // --- STORAGE MANAGER ---
        const StorageKey = "emotion_app_v2_data";
        let localData = {
            levelsCompleted: [], // List of matched IDs
            quizHistory: [], // {date, score, total}
            daysVisited: [new Date().toDateString()],
            groupMastery: { 1: 0, 2: 0, 3: 0, 4: 0 }
        };

        function loadFromLocal() {
            const saved = localStorage.getItem(StorageKey);
            if (saved) {
                const parsed = JSON.parse(saved);
                localData = { ...localData, ...parsed };
                // Update days visited
                const today = new Date().toDateString();
                if (!localData.daysVisited.includes(today)) {
                    localData.daysVisited.push(today);
                }
            }
        }

        function saveToLocal() {
            localStorage.setItem(StorageKey, JSON.stringify(localData));
        }

        function clearAllData() {
            if (confirm("é€™æœƒåˆªé™¤æ‰€æœ‰å­¸ç¿’ç´€éŒ„ï¼Œç¢ºå®šå—ï¼Ÿ")) {
                localStorage.removeItem(StorageKey);
                location.reload();
            }
        }

        // --- STATE ---
        let state = {
            mode: 'learn',
            learnFilter: 'all',
            lv: 1,
            selE: null,
            selS: null,
            doneInCurrentSession: [],
            charts: { progress: null, mastery: null, history: null },
            quiz: { questions: [], idx: 0, score: 0, locked: false }
        };

        // --- TTS ---
        function speak(txt) {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(txt);
            u.lang = 'zh-TW'; u.rate = 0.9;
            window.speechSynthesis.speak(u);
        }

        // --- CORE UI ---
        function init() {
            loadFromLocal();
            renderCards();
            renderLevelButtons();
            initCharts();
            switchMode('learn');
        }

        function switchMode(m) {
            state.mode = m;
            const navs = ['learn', 'practice', 'quiz', 'stats'];
            navs.forEach(k => {
                const btn = document.getElementById(`nav-${k}`);
                const view = document.getElementById(`view-${k}`);
                if (k === m) {
                    btn.className = "px-4 py-2 rounded-xl text-sm font-bold transition-all bg-white shadow-sm text-blue-600";
                    view.classList.remove('hidden');
                } else {
                    btn.className = "px-4 py-2 rounded-xl text-sm font-bold transition-all text-gray-500 hover:text-gray-700";
                    view.classList.add('hidden');
                }
            });

            // Title Updates
            const titles = { learn: "é–‹å§‹æ¢ç´¢å¿ƒæƒ…å§ï¼", practice: "å¿ƒæƒ…é…å°å¤§æŒ‘æˆ°", quiz: "å¿ƒæƒ…æƒ…å¢ƒé¸æ“‡é¡Œ", stats: "æˆ‘çš„å­¸ç¿’å„€è¡¨æ¿" };
            const descs = { 
                learn: "æ‰€æœ‰çš„æ„Ÿè¦ºéƒ½æœ‰å€‹åå­—ï¼Œé»æ“Šå¡ç‰‡è½è½çœ‹å§ï¼", 
                practice: "æ ¹æ“šäº‹ä»¶æ‰¾å‡ºå°æ‡‰çš„å¿ƒæƒ…ï¼Œç­”æ¡ˆæœƒè‡ªå‹•å„²å­˜å–”ã€‚", 
                quiz: "æ¸¬è©¦çœ‹çœ‹ä½ å°å¿ƒæƒ…çš„äº†è§£ç¨‹åº¦ï¼Œæˆç¸¾æœƒåˆ—å…¥çµ±è¨ˆã€‚", 
                stats: "é€™è£¡æ˜¯ä½ çš„æœ¬æ©Ÿå­¸ç¿’æ•¸æ“šï¼Œåªæœ‰åœ¨é€™å°é›»è…¦æ‰çœ‹å¾—åˆ°ã€‚" 
            };
            document.getElementById('view-title').innerText = titles[m];
            document.getElementById('view-desc').innerText = descs[m];

            if (m === 'practice') loadPracticeLevel(state.lv);
            if (m === 'quiz') startQuiz();
            if (m === 'stats') refreshStats();
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // --- LEARN ---
        function filterLearnGroup(g) {
            state.learnFilter = g;
            document.querySelectorAll('.l-filter-btn').forEach((btn, idx) => {
                const target = g === 'all' ? 0 : g;
                btn.className = idx == target ? "l-filter-btn px-6 py-2.5 rounded-2xl bg-gray-800 text-white font-bold shadow-lg" : "l-filter-btn px-6 py-2.5 rounded-2xl bg-white text-gray-500 border-2 border-gray-100 font-bold hover:border-blue-200";
            });
            renderCards();
        }

        function renderCards() {
            const container = document.getElementById('cards-grid');
            container.innerHTML = '';
            const data = state.learnFilter === 'all' ? emotions : emotions.filter(e => e.g == state.learnFilter);
            data.forEach(e => {
                const isFinished = localData.levelsCompleted.includes(e.id);
                const div = document.createElement('div');
                div.className = "flip-card cursor-pointer group";
                div.onclick = () => {
                    const inner = div.querySelector('.flip-card-inner');
                    const isFlipped = div.classList.toggle('flipped');
                    speak(isFlipped ? `${e.name}ã€‚${e.desc}ã€‚${e.ex}` : e.name);
                };
                div.innerHTML = `
                    <div class="flip-card-inner">
                        <div class="flip-card-front">
                            ${isFinished ? '<span class="absolute top-4 right-4 text-emerald-500 text-xs font-black">å·²æŒæ¡ âœ“</span>' : ''}
                            <span class="text-6xl mb-4 transform group-hover:scale-110 transition-transform">${e.icon}</span>
                            <h3 class="text-2xl font-black text-gray-800">${e.name}</h3>
                            <div class="mt-4 text-blue-400 text-sm font-bold opacity-60">ğŸ”Š é»æ“Šçœ‹æ„æ€</div>
                        </div>
                        <div class="flip-card-back">
                            <h3 class="text-xl font-bold text-blue-600 mb-2">${e.name}</h3>
                            <p class="text-gray-600 font-bold leading-tight">${e.desc}</p>
                            <p class="text-xs text-gray-400 mt-4 italic bg-gray-50 p-2 rounded-xl">"${e.ex}"</p>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // --- PRACTICE ---
        function renderLevelButtons() {
            const container = document.getElementById('level-buttons-container');
            container.innerHTML = '';
            [1, 2, 3, 4].forEach(lv => {
                const btn = document.createElement('button');
                btn.id = `lv-btn-${lv}`;
                btn.className = "lv-btn p-4 rounded-2xl border-2 font-black text-lg transition-all";
                btn.onclick = () => loadPracticeLevel(lv);
                btn.innerText = `ç¬¬ ${lv} é—œ`;
                container.appendChild(btn);
            });
        }

        function loadPracticeLevel(lv) {
            state.lv = lv;
            state.selE = null; state.selS = null;
            state.doneInCurrentSession = [];

            // Update UI Sidebar
            document.querySelectorAll('.lv-btn').forEach((btn, i) => {
                if ((i+1) == lv) {
                    btn.className = "lv-btn p-4 rounded-2xl border-2 border-blue-600 bg-blue-50 text-blue-700 font-black text-lg";
                } else {
                    btn.className = "lv-btn p-4 rounded-2xl border-2 border-gray-100 bg-white text-gray-400 font-black text-lg hover:border-blue-100";
                }
            });

            document.getElementById('win-overlay').classList.add('hidden');
            renderGameBoard();
            updatePracticeProgress();
        }

        function renderGameBoard() {
            const data = emotions.filter(e => e.g == state.lv);
            const emoCol = document.getElementById('game-emotions'), scenCol = document.getElementById('game-scenarios');
            emoCol.innerHTML = ''; scenCol.innerHTML = '';

            data.forEach(e => {
                const isSaved = localData.levelsCompleted.includes(e.id);
                const btn = document.createElement('button');
                btn.className = `match-item w-full flex items-center p-5 border-2 rounded-2xl shadow-sm text-left ${isSaved ? 'correct' : 'bg-white border-gray-100 hover:border-blue-200'}`;
                btn.id = `emo-${e.id}`;
                btn.onclick = () => { if(isSaved)return; state.selE = e.id; highlightMatch(); checkMatch(); };
                btn.innerHTML = `
                    <span class="text-3xl mr-4">${e.icon}</span>
                    <div class="flex flex-col">
                        <span class="text-xl font-black text-gray-700">${e.name}</span>
                        ${isSaved ? '<span class="text-[10px] text-emerald-500 font-bold">å·²åœ¨ç´€éŒ„ä¸­</span>' : ''}
                    </div>
                    <span onclick="event.stopPropagation();speak('${e.name}')" class="ml-auto text-xl opacity-30 hover:opacity-100">ğŸ”Š</span>
                `;
                emoCol.appendChild(btn);
            });

            const scens = [...data].sort(()=>Math.random()-0.5);
            scens.forEach(e => {
                const isSaved = localData.levelsCompleted.includes(e.id);
                const btn = document.createElement('button');
                btn.className = `match-item w-full flex items-center p-5 border-2 rounded-2xl shadow-sm text-left ${isSaved ? 'correct' : 'bg-white border-gray-100 hover:border-blue-200'}`;
                btn.id = `scen-${e.matchId}`;
                btn.onclick = () => { if(isSaved)return; state.selS = e.matchId; highlightMatch(); checkMatch(); };
                btn.innerHTML = `
                    <span onclick="event.stopPropagation();speak('${e.ex}')" class="mr-4 text-xl opacity-20 hover:opacity-100">ğŸ”Š</span>
                    <span class="text-gray-500 font-bold leading-snug text-sm">${e.ex}</span>
                `;
                scenCol.appendChild(btn);
            });
        }

        function highlightMatch() {
            document.querySelectorAll('.match-item').forEach(el => {
                if(!el.classList.contains('correct')) el.classList.remove('selected');
            });
            if(state.selE) document.getElementById(`emo-${state.selE}`).classList.add('selected');
            if(state.selS) document.getElementById(`scen-${state.selS}`).classList.add('selected');
        }

        function checkMatch() {
            if(!state.selE || !state.selS) return;
            const target = emotions.find(e => e.id == state.selE);
            if(target.matchId == state.selS) {
                // Correct
                if(!localData.levelsCompleted.includes(state.selE)) {
                    localData.levelsCompleted.push(state.selE);
                    saveToLocal();
                }
                document.getElementById(`emo-${state.selE}`).classList.add('correct');
                document.getElementById(`scen-${state.selS}`).classList.add('correct');
                speak("ç­”å°äº†ï¼ç´€éŒ„å·²å„²å­˜ã€‚");
                state.selE = null; state.selS = null;
                updatePracticeProgress();
                
                // Check level win
                const lvEmotions = emotions.filter(e => e.g == state.lv).map(e => e.id);
                const isLvDone = lvEmotions.every(id => localData.levelsCompleted.includes(id));
                if(isLvDone) {
                    setTimeout(()=> {
                        document.getElementById('win-overlay').classList.remove('hidden');
                        speak("é€™ä¸€é—œæ‰€æœ‰çš„ç´€éŒ„éƒ½å®Œæˆäº†ï¼Œå¤ªæ£’äº†ï¼");
                    }, 600);
                }
            } else {
                setTimeout(()=>{
                    state.selE = null; state.selS = null; highlightMatch();
                    speak("å†æƒ³ä¸€æƒ³å–”");
                }, 500);
            }
        }

        function goToNextLevel() {
            if(state.lv < 4) loadPracticeLevel(state.lv + 1);
            else switchMode('stats');
        }

        function updatePracticeProgress() {
            const lvEmotions = emotions.filter(e => e.g == state.lv).map(e => e.id);
            const count = lvEmotions.filter(id => localData.levelsCompleted.includes(id)).length;
            
            state.charts.progress.data.datasets[0].data = [count, 5 - count];
            state.charts.progress.update();
            
            document.getElementById('practice-percent').innerText = `${Math.round(count/5*100)}%`;
            document.getElementById('practice-count').innerText = `æœ¬é—œå®Œæˆï¼š${count} / 5`;
        }

        // --- QUIZ ---
        function startQuiz() {
            state.quiz.questions = [...emotions].sort(() => Math.random() - 0.5).slice(0, 5);
            state.quiz.idx = 0;
            state.quiz.score = 0;
            state.quiz.locked = false;

            document.getElementById('quiz-question-container').classList.remove('hidden');
            document.getElementById('quiz-result-overlay').classList.add('hidden');
            renderQuizQuestion();
        }

        function renderQuizQuestion() {
            const q = state.quiz.questions[state.quiz.idx];
            document.getElementById('quiz-progress-bar').style.width = `${(state.quiz.idx / 5) * 100}%`;
            document.getElementById('quiz-question-text').innerText = q.ex.replace("ä¾‹å¦‚", "æƒ…æ³ï¼š");
            
            const grid = document.getElementById('quiz-options-grid');
            grid.innerHTML = '';
            state.quiz.locked = false;

            let opts = [q, ...emotions.filter(e => e.id !== q.id).sort(()=>Math.random()-0.5).slice(0, 3)].sort(()=>Math.random()-0.5);
            opts.forEach(o => {
                const btn = document.createElement('button');
                btn.className = "quiz-option flex items-center p-5 bg-white border-2 border-gray-100 rounded-[2rem] shadow-sm hover:border-blue-200";
                btn.onclick = () => handleQuizSelection(o.id, btn);
                btn.innerHTML = `<span class="text-3xl mr-4">${o.icon}</span><span class="text-xl font-bold text-gray-700">${o.name}</span><span onclick="event.stopPropagation();speak('${o.name}')" class="ml-auto text-xl opacity-20">ğŸ”Š</span>`;
                grid.appendChild(btn);
            });
            speakCurrentQuestion();
        }

        function speakCurrentQuestion() {
            speak(state.quiz.questions[state.quiz.idx].ex.replace("ä¾‹å¦‚", "è«‹å•é€™æ¨£çš„æƒ…æ³æ˜¯ä»€éº¼å¿ƒæƒ…ï¼Ÿ"));
        }

        function handleQuizSelection(id, el) {
            if(state.quiz.locked) return;
            state.quiz.locked = true;
            const correct = state.quiz.questions[state.quiz.idx].id === id;
            if(correct) {
                state.quiz.score++;
                el.classList.add('correct');
                speak("ç­”å°äº†ï¼Œè§€å¯ŸåŠ›å¾ˆå¥½ï¼");
            } else {
                el.classList.add('wrong');
                speak(`é€™é¡Œä¸å°å–”ï¼Œæ‡‰è©²æ˜¯ ${state.quiz.questions[state.quiz.idx].name}ã€‚`);
            }

            setTimeout(() => {
                state.quiz.idx++;
                if(state.quiz.idx < 5) renderQuizQuestion();
                else finalizeQuiz();
            }, 1800);
        }

        function finalizeQuiz() {
            // Save to Local
            localData.quizHistory.push({ date: new Date().toLocaleTimeString(), score: state.quiz.score, total: 5 });
            if(localData.quizHistory.length > 10) localData.quizHistory.shift();
            saveToLocal();

            document.getElementById('quiz-progress-bar').style.width = "100%";
            document.getElementById('quiz-question-container').classList.add('hidden');
            document.getElementById('quiz-result-overlay').classList.remove('hidden');
            document.getElementById('quiz-score-text').innerText = `ç­”å°äº† ${state.quiz.score} é¡Œã€‚æ•¸æ“šå·²å„²å­˜ï¼`;
            speak(`æŒ‘æˆ°çµæŸï¼Œä½ ä¸€å…±ç­”å°äº† ${state.quiz.score} é¡Œã€‚`);
        }

        // --- STATS ---
        function refreshStats() {
            document.getElementById('stat-days').innerText = localData.daysVisited.length;
            const totalCorrect = localData.quizHistory.reduce((a, b) => a + b.score, 0);
            document.getElementById('stat-correct').innerText = totalCorrect;
            
            const recent = localData.quizHistory.slice(-5);
            const rate = recent.length ? Math.round((recent.reduce((a,b)=>a+b.score, 0) / (recent.length * 5)) * 100) : 0;
            document.getElementById('stat-rate').innerText = `${rate}%`;

            // Update Mastery Chart
            const masteries = [1, 2, 3, 4].map(g => {
                const ids = emotions.filter(e => e.g == g).map(e => e.id);
                return (ids.filter(id => localData.levelsCompleted.includes(id)).length / 5) * 100;
            });
            state.charts.mastery.data.datasets[0].data = masteries;
            state.charts.mastery.update();

            // Update History Chart
            state.charts.history.data.labels = localData.quizHistory.map(h => h.date);
            state.charts.history.data.datasets[0].data = localData.quizHistory.map(h => h.score);
            state.charts.history.update();
        }

        // --- CHARTS INIT ---
        function initCharts() {
            // Practice Ring
            const pCtx = document.getElementById('practiceProgressChart').getContext('2d');
            state.charts.progress = new Chart(pCtx, {
                type: 'doughnut',
                data: { datasets: [{ data: [0, 5], backgroundColor: ['#3b82f6', '#f3f4f6'], borderWidth: 0, cutout: '85%' }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { tooltip: { enabled: false } } }
            });

            // Mastery Bar
            const mCtx = document.getElementById('groupMasteryChart').getContext('2d');
            state.charts.mastery = new Chart(mCtx, {
                type: 'bar',
                data: {
                    labels: ['ç¬¬ä¸€çµ„', 'ç¬¬äºŒçµ„', 'ç¬¬ä¸‰çµ„', 'ç¬¬å››çµ„'],
                    datasets: [{ label: 'å®Œæˆåº¦ %', data: [0, 0, 0, 0], backgroundColor: '#6366f1', borderRadius: 15 }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, max: 100 } },
                    plugins: { legend: { display: false } }
                }
            });

            // History Line
            const hCtx = document.getElementById('quizHistoryChart').getContext('2d');
            state.charts.history = new Chart(hCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{ label: 'æ­£ç¢ºé¡Œæ•¸', data: [], borderColor: '#10b981', backgroundColor: '#ecfdf5', fill: true, tension: 0.4 }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { y: { min: 0, max: 5, ticks: { stepSize: 1 } } },
                    plugins: { legend: { display: false } }
                }
            });
        }

        window.onload = init;
    </script>
</body>
</html>
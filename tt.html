<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>學生情緒紀錄系統</title>
    <link rel="icon" href="images/dog.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Noto Sans TC', 'Microsoft JhengHei', 'PingFang TC', sans-serif;
            background: linear-gradient(135deg, #f9f3e5 0%, #fff9e6 100%);
            min-height: 100vh;
            color: #5c4f3c;
            font-size: 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem;
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
            border: 1px solid #f0e6d2;
        }
        select, button, textarea {
            transition: all 0.3s ease;
        }
        select:hover, button:hover, textarea:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        .emotion-btn {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        .emotion-btn .emoji { font-size: 1.8rem; margin-bottom: 0.25rem; }
        .emotion-btn .text { font-size: 1rem; font-weight: 500; }
        .emotion-btn:hover { transform: scale(1.1); }
        .emotion-btn.selected {
            transform: scale(1.1);
            box-shadow: 0 0 0 3px #e6c87a;
            border-color: #e6c87a;
        }
        .hidden { display: none; }
        .toast {
            position: fixed; bottom: 20px; left: 50%;
            transform: translateX(-50%);
            background-color: #e6c87a; color: #5c4f3c;
            padding: 12px 24px; border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 1000; opacity: 0; transition: opacity 0.3s ease;
        }
        .toast.show { opacity: 1; }
        .btn-primary { background-color: #e6c87a; border-color: #d4b66a; color: #5c4f3c; }
        .btn-primary:hover { background-color: #d4b66a; }
        .btn-secondary { background-color: #f0e6d2; border-color: #e6d9bc; color: #5c4f3c; }
        .btn-secondary:hover { background-color: #e6d9bc; }
        .btn-disabled {
            background-color: #e5e7eb; border-color: #d1d5db; color: #9ca3af;
            cursor: not-allowed; transform: none; box-shadow: none;
        }
        .success-message {
            background-color: #dcfce7; border: 1px solid #86efac; color: #166534;
            padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;
            text-align: center; font-weight: 500;
        }

        /* 四象限佈局的 CSS */
        .quadrant-layout-wrapper { display: flex; flex-direction: column; align-items: center; margin-top: 1rem; }
        .center-content { display: flex; align-items: stretch; gap: 0.5rem; }
        .axis-label {
            display: flex; align-items: center; justify-content: center; color: #854d0e;
            font-weight: 500; writing-mode: vertical-rl; padding: 0 0.25rem;
        }
        .y-axis-top { writing-mode: horizontal-tb; transform: none; margin-bottom: 0.5rem; }
        .y-axis-bottom { writing-mode: horizontal-tb; transform: none; margin-top: 0.5rem; }
        #emotion-quadrant-container {
            display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: auto auto;
            gap: 10px; width: 900px; border: 2px solid #f0e6d2; padding: 10px; border-radius: 1rem;
        }
        .quadrant {
            padding: 1rem; border-radius: 0.75rem; min-height: 220px; /* 增加最小高度以容納按鈕 */
            display: flex;
            flex-direction: column; /* 改為垂直排列 */
            justify-content: center;
            align-items: center;
            gap: 0; /* 移除 gap，由按鈕 margin 控制間距 */
            transition: all 0.3s ease;
        }
        .button-row {
            display: flex;
            justify-content: center;
        }
        .quadrant:hover { transform: scale(1.02); box-shadow: 0 8px 16px rgba(0,0,0,0.05); }
        .q1 { background-color: #fef3c7; grid-area: 1 / 2 / 2 / 3; } /* 右上 */
        .q2 { background-color: #fee2e2; grid-area: 1 / 1 / 2 / 2; } /* 左上 */
        .q3 { background-color: #e5e7eb; grid-area: 2 / 1 / 3 / 2; } /* 左下 */
        .q4 { background-color: #dcfce7; grid-area: 2 / 2 / 3 / 3; } /* 右下 */

        /* 情緒說明 Modal 的 CSS */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex; justify-content: center; align-items: center;
            z-index: 2000; opacity: 0; transition: opacity 0.3s ease;
        }
        .modal-content {
            background-color: #fff; color: #5c4f3c; padding: 2rem;
            border-radius: 1rem; width: 90%; max-width: 500px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            position: relative; transform: scale(0.95); transition: transform 0.3s ease;
        }
        .modal-overlay.show { opacity: 1; }
        .modal-overlay.show .modal-content { transform: scale(1); }
        .modal-close-btn {
            position: absolute; top: 1rem; right: 1rem;
            font-size: 1.5rem; line-height: 1; color: #9ca3af;
            background: none; border: none; cursor: pointer;
        }
        .modal-title { font-size: 1.75rem; font-weight: bold; color: #854d0e; margin-bottom: 1rem; }
        .modal-section-title { font-weight: 600; margin-bottom: 0.5rem; border-left: 4px solid #e6c87a; padding-left: 0.5rem; }
        .modal-text { line-height: 1.75; }

        /* 語音功能按鈕樣式 */
        .speech-btn {
            background: none; border: none; cursor: pointer;
            color: #a16207; transition: color 0.2s ease;
            padding: 0.5rem;
        }
        .speech-btn:hover { color: #e6c87a; }
        .speech-btn svg { width: 24px; height: 24px; }

        #mic-btn {
            position: absolute; bottom: 8px; right: 8px;
            background-color: #f0e6d2; border-radius: 50%; padding: 8px;
        }
        #mic-btn.is-recording {
             background-color: #ef4444; color: white;
        }
        #mic-status { color: #854d0e; }


        @media (max-width: 700px) {
            #emotion-quadrant-container { width: 100%; grid-template-columns: 1fr; grid-template-rows: auto; }
            .q1 { grid-area: auto; }
            .q2 { grid-area: auto; }
            .q3 { grid-area: auto; }
            .q4 { grid-area: auto; }
            .center-content { flex-direction: column; }
            .axis-label { writing-mode: horizontal-tb; transform: none; padding: 0.5rem 0; }
        }
    </style>
</head>
<body class="py-8">
    <div class="container relative">
        <div id="home-page" class="text-center">
            <h1 class="text-5xl font-bold mb-8 text-amber-800">學生情緒紀錄系統</h1>
            <div class="mb-6">
                <label class="block text-lg font-medium mb-2">請選擇年級：</label>
                <select id="grade-select" class="w-full p-3 border border-amber-200 rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-amber-300">
                    <option value="" disabled selected>請選擇年級</option>
                    <option value="七年級">七年級</option>
                    <option value="八年級">八年級</option>
                    <option value="九年級">九年級</option>
                </select>
            </div>
            <div class="mb-8">
                <label class="block text-lg font-medium mb-2">請選擇姓名：</label>
                <select id="name-select" class="w-full p-3 border border-amber-200 rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-amber-300" disabled>
                    <option value="" disabled selected>請先選擇年級</option>
                </select>
            </div>
            <button id="start-btn" class="btn-primary font-bold py-3 px-6 rounded-lg text-lg transition-all">
                開始紀錄
            </button>

                        <!-- START: 新增的圖片 -->
                        <div class="mt-8">
                            <img src="images/twodogs.png" alt="兩隻可愛的狗狗" class="mx-auto rounded-lg w-40">
                        </div>
                        <!-- END: 新增的圖片 -->
        </div>

        <div id="emotion-page" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-2xl font-bold text-amber-800">今日情緒紀錄</h1>
                <div><span id="current-date" class="text-lg font-medium"></span></div>
            </div>
            <div class="mb-4">
                <p class="text-lg"><span id="display-grade" class="font-medium"></span> - <span id="display-name" class="font-medium"></span></p>
            </div>
            
            
            <div class="mb-6">
                <div class="flex justify-center items-center">
                    <p id="main-instruction" class="text-lg font-medium mb-3 text-center">請點選你今天的心情</p>
                    <button id="read-aloud-btn" class="speech-btn" title="朗讀說明">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.114 5.636a9 9 0 010 12.728M16.463 8.288a5.25 5.25 0 010 7.424M6.75 8.25l4.72-4.72a.75.75 0 011.28.53v15.88a.75.75 0 01-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 012.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75z" /></svg>
                    </button>
                </div>
                <div class="quadrant-layout-wrapper">
                    <span class="axis-label y-axis-top">高能量</span>
                    <div class="center-content">
                        <span class="axis-label x-axis-left">不好的感受</span>
                        <div id="emotion-quadrant-container">
                            <!-- Q2: 高能量 / 不好的感受 -->
                            <div class="quadrant q2">
                                <div class="button-row">
                                    <div class="emotion-btn bg-red-100" data-emotion="生氣"><div class="emoji">😠</div><div class="text">生氣</div></div>
                                    <div class="emotion-btn bg-gray-800 text-white" data-emotion="害怕"><div class="emoji">😱</div><div class="text">害怕</div></div>
                                    <div class="emotion-btn bg-amber-800 text-white" data-emotion="煩"><div class="emoji">😩</div><div class="text">煩</div></div>
                                </div>
                                <div class="button-row">
                                    <div class="emotion-btn bg-purple-100" data-emotion="緊張"><div class="emoji">😰</div><div class="text">緊張</div></div>
                                    <div class="emotion-btn bg-yellow-800 text-white" data-emotion="嫉妒"><div class="emoji">😒</div><div class="text">嫉妒</div></div>
                                </div>
                            </div>
                            <!-- Q1: 高能量 / 好的感受 -->
                            <div class="quadrant q1">
                                <div class="button-row">
                                    <div class="emotion-btn bg-orange-100" data-emotion="興奮"><div class="emoji">🤩</div><div class="text">興奮</div></div>
                                    <div class="emotion-btn bg-yellow-100" data-emotion="開心"><div class="emoji">😄</div><div class="text">開心</div></div>
                                    <div class="emotion-btn bg-teal-100" data-emotion="期待"><div class="emoji">✨</div><div class="text">期待</div></div>
                                </div>
                                <div class="button-row">
                                    <div class="emotion-btn bg-sky-100" data-emotion="自信"><div class="emoji">💪</div><div class="text">自信</div></div>
                                    <div class="emotion-btn bg-cyan-100" data-emotion="驚訝"><div class="emoji">😮</div><div class="text">驚訝</div></div>
                                </div>
                            </div>
                            <!-- Q3: 低能量 / 不好的感受 -->
                            <div class="quadrant q3">
                                <div class="button-row">
                                    <div class="emotion-btn bg-blue-100" data-emotion="難過"><div class="emoji">😢</div><div class="text">難過</div></div>
                                    <div class="emotion-btn bg-indigo-100" data-emotion="失望"><div class="emoji">😞</div><div class="text">失望</div></div>
                                    <div class="emotion-btn bg-gray-100" data-emotion="心累"><div class="emoji">😮‍💨</div><div class="text">心累</div></div>
                                </div>
                                <div class="button-row">
                                    <div class="emotion-btn bg-pink-100" data-emotion="尷尬"><div class="emoji">😳</div><div class="text">尷尬</div></div>
                                    <div class="emotion-btn bg-slate-200" data-emotion="沒自信"><div class="emoji">😥</div><div class="text">沒自信</div></div>
                                </div>
                            </div>
                            <!-- Q4: 低能量 / 好的感受 -->
                            <div class="quadrant q4">
                                <div class="emotion-btn bg-lime-100" data-emotion="放鬆"><div class="emoji">😌</div><div class="text">放鬆</div></div>
                                <div class="emotion-btn bg-green-100" data-emotion="滿足"><div class="emoji">😊</div><div class="text">滿足</div></div>
                            </div>
                        </div>
                        <span class="axis-label x-axis-right">好的感受</span>
                    </div>
                    <span class="axis-label y-axis-bottom">低能量</span>
                </div>
            </div>
            
            <div id="reason-section" class="mb-8 hidden">
                <label for="reason-input" class="block text-lg font-medium mb-3">請說明你今天有這個心情的原因：</label>
                <div class="relative">
                    <textarea id="reason-input" class="w-full p-3 border border-amber-200 rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-amber-300" rows="4" placeholder="請在這裡輸入原因..."></textarea>
                    <button id="mic-btn" class="speech-btn absolute bottom-2 right-2 bg-gray-200 rounded-full p-2" title="語音輸入">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 18.75a6 6 0 006-6v-1.5m-6 7.5a6 6 0 01-6-6v-1.5m6 7.5v3.75m-3.75 0h7.5M12 15.75a3 3 0 01-3-3V4.5a3 3 0 016 0v8.25a3 3 0 01-3 3z" /></svg>
                    </button>
                </div>
                 <p id="mic-status" class="text-sm text-center mt-1 hidden"></p>
            </div>
            
            <div class="flex justify-between">
                <button id="back-btn" class="btn-secondary font-bold py-2 px-4 rounded-lg">返回</button>
                <button id="submit-btn" class="btn-disabled font-bold py-2 px-4 rounded-lg hidden" disabled>提交</button>
            </div>
        </div>

        <div id="result-page" class="hidden">
            <div class="success-message">✅ 已成功記錄！</div>
            <h1 class="text-2xl font-bold mb-6 text-amber-800 text-center">紀錄完成</h1>
            <div class="flex justify-center gap-6 mt-6">
                <button id="next-person-btn" class="btn-secondary font-bold py-2 px-4 rounded-lg">換下一個人</button>
                <button id="go-to-start-btn" onclick="location.href='start.html'" class="btn-primary font-bold py-2 px-4 rounded-lg">回學習系統</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <div id="emotion-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <button id="modal-close-btn" class="modal-close-btn">&times;</button>
            <h2 id="modal-title" class="modal-title"></h2>
            <div>
                <div class="flex justify-between items-center mt-4">
                    <h3 class="modal-section-title">簡單說明</h3>
                    <button id="modal-read-desc-btn" class="speech-btn" title="朗讀說明">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.114 5.636a9 9 0 010 12.728M16.463 8.288a5.25 5.25 0 010 7.424M6.75 8.25l4.72-4.72a.75.75 0 011.28.53v15.88a.75.75 0 01-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 012.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75z" /></svg>
                    </button>
                </div>
                <p id="modal-description" class="modal-text"></p>
                
                <div class="flex justify-between items-center mt-6">
                    <h3 class="modal-section-title">生活舉例</h3>
                    <button id="modal-read-ex-btn" class="speech-btn" title="朗讀舉例">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.114 5.636a9 9 0 010 12.728M16.463 8.288a5.25 5.25 0 010 7.424M6.75 8.25l4.72-4.72a.75.75 0 011.28.53v15.88a.75.75 0 01-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 012.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75z" /></svg>
                    </button>
                </div>
                <p id="modal-examples" class="modal-text"></p>
            </div>
            <div class="text-center mt-8">
                <button id="modal-confirm-btn" class="btn-primary font-bold py-2 px-6 rounded-lg text-lg">就是這個心情</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const currentDate = new Date().toLocaleDateString('zh-TW');
            document.getElementById('current-date').textContent = currentDate;
            let selectedEmotion = null;
            let currentEmotionTarget = null;

            // 頁面元素
            const homePage = document.getElementById('home-page');
            const emotionPage = document.getElementById('emotion-page');
            const resultPage = document.getElementById('result-page');
            const gradeSelect = document.getElementById('grade-select');
            const nameSelect = document.getElementById('name-select');
            const displayGrade = document.getElementById('display-grade');
            const displayName = document.getElementById('display-name');
            const reasonSection = document.getElementById('reason-section');
            const reasonInput = document.getElementById('reason-input');
            const submitBtn = document.getElementById('submit-btn');
            const toast = document.getElementById('toast');
            const emotionBtns = document.querySelectorAll('.emotion-btn');

            // Modal 元素
            const emotionModal = document.getElementById('emotion-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalDescription = document.getElementById('modal-description');
            const modalExamples = document.getElementById('modal-examples');
            const modalCloseBtn = document.getElementById('modal-close-btn');
            const modalConfirmBtn = document.getElementById('modal-confirm-btn');
            
            // 語音功能相關元素
            const readAloudBtn = document.getElementById('read-aloud-btn');
            const mainInstruction = document.getElementById('main-instruction');
            const micBtn = document.getElementById('mic-btn');
            const micStatus = document.getElementById('mic-status');
            const modalReadDescBtn = document.getElementById('modal-read-desc-btn');
            const modalReadExBtn = document.getElementById('modal-read-ex-btn');

            const emotionDetails = {
                '興奮': { desc: '心裡充滿期待，身體好像也充滿了電力，讓你幾乎<u>等不及</u>要迎接某件開心的事！', ex: '當你想到明天就要去期待已久的旅行、當你喜歡的偶像即將獲勝、當你正要拆開一份很想要的禮物。' },
                '開心': { desc: '一種內心感到<u>愉快、順利</u>的舒服感覺，會讓你忍不住想微笑。', ex: '當你和好朋友聚在一起聊天大笑、當你的努力被看見並稱讚、當你完成一件困難的事。' },
                '期待': { desc: '在心裡<u>盼望著</u>某件好事發生，雖然比「興奮」平靜一點，但充滿了希望的感覺。', ex: '當你期待放學後要看的最新一集動漫、當你和朋友約好週末要見面、當你希望訂的包裹趕快送到。' },
                '自信': { desc: '<u>相信自己有能力</u>做到某件事，覺得自己是可靠的、有價值的。', ex: '當你為報告準備了很久，相信自己能表現得很好、當你熟練了一個新技能並準備好展示它、當你勇敢地舉手發言。' },
                '驚訝': { desc: '發生了<u>出乎你意料之外</u>的事，可能是一個開心的驚喜，也可能只是一個小小的嚇一跳。', ex: '當朋友們為你準備了生日驚喜、當考試內容跟你想的完全不一樣、當看到一個意想不到的劇情反轉。' },
                '生氣': { desc: '當你覺得事情<u>不公平</u>、自己的<u>界線被侵犯</u>，或目標被阻礙時，內心會產生一股強烈的能量。', ex: '當別人沒有經過同意就拿走你的東西、當你被誤會了卻沒有機會好好解釋、當你想做好的事卻一再被打斷。' },
                '害怕': { desc: '感覺到可能有<u>危險或威脅</u>，身體會變得警覺，心跳加速，想要逃跑或躲起來。', ex: '當你晚上一個人走在暗巷裡、當你覺得自己好像闖禍了要被責罵、當你在看恐怖片被嚇到。' },
                '煩': { desc: '一種不太強烈但持續的生氣，讓你覺得<u>不耐煩、靜不下心</u>，很想擺脫目前的狀況。', ex: '當天氣又濕又熱讓你渾身不舒服、當你有很多事要做卻不知從何開始、當旁邊的人一直發出噪音。' },
                '緊張': { desc: '對於即將發生的事感到<u>擔心和不安</u>，可能會手心冒汗、肚子怪怪的。', ex: '當你馬上就要上台報告或表演、當重要的考試發下考卷的那一刻、當你鼓起勇氣要和某人說話。' },
                '嫉妒': { desc: '當看到別人擁有你想要的東西、才華或人際關係時，心裡產生的一種<u>酸酸的、不舒服</u>的感覺。', ex: '當你的好朋友好像跟別人更要好、當別人擁有你夢寐以求的最新款手機、當同學在某方面表現得特別出色。' },
                '難過': { desc: '因為<u>失去、分離或受傷</u>而感到心情低落，身體沉重，可能會想哭。', ex: '當你和親近的人或心愛的寵物分開、當你和最好的朋友大吵一架、當你覺得沒有人理解你。' },
                '失望': { desc: '當你所期待或盼望的事情沒有發生，那種<u>希望落空</u>的感覺。', ex: '當期待已久的活動因為下雨而取消、當朋友忘記了和你的約定、當考試成績比你預期的要差很多。' },
                '心累': { desc: '不是身體上的疲倦，而是<u>精神和情緒上的消耗</u>，覺得沒有力氣再去應付任何事。', ex: '當你應付了一整天複雜的人際關係後、當你為了不讓別人擔心一直假裝自己沒事、當有太多的煩惱壓在你心上。' },
                '尷尬': { desc: '當眾做了一些你覺得<u>很糗、很笨拙</u>的事，讓你臉上發熱，恨不得找個地洞鑽進去。', ex: '當你在走廊上不小心滑倒、當你在安靜的教室裡肚子突然叫了一聲、當你不小心把老師叫成「媽媽」。' },
                '沒自信': { desc: '一種<u>懷疑自己</u>、覺得自己<u>不夠好</u>或能力不足的感覺。當有這種感覺時，你可能會害怕嘗試，或是不敢表達自己的真實想法。', ex: '上課時明明知道答案，卻因為害怕說錯而不敢舉手、在分組活動時，總覺得自己的意見不重要、看到別人很輕鬆做到某件事，心裡想著「我一定辦不到」。' },
                '放鬆': { desc: '<u>沒有任何壓力</u>和煩惱，身心都處於非常平靜、舒展的狀態。', ex: '當你做完所有功課躺在床上聽音樂、當你沉浸在自己的興趣中（例如畫畫或閱讀）、當你泡在溫暖的浴缸裡。' },
                '滿足': { desc: '一種內心感到<u>充實、溫暖</u>的平靜喜悅，覺得「這樣就夠了」、「很美好」。', ex: '當你吃到一頓非常好吃的晚餐、當你完成一件作品並對它感到很滿意、當你和家人或朋友度過了一段溫馨的時光。' }
            };

            const studentsByGrade = {
                '七年級': ['吳恩旻', '林子龍', '楊育翔', '陳凱莉', '陳燕鈴'],
                '八年級': ['蘇祐慶', '黃雅璇', '黃寬益', '徐文彥', '蘇佳琦'],
                '九年級': ['鄭詠文', '卓冠佑', '馬若庭', '吳亮勳']
            };

            gradeSelect.addEventListener('change', function() {
                const selectedGrade = this.value;
                nameSelect.innerHTML = '<option value="" disabled selected>請選擇姓名</option>';
                if (selectedGrade && studentsByGrade[selectedGrade]) {
                    nameSelect.disabled = false;
                    studentsByGrade[selectedGrade].forEach(name => {
                        const option = document.createElement('option');
                        option.value = name;
                        option.textContent = name;
                        nameSelect.appendChild(option);
                    });
                } else {
                    nameSelect.innerHTML = '<option value="" disabled selected>請先選擇年級</option>';
                    nameSelect.disabled = true;
                }
            });

            function showToast(message) {
                toast.textContent = message;
                toast.classList.add('show');
                setTimeout(() => { toast.classList.remove('show'); }, 3000);
            }

            document.getElementById('start-btn').addEventListener('click', function() {
                const grade = gradeSelect.value;
                const name = nameSelect.value;
                if (!grade || !name) { alert('請選擇年級和姓名'); return; }
                displayGrade.textContent = grade;
                displayName.textContent = name;
                homePage.classList.add('hidden');
                emotionPage.classList.remove('hidden');
            });

            document.getElementById('back-btn').addEventListener('click', function() {
                emotionPage.classList.add('hidden');
                homePage.classList.remove('hidden');
                resetEmotionSelection();
            });
            
            // 語音朗讀 (TTS) 邏輯
            function speak(text) {
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = 'zh-TW';
                    utterance.rate = 1.1;
                    window.speechSynthesis.cancel();
                    window.speechSynthesis.speak(utterance);
                } else {
                    alert('抱歉，您的瀏覽器不支援語音朗讀功能。');
                }
            }

            readAloudBtn.addEventListener('click', () => {
                speak(mainInstruction.textContent);
            });
            
            modalReadDescBtn.addEventListener('click', () => {
                speak(modalDescription.textContent);
            });

            modalReadExBtn.addEventListener('click', () => {
                speak(modalExamples.textContent);
            });
            
            // 語音輸入 (Speech-to-Text) 邏輯
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            let recognition;

            if (SpeechRecognition) {
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.lang = 'cmn-Hant-TW';
                recognition.interimResults = false;

                micBtn.addEventListener('click', () => {
                    recognition.start();
                });

                recognition.onstart = () => {
                    micBtn.classList.add('is-recording');
                    micStatus.textContent = '正在聆聽...';
                    micStatus.classList.remove('hidden');
                };

                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    reasonInput.value += transcript;
                    updateSubmitButtonState();
                };

                recognition.onerror = (event) => {
                    micStatus.textContent = `語音辨識錯誤: ${event.error}`;
                };

                recognition.onend = () => {
                    micBtn.classList.remove('is-recording');
                    setTimeout(() => micStatus.classList.add('hidden'), 2000);
                };
            } else {
                micBtn.style.display = 'none';
                console.log('瀏覽器不支援語音辨識功能。');
            }

            function openModal(emotionName, targetButton) {
                const details = emotionDetails[emotionName];
                if (!details) return;

                modalTitle.textContent = emotionName;
                modalDescription.innerHTML = details.desc; // 使用 innerHTML 讓 <u> 生效
                modalExamples.innerHTML = details.ex;     // 使用 innerHTML 讓 <u> 生效
                currentEmotionTarget = targetButton;

                emotionModal.classList.remove('hidden');
                setTimeout(() => emotionModal.classList.add('show'), 10);
            }

            function closeModal() {
                window.speechSynthesis.cancel();
                emotionModal.classList.remove('show');
                setTimeout(() => emotionModal.classList.add('hidden'), 300);
            }

            emotionBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const emotionName = this.getAttribute('data-emotion');
                    openModal(emotionName, this);
                });
            });

            modalConfirmBtn.addEventListener('click', function() {
                if (!currentEmotionTarget) return;
                emotionBtns.forEach(b => b.classList.remove('selected'));
                currentEmotionTarget.classList.add('selected');
                selectedEmotion = currentEmotionTarget.getAttribute('data-emotion');
                reasonSection.classList.remove('hidden');
                submitBtn.classList.remove('hidden');
                updateSubmitButtonState();
                closeModal();
            });

            modalCloseBtn.addEventListener('click', closeModal);
            emotionModal.addEventListener('click', function(event) {
                if (event.target === emotionModal) closeModal();
            });

            reasonInput.addEventListener('input', updateSubmitButtonState);

            function updateSubmitButtonState() {
                const hasEmotion = selectedEmotion !== null;
                const hasReason = reasonInput.value.trim() !== '';
                if (hasEmotion && hasReason) {
                    submitBtn.disabled = false;
                    submitBtn.classList.remove('btn-disabled');
                    submitBtn.classList.add('btn-primary');
                } else {
                    submitBtn.disabled = true;
                    submitBtn.classList.add('btn-disabled');
                    submitBtn.classList.remove('btn-primary');
                }
            }

            submitBtn.addEventListener('click', function() {
                if (this.disabled) return;
                this.disabled = true;
                this.textContent = "送出中...";
                this.classList.add("btn-disabled");
                this.classList.remove("btn-primary");

                const grade = displayGrade.textContent;
                const name = displayName.textContent;
                const reasonsText = reasonInput.value.trim();

                fetch('https://google-sheet-proxy.onrender.com/submit', {
                    method: 'POST',
                    body: JSON.stringify({
                        date: currentDate, grade: grade, name: name,
                        emotion: selectedEmotion, reasons: reasonsText
                    }),
                    headers: { 'Content-Type': 'application/json' }
                })
                .then(response => {
                    if (!response.ok) throw new Error('網路錯誤，請稍後再試');
                    return response.text();
                })
                .then(result => {
                    showToast('✅ 資料已成功提交！');
                    emotionPage.classList.add('hidden');
                    resultPage.classList.remove('hidden');
                    resetEmotionSelection();
                })
                .catch(error => {
                    alert('提交失敗：' + error.message);
                    this.disabled = false;
                    this.textContent = "提交";
                    updateSubmitButtonState();
                });
            });

            document.getElementById('next-person-btn').addEventListener('click', function() {
                resultPage.classList.add('hidden');
                homePage.classList.remove('hidden');
                gradeSelect.value = '';
                nameSelect.innerHTML = '<option value="" disabled selected>請先選擇年級</option>';
                nameSelect.disabled = true;
            });

            function resetEmotionSelection() {
                emotionBtns.forEach(btn => btn.classList.remove('selected'));
                selectedEmotion = null;
                currentEmotionTarget = null;
                reasonSection.classList.add('hidden');
                submitBtn.classList.add('hidden');
                reasonInput.value = '';
                closeModal();
                updateSubmitButtonState();
            }
        });
    </script>
</body>
</html>


<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‹—ç‹—å†’éšªä¹‹æ—… - åœ–æ›¸é¤¨æŒ‘æˆ°</title> 
    <link rel="stylesheet" href="css/style.css"> 
    <link rel="stylesheet" href="css/quiz_page_styles.css"> 
</head>
<body class="library-quiz-page">
    <div class="container"> 
        <h1 id="quiz-page-title">åœ–æ›¸é¤¨æŒ‘æˆ°</h1> 
        <div class="player-info-bar">
            <span>è§’è‰²ï¼š<strong id="player-char">æœªçŸ¥å¤¥ä¼´</strong></span>
            <span class="meat-jerky-counter">ğŸ¦´ è‚‰ä¹¾ï¼š<strong id="meat-jerky-display">0</strong></span>
        </div>       
        <div class="quiz-area" id="quiz-content-area">
            <h2 id="question-text">æ­£åœ¨åŠ è¼‰å•é¡Œ...</h2> 
            <form id="quiz-form">
                <ul class="quiz-options-list" id="options-container">
                    </ul>
                <button type="submit" class="quiz-submit-btn" id="submit-answer-btn">æäº¤ç­”æ¡ˆ</button>
            </form>
            <p id="quiz-feedback" style="display: none;"></p> 
        </div>
        
        <div id="quiz-navigation" style="text-align: center; margin-top: 20px; display: none;">
            <button id="next-question-btn" class="quiz-navigation-link" style="background-color: #007bff;">ä¸‹ä¸€é¡Œ</button> 
            <a href="map_selection.html" class="quiz-navigation-link" id="back-to-map-link">è¿”å›åœ°åœ–é¸æ“‡</a>
        </div>

        <div id="quiz-complete-message" style="display: none; text-align:center; margin-top:30px;">
            <h3 id="quiz-complete-title">æŒ‘æˆ°å®Œæˆï¼</h3>
            <p id="final-score-message"></p> 
            <p id="basement-unlock-message" style="display: none; color: green; font-weight: bold;">ğŸ‰ æ­å–œï¼ä½ æ”¶é›†åˆ°äº†è¶³å¤ çš„è‚‰ä¹¾ï¼Œåœ°ä¸‹å®¤å·²ç¶“è§£é–äº†ï¼ ğŸ‰</p>
            <a href="map_selection.html" class="quiz-navigation-link">è¿”å›åœ°åœ–é¸æ“‡</a>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const playerCharSpan = document.getElementById('player-char');
            const quizPageTitle = document.getElementById('quiz-page-title');
            const meatJerkyDisplay = document.getElementById('meat-jerky-display');
            
            const quizContentArea = document.getElementById('quiz-content-area');
            const questionTextEl = document.getElementById('question-text');
            const optionsContainer = document.getElementById('options-container');
            const quizForm = document.getElementById('quiz-form');
            const submitAnswerBtn = document.getElementById('submit-answer-btn');
            const feedbackEl = document.getElementById('quiz-feedback');

            const quizNavigationDiv = document.getElementById('quiz-navigation');
            const nextQuestionBtn = document.getElementById('next-question-btn'); 

            const quizCompleteMessageDiv = document.getElementById('quiz-complete-message');
            const quizCompleteTitle = document.getElementById('quiz-complete-title');
            const finalScoreMessage = document.getElementById('final-score-message');
            const basementUnlockMessage = document.getElementById('basement-unlock-message');

            // --- Game State & Data ---
            let currentQuestionIndex = 0; 
            let meatJerkyCount = parseInt(localStorage.getItem('meatJerkyCount')) || 0;
            const MAX_MEAT_JERKY_TO_UNLOCK = 3;
            let questionsAnsweredInThisSession = 0; 

            const questionsData = [
                {
                    question: "åœ–æ›¸é¤¨ä¸­è¨˜è¼‰ã€Œå°¾èªä¹‹çŸ³ã€çš„å¤ç±æ˜¯ä»€éº¼é¡è‰²å°é¢çš„ï¼Ÿ",
                    options: { a: "ç´…è‰²ç¾Šçš®å°é¢", b: "æ·±è—è‰²ç¡¬æ®¼å°é¢", c: "ç ´æçš„æ£•è‰²çš®é©å°é¢", d: "æ²’æœ‰å°é¢ï¼Œåªæœ‰æ•£é " },
                    correctAnswer: "c",
                    locationName: "åœ–æ›¸é¤¨" 
                },
                {
                    question: "åœ¨åœ–æ›¸é¤¨çš„æ­·å²å€ï¼Œå“ªä½è‘—åæ ¡å‹çš„è‚–åƒç•«ä½œé¢¨æ ¼æœ€ç‚ºæŠ½è±¡ï¼Ÿ",
                    options: { a: "å‰µæ ¡æ ¡é•· é˜¿çˆ¾ä¼¯ç‰¹Â·æ±ª (å¯«å¯¦æ´¾)", b: "ç™¼æ˜å®¶ è‰¾æ‹‰Â·éª¨é ­ (æœªä¾†ä¸»ç¾©)", c: "æ¢éšªå®¶ å·´å…‹Â·æ¯›æ¯› (å°è±¡æ´¾)", d: "è—è¡“å®¶ é”åˆ©çŠ¬ (è¶…ç¾å¯¦ä¸»ç¾©)" },
                    correctAnswer: "d",
                    locationName: "åœ–æ›¸é¤¨"
                },
                {
                    question: "åœ–æ›¸é¤¨çš„ç¦æ›¸å€å‚³èè—æœ‰ä»€éº¼ç§˜å¯†ï¼Ÿ",
                    options: { a: "å¤±è½çš„é£Ÿè­œ", b: "å¤è€çš„é­”æ³•å’’èª", c: "æ ¡åœ’å»ºè¨­çš„è—åœ–", d: "ä¸€æœ¬ç©ºç™½çš„æ—¥è¨˜" },
                    correctAnswer: "b",
                    locationName: "åœ–æ›¸é¤¨"
                }
            ];
            
            // --- Initialization ---
            function initializeQuiz() {
                updateMeatJerkyDisplay();
                
                if (!questionsData || questionsData.length === 0) {
                    questionTextEl.textContent = "æ­¤åœ°é»æš«ç„¡æŒ‘æˆ°é¡Œç›®ã€‚";
                    if(submitAnswerBtn) submitAnswerBtn.style.display = 'none';
                    if(quizNavigationDiv) quizNavigationDiv.style.display = 'block';
                    if(nextQuestionBtn) nextQuestionBtn.style.display = 'none';
                    return;
                }
                loadQuestion(currentQuestionIndex);

                const urlParams = new URLSearchParams(window.location.search);
                const characterId = urlParams.get('char');
                const locationNameParam = urlParams.get('location'); 

                const characterNames = {'sheepdog':'ç‰§ç¾ŠçŠ¬','shiba':'æŸ´çŠ¬','mix':'ç±³å…‹æ–¯','bulldog':'é¬¥ç‰›çŠ¬'};
                if (characterId && characterNames[characterId]) {
                    playerCharSpan.textContent = characterNames[characterId];
                }
                
                const displayLocation = questionsData[0].locationName || (locationNameParam ? decodeURIComponent(locationNameParam) : "æœªçŸ¥åœ°é»");
                if (quizPageTitle) {
                    quizPageTitle.textContent = `${displayLocation}æŒ‘æˆ°`;
                }
            }

            // --- UI Update Functions ---
            function updateMeatJerkyDisplay() {
                meatJerkyDisplay.textContent = meatJerkyCount;
            }

            function loadQuestion(index) {
                if (index >= questionsData.length) {
                    endQuiz(); 
                    return;
                }
                const qData = questionsData[index];
                questionTextEl.textContent = `å•é¡Œ ${index + 1}ï¼š${qData.question}`;

                optionsContainer.innerHTML = ''; 
                for (const key in qData.options) {
                    const optionLi = document.createElement('li');
                    optionLi.className = 'quiz-option';
                    const label = document.createElement('label');
                    label.className = 'quiz-option-label';
                    const input = document.createElement('input');
                    input.type = 'radio';
                    input.name = 'q_answer'; 
                    input.value = key;
                    const customRadio = document.createElement('span');
                    customRadio.className = 'custom-radio';
                    const optionText = document.createElement('span');
                    optionText.className = 'option-text';
                    optionText.textContent = qData.options[key];
                    
                    label.appendChild(input);
                    label.appendChild(customRadio);
                    label.appendChild(optionText);
                    optionLi.appendChild(label);
                    optionsContainer.appendChild(optionLi);

                    input.addEventListener('change', () => {
                        document.querySelectorAll('input[name="q_answer"]').forEach(radio => {
                            radio.closest('.quiz-option-label').classList.remove('selected');
                        });
                        if (input.checked) {
                            label.classList.add('selected');
                        }
                    });
                }
                feedbackEl.style.display = 'none';
                if(submitAnswerBtn) {
                    submitAnswerBtn.disabled = false;
                    submitAnswerBtn.style.display = 'block'; 
                }
                if(quizNavigationDiv) quizNavigationDiv.style.display = 'none'; 
            }

            // --- Event Handlers ---
            if (quizForm) {
                quizForm.addEventListener('submit', function(event) {
                    event.preventDefault();
                    if(submitAnswerBtn) submitAnswerBtn.disabled = true; 
                    
                    const selectedAnswerInput = quizForm.querySelector('input[name="q_answer"]:checked');
                    
                    feedbackEl.style.display = 'block';
                    feedbackEl.className = ''; 
                    feedbackEl.id = 'quiz-feedback';

                    if (selectedAnswerInput) {
                        const userAnswer = selectedAnswerInput.value;
                        const currentQuestionData = questionsData[currentQuestionIndex];
                        const correctAnswer = currentQuestionData.correctAnswer;
                        const isCorrect = (userAnswer === correctAnswer);

                        if (isCorrect) {
                            feedbackEl.textContent = 'ç­”å°äº†ï¼ç²å¾—ä¸€å€‹ ğŸ¦´ è‚‰ä¹¾ï¼';
                            feedbackEl.classList.add('correct');
                            meatJerkyCount++;
                            questionsAnsweredInThisSession++;
                            localStorage.setItem('meatJerkyCount', meatJerkyCount); 
                            updateMeatJerkyDisplay();
                            checkBasementUnlock();
                        } else {
                            feedbackEl.textContent = `ç­”éŒ¯äº†ã€‚æ­£ç¢ºç­”æ¡ˆæ˜¯ï¼š${currentQuestionData.options[correctAnswer]}`;
                            feedbackEl.classList.add('incorrect');
                        }

                        // ================== å‚³é€è³‡æ–™åˆ° FIREBASE ==================
                        try {
                            const characterName = playerCharSpan.textContent || 'æœªçŸ¥è§’è‰²';
                            
                            const answerRecord = {
                                character: characterName,
                                location: currentQuestionData.locationName,
                                question: currentQuestionData.question,
                                userAnswer: currentQuestionData.options[userAnswer],
                                correctAnswer: currentQuestionData.options[correctAnswer],
                                isCorrect: isCorrect,
                                timestamp: new Date() 
                            };

                            // ä½¿ç”¨æˆ‘å€‘åœ¨ä¸‹é¢åˆå§‹åŒ–çš„ db ç‰©ä»¶ä¾†å‚³é€è³‡æ–™
                            db.collection("answers").add(answerRecord)
                                .then((docRef) => {
                                    console.log("ç´€éŒ„æˆåŠŸå„²å­˜ï¼ŒID: ", docRef.id);
                                })
                                .catch((error) => {
                                    console.error("å„²å­˜ç´€éŒ„æ™‚ç™¼ç”ŸéŒ¯èª¤: ", error);
                                });

                        } catch(e) {
                            console.error("ç„¡æ³•å‚³é€è³‡æ–™åˆ° Firebase: ", e);
                        }
                        // =========================================================

                    } else {
                        feedbackEl.textContent = 'è«‹é¸æ“‡ä¸€å€‹ç­”æ¡ˆï¼';
                        feedbackEl.classList.add('info');
                        if(submitAnswerBtn) submitAnswerBtn.disabled = false; 
                        return; 
                    }
                    
                    if(submitAnswerBtn) submitAnswerBtn.style.display = 'none'; 
                    if(quizNavigationDiv) quizNavigationDiv.style.display = 'block';

                    if (currentQuestionIndex >= questionsData.length - 1) {
                        if (nextQuestionBtn) nextQuestionBtn.textContent = "æŸ¥çœ‹çµæœ";
                    } else {
                        if (nextQuestionBtn) {
                            nextQuestionBtn.textContent = "ä¸‹ä¸€é¡Œ";
                            nextQuestionBtn.style.display = 'inline-block';
                        }
                    }
                });
            }

            if (nextQuestionBtn) {
                nextQuestionBtn.addEventListener('click', () => {
                    if (currentQuestionIndex >= questionsData.length - 1) {
                        endQuiz();
                    } else {
                        currentQuestionIndex++;
                        loadQuestion(currentQuestionIndex);
                    }
                });
            }

            // --- Game Logic ---
            function checkBasementUnlock() {
                if (meatJerkyCount >= MAX_MEAT_JERKY_TO_UNLOCK) {
                    if (localStorage.getItem('basementUnlocked') !== 'true') {
                        localStorage.setItem('basementUnlocked', 'true');
                    }
                }
            }

            function endQuiz() {
                if(quizContentArea) quizContentArea.style.display = 'none'; 
                if(quizNavigationDiv) quizNavigationDiv.style.display = 'none'; 
                if(quizCompleteMessageDiv) quizCompleteMessageDiv.style.display = 'block'; 

                if (quizCompleteTitle) quizCompleteTitle.textContent = "åœ–æ›¸é¤¨æŒ‘æˆ°å®Œæˆï¼"; 
                if (finalScoreMessage) {
                     finalScoreMessage.textContent = `æœ¬æ¬¡æŒ‘æˆ°ä½ ç­”å°äº† ${questionsAnsweredInThisSession} / ${questionsData.length} é¡Œã€‚`;
                     finalScoreMessage.textContent += ` ç›®å‰ç¸½å…±æœ‰ ${meatJerkyCount} å€‹è‚‰ä¹¾ã€‚`;
                }

                if (localStorage.getItem('basementUnlocked') === 'true' || meatJerkyCount >= MAX_MEAT_JERKY_TO_UNLOCK) {
                    if(basementUnlockMessage) basementUnlockMessage.style.display = 'block';
                }
            }

            // --- Start Quiz ---
            initializeQuiz();
        });
    </script>

    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-firestore.js"></script>
    <script>
      // æ‚¨çš„ Firebase è¨­å®š
      const firebaseConfig = {
        apiKey: "AIzaSyA_JPaac0v0ssMb2tAOGIZ_YCQYbcLKRLc", // å®‰å…¨æé†’ï¼šæ­¤é‡‘é‘°å·²åœ¨å°è©±ä¸­å…¬é–‹ï¼Œå»ºè­°å°ˆæ¡ˆå®Œæˆå¾Œå¾Firebaseå¾Œå°æ›´æ›ä¸€çµ„æ–°çš„
        authDomain: "rpg-game-records.firebaseapp.com",
        projectId: "rpg-game-records",
        storageBucket: "rpg-game-records.appspot.com",
        messagingSenderId: "490562660857",
        appId: "1:490562660857:web:d1601081191e476cf53528"
      };

      // åˆå§‹åŒ– Firebase
      const app = firebase.initializeApp(firebaseConfig);
      
      // å–å¾— Firestore è³‡æ–™åº«çš„å¯¦ä¾‹ï¼Œä¸¦å­˜åˆ°ä¸€å€‹å«åš db çš„è®Šæ•¸ä¸­
      // ä¸Šæ–¹çš„éŠæˆ²è…³æœ¬æœƒä½¿ç”¨é€™å€‹ 'db' è®Šæ•¸ä¾†å‚³é€è³‡æ–™
      const db = firebase.firestore();
    </script>
</body>
</html>